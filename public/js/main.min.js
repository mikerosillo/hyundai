(function(){"use strict";var document=typeof window!=="undefined"&&typeof window.document!=="undefined"?window.document:{};var isCommonjs=typeof module!=="undefined"&&module.exports;var keyboardAllowed=typeof Element!=="undefined"&&"ALLOW_KEYBOARD_INPUT"in Element;var fn=function(){var val;var fnMap=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]];var i=0;var l=fnMap.length;var ret={};for(;i<l;i++){val=fnMap[i];if(val&&val[1]in document){for(i=0;i<val.length;i++){ret[fnMap[0][i]]=val[i]}return ret}}return false}();var eventNameMap={change:fn.fullscreenchange,error:fn.fullscreenerror};var screenfull={request:function(elem){var request=fn.requestFullscreen;elem=elem||document.documentElement;if(/5\.1[.\d]* Safari/.test(navigator.userAgent)){elem[request]()}else{elem[request](keyboardAllowed&&Element.ALLOW_KEYBOARD_INPUT)}},exit:function(){document[fn.exitFullscreen]()},toggle:function(elem){if(this.isFullscreen){this.exit()}else{this.request(elem)}},onchange:function(callback){this.on("change",callback)},onerror:function(callback){this.on("error",callback)},on:function(event,callback){var eventName=eventNameMap[event];if(eventName){document.addEventListener(eventName,callback,false)}},off:function(event,callback){var eventName=eventNameMap[event];if(eventName){document.removeEventListener(eventName,callback,false)}},raw:fn};if(!fn){if(isCommonjs){module.exports=false}else{window.screenfull=false}return}Object.defineProperties(screenfull,{isFullscreen:{get:function(){return Boolean(document[fn.fullscreenElement])}},element:{enumerable:true,get:function(){return document[fn.fullscreenElement]}},enabled:{enumerable:true,get:function(){return Boolean(document[fn.fullscreenEnabled])}}});if(isCommonjs){module.exports=screenfull}else{window.screenfull=screenfull}})();(function(){"use strict";var objectTypes={function:true,object:true};var root=objectTypes[typeof window]&&window||this;var oldRoot=root;var freeExports=objectTypes[typeof exports]&&exports;var freeModule=objectTypes[typeof module]&&module&&!module.nodeType&&module;var freeGlobal=freeExports&&freeModule&&typeof global=="object"&&global;if(freeGlobal&&(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal)){root=freeGlobal}var maxSafeInteger=Math.pow(2,53)-1;var reOpera=/\bOpera/;var thisBinding=this;var objectProto=Object.prototype;var hasOwnProperty=objectProto.hasOwnProperty;var toString=objectProto.toString;function capitalize(string){string=String(string);return string.charAt(0).toUpperCase()+string.slice(1)}function cleanupOS(os,pattern,label){var data={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};if(pattern&&label&&/^Win/i.test(os)&&!/^Windows Phone /i.test(os)&&(data=data[/[\d.]+$/.exec(os)])){os="Windows "+data}os=String(os);if(pattern&&label){os=os.replace(RegExp(pattern,"i"),label)}os=format(os.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0]);return os}function each(object,callback){var index=-1,length=object?object.length:0;if(typeof length=="number"&&length>-1&&length<=maxSafeInteger){while(++index<length){callback(object[index],index,object)}}else{forOwn(object,callback)}}function format(string){string=trim(string);return/^(?:webOS|i(?:OS|P))/.test(string)?string:capitalize(string)}function forOwn(object,callback){for(var key in object){if(hasOwnProperty.call(object,key)){callback(object[key],key,object)}}}function getClassOf(value){return value==null?capitalize(value):toString.call(value).slice(8,-1)}function isHostType(object,property){var type=object!=null?typeof object[property]:"number";return!/^(?:boolean|number|string|undefined)$/.test(type)&&(type=="object"?!!object[property]:true)}function qualify(string){return String(string).replace(/([ -])(?!$)/g,"$1?")}function reduce(array,callback){var accumulator=null;each(array,function(value,index){accumulator=callback(accumulator,value,index,array)});return accumulator}function trim(string){return String(string).replace(/^ +| +$/g,"")}function parse(ua){var context=root;var isCustomContext=ua&&typeof ua=="object"&&getClassOf(ua)!="String";if(isCustomContext){context=ua;ua=null}var nav=context.navigator||{};var userAgent=nav.userAgent||"";ua||(ua=userAgent);var isModuleScope=isCustomContext||thisBinding==oldRoot;var likeChrome=isCustomContext?!!nav.likeChrome:/\bChrome\b/.test(ua)&&!/internal|\n/i.test(toString.toString());var objectClass="Object",airRuntimeClass=isCustomContext?objectClass:"ScriptBridgingProxyObject",enviroClass=isCustomContext?objectClass:"Environment",javaClass=isCustomContext&&context.java?"JavaPackage":getClassOf(context.java),phantomClass=isCustomContext?objectClass:"RuntimeObject";var java=/\bJava/.test(javaClass)&&context.java;var rhino=java&&getClassOf(context.environment)==enviroClass;var alpha=java?"a":"α";var beta=java?"b":"β";var doc=context.document||{};var opera=context.operamini||context.opera;var operaClass=reOpera.test(operaClass=isCustomContext&&opera?opera["[[Class]]"]:getClassOf(opera))?operaClass:opera=null;var data;var arch=ua;var description=[];var prerelease=null;var useFeatures=ua==userAgent;var version=useFeatures&&opera&&typeof opera.version=="function"&&opera.version();var isSpecialCasedOS;var layout=getLayout([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"]);var name=getName(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"Edge"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Waterfox","WebPositive","Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chrome",{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]);var product=getProduct([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]);var manufacturer=getManufacturer({Apple:{iPad:1,iPhone:1,iPod:1},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1}});var os=getOS(["Windows Phone","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function getLayout(guesses){return reduce(guesses,function(result,guess){return result||RegExp("\\b"+(guess.pattern||qualify(guess))+"\\b","i").exec(ua)&&(guess.label||guess)})}function getManufacturer(guesses){return reduce(guesses,function(result,value,key){return result||(value[product]||value[/^[a-z]+(?: +[a-z]+\b)*/i.exec(product)]||RegExp("\\b"+qualify(key)+"(?:\\b|\\w*\\d)","i").exec(ua))&&key})}function getName(guesses){return reduce(guesses,function(result,guess){return result||RegExp("\\b"+(guess.pattern||qualify(guess))+"\\b","i").exec(ua)&&(guess.label||guess)})}function getOS(guesses){return reduce(guesses,function(result,guess){var pattern=guess.pattern||qualify(guess);if(!result&&(result=RegExp("\\b"+pattern+"(?:/[\\d.]+|[ \\w.]*)","i").exec(ua))){result=cleanupOS(result,pattern,guess.label||guess)}return result})}function getProduct(guesses){return reduce(guesses,function(result,guess){var pattern=guess.pattern||qualify(guess);if(!result&&(result=RegExp("\\b"+pattern+" *\\d+[.\\w_]*","i").exec(ua)||RegExp("\\b"+pattern+" *\\w+-[\\w]*","i").exec(ua)||RegExp("\\b"+pattern+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(ua))){if((result=String(guess.label&&!RegExp(pattern,"i").test(guess.label)?guess.label:result).split("/"))[1]&&!/[\d.]+/.test(result[0])){result[0]+=" "+result[1]}guess=guess.label||guess;result=format(result[0].replace(RegExp(pattern,"i"),guess).replace(RegExp("; *(?:"+guess+"[_-])?","i")," ").replace(RegExp("("+guess+")[-_.]?(\\w)","i"),"$1 $2"))}return result})}function getVersion(patterns){return reduce(patterns,function(result,pattern){return result||(RegExp(pattern+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(ua)||0)[1]||null})}function toStringPlatform(){return this.description||""}layout&&(layout=[layout]);if(manufacturer&&!product){product=getProduct([manufacturer])}if(data=/\bGoogle TV\b/.exec(product)){product=data[0]}if(/\bSimulator\b/i.test(ua)){product=(product?product+" ":"")+"Simulator"}if(name=="Opera Mini"&&/\bOPiOS\b/.test(ua)){description.push("running in Turbo/Uncompressed mode")}if(name=="IE"&&/\blike iPhone OS\b/.test(ua)){data=parse(ua.replace(/like iPhone OS/,""));manufacturer=data.manufacturer;product=data.product}else if(/^iP/.test(product)){name||(name="Safari");os="iOS"+((data=/ OS ([\d_]+)/i.exec(ua))?" "+data[1].replace(/_/g,"."):"")}else if(name=="Konqueror"&&!/buntu/i.test(os)){os="Kubuntu"}else if(manufacturer&&manufacturer!="Google"&&(/Chrome/.test(name)&&!/\bMobile Safari\b/i.test(ua)||/\bVita\b/.test(product))||/\bAndroid\b/.test(os)&&/^Chrome/.test(name)&&/\bVersion\//i.test(ua)){name="Android Browser";os=/\bAndroid\b/.test(os)?os:"Android"}else if(name=="Silk"){if(!/\bMobi/i.test(ua)){os="Android";description.unshift("desktop mode")}if(/Accelerated *= *true/i.test(ua)){description.unshift("accelerated")}}else if(name=="PaleMoon"&&(data=/\bFirefox\/([\d.]+)\b/.exec(ua))){description.push("identifying as Firefox "+data[1])}else if(name=="Firefox"&&(data=/\b(Mobile|Tablet|TV)\b/i.exec(ua))){os||(os="Firefox OS");product||(product=data[1])}else if(!name||(data=!/\bMinefield\b/i.test(ua)&&/\b(?:Firefox|Safari)\b/.exec(name))){if(name&&!product&&/[\/,]|^[^(]+?\)/.test(ua.slice(ua.indexOf(data+"/")+8))){name=null}if((data=product||manufacturer||os)&&(product||manufacturer||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(os))){name=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(os)?os:data)+" Browser"}}else if(name=="Electron"&&(data=(/\bChrome\/([\d.]+)\b/.exec(ua)||0)[1])){description.push("Chromium "+data)}if(!version){version=getVersion(["(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))","Version",qualify(name),"(?:Firefox|Minefield|NetFront)"])}if(data=layout=="iCab"&&parseFloat(version)>3&&"WebKit"||/\bOpera\b/.test(name)&&(/\bOPR\b/.test(ua)?"Blink":"Presto")||/\b(?:Midori|Nook|Safari)\b/i.test(ua)&&!/^(?:Trident|EdgeHTML)$/.test(layout)&&"WebKit"||!layout&&/\bMSIE\b/i.test(ua)&&(os=="Mac OS"?"Tasman":"Trident")||layout=="WebKit"&&/\bPlayStation\b(?! Vita\b)/i.test(name)&&"NetFront"){layout=[data]}if(name=="IE"&&(data=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(ua)||0)[1])){name+=" Mobile";os="Windows Phone "+(/\+$/.test(data)?data:data+".x");description.unshift("desktop mode")}else if(/\bWPDesktop\b/i.test(ua)){name="IE Mobile";os="Windows Phone 8.x";description.unshift("desktop mode");version||(version=(/\brv:([\d.]+)/.exec(ua)||0)[1])}else if(name!="IE"&&layout=="Trident"&&(data=/\brv:([\d.]+)/.exec(ua))){if(name){description.push("identifying as "+name+(version?" "+version:""))}name="IE";version=data[1]}if(useFeatures){if(isHostType(context,"global")){if(java){data=java.lang.System;arch=data.getProperty("os.arch");os=os||data.getProperty("os.name")+" "+data.getProperty("os.version")}if(rhino){try{version=context.require("ringo/engine").version.join(".");name="RingoJS"}catch(e){if((data=context.system)&&data.global.system==context.system){name="Narwhal";os||(os=data[0].os||null)}}if(!name){name="Rhino"}}else if(typeof context.process=="object"&&!context.process.browser&&(data=context.process)){if(typeof data.versions=="object"){if(typeof data.versions.electron=="string"){description.push("Node "+data.versions.node);name="Electron";version=data.versions.electron}else if(typeof data.versions.nw=="string"){description.push("Chromium "+version,"Node "+data.versions.node);name="NW.js";version=data.versions.nw}}if(!name){name="Node.js";arch=data.arch;os=data.platform;version=/[\d.]+/.exec(data.version);version=version?version[0]:null}}}else if(getClassOf(data=context.runtime)==airRuntimeClass){name="Adobe AIR";os=data.flash.system.Capabilities.os}else if(getClassOf(data=context.phantom)==phantomClass){name="PhantomJS";version=(data=data.version||null)&&data.major+"."+data.minor+"."+data.patch}else if(typeof doc.documentMode=="number"&&(data=/\bTrident\/(\d+)/i.exec(ua))){version=[version,doc.documentMode];if((data=+data[1]+4)!=version[1]){description.push("IE "+version[1]+" mode");layout&&(layout[1]="");version[1]=data}version=name=="IE"?String(version[1].toFixed(1)):version[0]}else if(typeof doc.documentMode=="number"&&/^(?:Chrome|Firefox)\b/.test(name)){description.push("masking as "+name+" "+version);name="IE";version="11.0";layout=["Trident"];os="Windows"}os=os&&format(os)}if(version&&(data=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(version)||/(?:alpha|beta)(?: ?\d)?/i.exec(ua+";"+(useFeatures&&nav.appMinorVersion))||/\bMinefield\b/i.test(ua)&&"a")){prerelease=/b/i.test(data)?"beta":"alpha";version=version.replace(RegExp(data+"\\+?$"),"")+(prerelease=="beta"?beta:alpha)+(/\d+\+?/.exec(data)||"")}if(name=="Fennec"||name=="Firefox"&&/\b(?:Android|Firefox OS)\b/.test(os)){name="Firefox Mobile"}else if(name=="Maxthon"&&version){version=version.replace(/\.[\d.]+/,".x")}else if(/\bXbox\b/i.test(product)){if(product=="Xbox 360"){os=null}if(product=="Xbox 360"&&/\bIEMobile\b/.test(ua)){description.unshift("mobile mode")}}else if((/^(?:Chrome|IE|Opera)$/.test(name)||name&&!product&&!/Browser|Mobi/.test(name))&&(os=="Windows CE"||/Mobi/i.test(ua))){name+=" Mobile"}else if(name=="IE"&&useFeatures){try{if(context.external===null){description.unshift("platform preview")}}catch(e){description.unshift("embedded")}}else if((/\bBlackBerry\b/.test(product)||/\bBB10\b/.test(ua))&&(data=(RegExp(product.replace(/ +/g," *")+"/([.\\d]+)","i").exec(ua)||0)[1]||version)){data=[data,/BB10/.test(ua)];os=(data[1]?(product=null,manufacturer="BlackBerry"):"Device Software")+" "+data[0];version=null}else if(this!=forOwn&&product!="Wii"&&(useFeatures&&opera||/Opera/.test(name)&&/\b(?:MSIE|Firefox)\b/i.test(ua)||name=="Firefox"&&/\bOS X (?:\d+\.){2,}/.test(os)||name=="IE"&&(os&&!/^Win/.test(os)&&version>5.5||/\bWindows XP\b/.test(os)&&version>8||version==8&&!/\bTrident\b/.test(ua)))&&!reOpera.test(data=parse.call(forOwn,ua.replace(reOpera,"")+";"))&&data.name){data="ing as "+data.name+((data=data.version)?" "+data:"");if(reOpera.test(name)){if(/\bIE\b/.test(data)&&os=="Mac OS"){os=null}data="identify"+data}else{data="mask"+data;if(operaClass){name=format(operaClass.replace(/([a-z])([A-Z])/g,"$1 $2"))}else{name="Opera"}if(/\bIE\b/.test(data)){os=null}if(!useFeatures){version=null}}layout=["Presto"];description.push(data)}if(data=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(ua)||0)[1]){data=[parseFloat(data.replace(/\.(\d)$/,".0$1")),data];if(name=="Safari"&&data[1].slice(-1)=="+"){name="WebKit Nightly";prerelease="alpha";version=data[1].slice(0,-1)}else if(version==data[1]||version==(data[2]=(/\bSafari\/([\d.]+\+?)/i.exec(ua)||0)[1])){version=null}data[1]=(/\bChrome\/([\d.]+)/i.exec(ua)||0)[1];if(data[0]==537.36&&data[2]==537.36&&parseFloat(data[1])>=28&&layout=="WebKit"){layout=["Blink"]}if(!useFeatures||!likeChrome&&!data[1]){layout&&(layout[1]="like Safari");data=(data=data[0],data<400?1:data<500?2:data<526?3:data<533?4:data<534?"4+":data<535?5:data<537?6:data<538?7:data<601?8:"8")}else{layout&&(layout[1]="like Chrome");data=data[1]||(data=data[0],data<530?1:data<532?2:data<532.05?3:data<533?4:data<534.03?5:data<534.07?6:data<534.1?7:data<534.13?8:data<534.16?9:data<534.24?10:data<534.3?11:data<535.01?12:data<535.02?"13+":data<535.07?15:data<535.11?16:data<535.19?17:data<536.05?18:data<536.1?19:data<537.01?20:data<537.11?"21+":data<537.13?23:data<537.18?24:data<537.24?25:data<537.36?26:layout!="Blink"?"27":"28")}layout&&(layout[1]+=" "+(data+=typeof data=="number"?".x":/[.+]/.test(data)?"":"+"));if(name=="Safari"&&(!version||parseInt(version)>45)){version=data}}if(name=="Opera"&&(data=/\bzbov|zvav$/.exec(os))){name+=" ";description.unshift("desktop mode");if(data=="zvav"){name+="Mini";version=null}else{name+="Mobile"}os=os.replace(RegExp(" *"+data+"$"),"")}else if(name=="Safari"&&/\bChrome\b/.exec(layout&&layout[1])){description.unshift("desktop mode");name="Chrome Mobile";version=null;if(/\bOS X\b/.test(os)){manufacturer="Apple";os="iOS 4.3+"}else{os=null}}if(version&&version.indexOf(data=/[\d.]+$/.exec(os))==0&&ua.indexOf("/"+data+"-")>-1){os=trim(os.replace(data,""))}if(layout&&!/\b(?:Avant|Nook)\b/.test(name)&&(/Browser|Lunascape|Maxthon/.test(name)||name!="Safari"&&/^iOS/.test(os)&&/\bSafari\b/.test(layout[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(name)&&layout[1])){(data=layout[layout.length-1])&&description.push(data)}if(description.length){description=["("+description.join("; ")+")"]}if(manufacturer&&product&&product.indexOf(manufacturer)<0){description.push("on "+manufacturer)}if(product){description.push((/^on /.test(description[description.length-1])?"":"on ")+product)}if(os){data=/ ([\d.+]+)$/.exec(os);isSpecialCasedOS=data&&os.charAt(os.length-data[0].length-1)=="/";os={architecture:32,family:data&&!isSpecialCasedOS?os.replace(data[0],""):os,version:data?data[1]:null,toString:function(){var version=this.version;return this.family+(version&&!isSpecialCasedOS?" "+version:"")+(this.architecture==64?" 64-bit":"")}}}if((data=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(arch))&&!/\bi686\b/i.test(arch)){if(os){os.architecture=64;os.family=os.family.replace(RegExp(" *"+data),"")}if(name&&(/\bWOW64\b/i.test(ua)||useFeatures&&/\w(?:86|32)$/.test(nav.cpuClass||nav.platform)&&!/\bWin64; x64\b/i.test(ua))){description.unshift("32-bit")}}else if(os&&/^OS X/.test(os.family)&&name=="Chrome"&&parseFloat(version)>=39){os.architecture=64}ua||(ua=null);var platform={};platform.description=ua;platform.layout=layout&&layout[0];platform.manufacturer=manufacturer;platform.name=name;platform.prerelease=prerelease;platform.product=product;platform.ua=ua;platform.version=name&&version;platform.os=os||{architecture:null,family:null,version:null,toString:function(){return"null"}};platform.parse=parse;platform.toString=toStringPlatform;if(platform.version){description.unshift(version)}if(platform.name){description.unshift(name)}if(os&&name&&!(os==String(os).split(" ")[0]&&(os==name.split(" ")[0]||product))){description.push(product?"("+os+")":"on "+os)}if(description.length){platform.description=description.join(" ")}return platform}var platform=parse();if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){root.platform=platform;define(function(){return platform})}else if(freeExports&&freeModule){forOwn(platform,function(value,key){freeExports[key]=value})}else{root.platform=platform}}).call(this);function buildIOSMeta(){var aMetaTags=[{name:"viewport",content:"width=device-width, height=device-height, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"},{name:"apple-mobile-web-app-capable",content:"yes"},{name:"apple-mobile-web-app-status-bar-style",content:"black"}];for(var i=0;i<aMetaTags.length;i++){var oNewMeta=document.createElement("meta");oNewMeta.name=aMetaTags[i].name;oNewMeta.content=aMetaTags[i].content;var oOldMeta=window.document.head.querySelector('meta[name="'+oNewMeta.name+'"]');if(oOldMeta){oOldMeta.parentNode.removeChild(oOldMeta)}window.document.head.appendChild(oNewMeta)}}function hideIOSFullscreenPanel(){jQuery(".xxx-ios-fullscreen-message").css("display","none");jQuery(".xxx-ios-fullscreen-scroll").css("display","none");jQuery(".xxx-game-iframe-full").removeClass("xxx-game-iframe-iphone-se")}function buildIOSFullscreenPanel(){var html="";html+='<div class="xxx-ios-fullscreen-message">';html+='<div class="xxx-ios-fullscreen-swipe">';html+="</div>";html+="</div>";html+='<div class="xxx-ios-fullscreen-scroll">';html+="</div>";jQuery("body").append(html)}function showIOSFullscreenPanel(){jQuery(".xxx-ios-fullscreen-message").css("display","block");jQuery(".xxx-ios-fullscreen-scroll").css("display","block")}function __iosResize(){window.scrollTo(0,0);console.log(window.devicePixelRatio);console.log(window.innerWidth);console.log(window.innerHeight);if(platform.product==="iPhone"){switch(window.devicePixelRatio){case 2:{switch(window.innerWidth){case 568:{if(window.innerHeight===320){}else{jQuery(".xxx-game-iframe-full").addClass("xxx-game-iframe-iphone-se")}}break;case 667:{if(window.innerHeight===375){hideIOSFullscreenPanel()}else{showIOSFullscreenPanel()}}break;case 808:{if(window.innerHeight===414){hideIOSFullscreenPanel()}else{showIOSFullscreenPanel()}}break;default:{hideIOSFullscreenPanel()}}}break;case 3:{switch(window.innerWidth){case 736:{if(window.innerHeight===414){hideIOSFullscreenPanel()}else{showIOSFullscreenPanel()}}break;case 724:{if(window.innerHeight===375){hideIOSFullscreenPanel()}else{showIOSFullscreenPanel()}}break;case 808:{if(window.innerHeight===414){hideIOSFullscreenPanel()}else{showIOSFullscreenPanel()}}break;default:{hideIOSFullscreenPanel()}}}break;default:{hideIOSFullscreenPanel()}}}}function iosResize(){__iosResize();setTimeout(function(){__iosResize()},500)}function iosInIframe(){try{return window.self!==window.top}catch(e){return true}}$(document).ready(function(){if(platform&&platform.product==="iPhone"&&platform.name.toLowerCase()!=="safari"&&!iosInIframe()){buildIOSFullscreenPanel();buildIOSMeta()}});jQuery(window).resize(function(){if(platform&&platform.product==="iPhone"&&platform.name.toLowerCase()!=="safari"&&!iosInIframe()){iosResize()}});CTLText.prototype={constructor:CTLText,__autofit:function(){if(this._bFitText){var iFontSize=this._iFontSize;while(this._oText.getBounds().height>this._iHeight-this._iPaddingV*2||this._oText.getBounds().width>this._iWidth-this._iPaddingH*2){iFontSize--;this._oText.font=iFontSize+"px "+this._szFont;this._oText.lineHeight=Math.round(iFontSize*this._fLineHeightFactor);this.__updateY();this.__verticalAlign();if(iFontSize<8){break}}this._iFontSize=iFontSize}},__verticalAlign:function(){if(this._bVerticalAlign){var iCurHeight=this._oText.getBounds().height;this._oText.y-=(iCurHeight-this._iHeight)/2+this._iPaddingV}},__updateY:function(){this._oText.y=this._y+this._iPaddingV;switch(this._oText.textBaseline){case"middle":{this._oText.y+=this._oText.lineHeight/2+(this._iFontSize*this._fLineHeightFactor-this._iFontSize)}break}},__createText:function(szMsg){if(this._bDebug){this._oDebugShape=new createjs.Shape;this._oDebugShape.graphics.beginFill("rgba(255,0,0,0.5)").drawRect(this._x,this._y,this._iWidth,this._iHeight);this._oContainer.addChild(this._oDebugShape)}this._oText=new createjs.Text(szMsg,this._iFontSize+"px "+this._szFont,this._szColor);this._oText.textBaseline="middle";this._oText.lineHeight=Math.round(this._iFontSize*this._fLineHeightFactor);this._oText.textAlign=this._szAlign;if(this._bMultiline){this._oText.lineWidth=this._iWidth-this._iPaddingH*2}else{this._oText.lineWidth=null}switch(this._szAlign){case"center":{this._oText.x=this._x+this._iWidth/2}break;case"left":{this._oText.x=this._x+this._iPaddingH}break;case"right":{this._oText.x=this._x+this._iWidth-this._iPaddingH}break}this._oContainer.addChild(this._oText);this.refreshText(szMsg)},setVerticalAlign:function(bVerticalAlign){this._bVerticalAlign=bVerticalAlign},setOutline:function(iSize){if(this._oText!==null){this._oText.outline=iSize}},setShadow:function(szColor,iOffsetX,iOffsetY,iBlur){if(this._oText!==null){this._oText.shadow=new createjs.Shadow(szColor,iOffsetX,iOffsetY,iBlur)}},setColor:function(szColor){this._oText.color=szColor},setAlpha:function(iAlpha){this._oText.alpha=iAlpha},removeTweens:function(){createjs.Tween.removeTweens(this._oText)},getText:function(){return this._oText},getY:function(){return this._y},getFontSize:function(){return this._iFontSize},refreshText:function(szMsg){if(szMsg===""){szMsg=" "}if(this._oText===null){this.__createText(szMsg)}this._oText.text=szMsg;this._oText.font=this._iFontSize+"px "+this._szFont;this._oText.lineHeight=Math.round(this._iFontSize*this._fLineHeightFactor);this.__autofit();this.__updateY();this.__verticalAlign()}};function CTLText(oContainer,x,y,iWidth,iHeight,iFontSize,szAlign,szColor,szFont,iLineHeightFactor,iPaddingH,iPaddingV,szMsg,bFitText,bVerticalAlign,bMultiline,bDebug){this._oContainer=oContainer;this._x=x;this._y=y;this._iWidth=iWidth;this._iHeight=iHeight;this._bMultiline=bMultiline;this._iFontSize=iFontSize;this._szAlign=szAlign;this._szColor=szColor;this._szFont=szFont;this._iPaddingH=iPaddingH;this._iPaddingV=iPaddingV;this._bVerticalAlign=bVerticalAlign;this._bFitText=bFitText;this._bDebug=bDebug;this._oDebugShape=null;this._fLineHeightFactor=iLineHeightFactor;this._oText=null;if(szMsg){this.__createText(szMsg)}}var s_iOffsetX=0;var s_iOffsetY=0;var s_fInverseScaling=0;(function(a){(jQuery.browser=jQuery.browser||{}).mobile=/android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(ad|hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|tablet|treo|up\.(browser|link)|vodafone|wap|webos|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))})(navigator.userAgent||navigator.vendor||window.opera);$(window).resize(function(){sizeHandler()});function trace(szMsg){console.log(szMsg)}function isIOS(){var iDevices=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];while(iDevices.length){if(navigator.platform===iDevices.pop()){s_bIsIphone=true;return true}}s_bIsIphone=false;return false}window.addEventListener("orientationchange",onOrientationChange);function onOrientationChange(){if(window.matchMedia("(orientation: portrait)").matches){sizeHandler()}if(window.matchMedia("(orientation: landscape)").matches){sizeHandler()}}function getSize(Name){var size;var name=Name.toLowerCase();var document=window.document;var documentElement=document.documentElement;if(window["inner"+Name]===undefined){size=documentElement["client"+Name]}else if(window["inner"+Name]!=documentElement["client"+Name]){var bodyElement=document.createElement("body");bodyElement.id="vpw-test-b";bodyElement.style.cssText="overflow:scroll";var divElement=document.createElement("div");divElement.id="vpw-test-d";divElement.style.cssText="position:absolute;top:-1000px";divElement.innerHTML="<style>@media("+name+":"+documentElement["client"+Name]+"px){body#vpw-test-b div#vpw-test-d{"+name+":7px!important}}</style>";bodyElement.appendChild(divElement);documentElement.insertBefore(bodyElement,document.head);if(divElement["offset"+Name]==7){size=documentElement["client"+Name]}else{size=window["inner"+Name]}documentElement.removeChild(bodyElement)}else{size=window["inner"+Name]}return size}function getIOSWindowHeight(){var zoomLevel=document.documentElement.clientWidth/window.innerWidth;return window.innerHeight*zoomLevel}function getHeightOfIOSToolbars(){var tH=(window.orientation===0?screen.height:screen.width)-getIOSWindowHeight();return tH>1?tH:0}function sizeHandler(){window.scrollTo(0,1);if(!$("#canvas")){return}var h;if(platform.name.toLowerCase()==="safari"){h=getIOSWindowHeight()}else{h=getSize("Height")}var w=getSize("Width");_checkOrientation(w,h);s_iScaleFactor=Math.min(h/CANVAS_HEIGHT,w/CANVAS_WIDTH);var destW=CANVAS_WIDTH*s_iScaleFactor;var destH=CANVAS_HEIGHT*s_iScaleFactor;var iAdd=0;if(destH<h){iAdd=h-destH;destH+=iAdd;destW+=iAdd*(CANVAS_WIDTH/CANVAS_HEIGHT)}else if(destW<w){iAdd=w-destW;destW+=iAdd;destH+=iAdd*(CANVAS_HEIGHT/CANVAS_WIDTH)}var fOffsetY=h/2-destH/2;var fOffsetX=w/2-destW/2;var fGameInverseScaling=CANVAS_WIDTH/destW;if(fOffsetX*fGameInverseScaling<-EDGEBOARD_X||fOffsetY*fGameInverseScaling<-EDGEBOARD_Y){s_iScaleFactor=Math.min(h/(CANVAS_HEIGHT-EDGEBOARD_Y*2),w/(CANVAS_WIDTH-EDGEBOARD_X*2));destW=CANVAS_WIDTH*s_iScaleFactor;destH=CANVAS_HEIGHT*s_iScaleFactor;fOffsetY=(h-destH)/2;fOffsetX=(w-destW)/2;fGameInverseScaling=CANVAS_WIDTH/destW}s_fInverseScaling=fGameInverseScaling;s_iOffsetX=-1*fOffsetX*fGameInverseScaling;s_iOffsetY=-1*fOffsetY*fGameInverseScaling;if(fOffsetY>=0){s_iOffsetY=0}if(fOffsetX>=0){s_iOffsetX=0}if(s_oInterface!==null){s_oInterface.refreshButtonPos(s_iOffsetX,s_iOffsetY)}if(s_oMenu!==null){s_oMenu.refreshButtonPos(s_iOffsetX,s_iOffsetY)}if(s_oLevelMenu!==null){s_oLevelMenu.refreshButtonPos()}if(s_oSelectMenu!==null){s_oSelectMenu.refreshButtonPos()}$("#canvas").css("width",destW+"px");$("#canvas").css("height",destH+"px");s_iCanvasOffsetHeight=fOffsetY;if(fOffsetY<0){$("#canvas").css("top",fOffsetY+"px")}else{fOffsetY=(h-destH)/2;$("#canvas").css("top",fOffsetY+"px")}$("#canvas").css("left",fOffsetX+"px");resizeCanvas3D();s_iCanvasResizeWidth=destW;s_iCanvasResizeHeight=destH;s_iCanvasOffsetWidth=fOffsetX;fullscreenHandler()}function _checkOrientation(iWidth,iHeight){if(s_bMobile&&ENABLE_CHECK_ORIENTATION){if(iWidth>iHeight){if($(".orientation-msg-container").attr("data-orientation")==="landscape"){$(".orientation-msg-container").css("display","none");s_oMain.startUpdate()}else{$(".orientation-msg-container").css("display","block");s_oMain.stopUpdate()}}else{if($(".orientation-msg-container").attr("data-orientation")==="portrait"){$(".orientation-msg-container").css("display","none");s_oMain.startUpdate()}else{$(".orientation-msg-container").css("display","block");s_oMain.stopUpdate()}}}}function saveItem(szItem,oValue){localStorage.setItem(szItem,oValue)}function getItem(szItem){return localStorage.getItem(szItem)}function createBitmap(oSprite,iWidthHitArea,iHeightHitArea){var oBmp=new createjs.Bitmap(oSprite);var hitObject=new createjs.Shape;if(iWidthHitArea&&iHeightHitArea){hitObject.graphics.beginFill("#fff").drawRect(-iWidthHitArea/2,-iHeightHitArea/2,iWidthHitArea,iHeightHitArea)}else{hitObject.graphics.beginFill("#ff0").drawRect(0,0,oSprite.width,oSprite.height)}oBmp.hitArea=hitObject;return oBmp}function createSprite(oSpriteSheet,szState,iRegX,iRegY,iWidth,iHeight){if(szState!==null){var oRetSprite=new createjs.Sprite(oSpriteSheet,szState)}else{var oRetSprite=new createjs.Sprite(oSpriteSheet)}var hitObject=new createjs.Shape;hitObject.graphics.beginFill("#000000").drawRect(-iRegX,-iRegY,iWidth,iHeight);oRetSprite.hitArea=hitObject;return oRetSprite}function randomFloatBetween(minValue,maxValue,precision){if(typeof precision==="undefined"){precision=2}return parseFloat(Math.min(minValue+Math.random()*(maxValue-minValue),maxValue).toFixed(precision))}function shuffle(array){var currentIndex=array.length,temporaryValue,randomIndex;while(0!==currentIndex){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex-=1;temporaryValue=array[currentIndex];array[currentIndex]=array[randomIndex];array[randomIndex]=temporaryValue}return array}function formatTime(iTime){iTime/=1e3;var iMins=Math.floor(iTime/60);var iSecs=iTime-iMins*60;iSecs=parseFloat(iSecs).toFixed(1);var szRet="";if(iMins<10){szRet+="0"+iMins+":"}else{szRet+=iMins+":"}if(iSecs<10){szRet+="0"+iSecs}else{szRet+=iSecs}return szRet}function degreesToRadians(iAngle){return iAngle*Math.PI/180}function checkRectCollision(bitmap1,bitmap2){var b1,b2;b1=getBounds(bitmap1,.9);b2=getBounds(bitmap2,.98);return calculateIntersection(b1,b2)}function calculateIntersection(rect1,rect2){var dx,dy,r1={},r2={};r1.cx=rect1.x+(r1.hw=rect1.width/2);r1.cy=rect1.y+(r1.hh=rect1.height/2);r2.cx=rect2.x+(r2.hw=rect2.width/2);r2.cy=rect2.y+(r2.hh=rect2.height/2);dx=Math.abs(r1.cx-r2.cx)-(r1.hw+r2.hw);dy=Math.abs(r1.cy-r2.cy)-(r1.hh+r2.hh);if(dx<0&&dy<0){dx=Math.min(Math.min(rect1.width,rect2.width),-dx);dy=Math.min(Math.min(rect1.height,rect2.height),-dy);return{x:Math.max(rect1.x,rect2.x),y:Math.max(rect1.y,rect2.y),width:dx,height:dy,rect1:rect1,rect2:rect2}}else{return null}}function getBounds(obj,iTolerance){var bounds={x:Infinity,y:Infinity,width:0,height:0};if(obj instanceof createjs.Container){bounds.x2=-Infinity;bounds.y2=-Infinity;var children=obj.children,l=children.length,cbounds,c;for(c=0;c<l;c++){cbounds=getBounds(children[c],1);if(cbounds.x<bounds.x)bounds.x=cbounds.x;if(cbounds.y<bounds.y)bounds.y=cbounds.y;if(cbounds.x+cbounds.width>bounds.x2)bounds.x2=cbounds.x+cbounds.width;if(cbounds.y+cbounds.height>bounds.y2)bounds.y2=cbounds.y+cbounds.height}if(bounds.x==Infinity)bounds.x=0;if(bounds.y==Infinity)bounds.y=0;if(bounds.x2==Infinity)bounds.x2=0;if(bounds.y2==Infinity)bounds.y2=0;bounds.width=bounds.x2-bounds.x;bounds.height=bounds.y2-bounds.y;delete bounds.x2;delete bounds.y2}else{var gp,gp2,gp3,gp4,imgr={},sr;if(obj instanceof createjs.Bitmap){sr=obj.sourceRect||obj.image;imgr.width=sr.width*iTolerance;imgr.height=sr.height*iTolerance}else if(obj instanceof createjs.Sprite){if(obj.spriteSheet._frames&&obj.spriteSheet._frames[obj.currentFrame]&&obj.spriteSheet._frames[obj.currentFrame].image){var cframe=obj.spriteSheet.getFrame(obj.currentFrame);imgr.width=cframe.rect.width;imgr.height=cframe.rect.height;imgr.regX=cframe.regX;imgr.regY=cframe.regY}else{bounds.x=obj.x||0;bounds.y=obj.y||0}}else{bounds.x=obj.x||0;bounds.y=obj.y||0}imgr.regX=imgr.regX||0;imgr.width=imgr.width||0;imgr.regY=imgr.regY||0;imgr.height=imgr.height||0;bounds.regX=imgr.regX;bounds.regY=imgr.regY;gp=obj.localToGlobal(0-imgr.regX,0-imgr.regY);gp2=obj.localToGlobal(imgr.width-imgr.regX,imgr.height-imgr.regY);gp3=obj.localToGlobal(imgr.width-imgr.regX,0-imgr.regY);gp4=obj.localToGlobal(0-imgr.regX,imgr.height-imgr.regY);bounds.x=Math.min(Math.min(Math.min(gp.x,gp2.x),gp3.x),gp4.x);bounds.y=Math.min(Math.min(Math.min(gp.y,gp2.y),gp3.y),gp4.y);bounds.width=Math.max(Math.max(Math.max(gp.x,gp2.x),gp3.x),gp4.x)-bounds.x;bounds.height=Math.max(Math.max(Math.max(gp.y,gp2.y),gp3.y),gp4.y)-bounds.y}return bounds}function NoClickDelay(el){this.element=el;if(window.Touch)this.element.addEventListener("touchstart",this,false)}NoClickDelay.prototype={handleEvent:function(e){switch(e.type){case"touchstart":this.onTouchStart(e);break;case"touchmove":this.onTouchMove(e);break;case"touchend":this.onTouchEnd(e);break}},onTouchStart:function(e){e.preventDefault();this.moved=false;this.element.addEventListener("touchmove",this,false);this.element.addEventListener("touchend",this,false)},onTouchMove:function(e){this.moved=true},onTouchEnd:function(e){this.element.removeEventListener("touchmove",this,false);this.element.removeEventListener("touchend",this,false);if(!this.moved){var theTarget=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY);if(theTarget.nodeType==3)theTarget=theTarget.parentNode;var theEvent=document.createEvent("MouseEvents");theEvent.initEvent("click",true,true);theTarget.dispatchEvent(theEvent)}}};(function(){var hidden="hidden";if(hidden in document)document.addEventListener("visibilitychange",onchange);else if((hidden="mozHidden")in document)document.addEventListener("mozvisibilitychange",onchange);else if((hidden="webkitHidden")in document)document.addEventListener("webkitvisibilitychange",onchange);else if((hidden="msHidden")in document)document.addEventListener("msvisibilitychange",onchange);else if("onfocusin"in document)document.onfocusin=document.onfocusout=onchange;else window.onpageshow=window.onpagehide=window.onfocus=window.onblur=onchange;function onchange(evt){var v="visible",h="hidden",evtMap={focus:v,focusin:v,pageshow:v,blur:h,focusout:h,pagehide:h};evt=evt||window.event;if(evt.type in evtMap){document.body.className=evtMap[evt.type]}else{document.body.className=this[hidden]?"hidden":"visible";if(document.body.className==="hidden"){s_oMain.stopUpdate()}else{s_oMain.startUpdate()}}}})();function playSound(szSound,iVolume,bLoop){if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){s_aSounds[szSound].play();s_aSounds[szSound].volume(iVolume);s_aSounds[szSound].loop(bLoop);return s_aSounds[szSound]}return null}function stopSound(szSound){if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){s_aSounds[szSound].stop()}}function setVolume(szSound,iVolume){if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){s_aSounds[szSound].volume(iVolume)}}function setMute(szSound,bMute){if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){s_aSounds[szSound].mute(bMute)}}function ctlArcadeResume(){if(s_oMain!==null){s_oMain.startUpdate()}}function ctlArcadePause(){if(s_oMain!==null){s_oMain.stopUpdate()}}function getParamValue(paramName){var url=window.location.search.substring(1);var qArray=url.split("&");for(var i=0;i<qArray.length;i++){var pArr=qArray[i].split("=");if(pArr[0]==paramName)return pArr[1]}}function normalize(o,len){if(len>0){o.x/=len;o.y/=len}return o}function length(o){return Math.sqrt(o.x*o.x+o.y*o.y)}function findNearestIntersectingObject(clientX,clientY,camera,objects){var SCREEN_WIDTH=CANVAS_RESIZE_WIDTH+OFFSET_WIDTH*2;var SCREEN_HEIGHT=CANVAS_RESIZE_HEIGHT+OFFSET_HEIGHT*2;var raycaster=new THREE.Raycaster;var mouse3D=new THREE.Vector3;mouse3D.x=clientX/SCREEN_WIDTH*2-1;mouse3D.y=-(clientY/SCREEN_HEIGHT)*2+1;mouse3D.z=.5;raycaster.setFromCamera(mouse3D,camera);var hits=raycaster.intersectObjects(objects,true);var closest=false;if(hits.length>0){closest=hits[0]}return closest}function distance(x1,y1,x2,y2){var iDx=x1-x2;var iDy=y1-y2;return Math.sqrt(iDx*iDx+iDy*iDy)}function distance2(x1,y1,x2,y2){var iDx=x1-x2;var iDy=y1-y2;return iDx*iDx+iDy*iDy}function resizeCanvas3D(){$("canvas").each(function(){if($(this).attr("id")=="#canvas"){return}$(this).css("width",$("#canvas").css("width"));$(this).css("height",$("#canvas").css("height"));$(this).css("position",$("#canvas").css("position"));$(this).css("left",$("#canvas").css("left"));$(this).css("top",$("#canvas").css("top"))})}function createOrthoGraphicCamera(){var oCamera=new THREE.PerspectiveCamera(FOV,CANVAS_WIDTH/CANVAS_HEIGHT,NEAR,FAR);if(s_iCurState===GOALKEEPER_MODE){oCamera.rotation.x=84*(Math.PI/180);oCamera.position.set(0,0,3)}else{oCamera.rotation.x=88.6*(Math.PI/180);oCamera.rotation.y=.03*(Math.PI/180);oCamera.position.set(CAMERA_POSITION.x,CAMERA_POSITION.y,CAMERA_POSITION.z)}oCamera.updateProjectionMatrix();oCamera.updateMatrixWorld();return oCamera}function rotateVector2D(iAngle,o){var iX=o.x*Math.cos(iAngle)+o.y*Math.sin(iAngle);var iY=o.x*-Math.sin(iAngle)+o.y*Math.cos(iAngle);return{x:iX,y:iY,z:0}}Math.radians=function(degrees){return degrees*Math.PI/180};Math.degrees=function(radians){return radians*180/Math.PI};function distanceV3(x1,y1,z1,x2,y2,z2){var iDx=x1-x2;var iDy=y1-y2;var iDz=z1-z2;return Math.sqrt(iDx*iDx+iDy*iDy+iDz*iDz)}function distanceV2(v1,v2){var iDx=v1.x-v2.x;var iDy=v1.y-v2.y;return Math.sqrt(iDx*iDx+iDy*iDy)}function clearAllItem(){localStorage.clear()}function fullscreenHandler(){if(!ENABLE_FULLSCREEN||screenfull.enabled===false){return}s_bFullscreen=screenfull.isFullscreen;if(s_oInterface!==null){s_oInterface.resetFullscreenBut()}if(s_oMenu!==null){s_oMenu.resetFullscreenBut()}if(s_oLevelMenu!==null){s_oLevelMenu.resetFullscreenBut()}if(s_oSelectMenu!==null){s_oSelectMenu.resetFullscreenBut()}}if(screenfull.enabled){screenfull.on("change",function(){s_bFullscreen=screenfull.isFullscreen;if(s_oInterface!==null){s_oInterface.resetFullscreenBut()}if(s_oMenu!==null){s_oMenu.resetFullscreenBut()}if(s_oLevelMenu!==null){s_oLevelMenu.resetFullscreenBut()}if(s_oSelectMenu!==null){s_oSelectMenu.resetFullscreenBut()}})}function CSpriteLibrary(){var _oLibSprites={};var _oSpritesToLoad;var _iNumSprites;var _iCntSprites;var _cbCompleted;var _cbTotalCompleted;var _cbOwner;this.init=function(cbCompleted,cbTotalCompleted,cbOwner){_oSpritesToLoad={};_iNumSprites=0;_iCntSprites=0;_cbCompleted=cbCompleted;_cbTotalCompleted=cbTotalCompleted;_cbOwner=cbOwner};this.addSprite=function(szKey,szPath){if(_oLibSprites.hasOwnProperty(szKey)){return}var oImage=new Image;_oLibSprites[szKey]=_oSpritesToLoad[szKey]={szPath:szPath,oSprite:oImage,bLoaded:false};_iNumSprites++};this.getSprite=function(szKey){if(!_oLibSprites.hasOwnProperty(szKey)){return null}else{return _oLibSprites[szKey].oSprite}};this._onSpritesLoaded=function(){_iNumSprites=0;_cbTotalCompleted.call(_cbOwner)};this._onSpriteLoaded=function(){_cbCompleted.call(_cbOwner);if(++_iCntSprites===_iNumSprites){this._onSpritesLoaded()}};this.loadSprites=function(){for(var szKey in _oSpritesToLoad){_oSpritesToLoad[szKey].oSprite["oSpriteLibrary"]=this;_oSpritesToLoad[szKey].oSprite["szKey"]=szKey;_oSpritesToLoad[szKey].oSprite.onload=function(){this.oSpriteLibrary.setLoaded(this.szKey);this.oSpriteLibrary._onSpriteLoaded(this.szKey)};_oSpritesToLoad[szKey].oSprite.onerror=function(evt){var oSpriteToRestore=evt.currentTarget;setTimeout(function(){_oSpritesToLoad[oSpriteToRestore.szKey].oSprite.src=_oSpritesToLoad[oSpriteToRestore.szKey].szPath},500)};_oSpritesToLoad[szKey].oSprite.src=_oSpritesToLoad[szKey].szPath}};this.setLoaded=function(szKey){_oLibSprites[szKey].bLoaded=true};this.isLoaded=function(szKey){return _oLibSprites[szKey].bLoaded};this.getNumSprites=function(){return _iNumSprites}}var CANVAS_WIDTH=1280;var CANVAS_HEIGHT=640;var CANVAS_WIDTH_HALF=CANVAS_WIDTH/2;var CANVAS_HEIGHT_HALF=CANVAS_HEIGHT/2;var START_HAND_SWIPE_POS;var END_HAND_SWIPE_POS;var EDGEBOARD_X=100;var EDGEBOARD_Y=40;var DISABLE_SOUND_MOBILE=false;var PRIMARY_FONT="TradeGothic";var SECONDARY_FONT="arialbold";var FPS=30;var FPS_DESKTOP=60;var FPS_TIME=1/FPS;var SOUNDTRACK_VOLUME_IN_GAME=0;var ROLL_BALL_RATE=60/FPS;var STATE_LOADING=0;var STATE_MENU=1;var STATE_HELP=2;var STATE_CHOOSE_LEVEL=3;var STATE_CHOOSE_TEAM=4;var STATE_GAME=5;var ON_MOUSE_DOWN=0;var ON_MOUSE_UP=1;var ON_MOUSE_OVER=2;var ON_MOUSE_OUT=3;var ON_DRAG_START=4;var ON_DRAG_END=5;var ON_TWEEN_ENDED=6;var ON_BUT_NO_DOWN=7;var ON_BUT_YES_DOWN=8;var ON_ALERT_SKIP=9;var STEP_RATE=1.5;var TEXT_SIZE=[80,100,130];var MS_TIME_SWIPE_END=1e3;var MS_TIME_SWIPE_START=3e3;var MS_TIME_FADE_HELP_TEXT=500;var TEXT_EXCELLENT_COLOR=["#fff","#5d96fe"];var TEXT_COLOR="#ffffff";var TEXT_COLOR_1="#ff2222";var OUTLINE_WIDTH=1.5;var TIME_INTERVAL_STROBE=.2;var PHYSICS_ACCURACY=3;var MOBILE_OFFSET_GLOVES_Y=-70;var BALL_VELOCITY_MULTIPLIER=1;var PHYSICS_STEP=1/(FPS*STEP_RATE);var MS_WAIT_SHOW_GAME_OVER_PANEL=250;var STATE_INIT=0;var STATE_PLAY=1;var STATE_FINISH=2;var STATE_PAUSE=3;var IDLE=0;var RIGHT=1;var LEFT=2;var CENTER_DOWN=3;var CENTER_UP=4;var LEFT_DOWN=5;var RIGHT_DOWN=6;var ANIM_GOAL_KEEPER_FAIL=[LEFT,RIGHT,CENTER_DOWN,CENTER_UP,LEFT_DOWN,RIGHT_DOWN];var ANIM_GOAL_KEEPER_FAIL_ALT=[LEFT,RIGHT,LEFT_DOWN,RIGHT_DOWN];var NUM_SPRITE_PLAYER=31;var SPRITE_NAME_GOALKEEPER=["gk_idle_","gk_save_right_","gk_save_left_","gk_save_center_down_","gk_save_center_up_","gk_save_down_left_","gk_save_down_right_"];var NUM_SPRITE_GOALKEEPER=[24,34,34,51,25,34,34];var OFFSET_CONTAINER_GOALKEEPER=[{x:0,y:0},{x:15,y:-29},{x:-360,y:-29},{x:-15,y:-15},{x:-20,y:-85},{x:-355,y:20},{x:21,y:20}];var BALL_MASS=.5;var BALL_LINEAR_DAMPING=.2;var OBJECT;var TIME_TRY_TO_SHOT_BALL_OPPONENT=.7;var START_POS_FLAG={x:277,y:268};var FLAG_ADDED_POS={x:61,y:69};var FLAG_LIMIT_POS_X=690;var TOT_TEAM=32;var MIN_BALL_VEL_ROTATION=.1;var SHOOT_FRAME=7;var HAND_KEEPER_ANGLE_RATE=.15;var TIME_POLE_COLLISION_RESET=1e3;var LIMIT_HAND_RANGE_POS={x:20,zMax:7,zMin:-8.5};var LEFT_RIGHT_WALL_GOAL_SIZE;var NUM_AREA_GOAL={h:3,w:5};var AREA_GOALS_ANIM=[LEFT,LEFT,CENTER_UP,RIGHT,RIGHT,LEFT,LEFT,CENTER_UP,RIGHT,RIGHT,LEFT_DOWN,LEFT_DOWN,CENTER_DOWN,RIGHT_DOWN,RIGHT_DOWN];var BUFFER_ANIM_PLAYER=FPS;var MS_EFFECT_ADD=1500;var MS_ROLLING_SCORE=500;var MAX_PERCENT_PROBABILITY=100;var GOAL_KEEPER_TOLLERANCE_LEFT=-4;var GOAL_KEEPER_TOLLERANCE_RIGHT=4;var TIME_RESET_AFTER_BALL_OUT=250;var TIME_RESET_AFTER_SAVE=500;var AREA_GOAL_PROPERTIES={width:4,depth:1,height:2.4};var POLE_RIGHT_LEFT_SIZE;var COLOR_AREA_GOAL=[16711680,65280,255,16776960,16711935,65535,15790320,986895,16759705,16777215,5675280,10083618,1056896,8392736,9017449];var OFFSET_FIELD_Y=35;var OFFSET_FIELD_X=35;var FORCE_RATE=.0014;var FORCE_MULTIPLIER_AXIS={x:.12,y:.4,z:.08};var FORCE_MAX=.5;var FIELD_POSITION;var MAX_FORCE_Y=66;var MIN_FORCE_Y=50;var CALCULATE_PROBABILITY=[{xMax:-7,xMin:-11,zMax:11,zMin:8},{xMax:-3.6,xMin:-7,zMax:11,zMin:8},{xMax:3.6,xMin:-3.6,zMax:11,zMin:8},{xMax:7,xMin:3.6,zMax:11,zMin:8},{xMax:11,xMin:7,zMax:11,zMin:8},{xMax:-7,xMin:-7,zMax:8,zMin:5},{xMax:-3.6,xMin:-7,zMax:8,zMin:5},{xMax:3.6,xMin:-3.6,zMax:8,zMin:5},{xMax:7,xMin:3.6,zMax:8,zMin:5},{xMax:11,xMin:7,zMax:8,zMin:5},{xMax:-7,xMin:-11,zMax:5,zMin:0},{xMax:-3.6,xMin:-7,zMax:5,zMin:0},{xMax:3.6,xMin:-3.6,zMax:5,zMin:0},{xMax:7,xMin:3.6,zMax:5,zMin:0},{xMax:11,xMin:7,zMax:5,zMin:0}];var SHOW_AREAS_GOAL=false;var SHOW_3D_RENDER=false;var CANVAS_3D_OPACITY=.5;var CAMERA_TEST_TRACKBALL=false;var CAMERA_TEST_TRANSFORM=false;var MOUSE_SENSIBILTY=.03;var CAMERA_TEST_LOOK_AT={x:0,y:-500,z:-100};var BALL_SCALE_FACTOR=.007;var SHADOWN_FACTOR=1.1;var FORCE_BALL_DISPLAY_SHOCK=[{max:55,min:MIN_FORCE_Y-1},{max:58,min:55},{max:62,min:58},{max:MAX_FORCE_Y,min:62}];var GOALKEEPER_MODE=0;var STRIKER_MODE=1;var ENABLE_FULLSCREEN;var ENABLE_CHECK_ORIENTATION;var NUM_MATCHES=10;var OFFSET_BALL_POS_X=10;var HAND_KEEPER_SIZE={width:1.8,depth:.5,height:1.5};var HAND_KEEPER_POSITION={x:0,y:36,z:0};var CAMERA_TEST=false;var BALL_Z_FORCE_RANGE={min:3,max:10};var GOAL_POSITION={x:0,y:33,z:-2.7};var TIME_RESET_AFTER_KEEPER_SAVED=2;var TIME_RESET_AFTER_PERFECT_KEEPER_SAVED=3;var TIME_BALL_IN_HAND=1e3;var NUM_KICKS=10;var BALL_FORCE_X=[8,6,7,8,9,10,7,12,10,12];var BALL_FORCE_Z=[{min:1,max:8},{min:5,max:9},{min:3,max:9},{min:1,max:8},{min:2,max:8},{min:4,max:8},{min:3,max:9},{min:1,max:10},{min:5,max:8},{min:5,max:10.5}];var BALL_FORCE_Y=[60,40,50,60,65,60,70,64,68,65];var BALL_SAVED_POINT={x:.7,z:.6};var GOAL_SCORED;var GOAL_MISSED;var GOAL_SAVED;var GOAL_SUFFERED;var LOCALSTORAGE_STRING=["penalty_challenge_"];var TEXT_COLOR_STROKE;var BALL_RADIUS;var TIME_RESET_AFTER_GOAL;var BACK_WALL_GOAL_SIZE;var UP_WALL_GOAL_SIZE;var BACK_WALL_GOAL_POSITION;var GOAL_LINE_POS;var GOAL_SPRITE_SWAP_Y;var GOAL_SPRITE_SWAP_Z;var FIRST_AREA_GOAL_POS;var GOAL_KEEPER_DEPTH_Y;var BALL_OUT_Y;var POSITION_BALL;var POLE_UP_SIZE;var HIT_BALL_MAX_FORCE;var HIT_BALL_MIN_FORCE;var INTENSITY_DISPLAY_SHOCK;var CAMERA_POSITION;var FOV;var NEAR;var FAR;function refreshSettings(iMode){if(iMode===GOALKEEPER_MODE){TEXT_COLOR_STROKE="#000000";BALL_RADIUS=1;TIME_RESET_AFTER_GOAL=1;BACK_WALL_GOAL_SIZE={width:21,depth:.1,height:11};UP_WALL_GOAL_SIZE={width:21,depth:25,height:.1};POLE_RIGHT_LEFT_SIZE={radius_top:.5,radius_bottom:.5,height:21.5,segments:10};BACK_WALL_GOAL_POSITION={x:0,y:8,z:-2.7};GOAL_LINE_POS={x:0,y:31,z:-2.7};POSITION_BALL={x:0,y:125,z:-9};POLE_UP_SIZE={radius_top:.5,radius_bottom:.5,height:42,segments:10};LEFT_RIGHT_WALL_GOAL_SIZE={width:.1,depth:25,height:11};HIT_BALL_MAX_FORCE=100;HIT_BALL_MIN_FORCE=.01;INTENSITY_DISPLAY_SHOCK=[{x:30,y:20,time:75},{x:50,y:25,time:75},{x:70,y:30,time:75},{x:90,y:40,time:75}];CAMERA_POSITION={x:0,y:0,z:100};FOV=45;NEAR=10;FAR=2e3}else{TEXT_COLOR_STROKE="#002a59";BALL_RADIUS=.68;TIME_RESET_AFTER_GOAL=1e3;BACK_WALL_GOAL_SIZE={width:20.5,depth:1,height:7.5};UP_WALL_GOAL_SIZE={width:20.5,depth:25,height:.1};BACK_WALL_GOAL_POSITION={x:0,y:155,z:-2.7};GOAL_LINE_POS={x:0,y:BACK_WALL_GOAL_POSITION.y-UP_WALL_GOAL_SIZE.depth+2,z:BACK_WALL_GOAL_POSITION.z};POSITION_BALL={x:.05,y:15.4,z:-9+BALL_RADIUS};POLE_UP_SIZE={radius_top:.5,radius_bottom:.5,height:40.5,segments:10};POLE_RIGHT_LEFT_SIZE={radius_top:.5,radius_bottom:.5,height:15,segments:10};LEFT_RIGHT_WALL_GOAL_SIZE={width:.1,depth:25,height:7.5};HIT_BALL_MAX_FORCE=130;HIT_BALL_MIN_FORCE=5;INTENSITY_DISPLAY_SHOCK=[{x:10,y:7.5,time:50},{x:20,y:9,time:50},{x:30,y:12,time:50},{x:33,y:15,time:50}];CAMERA_POSITION={x:0,y:0,z:-7};FOV=15;NEAR=1;FAR=2e3}GOAL_SPRITE_SWAP_Y=GOAL_LINE_POS.y;GOAL_SPRITE_SWAP_Z=BACK_WALL_GOAL_POSITION.z+LEFT_RIGHT_WALL_GOAL_SIZE.height;FIRST_AREA_GOAL_POS={x:-14-AREA_GOAL_PROPERTIES.width*.5,y:BACK_WALL_GOAL_POSITION.y-UP_WALL_GOAL_SIZE.depth+1.1,z:3.1-AREA_GOAL_PROPERTIES.height*.5};BALL_OUT_Y=BACK_WALL_GOAL_POSITION.y+3;GOAL_KEEPER_DEPTH_Y=BACK_WALL_GOAL_POSITION.y-UP_WALL_GOAL_SIZE.depth;START_HAND_SWIPE_POS={x:CANVAS_WIDTH_HALF,y:CANVAS_HEIGHT_HALF+200};END_HAND_SWIPE_POS=[{x:CANVAS_WIDTH_HALF-250,y:CANVAS_HEIGHT_HALF-200},{x:CANVAS_WIDTH_HALF,y:CANVAS_HEIGHT_HALF-200},{x:CANVAS_WIDTH_HALF+250,y:CANVAS_HEIGHT_HALF-200}]}var TEXT_PRELOADER_CONTINUE="COMENZAR";var TEXT_MULTIPLIER="x";var TEXT_SCORE="PUNTAJE";var TEXT_LEVEL_SCORE="PUNTAJE DE NIVEL";var TEXT_TIME="TIEMPO";var TEXT_TOTAL="PUNTAJE TOTAL";var TEXT_GOAL="¡GOL!";var TEXT_ARE_SURE="¿ESTÁS SEGURO QUE QUIERES SALIR DEL JUEGO?";var TEXT_CONFIRM_DELETE="¡TODO TU PROGRESO SERA BORRADO! ¿ESTÁS SEGURO?";var TEXT_SAVED="¡BUENA ATAJADA!";var TEXT_MISSED="¡FALLASTE!";var TEXT_HELP="ARRASTRAR PARA PATEAR";var TEXT_HELP_KEEPER="DA CLICK EN LA PANTALLA PARA QUE HYUNDAI TIRE";var TEXT_WIN="GRACIAS POR PARTICIPAR";var TEXT_LOSE="PERDISTE";var TEXT_CREDITS_DEVELOPED="DESARROLLADO POR";var TEXT_VS="VS";var TEXT_MATCH="NIVEL";var TEXT_SELECT_TEAM="SELECCIONE SU EQUIPO";var TEXT_MATCHES="NIVELES";var TEXT_ERR_LS="SU NAVEGADOR WEB NO SOPORTA EL ALMACENAIMIENTO DEL JUEGO. SI UTILIZA SAFARI, PUEDE SER QUE LO HAYA ABIERTO EN UNA VENTANA PRIVADA. COMO RESULTADO, PUEDE QUE ALGUNA INFORMACIÓN O CARACTERÍSTICA NO ESTE DISPONIBLE.";var TEXT_TEAM=new Array;TEXT_TEAM[0]="RUSSIA";TEXT_TEAM[1]="HYUNDAI";TEXT_TEAM[2]="IRAN";TEXT_TEAM[3]="CHELSEA";TEXT_TEAM[4]="MEXICO";TEXT_TEAM[5]="BELGIUM";TEXT_TEAM[6]="SOUTH KOREA";TEXT_TEAM[7]="SAUDI ARABIA";TEXT_TEAM[8]="GERMANY";TEXT_TEAM[9]="ENGLAND";TEXT_TEAM[10]="SPAIN";TEXT_TEAM[11]="NIGERIA";TEXT_TEAM[12]="COSTA RICA";TEXT_TEAM[13]="POLAND";TEXT_TEAM[14]="EGYPT";TEXT_TEAM[15]="SERBIA";TEXT_TEAM[16]="ICELAND";TEXT_TEAM[17]="FRANCE";TEXT_TEAM[18]="PORTUGAL";TEXT_TEAM[19]="URUGUAY";TEXT_TEAM[20]="ARGENTINA";TEXT_TEAM[21]="COLOMBIA";TEXT_TEAM[22]="PANAMA";TEXT_TEAM[23]="SENEGAL";TEXT_TEAM[24]="MOROCCO";TEXT_TEAM[25]="TUNISIA";TEXT_TEAM[26]="SWITZERLAND";TEXT_TEAM[27]="CROATIA";TEXT_TEAM[28]="SWEDEN";TEXT_TEAM[29]="DENMARK";TEXT_TEAM[30]="AUSTRALIA";TEXT_TEAM[31]="PERU";var TEXT_SHARE_IMAGE="200x200.jpg";var TEXT_SHARE_TITLE="¡Felicidades!";var TEXT_SHARE_MSG1="Lograste <strong>";var TEXT_SHARE_MSG2=" Puntos</strong>!<br><br>¡Compartelo con tus amigos!";var TEXT_SHARE_SHARE1="Mi puntaje es ";var TEXT_SHARE_SHARE2=" puntos! ¿Puedes mejorarlo?";function CPreloader(){var _iMaskWidth;var _iMaskHeight;var _oLoadingText;var _oProgressBar;var _oMaskPreloader;var _oFade;var _oIcon;var _oIconMask;var _oButStart;var _oContainer;this._init=function(){s_oSpriteLibrary.init(this._onImagesLoaded,this._onAllImagesLoaded,this);s_oSpriteLibrary.addSprite("progress_bar","./sprites/progress_bar.png");s_oSpriteLibrary.addSprite("200x200","./sprites/200x200.jpg");s_oSpriteLibrary.addSprite("but_start","./sprites/but_start.png");s_oSpriteLibrary.addSprite("bg_preloader","./sprites/bg_preloader.jpg");s_oSpriteLibrary.loadSprites();_oContainer=new createjs.Container;s_oStage.addChild(_oContainer)};this.unload=function(){_oContainer.removeAllChildren();_oButStart.unload()};this._onImagesLoaded=function(){};this._onAllImagesLoaded=function(){this.attachSprites();s_oMain.preloaderReady()};this.attachSprites=function(){var oBgImage=createBitmap(s_oSpriteLibrary.getSprite("bg_preloader"));s_oStage.addChild(oBgImage);_oContainer.addChild(oBgImage);var oSprite=s_oSpriteLibrary.getSprite("progress_bar");_oProgressBar=createBitmap(oSprite);_oProgressBar.x=CANVAS_WIDTH/2-oSprite.width/2;_oProgressBar.y=CANVAS_HEIGHT/2+50;_oContainer.addChild(_oProgressBar);_iMaskWidth=oSprite.width;_iMaskHeight=oSprite.height;_oMaskPreloader=new createjs.Shape;_oMaskPreloader.graphics.beginFill("rgba(0,0,0,0.01)").drawRect(_oProgressBar.x,_oProgressBar.y,1,_iMaskHeight);_oContainer.addChild(_oMaskPreloader);_oProgressBar.mask=_oMaskPreloader;_oLoadingText=new createjs.Text("","30px "+PRIMARY_FONT,"#fff");_oLoadingText.x=CANVAS_WIDTH/2;_oLoadingText.y=CANVAS_HEIGHT/2+100;_oLoadingText.textBaseline="alphabetic";_oLoadingText.textAlign="center";_oContainer.addChild(_oLoadingText);var oSprite=s_oSpriteLibrary.getSprite("but_start");_oButStart=new CTextButton(CANVAS_WIDTH/2,CANVAS_HEIGHT/2,oSprite,TEXT_PRELOADER_CONTINUE,"Arial","#000",40,_oContainer);_oButStart.addEventListener(ON_MOUSE_UP,this._onButStartRelease,this);_oButStart.setVisible(false);_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oContainer.addChild(_oFade);createjs.Tween.get(_oFade).to({alpha:0},500).call(function(){createjs.Tween.removeTweens(_oFade);_oContainer.removeChild(_oFade)})};this._onButStartRelease=function(){s_oMain._onRemovePreloader()};this.refreshLoader=function(iPerc){_oLoadingText.text=iPerc+"%";if(iPerc===100){s_oMain._onRemovePreloader();_oButStart.setVisible(false);_oLoadingText.visible=false;_oProgressBar.visible=false}_oMaskPreloader.graphics.clear();var iNewMaskWidth=Math.floor(iPerc*_iMaskWidth/100);_oMaskPreloader.graphics.beginFill("rgba(0,0,0,0.01)").drawRect(_oProgressBar.x,_oProgressBar.y,iNewMaskWidth,_iMaskHeight)};this._init()}function CMain(oData){var _bUpdate;var _iCurResource=0;var RESOURCE_TO_LOAD=0;var _iState=STATE_LOADING;var _oData;var _oPreloader;var _oMenu;var _oHelp;var _oLevelMenu;var _oSelectMenu;var _oGame;this.initContainer=function(){s_oCanvas=document.getElementById("canvas");s_oStage=new createjs.Stage(canvas);createjs.Touch.enable(s_oStage);s_oStage.preventSelection=false;s_bMobile=jQuery.browser.mobile;if(s_bMobile===false){s_oStage.enableMouseOver(20);$("body").on("contextmenu","#canvas",function(e){return false});FPS=FPS_DESKTOP;FPS_TIME=1/FPS;PHYSICS_STEP=1/(FPS*STEP_RATE);ROLL_BALL_RATE=60/FPS}else{BALL_VELOCITY_MULTIPLIER=.8}s_iPrevTime=(new Date).getTime();createjs.Ticker.addEventListener("tick",this._update);createjs.Ticker.framerate=FPS;if(navigator.userAgent.match(/Windows Phone/i)){DISABLE_SOUND_MOBILE=true}s_oSpriteLibrary=new CSpriteLibrary;_oPreloader=new CPreloader;_bUpdate=true};this.soundLoaded=function(){_iCurResource++;var iPerc=Math.floor(_iCurResource/RESOURCE_TO_LOAD*100);_oPreloader.refreshLoader(iPerc)};this._initSounds=function(){Howler.mute(!s_bAudioActive);s_aSoundsInfo=new Array;s_aSoundsInfo.push({path:"./sounds/",filename:"drop_bounce_grass",loop:false,volume:1,ingamename:"drop_bounce_grass"});s_aSoundsInfo.push({path:"./sounds/",filename:"click",loop:false,volume:1,ingamename:"click"});s_aSoundsInfo.push({path:"./sounds/",filename:"kick",loop:false,volume:1,ingamename:"kick"});s_aSoundsInfo.push({path:"./sounds/",filename:"ball_saved",loop:false,volume:1,ingamename:"ball_saved"});s_aSoundsInfo.push({path:"./sounds/",filename:"goal_keeper",loop:false,volume:1,ingamename:"goal_keeper"});s_aSoundsInfo.push({path:"./sounds/",filename:"goal_striker",loop:false,volume:1,ingamename:"goal_striker"});s_aSoundsInfo.push({path:"./sounds/",filename:"keep_ball",loop:false,volume:1,ingamename:"keep_ball"});s_aSoundsInfo.push({path:"./sounds/",filename:"pole",loop:false,volume:1,ingamename:"pole"});s_aSoundsInfo.push({path:"./sounds/",filename:"win",loop:false,volume:1,ingamename:"win"});s_aSoundsInfo.push({path:"./sounds/",filename:"soundtrack",loop:true,volume:1,ingamename:"soundtrack"});s_aSoundsInfo.push({path:"./sounds/",filename:"crowd",loop:true,volume:1,ingamename:"crowd"});RESOURCE_TO_LOAD+=s_aSoundsInfo.length;s_aSounds=new Array;for(var i=0;i<s_aSoundsInfo.length;i++){this.tryToLoadSound(s_aSoundsInfo[i],false)}};this.tryToLoadSound=function(oSoundInfo,bDelay){setTimeout(function(){s_aSounds[oSoundInfo.ingamename]=new Howl({src:[oSoundInfo.path+oSoundInfo.filename+".mp3"],autoplay:false,preload:true,loop:oSoundInfo.loop,volume:oSoundInfo.volume,onload:s_oMain.soundLoaded,onloaderror:function(szId,szMsg){for(var i=0;i<s_aSoundsInfo.length;i++){if(szId===s_aSounds[s_aSoundsInfo[i].ingamename]._sounds[0]._id){s_oMain.tryToLoadSound(s_aSoundsInfo[i],true);break}}},onplayerror:function(szId){for(var i=0;i<s_aSoundsInfo.length;i++){if(szId===s_aSounds[s_aSoundsInfo[i].ingamename]._sounds[0]._id){s_aSounds[s_aSoundsInfo[i].ingamename].once("unlock",function(){s_aSounds[s_aSoundsInfo[i].ingamename].play();if(s_aSoundsInfo[i].ingamename==="soundtrack"&&s_oGame!==null){setVolume("soundtrack",SOUNDTRACK_VOLUME_IN_GAME)}});break}}}})},bDelay?200:0)};this._loadImages=function(){s_oSpriteLibrary.init(this._onImagesLoaded,this._onAllImagesLoaded,this);s_oSpriteLibrary.addSprite("bg_menu","./sprites/bg_menu.jpg");s_oSpriteLibrary.addSprite("but_play","./sprites/but_play.png");s_oSpriteLibrary.addSprite("audio_icon","./sprites/audio_icon.png");s_oSpriteLibrary.addSprite("but_fullscreen","./sprites/but_fullscreen.png");s_oSpriteLibrary.addSprite("ball","./sprites/ball.png");s_oSpriteLibrary.addSprite("ball_shadow","./sprites/ball_shadow.png");s_oSpriteLibrary.addSprite("start_ball","./sprites/start_ball.png");s_oSpriteLibrary.addSprite("hand_touch","./sprites/hand_touch.png");s_oSpriteLibrary.addSprite("cursor","./sprites/cursor.png");s_oSpriteLibrary.addSprite("msg_box","./sprites/msg_box.png");s_oSpriteLibrary.addSprite("msg_box_small","./sprites/msg_box_small.png");s_oSpriteLibrary.addSprite("bg_levelselect","./sprites/bg_levelselect.jpg");s_oSpriteLibrary.addSprite("but_level","./sprites/but_level.png");s_oSpriteLibrary.addSprite("but_info","./sprites/but_info.png");s_oSpriteLibrary.addSprite("logo_ctl","./sprites/logo_ctl.png");s_oSpriteLibrary.addSprite("but_exit","./sprites/but_exit.png");s_oSpriteLibrary.addSprite("but_yes","./sprites/but_yes.png");s_oSpriteLibrary.addSprite("but_no","./sprites/but_no.png");s_oSpriteLibrary.addSprite("but_level_locked","./sprites/but_level_locked.png");s_oSpriteLibrary.addSprite("but_next","./sprites/but_next.png");s_oSpriteLibrary.addSprite("but_restart","./sprites/but_restart.png");s_oSpriteLibrary.addSprite("but_home","./sprites/but_home.png");s_oSpriteLibrary.addSprite("but_delete_savings","./sprites/but_delete_savings.png");s_oSpriteLibrary.addSprite("ball_kick","./sprites/ball_kick.png");s_oSpriteLibrary.addSprite("score_side_bg","./sprites/score_side_bg.png");for(var k=0;k<NUM_TEAMS;k++){s_oSpriteLibrary.addSprite("flag_"+k,"./sprites/flags/flag_"+k+".png")}s_oSpriteLibrary.addSprite("bg_game_striker","./sprites/striker/bg_game_striker.jpg");s_oSpriteLibrary.addSprite("goal_0","./sprites/striker/goal_0.png");for(var t=0;t<22;t++){for(var s=0;s<31;s++){s_oSpriteLibrary.addSprite("player_"+t+"_"+s,"./sprites/striker/player/player_"+t+"_"+s+".png")}}for(var k=0;k<2;k++){for(var i=0;i<24;i++){s_oSpriteLibrary.addSprite("gk_idle_"+k+"_"+i,"./sprites/striker/gk_idle_"+k+"_"+i+".png")}for(var i=0;i<51;i++){s_oSpriteLibrary.addSprite("gk_save_center_down_"+k+"_"+i,"./sprites/striker/gk_save_center_down_"+k+"_"+i+".png")}for(var i=0;i<25;i++){s_oSpriteLibrary.addSprite("gk_save_center_up_"+k+"_"+i,"./sprites/striker/gk_save_center_up_"+k+"_"+i+".png")}for(var i=0;i<34;i++){s_oSpriteLibrary.addSprite("gk_save_down_left_"+k+"_"+i,"./sprites/striker/gk_save_down_left_"+k+"_"+i+".png")}for(var i=0;i<34;i++){s_oSpriteLibrary.addSprite("gk_save_down_right_"+k+"_"+i,"./sprites/striker/gk_save_down_right_"+k+"_"+i+".png")}for(var i=0;i<42;i++){s_oSpriteLibrary.addSprite("gk_save_left_"+k+"_"+i,"./sprites/striker/gk_save_left_"+k+"_"+i+".png")}for(var i=0;i<42;i++){s_oSpriteLibrary.addSprite("gk_save_right_"+k+"_"+i,"./sprites/striker/gk_save_right_"+k+"_"+i+".png")}}s_oSpriteLibrary.addSprite("bg_game_gk","./sprites/goalkeeper/bg_game_gk.jpg");s_oSpriteLibrary.addSprite("gloves","./sprites/goalkeeper/gloves.png");s_oSpriteLibrary.addSprite("goal_1","./sprites/goalkeeper/goal_1.png");s_oSpriteLibrary.addSprite("help_mouse","./sprites/goalkeeper/help_mouse.png");s_oSpriteLibrary.addSprite("help_touch","./sprites/goalkeeper/help_touch.png");for(var k=0;k<NUM_TEAMS;k++){s_oSpriteLibrary.addSprite("opponent_"+k,"./sprites/goalkeeper/opponent_"+k+".png")}RESOURCE_TO_LOAD+=s_oSpriteLibrary.getNumSprites();s_oSpriteLibrary.loadSprites()};this._onImagesLoaded=function(){_iCurResource++;var iPerc=Math.floor(_iCurResource/RESOURCE_TO_LOAD*100);_oPreloader.refreshLoader(iPerc)};this._onAllImagesLoaded=function(){};this.preloaderReady=function(){_iCurResource=0;if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){this._initSounds()}this._loadImages();_bUpdate=true};this._onRemovePreloader=function(){_oPreloader.unload();s_bStorageAvailable=false;this.gotoMenu();s_oSoundtrack=playSound("soundtrack",1,true)};this.saveMatch=function(iMatch,iOpponent,szResult,iLevelScore,iScore){saveItem(LOCALSTORAGE_STRING+"match_"+iMatch,JSON.stringify({opponent:iOpponent,result:szResult,score:iScore,level_score:iLevelScore}))};this.saveTeam=function(iTeam){s_iTeamSelected=iTeam;saveItem(LOCALSTORAGE_STRING+"team",s_iTeamSelected)};this.saveLevel=function(iLevel){s_iLastLevel=iLevel;saveItem(LOCALSTORAGE_STRING+"level",s_iLastLevel)};this.getStoredTeamSelected=function(){return getItem(LOCALSTORAGE_STRING+"team")};this.getMatches=function(){if(getItem(LOCALSTORAGE_STRING+"match_1")===null){return null}else{var aMatches=new Array;for(var i=1;i<NUM_MATCHES+1;i++){aMatches.push(JSON.parse(getItem(LOCALSTORAGE_STRING+"match_"+i)))}return aMatches}};this.getLastLevel=function(){var iLevel=getItem(LOCALSTORAGE_STRING+"level");if(iLevel===null){return 1}else{return iLevel}};this.getScoreMatch=function(iLevel){var oItem=getItem(LOCALSTORAGE_STRING+"match_"+iLevel);return JSON.parse(oItem).level_score};this.getScoreTillLevel=function(iLevel){if(!s_bStorageAvailable){return 0}var iScore=0;for(var i=0;i<iLevel-1;i++){iScore+=this.getScoreMatch(i+1)}return iScore};this.gotoMenu=function(){_oMenu=new CMenu;_iState=STATE_MENU};this.gotoLevelPanel=function(){_oLevelMenu=new CLevelMenu;_iState=STATE_CHOOSE_LEVEL};this.gotoSelectTeam=function(){_oSelectMenu=new CSelectTeamMenu;_iState=STATE_CHOOSE_TEAM};this.gotoGame=function(iLevel){_oGame=new CGame(_oData,iLevel);_iState=STATE_GAME};this.gotoHelp=function(){_oHelp=new CHelp;_iState=STATE_HELP};this.stopUpdateNoBlock=function(){_bUpdate=false;createjs.Ticker.paused=true};this.startUpdateNoBlock=function(){s_iPrevTime=(new Date).getTime();_bUpdate=true;createjs.Ticker.paused=false};this.stopUpdate=function(){_bUpdate=false;createjs.Ticker.paused=true;$("#block_game").css("display","block");if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){Howler.mute(true)}};this.startUpdate=function(){s_iPrevTime=(new Date).getTime();_bUpdate=true;createjs.Ticker.paused=false;$("#block_game").css("display","none");if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){if(s_bAudioActive){Howler.mute(false)}}};this._update=function(event){if(_bUpdate===false){return}var iCurTime=(new Date).getTime();s_iTimeElaps=iCurTime-s_iPrevTime;s_iCntTime+=s_iTimeElaps;s_iCntFps++;s_iPrevTime=iCurTime;if(s_iCntTime>=1e3){s_iCurFps=s_iCntFps;s_iCntTime-=1e3;s_iCntFps=0}if(_iState===STATE_GAME){_oGame.update()}s_oStage.update(event)};s_oMain=this;_oData=oData;ENABLE_FULLSCREEN=oData.fullscreen;ENABLE_CHECK_ORIENTATION=oData.check_orientation;this.initContainer()}var s_bMobile;var s_bAudioActive=true;var s_bFullscreen=false;var s_iCntTime=0;var s_iTimeElaps=0;var s_iPrevTime=0;var s_iCntFps=0;var s_iCurFps=0;var s_oPhysicsController;var s_iCanvasResizeHeight;var s_iCanvasResizeWidth;var s_iCanvasOffsetHeight;var s_iCanvasOffsetWidth;var s_oDrawLayer;var s_oStage;var s_oCanvas;var s_oMain;var s_oSpriteLibrary;var s_oSoundTrack=null;var s_iLastLevel=1;var s_iTeamSelected;var s_aSounds;var s_aSoundsInfo;var s_bStorageAvailable=true;function CTextButton(iXPos,iYPos,oSprite,szText,szFont,szColor,iFontSize,oParentContainer){var _bDisable;var _iCurScale;var _iWidth;var _iHeight;var _aCbCompleted;var _aCbOwner;var _oListenerDown;var _oListenerUp;var _oParams;var _oButton;var _oText;var _oButtonBg;var _oParentContainer=oParentContainer;this._init=function(iXPos,iYPos,oSprite,szText,szFont,szColor,iFontSize){_bDisable=false;_iCurScale=1;_aCbCompleted=new Array;_aCbOwner=new Array;_oButtonBg=createBitmap(oSprite);_iWidth=oSprite.width;_iHeight=oSprite.height;_oButton=new createjs.Container;_oButton.x=iXPos;_oButton.y=iYPos;_oButton.regX=oSprite.width/2;_oButton.regY=oSprite.height/2;if(!s_bMobile){_oButton.cursor="pointer"}_oButton.addChild(_oButtonBg,_oText);_oParentContainer.addChild(_oButton);_oText=new CTLText(_oButton,40,0,oSprite.width-80,oSprite.height,iFontSize,"center",szColor,szFont,1,2,2,szText,true,true,false,false);this._initListener()};this.unload=function(){_oButton.off("mousedown",_oListenerDown);_oButton.off("pressup",_oListenerUp);_oParentContainer.removeChild(_oButton)};this.setVisible=function(bVisible){_oButton.visible=bVisible};this.setAlign=function(szAlign){_oText.textAlign=szAlign};this.setTextX=function(iX){_oText.x=iX};this.setScale=function(iScale){_oButton.scaleX=_oButton.scaleY=iScale;_iCurScale=iScale};this.enable=function(){_bDisable=false};this.disable=function(){_bDisable=true};this._initListener=function(){_oListenerDown=_oButton.on("mousedown",this.buttonDown);_oListenerUp=_oButton.on("pressup",this.buttonRelease)};this.addEventListener=function(iEvent,cbCompleted,cbOwner){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner};this.addEventListenerWithParams=function(iEvent,cbCompleted,cbOwner,oParams){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner;_oParams=oParams};this.buttonRelease=function(){if(_bDisable){return}playSound("but_click",1,false);_oButton.scaleX=_iCurScale;_oButton.scaleY=_iCurScale;if(_aCbCompleted[ON_MOUSE_UP]){_aCbCompleted[ON_MOUSE_UP].call(_aCbOwner[ON_MOUSE_UP],_oParams)}};this.buttonDown=function(){if(_bDisable){return}_oButton.scaleX=_iCurScale*.9;_oButton.scaleY=_iCurScale*.9;if(_aCbCompleted[ON_MOUSE_DOWN]){_aCbCompleted[ON_MOUSE_DOWN].call(_aCbOwner[ON_MOUSE_DOWN])}};this.setPosition=function(iXPos,iYPos){_oButton.x=iXPos;_oButton.y=iYPos};this.tweenPosition=function(iXPos,iYPos,iTime,iDelay,oEase,oCallback,oCallOwner){createjs.Tween.get(_oButton).wait(iDelay).to({x:iXPos,y:iYPos},iTime,oEase).call(function(){if(oCallback!==undefined){oCallback.call(oCallOwner)}})};this.changeText=function(szText){_oText.refreshText(szText)};this.setX=function(iXPos){_oButton.x=iXPos};this.setY=function(iYPos){_oButton.y=iYPos};this.getButtonImage=function(){return _oButton};this.getX=function(){return _oButton.x};this.getY=function(){return _oButton.y};this.getSprite=function(){return _oButton};this.getScale=function(){return _oButton.scaleX};this._init(iXPos,iYPos,oSprite,szText,szFont,szColor,iFontSize)}function CToggle(iXPos,iYPos,oSprite,bActive,oParentContainer){var _bActive;var _aCbCompleted;var _aCbOwner;var _oButton;var _oParentContainer;this._init=function(iXPos,iYPos,oSprite,bActive,oParentContainer){if(oParentContainer!==undefined){_oParentContainer=oParentContainer}else{_oParentContainer=s_oStage}_aCbCompleted=new Array;_aCbOwner=new Array;var oData={images:[oSprite],frames:{width:oSprite.width/2,height:oSprite.height,regX:oSprite.width/2/2,regY:oSprite.height/2},animations:{state_true:[0],state_false:[1]}};var oSpriteSheet=new createjs.SpriteSheet(oData);_bActive=bActive;_oButton=createSprite(oSpriteSheet,"state_"+_bActive,oSprite.width/2/2,oSprite.height/2,oSprite.width/2,oSprite.height);_oButton.x=iXPos;_oButton.y=iYPos;_oButton.stop();if(!s_bMobile)_oButton.cursor="pointer";_oParentContainer.addChild(_oButton);this._initListener()};this.unload=function(){_oButton.off("mousedown",this.buttonDown);_oButton.off("pressup",this.buttonRelease);_oParentContainer.removeChild(_oButton)};this._initListener=function(){_oButton.on("mousedown",this.buttonDown);_oButton.on("pressup",this.buttonRelease)};this.addEventListener=function(iEvent,cbCompleted,cbOwner){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner};this.setCursorType=function(szValue){_oButton.cursor=szValue};this.setActive=function(bActive){_bActive=bActive;_oButton.gotoAndStop("state_"+_bActive)};this.buttonRelease=function(){_oButton.scaleX=1;_oButton.scaleY=1;playSound("click",1,false);_bActive=!_bActive;_oButton.gotoAndStop("state_"+_bActive);if(_aCbCompleted[ON_MOUSE_UP]){_aCbCompleted[ON_MOUSE_UP].call(_aCbOwner[ON_MOUSE_UP],_bActive)}};this.buttonDown=function(){_oButton.scaleX=.9;_oButton.scaleY=.9;if(_aCbCompleted[ON_MOUSE_DOWN]){_aCbCompleted[ON_MOUSE_DOWN].call(_aCbOwner[ON_MOUSE_DOWN])}};this.setPosition=function(iX,iY){_oButton.x=iX;_oButton.y=iY};this._init(iXPos,iYPos,oSprite,bActive,oParentContainer)}function CGfxButton(iXPos,iYPos,oSprite,oParentContainer){var _aCbCompleted;var _aCbOwner;var _oButton;var _aParams;var _fScaleX;var _fScaleY;var _oParent;var _oTween;var _bBlock=false;var _oParentContainer;this._init=function(iXPos,iYPos,oSprite){_aCbCompleted=new Array;_aCbOwner=new Array;_aParams=new Array;_oButton=createBitmap(oSprite);_oButton.x=iXPos;_oButton.y=iYPos;_fScaleX=1;_fScaleY=1;_oButton.regX=oSprite.width/2;_oButton.regY=oSprite.height/2;if(!s_bMobile)_oButton.cursor="pointer";_oParentContainer.addChild(_oButton);this._initListener()};this.unload=function(){_oButton.off("mousedown",this.buttonDown);_oButton.off("pressup",this.buttonRelease);_oParentContainer.removeChild(_oButton)};this.setVisible=function(bVisible){_oButton.visible=bVisible};this.setCursorType=function(szValue){_oButton.cursor=szValue};this._initListener=function(){_oButton.on("mousedown",this.buttonDown);_oButton.on("pressup",this.buttonRelease)};this.addEventListener=function(iEvent,cbCompleted,cbOwner){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner};this.addEventListenerWithParams=function(iEvent,cbCompleted,cbOwner,aParams){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner;_aParams[iEvent]=aParams};this.buttonRelease=function(){if(_bBlock){return}if(_fScaleX>0){_oButton.scaleX=1}else{_oButton.scaleX=-1}_oButton.scaleY=1;playSound("click",1,false);if(_aCbCompleted[ON_MOUSE_UP]){_aCbCompleted[ON_MOUSE_UP].call(_aCbOwner[ON_MOUSE_UP],_aParams[ON_MOUSE_UP])}};this.buttonDown=function(){if(_bBlock){return}if(_fScaleX>0){_oButton.scaleX=.9}else{_oButton.scaleX=-.9}_oButton.scaleY=.9;if(_aCbCompleted[ON_MOUSE_DOWN]){_aCbCompleted[ON_MOUSE_DOWN].call(_aCbOwner[ON_MOUSE_DOWN],_aParams[ON_MOUSE_DOWN])}};this.rotation=function(iRotation){_oButton.rotation=iRotation};this.getButton=function(){return _oButton};this.setPosition=function(iXPos,iYPos){_oButton.x=iXPos;_oButton.y=iYPos};this.setX=function(iXPos){_oButton.x=iXPos};this.setY=function(iYPos){_oButton.y=iYPos};this.getButtonImage=function(){return _oButton};this.block=function(bVal){_bBlock=bVal;_oButton.scaleX=_fScaleX;_oButton.scaleY=_fScaleY};this.setScaleX=function(fValue){_oButton.scaleX=fValue;_fScaleX=fValue};this.getX=function(){return _oButton.x};this.getY=function(){return _oButton.y};this.pulseAnimation=function(){_oTween=createjs.Tween.get(_oButton).to({scaleX:_fScaleX*.9,scaleY:_fScaleY*.9},850,createjs.Ease.quadOut).to({scaleX:_fScaleX,scaleY:_fScaleY},650,createjs.Ease.quadIn).call(function(){_oParent.pulseAnimation()})};this.trebleAnimation=function(){_oTween=createjs.Tween.get(_oButton).to({rotation:5},75,createjs.Ease.quadOut).to({rotation:-5},140,createjs.Ease.quadIn).to({rotation:0},75,createjs.Ease.quadIn).wait(750).call(function(){_oParent.trebleAnimation()})};this.removeAllTweens=function(){createjs.Tween.removeTweens(_oButton)};if(oParentContainer!==undefined){_oParentContainer=oParentContainer}else{_oParentContainer=s_oStage}this._init(iXPos,iYPos,oSprite);_oParent=this;return this}function CMenu(){var _pStartPosAudio;var _pStartPosPlay;var _pStartPosInfo;var _pStartPosFullscreen;var _pStartPosDelete;var _oBg;var _oButPlay;var _oButInfo;var _oButDeleteSavings;var _oAreYouSurePanel;var _oFade;var _oAudioToggle;var _oButFullscreen;var _fRequestFullScreen=null;var _fCancelFullScreen=null;var _level=1;var _hyundai=1;this._init=function(){_oBg=createBitmap(s_oSpriteLibrary.getSprite("bg_menu"));s_oStage.addChild(_oBg);var oSprite=s_oSpriteLibrary.getSprite("but_play");_pStartPosPlay={x:CANVAS_WIDTH/2+280,y:CANVAS_HEIGHT-130};_oButPlay=new CGfxButton(_pStartPosPlay.x,_pStartPosPlay.y,oSprite);_oButPlay.addEventListener(ON_MOUSE_UP,this._onButPlayRelease,this);_oButPlay.pulseAnimation();if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){var oSprite=s_oSpriteLibrary.getSprite("audio_icon");_pStartPosAudio={x:CANVAS_WIDTH-oSprite.height/2-10,y:oSprite.height/2+10};_oAudioToggle=new CToggle(_pStartPosAudio.x,_pStartPosAudio.y,oSprite,s_bAudioActive);_oAudioToggle.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this)}var doc=window.document;var docEl=doc.documentElement;_fRequestFullScreen=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;_fCancelFullScreen=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;if(ENABLE_FULLSCREEN===false){_fRequestFullScreen=false}if(_fRequestFullScreen&&screenfull.enabled){oSprite=s_oSpriteLibrary.getSprite("but_fullscreen");_pStartPosFullscreen={x:oSprite.height/2+10,y:oSprite.height/2+10};_oButFullscreen=new CToggle(_pStartPosFullscreen.x,_pStartPosFullscreen.y,oSprite,s_bFullscreen,s_oStage);_oButFullscreen.addEventListener(ON_MOUSE_UP,this._onFullscreenRelease,this)}_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);s_oStage.addChild(_oFade);createjs.Tween.get(_oFade).to({alpha:0},1e3).call(function(){_oFade.visible=false});if(!s_bStorageAvailable){}this.refreshButtonPos(s_iOffsetX,s_iOffsetY)};this.refreshButtonPos=function(iNewX,iNewY){if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.setPosition(_pStartPosAudio.x-iNewX,iNewY+_pStartPosAudio.y)}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setPosition(_pStartPosFullscreen.x+iNewX,_pStartPosFullscreen.y+iNewY)}};this.unload=function(){_oButPlay.unload();_oButPlay=null;if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.unload();_oAudioToggle=null}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.unload()}s_oStage.removeAllChildren();s_oMenu=null};this._onButPlayRelease=function(){this.unload();s_iTeamSelected=3;s_iLastLevel=_level;this._extractMatches();if(s_oSpriteLibrary.getSprite("player_"+TEAM_INFO[s_iTeamSelected].player+"_0")===null){s_oSpriteLibrary.init(function(){},this._onAllImagesLoaded,this);for(var i=0;i<31;i++){s_oSpriteLibrary.addSprite("player_"+TEAM_INFO[s_iTeamSelected].player+"_"+i,"./sprites/striker/player/player_"+TEAM_INFO[s_iTeamSelected].player+"_"+i+".png")}_iCurResources=0;_iTotResources=s_oSpriteLibrary.getNumSprites();s_oSpriteLibrary.loadSprites()}else{s_oMain.gotoGame(_level)}};this._extractMatches=function(){s_aMatches=new Array;_aResults=new Array;s_aMatches=[_hyundai]};this._onAllImagesLoaded=function(){s_oLevelMenu.unload();s_oMain.gotoGame(_level)};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=!s_bAudioActive};this._onButInfoRelease=function(){new CCreditsPanel};this.resetFullscreenBut=function(){if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setActive(s_bFullscreen)}};this._onFullscreenRelease=function(){if(s_bFullscreen){_fCancelFullScreen.call(window.document)}else{_fRequestFullScreen.call(window.document.documentElement)}sizeHandler()};this._onDeleteSavings=function(){_oAreYouSurePanel.show(TEXT_CONFIRM_DELETE)};this._onConfirmDelete=function(){s_iLastLevel=1;clearAllItem()};s_oMenu=this;this._init()}var s_oMenu=null;!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&false)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.CANNON=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){module.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(_dereq_,module,exports){module.exports={version:_dereq_("../package.json").version,AABB:_dereq_("./collision/AABB"),ArrayCollisionMatrix:_dereq_("./collision/ArrayCollisionMatrix"),Body:_dereq_("./objects/Body"),Box:_dereq_("./shapes/Box"),Broadphase:_dereq_("./collision/Broadphase"),Constraint:_dereq_("./constraints/Constraint"),ContactEquation:_dereq_("./equations/ContactEquation"),Narrowphase:_dereq_("./world/Narrowphase"),ConeTwistConstraint:_dereq_("./constraints/ConeTwistConstraint"),ContactMaterial:_dereq_("./material/ContactMaterial"),ConvexPolyhedron:_dereq_("./shapes/ConvexPolyhedron"),Cylinder:_dereq_("./shapes/Cylinder"),DistanceConstraint:_dereq_("./constraints/DistanceConstraint"),Equation:_dereq_("./equations/Equation"),EventTarget:_dereq_("./utils/EventTarget"),FrictionEquation:_dereq_("./equations/FrictionEquation"),GSSolver:_dereq_("./solver/GSSolver"),GridBroadphase:_dereq_("./collision/GridBroadphase"),Heightfield:_dereq_("./shapes/Heightfield"),HingeConstraint:_dereq_("./constraints/HingeConstraint"),LockConstraint:_dereq_("./constraints/LockConstraint"),Mat3:_dereq_("./math/Mat3"),Material:_dereq_("./material/Material"),NaiveBroadphase:_dereq_("./collision/NaiveBroadphase"),ObjectCollisionMatrix:_dereq_("./collision/ObjectCollisionMatrix"),Pool:_dereq_("./utils/Pool"),Particle:_dereq_("./shapes/Particle"),Plane:_dereq_("./shapes/Plane"),PointToPointConstraint:_dereq_("./constraints/PointToPointConstraint"),Quaternion:_dereq_("./math/Quaternion"),Ray:_dereq_("./collision/Ray"),RaycastVehicle:_dereq_("./objects/RaycastVehicle"),RaycastResult:_dereq_("./collision/RaycastResult"),RigidVehicle:_dereq_("./objects/RigidVehicle"),RotationalEquation:_dereq_("./equations/RotationalEquation"),RotationalMotorEquation:_dereq_("./equations/RotationalMotorEquation"),SAPBroadphase:_dereq_("./collision/SAPBroadphase"),SPHSystem:_dereq_("./objects/SPHSystem"),Shape:_dereq_("./shapes/Shape"),Solver:_dereq_("./solver/Solver"),Sphere:_dereq_("./shapes/Sphere"),SplitSolver:_dereq_("./solver/SplitSolver"),Spring:_dereq_("./objects/Spring"),Trimesh:_dereq_("./shapes/Trimesh"),Vec3:_dereq_("./math/Vec3"),Vec3Pool:_dereq_("./utils/Vec3Pool"),World:_dereq_("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");var Utils=_dereq_("../utils/Utils");module.exports=AABB;function AABB(options){options=options||{};this.lowerBound=new Vec3;if(options.lowerBound){this.lowerBound.copy(options.lowerBound)}this.upperBound=new Vec3;if(options.upperBound){this.upperBound.copy(options.upperBound)}}var tmp=new Vec3;AABB.prototype.setFromPoints=function(points,position,quaternion,skinSize){var l=this.lowerBound,u=this.upperBound,q=quaternion;l.copy(points[0]);if(q){q.vmult(l,l)}u.copy(l);for(var i=1;i<points.length;i++){var p=points[i];if(q){q.vmult(p,tmp);p=tmp}if(p.x>u.x){u.x=p.x}if(p.x<l.x){l.x=p.x}if(p.y>u.y){u.y=p.y}if(p.y<l.y){l.y=p.y}if(p.z>u.z){u.z=p.z}if(p.z<l.z){l.z=p.z}}if(position){position.vadd(l,l);position.vadd(u,u)}if(skinSize){l.x-=skinSize;l.y-=skinSize;l.z-=skinSize;u.x+=skinSize;u.y+=skinSize;u.z+=skinSize}return this};AABB.prototype.copy=function(aabb){this.lowerBound.copy(aabb.lowerBound);this.upperBound.copy(aabb.upperBound);return this};AABB.prototype.clone=function(){return(new AABB).copy(this)};AABB.prototype.extend=function(aabb){var l=aabb.lowerBound.x;if(this.lowerBound.x>l){this.lowerBound.x=l}var u=aabb.upperBound.x;if(this.upperBound.x<u){this.upperBound.x=u}var l=aabb.lowerBound.y;if(this.lowerBound.y>l){this.lowerBound.y=l}var u=aabb.upperBound.y;if(this.upperBound.y<u){this.upperBound.y=u}var l=aabb.lowerBound.z;if(this.lowerBound.z>l){this.lowerBound.z=l}var u=aabb.upperBound.z;if(this.upperBound.z<u){this.upperBound.z=u}};AABB.prototype.overlaps=function(aabb){var l1=this.lowerBound,u1=this.upperBound,l2=aabb.lowerBound,u2=aabb.upperBound;return(l2.x<=u1.x&&u1.x<=u2.x||l1.x<=u2.x&&u2.x<=u1.x)&&(l2.y<=u1.y&&u1.y<=u2.y||l1.y<=u2.y&&u2.y<=u1.y)&&(l2.z<=u1.z&&u1.z<=u2.z||l1.z<=u2.z&&u2.z<=u1.z)};AABB.prototype.contains=function(aabb){var l1=this.lowerBound,u1=this.upperBound,l2=aabb.lowerBound,u2=aabb.upperBound;return l1.x<=l2.x&&u1.x>=u2.x&&(l1.y<=l2.y&&u1.y>=u2.y)&&(l1.z<=l2.z&&u1.z>=u2.z)};AABB.prototype.getCorners=function(a,b,c,d,e,f,g,h){var l=this.lowerBound,u=this.upperBound;a.copy(l);b.set(u.x,l.y,l.z);c.set(u.x,u.y,l.z);d.set(l.x,u.y,u.z);e.set(u.x,l.y,l.z);f.set(l.x,u.y,l.z);g.set(l.x,l.y,u.z);h.copy(u)};var transformIntoFrame_corners=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];AABB.prototype.toLocalFrame=function(frame,target){var corners=transformIntoFrame_corners;var a=corners[0];var b=corners[1];var c=corners[2];var d=corners[3];var e=corners[4];var f=corners[5];var g=corners[6];var h=corners[7];this.getCorners(a,b,c,d,e,f,g,h);for(var i=0;i!==8;i++){var corner=corners[i];frame.pointToLocal(corner,corner)}return target.setFromPoints(corners)};AABB.prototype.toWorldFrame=function(frame,target){var corners=transformIntoFrame_corners;var a=corners[0];var b=corners[1];var c=corners[2];var d=corners[3];var e=corners[4];var f=corners[5];var g=corners[6];var h=corners[7];this.getCorners(a,b,c,d,e,f,g,h);for(var i=0;i!==8;i++){var corner=corners[i];frame.pointToWorld(corner,corner)}return target.setFromPoints(corners)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(_dereq_,module,exports){module.exports=ArrayCollisionMatrix;function ArrayCollisionMatrix(){this.matrix=[]}ArrayCollisionMatrix.prototype.get=function(i,j){i=i.index;j=j.index;if(j>i){var temp=j;j=i;i=temp}return this.matrix[(i*(i+1)>>1)+j-1]};ArrayCollisionMatrix.prototype.set=function(i,j,value){i=i.index;j=j.index;if(j>i){var temp=j;j=i;i=temp}this.matrix[(i*(i+1)>>1)+j-1]=value?1:0};ArrayCollisionMatrix.prototype.reset=function(){for(var i=0,l=this.matrix.length;i!==l;i++){this.matrix[i]=0}};ArrayCollisionMatrix.prototype.setNumObjects=function(n){this.matrix.length=n*(n-1)>>1}},{}],5:[function(_dereq_,module,exports){var Body=_dereq_("../objects/Body");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Shape=_dereq_("../shapes/Shape");var Plane=_dereq_("../shapes/Plane");module.exports=Broadphase;function Broadphase(){this.world=null;this.useBoundingBoxes=false;this.dirty=true}Broadphase.prototype.collisionPairs=function(world,p1,p2){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var Broadphase_needBroadphaseCollision_STATIC_OR_KINEMATIC=Body.STATIC|Body.KINEMATIC;Broadphase.prototype.needBroadphaseCollision=function(bodyA,bodyB){if((bodyA.collisionFilterGroup&bodyB.collisionFilterMask)===0||(bodyB.collisionFilterGroup&bodyA.collisionFilterMask)===0){return false}if(((bodyA.type&Broadphase_needBroadphaseCollision_STATIC_OR_KINEMATIC)!==0||bodyA.sleepState===Body.SLEEPING)&&((bodyB.type&Broadphase_needBroadphaseCollision_STATIC_OR_KINEMATIC)!==0||bodyB.sleepState===Body.SLEEPING)){return false}return true};Broadphase.prototype.intersectionTest=function(bodyA,bodyB,pairs1,pairs2){if(this.useBoundingBoxes){this.doBoundingBoxBroadphase(bodyA,bodyB,pairs1,pairs2)}else{this.doBoundingSphereBroadphase(bodyA,bodyB,pairs1,pairs2)}};var Broadphase_collisionPairs_r=new Vec3,Broadphase_collisionPairs_normal=new Vec3,Broadphase_collisionPairs_quat=new Quaternion,Broadphase_collisionPairs_relpos=new Vec3;Broadphase.prototype.doBoundingSphereBroadphase=function(bodyA,bodyB,pairs1,pairs2){var r=Broadphase_collisionPairs_r;bodyB.position.vsub(bodyA.position,r);var boundingRadiusSum2=Math.pow(bodyA.boundingRadius+bodyB.boundingRadius,2);var norm2=r.norm2();if(norm2<boundingRadiusSum2){pairs1.push(bodyA);pairs2.push(bodyB)}};Broadphase.prototype.doBoundingBoxBroadphase=function(bodyA,bodyB,pairs1,pairs2){if(bodyA.aabbNeedsUpdate){bodyA.computeAABB()}if(bodyB.aabbNeedsUpdate){bodyB.computeAABB()}if(bodyA.aabb.overlaps(bodyB.aabb)){pairs1.push(bodyA);pairs2.push(bodyB)}};var Broadphase_makePairsUnique_temp={keys:[]},Broadphase_makePairsUnique_p1=[],Broadphase_makePairsUnique_p2=[];Broadphase.prototype.makePairsUnique=function(pairs1,pairs2){var t=Broadphase_makePairsUnique_temp,p1=Broadphase_makePairsUnique_p1,p2=Broadphase_makePairsUnique_p2,N=pairs1.length;for(var i=0;i!==N;i++){p1[i]=pairs1[i];p2[i]=pairs2[i]}pairs1.length=0;pairs2.length=0;for(var i=0;i!==N;i++){var id1=p1[i].id,id2=p2[i].id;var key=id1<id2?id1+","+id2:id2+","+id1;t[key]=i;t.keys.push(key)}for(var i=0;i!==t.keys.length;i++){var key=t.keys.pop(),pairIndex=t[key];pairs1.push(p1[pairIndex]);pairs2.push(p2[pairIndex]);delete t[key]}};Broadphase.prototype.setWorld=function(world){};var bsc_dist=new Vec3;Broadphase.boundingSphereCheck=function(bodyA,bodyB){var dist=bsc_dist;bodyA.position.vsub(bodyB.position,dist);return Math.pow(bodyA.shape.boundingSphereRadius+bodyB.shape.boundingSphereRadius,2)>dist.norm2()};Broadphase.prototype.aabbQuery=function(world,aabb,result){console.warn(".aabbQuery is not implemented in this Broadphase subclass.");return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(_dereq_,module,exports){module.exports=GridBroadphase;var Broadphase=_dereq_("./Broadphase");var Vec3=_dereq_("../math/Vec3");var Shape=_dereq_("../shapes/Shape");function GridBroadphase(aabbMin,aabbMax,nx,ny,nz){Broadphase.apply(this);this.nx=nx||10;this.ny=ny||10;this.nz=nz||10;this.aabbMin=aabbMin||new Vec3(100,100,100);this.aabbMax=aabbMax||new Vec3(-100,-100,-100);var nbins=this.nx*this.ny*this.nz;if(nbins<=0){throw"GridBroadphase: Each dimension's n must be >0"}this.bins=[];this.binLengths=[];this.bins.length=nbins;this.binLengths.length=nbins;for(var i=0;i<nbins;i++){this.bins[i]=[];this.binLengths[i]=0}}GridBroadphase.prototype=new Broadphase;GridBroadphase.prototype.constructor=GridBroadphase;var GridBroadphase_collisionPairs_d=new Vec3;var GridBroadphase_collisionPairs_binPos=new Vec3;GridBroadphase.prototype.collisionPairs=function(world,pairs1,pairs2){var N=world.numObjects(),bodies=world.bodies;var max=this.aabbMax,min=this.aabbMin,nx=this.nx,ny=this.ny,nz=this.nz;var xstep=ny*nz;var ystep=nz;var zstep=1;var xmax=max.x,ymax=max.y,zmax=max.z,xmin=min.x,ymin=min.y,zmin=min.z;var xmult=nx/(xmax-xmin),ymult=ny/(ymax-ymin),zmult=nz/(zmax-zmin);var binsizeX=(xmax-xmin)/nx,binsizeY=(ymax-ymin)/ny,binsizeZ=(zmax-zmin)/nz;var binRadius=Math.sqrt(binsizeX*binsizeX+binsizeY*binsizeY+binsizeZ*binsizeZ)*.5;var types=Shape.types;var SPHERE=types.SPHERE,PLANE=types.PLANE,BOX=types.BOX,COMPOUND=types.COMPOUND,CONVEXPOLYHEDRON=types.CONVEXPOLYHEDRON;var bins=this.bins,binLengths=this.binLengths,Nbins=this.bins.length;for(var i=0;i!==Nbins;i++){binLengths[i]=0}var ceil=Math.ceil;var min=Math.min;var max=Math.max;function addBoxToBins(x0,y0,z0,x1,y1,z1,bi){var xoff0=(x0-xmin)*xmult|0,yoff0=(y0-ymin)*ymult|0,zoff0=(z0-zmin)*zmult|0,xoff1=ceil((x1-xmin)*xmult),yoff1=ceil((y1-ymin)*ymult),zoff1=ceil((z1-zmin)*zmult);if(xoff0<0){xoff0=0}else if(xoff0>=nx){xoff0=nx-1}if(yoff0<0){yoff0=0}else if(yoff0>=ny){yoff0=ny-1}if(zoff0<0){zoff0=0}else if(zoff0>=nz){zoff0=nz-1}if(xoff1<0){xoff1=0}else if(xoff1>=nx){xoff1=nx-1}if(yoff1<0){yoff1=0}else if(yoff1>=ny){yoff1=ny-1}if(zoff1<0){zoff1=0}else if(zoff1>=nz){zoff1=nz-1}xoff0*=xstep;yoff0*=ystep;zoff0*=zstep;xoff1*=xstep;yoff1*=ystep;zoff1*=zstep;for(var xoff=xoff0;xoff<=xoff1;xoff+=xstep){for(var yoff=yoff0;yoff<=yoff1;yoff+=ystep){for(var zoff=zoff0;zoff<=zoff1;zoff+=zstep){var idx=xoff+yoff+zoff;bins[idx][binLengths[idx]++]=bi}}}}for(var i=0;i!==N;i++){var bi=bodies[i];var si=bi.shape;switch(si.type){case SPHERE:var x=bi.position.x,y=bi.position.y,z=bi.position.z;var r=si.radius;addBoxToBins(x-r,y-r,z-r,x+r,y+r,z+r,bi);break;case PLANE:if(si.worldNormalNeedsUpdate){si.computeWorldNormal(bi.quaternion)}var planeNormal=si.worldNormal;var xreset=xmin+binsizeX*.5-bi.position.x,yreset=ymin+binsizeY*.5-bi.position.y,zreset=zmin+binsizeZ*.5-bi.position.z;var d=GridBroadphase_collisionPairs_d;d.set(xreset,yreset,zreset);for(var xi=0,xoff=0;xi!==nx;xi++,xoff+=xstep,d.y=yreset,d.x+=binsizeX){for(var yi=0,yoff=0;yi!==ny;yi++,yoff+=ystep,d.z=zreset,d.y+=binsizeY){for(var zi=0,zoff=0;zi!==nz;zi++,zoff+=zstep,d.z+=binsizeZ){if(d.dot(planeNormal)<binRadius){var idx=xoff+yoff+zoff;bins[idx][binLengths[idx]++]=bi}}}}break;default:if(bi.aabbNeedsUpdate){bi.computeAABB()}addBoxToBins(bi.aabb.lowerBound.x,bi.aabb.lowerBound.y,bi.aabb.lowerBound.z,bi.aabb.upperBound.x,bi.aabb.upperBound.y,bi.aabb.upperBound.z,bi);break}}for(var i=0;i!==Nbins;i++){var binLength=binLengths[i];if(binLength>1){var bin=bins[i];for(var xi=0;xi!==binLength;xi++){var bi=bin[xi];for(var yi=0;yi!==xi;yi++){var bj=bin[yi];if(this.needBroadphaseCollision(bi,bj)){this.intersectionTest(bi,bj,pairs1,pairs2)}}}}}this.makePairsUnique(pairs1,pairs2)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(_dereq_,module,exports){module.exports=NaiveBroadphase;var Broadphase=_dereq_("./Broadphase");var AABB=_dereq_("./AABB");function NaiveBroadphase(){Broadphase.apply(this)}NaiveBroadphase.prototype=new Broadphase;NaiveBroadphase.prototype.constructor=NaiveBroadphase;NaiveBroadphase.prototype.collisionPairs=function(world,pairs1,pairs2){var bodies=world.bodies,n=bodies.length,i,j,bi,bj;for(i=0;i!==n;i++){for(j=0;j!==i;j++){bi=bodies[i];bj=bodies[j];if(!this.needBroadphaseCollision(bi,bj)){continue}this.intersectionTest(bi,bj,pairs1,pairs2)}}};var tmpAABB=new AABB;NaiveBroadphase.prototype.aabbQuery=function(world,aabb,result){result=result||[];for(var i=0;i<world.bodies.length;i++){var b=world.bodies[i];if(b.aabbNeedsUpdate){b.computeAABB()}if(b.aabb.overlaps(aabb)){result.push(b)}}return result}},{"./AABB":3,"./Broadphase":5}],8:[function(_dereq_,module,exports){module.exports=ObjectCollisionMatrix;function ObjectCollisionMatrix(){this.matrix={}}ObjectCollisionMatrix.prototype.get=function(i,j){i=i.id;j=j.id;if(j>i){var temp=j;j=i;i=temp}return i+"-"+j in this.matrix};ObjectCollisionMatrix.prototype.set=function(i,j,value){i=i.id;j=j.id;if(j>i){var temp=j;j=i;i=temp}if(value){this.matrix[i+"-"+j]=true}else{delete this.matrix[i+"-"+j]}};ObjectCollisionMatrix.prototype.reset=function(){this.matrix={}};ObjectCollisionMatrix.prototype.setNumObjects=function(n){}},{}],9:[function(_dereq_,module,exports){module.exports=Ray;var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Transform=_dereq_("../math/Transform");var ConvexPolyhedron=_dereq_("../shapes/ConvexPolyhedron");var Box=_dereq_("../shapes/Box");var RaycastResult=_dereq_("../collision/RaycastResult");var Shape=_dereq_("../shapes/Shape");var AABB=_dereq_("../collision/AABB");function Ray(from,to){this.from=from?from.clone():new Vec3;this.to=to?to.clone():new Vec3;this._direction=new Vec3;this.precision=1e-4;this.checkCollisionResponse=true;this.skipBackfaces=false;this.collisionFilterMask=-1;this.collisionFilterGroup=-1;this.mode=Ray.ANY;this.result=new RaycastResult;this.hasHit=false;this.callback=function(result){}}Ray.prototype.constructor=Ray;Ray.CLOSEST=1;Ray.ANY=2;Ray.ALL=4;var tmpAABB=new AABB;var tmpArray=[];Ray.prototype.intersectWorld=function(world,options){this.mode=options.mode||Ray.ANY;this.result=options.result||new RaycastResult;this.skipBackfaces=!!options.skipBackfaces;this.collisionFilterMask=typeof options.collisionFilterMask!=="undefined"?options.collisionFilterMask:-1;this.collisionFilterGroup=typeof options.collisionFilterGroup!=="undefined"?options.collisionFilterGroup:-1;if(options.from){this.from.copy(options.from)}if(options.to){this.to.copy(options.to)}this.callback=options.callback||function(){};this.hasHit=false;this.result.reset();this._updateDirection();this.getAABB(tmpAABB);tmpArray.length=0;world.broadphase.aabbQuery(world,tmpAABB,tmpArray);this.intersectBodies(tmpArray);return this.hasHit};var v1=new Vec3,v2=new Vec3;Ray.pointInTriangle=pointInTriangle;function pointInTriangle(p,a,b,c){c.vsub(a,v0);b.vsub(a,v1);p.vsub(a,v2);var dot00=v0.dot(v0);var dot01=v0.dot(v1);var dot02=v0.dot(v2);var dot11=v1.dot(v1);var dot12=v1.dot(v2);var u,v;return(u=dot11*dot02-dot01*dot12)>=0&&(v=dot00*dot12-dot01*dot02)>=0&&u+v<dot00*dot11-dot01*dot01}var intersectBody_xi=new Vec3;var intersectBody_qi=new Quaternion;Ray.prototype.intersectBody=function(body,result){if(result){this.result=result;this._updateDirection()}var checkCollisionResponse=this.checkCollisionResponse;if(checkCollisionResponse&&!body.collisionResponse){return}if((this.collisionFilterGroup&body.collisionFilterMask)===0||(body.collisionFilterGroup&this.collisionFilterMask)===0){return}var xi=intersectBody_xi;var qi=intersectBody_qi;for(var i=0,N=body.shapes.length;i<N;i++){var shape=body.shapes[i];if(checkCollisionResponse&&!shape.collisionResponse){continue}body.quaternion.mult(body.shapeOrientations[i],qi);body.quaternion.vmult(body.shapeOffsets[i],xi);xi.vadd(body.position,xi);this.intersectShape(shape,qi,xi,body);if(this.result._shouldStop){break}}};Ray.prototype.intersectBodies=function(bodies,result){if(result){this.result=result;this._updateDirection()}for(var i=0,l=bodies.length;!this.result._shouldStop&&i<l;i++){this.intersectBody(bodies[i])}};Ray.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction);this._direction.normalize()};Ray.prototype.intersectShape=function(shape,quat,position,body){var from=this.from;var distance=distanceFromIntersection(from,this._direction,position);if(distance>shape.boundingSphereRadius){return}var intersectMethod=this[shape.type];if(intersectMethod){intersectMethod.call(this,shape,quat,position,body)}};var vector=new Vec3;var normal=new Vec3;var intersectPoint=new Vec3;var a=new Vec3;var b=new Vec3;var c=new Vec3;var d=new Vec3;var tmpRaycastResult=new RaycastResult;Ray.prototype.intersectBox=function(shape,quat,position,body){return this.intersectConvex(shape.convexPolyhedronRepresentation,quat,position,body)};Ray.prototype[Shape.types.BOX]=Ray.prototype.intersectBox;Ray.prototype.intersectPlane=function(shape,quat,position,body){var from=this.from;var to=this.to;var direction=this._direction;var worldNormal=new Vec3(0,0,1);quat.vmult(worldNormal,worldNormal);var len=new Vec3;from.vsub(position,len);var planeToFrom=len.dot(worldNormal);to.vsub(position,len);var planeToTo=len.dot(worldNormal);if(planeToFrom*planeToTo>0){return}if(from.distanceTo(to)<planeToFrom){return}var n_dot_dir=worldNormal.dot(direction);if(Math.abs(n_dot_dir)<this.precision){return}var planePointToFrom=new Vec3;var dir_scaled_with_t=new Vec3;var hitPointWorld=new Vec3;from.vsub(position,planePointToFrom);var t=-worldNormal.dot(planePointToFrom)/n_dot_dir;direction.scale(t,dir_scaled_with_t);from.vadd(dir_scaled_with_t,hitPointWorld);this.reportIntersection(worldNormal,hitPointWorld,shape,body,-1)};Ray.prototype[Shape.types.PLANE]=Ray.prototype.intersectPlane;Ray.prototype.getAABB=function(result){var to=this.to;var from=this.from;result.lowerBound.x=Math.min(to.x,from.x);result.lowerBound.y=Math.min(to.y,from.y);result.lowerBound.z=Math.min(to.z,from.z);result.upperBound.x=Math.max(to.x,from.x);result.upperBound.y=Math.max(to.y,from.y);result.upperBound.z=Math.max(to.z,from.z)};var intersectConvexOptions={faceList:[0]};Ray.prototype.intersectHeightfield=function(shape,quat,position,body){var data=shape.data,w=shape.elementSize,worldPillarOffset=new Vec3;var localRay=new Ray(this.from,this.to);Transform.pointToLocalFrame(position,quat,localRay.from,localRay.from);Transform.pointToLocalFrame(position,quat,localRay.to,localRay.to);var index=[];var iMinX=null;var iMinY=null;var iMaxX=null;var iMaxY=null;var inside=shape.getIndexOfPosition(localRay.from.x,localRay.from.y,index,false);if(inside){iMinX=index[0];iMinY=index[1];iMaxX=index[0];iMaxY=index[1]}inside=shape.getIndexOfPosition(localRay.to.x,localRay.to.y,index,false);if(inside){if(iMinX===null||index[0]<iMinX){iMinX=index[0]}if(iMaxX===null||index[0]>iMaxX){iMaxX=index[0]}if(iMinY===null||index[1]<iMinY){iMinY=index[1]}if(iMaxY===null||index[1]>iMaxY){iMaxY=index[1]}}if(iMinX===null){return}var minMax=[];shape.getRectMinMax(iMinX,iMinY,iMaxX,iMaxY,minMax);var min=minMax[0];var max=minMax[1];for(var i=iMinX;i<=iMaxX;i++){for(var j=iMinY;j<=iMaxY;j++){if(this.result._shouldStop){return}shape.getConvexTrianglePillar(i,j,false);Transform.pointToWorldFrame(position,quat,shape.pillarOffset,worldPillarOffset);this.intersectConvex(shape.pillarConvex,quat,worldPillarOffset,body,intersectConvexOptions);if(this.result._shouldStop){return}shape.getConvexTrianglePillar(i,j,true);Transform.pointToWorldFrame(position,quat,shape.pillarOffset,worldPillarOffset);this.intersectConvex(shape.pillarConvex,quat,worldPillarOffset,body,intersectConvexOptions)}}};Ray.prototype[Shape.types.HEIGHTFIELD]=Ray.prototype.intersectHeightfield;var Ray_intersectSphere_intersectionPoint=new Vec3;var Ray_intersectSphere_normal=new Vec3;Ray.prototype.intersectSphere=function(shape,quat,position,body){var from=this.from,to=this.to,r=shape.radius;var a=Math.pow(to.x-from.x,2)+Math.pow(to.y-from.y,2)+Math.pow(to.z-from.z,2);var b=2*((to.x-from.x)*(from.x-position.x)+(to.y-from.y)*(from.y-position.y)+(to.z-from.z)*(from.z-position.z));var c=Math.pow(from.x-position.x,2)+Math.pow(from.y-position.y,2)+Math.pow(from.z-position.z,2)-Math.pow(r,2);var delta=Math.pow(b,2)-4*a*c;var intersectionPoint=Ray_intersectSphere_intersectionPoint;var normal=Ray_intersectSphere_normal;if(delta<0){return}else if(delta===0){from.lerp(to,delta,intersectionPoint);intersectionPoint.vsub(position,normal);normal.normalize();this.reportIntersection(normal,intersectionPoint,shape,body,-1)}else{var d1=(-b-Math.sqrt(delta))/(2*a);var d2=(-b+Math.sqrt(delta))/(2*a);if(d1>=0&&d1<=1){from.lerp(to,d1,intersectionPoint);intersectionPoint.vsub(position,normal);normal.normalize();this.reportIntersection(normal,intersectionPoint,shape,body,-1)}if(this.result._shouldStop){return}if(d2>=0&&d2<=1){from.lerp(to,d2,intersectionPoint);intersectionPoint.vsub(position,normal);normal.normalize();this.reportIntersection(normal,intersectionPoint,shape,body,-1)}}};Ray.prototype[Shape.types.SPHERE]=Ray.prototype.intersectSphere;var intersectConvex_normal=new Vec3;var intersectConvex_minDistNormal=new Vec3;var intersectConvex_minDistIntersect=new Vec3;var intersectConvex_vector=new Vec3;Ray.prototype.intersectConvex=function intersectConvex(shape,quat,position,body,options){var minDistNormal=intersectConvex_minDistNormal;var normal=intersectConvex_normal;var vector=intersectConvex_vector;var minDistIntersect=intersectConvex_minDistIntersect;var faceList=options&&options.faceList||null;var faces=shape.faces,vertices=shape.vertices,normals=shape.faceNormals;var direction=this._direction;var from=this.from;var to=this.to;var fromToDistance=from.distanceTo(to);var minDist=-1;var Nfaces=faceList?faceList.length:faces.length;var result=this.result;for(var j=0;!result._shouldStop&&j<Nfaces;j++){var fi=faceList?faceList[j]:j;var face=faces[fi];var faceNormal=normals[fi];var q=quat;var x=position;vector.copy(vertices[face[0]]);q.vmult(vector,vector);vector.vadd(x,vector);vector.vsub(from,vector);q.vmult(faceNormal,normal);var dot=direction.dot(normal);if(Math.abs(dot)<this.precision){continue}var scalar=normal.dot(vector)/dot;if(scalar<0){continue}direction.mult(scalar,intersectPoint);intersectPoint.vadd(from,intersectPoint);a.copy(vertices[face[0]]);q.vmult(a,a);x.vadd(a,a);for(var i=1;!result._shouldStop&&i<face.length-1;i++){b.copy(vertices[face[i]]);c.copy(vertices[face[i+1]]);q.vmult(b,b);q.vmult(c,c);x.vadd(b,b);x.vadd(c,c);var distance=intersectPoint.distanceTo(from);if(!(pointInTriangle(intersectPoint,a,b,c)||pointInTriangle(intersectPoint,b,a,c))||distance>fromToDistance){continue}this.reportIntersection(normal,intersectPoint,shape,body,fi)}}};Ray.prototype[Shape.types.CONVEXPOLYHEDRON]=Ray.prototype.intersectConvex;var intersectTrimesh_normal=new Vec3;var intersectTrimesh_localDirection=new Vec3;var intersectTrimesh_localFrom=new Vec3;var intersectTrimesh_localTo=new Vec3;var intersectTrimesh_worldNormal=new Vec3;var intersectTrimesh_worldIntersectPoint=new Vec3;var intersectTrimesh_localAABB=new AABB;var intersectTrimesh_triangles=[];var intersectTrimesh_treeTransform=new Transform;Ray.prototype.intersectTrimesh=function intersectTrimesh(mesh,quat,position,body,options){var normal=intersectTrimesh_normal;var triangles=intersectTrimesh_triangles;var treeTransform=intersectTrimesh_treeTransform;var minDistNormal=intersectConvex_minDistNormal;var vector=intersectConvex_vector;var minDistIntersect=intersectConvex_minDistIntersect;var localAABB=intersectTrimesh_localAABB;var localDirection=intersectTrimesh_localDirection;var localFrom=intersectTrimesh_localFrom;var localTo=intersectTrimesh_localTo;var worldIntersectPoint=intersectTrimesh_worldIntersectPoint;var worldNormal=intersectTrimesh_worldNormal;var faceList=options&&options.faceList||null;var indices=mesh.indices,vertices=mesh.vertices,normals=mesh.faceNormals;var from=this.from;var to=this.to;var direction=this._direction;var minDist=-1;treeTransform.position.copy(position);treeTransform.quaternion.copy(quat);Transform.vectorToLocalFrame(position,quat,direction,localDirection);Transform.pointToLocalFrame(position,quat,from,localFrom);Transform.pointToLocalFrame(position,quat,to,localTo);var fromToDistanceSquared=localFrom.distanceSquared(localTo);mesh.tree.rayQuery(this,treeTransform,triangles);for(var i=0,N=triangles.length;!this.result._shouldStop&&i!==N;i++){var trianglesIndex=triangles[i];mesh.getNormal(trianglesIndex,normal);mesh.getVertex(indices[trianglesIndex*3],a);a.vsub(localFrom,vector);var dot=localDirection.dot(normal);var scalar=normal.dot(vector)/dot;if(scalar<0){continue}localDirection.scale(scalar,intersectPoint);intersectPoint.vadd(localFrom,intersectPoint);mesh.getVertex(indices[trianglesIndex*3+1],b);mesh.getVertex(indices[trianglesIndex*3+2],c);var squaredDistance=intersectPoint.distanceSquared(localFrom);if(!(pointInTriangle(intersectPoint,b,a,c)||pointInTriangle(intersectPoint,a,b,c))||squaredDistance>fromToDistanceSquared){continue}Transform.vectorToWorldFrame(quat,normal,worldNormal);Transform.pointToWorldFrame(position,quat,intersectPoint,worldIntersectPoint);this.reportIntersection(worldNormal,worldIntersectPoint,mesh,body,trianglesIndex)}triangles.length=0};Ray.prototype[Shape.types.TRIMESH]=Ray.prototype.intersectTrimesh;Ray.prototype.reportIntersection=function(normal,hitPointWorld,shape,body,hitFaceIndex){var from=this.from;var to=this.to;var distance=from.distanceTo(hitPointWorld);var result=this.result;if(this.skipBackfaces&&normal.dot(this._direction)>0){return}result.hitFaceIndex=typeof hitFaceIndex!=="undefined"?hitFaceIndex:-1;switch(this.mode){case Ray.ALL:this.hasHit=true;result.set(from,to,normal,hitPointWorld,shape,body,distance);result.hasHit=true;this.callback(result);break;case Ray.CLOSEST:if(distance<result.distance||!result.hasHit){this.hasHit=true;result.hasHit=true;result.set(from,to,normal,hitPointWorld,shape,body,distance)}break;case Ray.ANY:this.hasHit=true;result.hasHit=true;result.set(from,to,normal,hitPointWorld,shape,body,distance);result._shouldStop=true;break}};var v0=new Vec3,intersect=new Vec3;function distanceFromIntersection(from,direction,position){position.vsub(from,v0);var dot=v0.dot(direction);direction.mult(dot,intersect);intersect.vadd(from,intersect);var distance=position.distanceTo(intersect);return distance}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");module.exports=RaycastResult;function RaycastResult(){this.rayFromWorld=new Vec3;this.rayToWorld=new Vec3;this.hitNormalWorld=new Vec3;this.hitPointWorld=new Vec3;this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false}RaycastResult.prototype.reset=function(){this.rayFromWorld.setZero();this.rayToWorld.setZero();this.hitNormalWorld.setZero();this.hitPointWorld.setZero();this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false};RaycastResult.prototype.abort=function(){this._shouldStop=true};RaycastResult.prototype.set=function(rayFromWorld,rayToWorld,hitNormalWorld,hitPointWorld,shape,body,distance){this.rayFromWorld.copy(rayFromWorld);this.rayToWorld.copy(rayToWorld);this.hitNormalWorld.copy(hitNormalWorld);this.hitPointWorld.copy(hitPointWorld);this.shape=shape;this.body=body;this.distance=distance}},{"../math/Vec3":30}],11:[function(_dereq_,module,exports){var Shape=_dereq_("../shapes/Shape");var Broadphase=_dereq_("../collision/Broadphase");module.exports=SAPBroadphase;function SAPBroadphase(world){Broadphase.apply(this);this.axisList=[];this.world=null;this.axisIndex=0;var axisList=this.axisList;this._addBodyHandler=function(e){axisList.push(e.body)};this._removeBodyHandler=function(e){var idx=axisList.indexOf(e.body);if(idx!==-1){axisList.splice(idx,1)}};if(world){this.setWorld(world)}}SAPBroadphase.prototype=new Broadphase;SAPBroadphase.prototype.setWorld=function(world){this.axisList.length=0;for(var i=0;i<world.bodies.length;i++){this.axisList.push(world.bodies[i])}world.removeEventListener("addBody",this._addBodyHandler);world.removeEventListener("removeBody",this._removeBodyHandler);world.addEventListener("addBody",this._addBodyHandler);world.addEventListener("removeBody",this._removeBodyHandler);this.world=world;this.dirty=true};SAPBroadphase.insertionSortX=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound.x<=v.aabb.lowerBound.x){break}a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.insertionSortY=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound.y<=v.aabb.lowerBound.y){break}a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.insertionSortZ=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound.z<=v.aabb.lowerBound.z){break}a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.prototype.collisionPairs=function(world,p1,p2){var bodies=this.axisList,N=bodies.length,axisIndex=this.axisIndex,i,j;if(this.dirty){this.sortList();this.dirty=false}for(i=0;i!==N;i++){var bi=bodies[i];for(j=i+1;j<N;j++){var bj=bodies[j];if(!this.needBroadphaseCollision(bi,bj)){continue}if(!SAPBroadphase.checkBounds(bi,bj,axisIndex)){break}this.intersectionTest(bi,bj,p1,p2)}}};SAPBroadphase.prototype.sortList=function(){var axisList=this.axisList;var axisIndex=this.axisIndex;var N=axisList.length;for(var i=0;i!==N;i++){var bi=axisList[i];if(bi.aabbNeedsUpdate){bi.computeAABB()}}if(axisIndex===0){SAPBroadphase.insertionSortX(axisList)}else if(axisIndex===1){SAPBroadphase.insertionSortY(axisList)}else if(axisIndex===2){SAPBroadphase.insertionSortZ(axisList)}};SAPBroadphase.checkBounds=function(bi,bj,axisIndex){var biPos;var bjPos;if(axisIndex===0){biPos=bi.position.x;bjPos=bj.position.x}else if(axisIndex===1){biPos=bi.position.y;bjPos=bj.position.y}else if(axisIndex===2){biPos=bi.position.z;bjPos=bj.position.z}var ri=bi.boundingRadius,rj=bj.boundingRadius,boundA1=biPos-ri,boundA2=biPos+ri,boundB1=bjPos-rj,boundB2=bjPos+rj;return boundB1<boundA2};SAPBroadphase.prototype.autoDetectAxis=function(){var sumX=0,sumX2=0,sumY=0,sumY2=0,sumZ=0,sumZ2=0,bodies=this.axisList,N=bodies.length,invN=1/N;for(var i=0;i!==N;i++){var b=bodies[i];var centerX=b.position.x;sumX+=centerX;sumX2+=centerX*centerX;var centerY=b.position.y;sumY+=centerY;sumY2+=centerY*centerY;var centerZ=b.position.z;sumZ+=centerZ;sumZ2+=centerZ*centerZ}var varianceX=sumX2-sumX*sumX*invN,varianceY=sumY2-sumY*sumY*invN,varianceZ=sumZ2-sumZ*sumZ*invN;if(varianceX>varianceY){if(varianceX>varianceZ){this.axisIndex=0}else{this.axisIndex=2}}else if(varianceY>varianceZ){this.axisIndex=1}else{this.axisIndex=2}};SAPBroadphase.prototype.aabbQuery=function(world,aabb,result){result=result||[];if(this.dirty){this.sortList();this.dirty=false}var axisIndex=this.axisIndex,axis="x";if(axisIndex===1){axis="y"}if(axisIndex===2){axis="z"}var axisList=this.axisList;var lower=aabb.lowerBound[axis];var upper=aabb.upperBound[axis];for(var i=0;i<axisList.length;i++){var b=axisList[i];if(b.aabbNeedsUpdate){b.computeAABB()}if(b.aabb.overlaps(aabb)){result.push(b)}}return result}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(_dereq_,module,exports){module.exports=ConeTwistConstraint;var Constraint=_dereq_("./Constraint");var PointToPointConstraint=_dereq_("./PointToPointConstraint");var ConeEquation=_dereq_("../equations/ConeEquation");var RotationalEquation=_dereq_("../equations/RotationalEquation");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function ConeTwistConstraint(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;var pivotA=options.pivotA?options.pivotA.clone():new Vec3;var pivotB=options.pivotB?options.pivotB.clone():new Vec3;this.axisA=options.axisA?options.axisA.clone():new Vec3;this.axisB=options.axisB?options.axisB.clone():new Vec3;PointToPointConstraint.call(this,bodyA,pivotA,bodyB,pivotB,maxForce);this.collideConnected=!!options.collideConnected;this.angle=typeof options.angle!=="undefined"?options.angle:0;var c=this.coneEquation=new ConeEquation(bodyA,bodyB,options);var t=this.twistEquation=new RotationalEquation(bodyA,bodyB,options);this.twistAngle=typeof options.twistAngle!=="undefined"?options.twistAngle:0;c.maxForce=0;c.minForce=-maxForce;t.maxForce=0;t.minForce=-maxForce;this.equations.push(c,t)}ConeTwistConstraint.prototype=new PointToPointConstraint;ConeTwistConstraint.constructor=ConeTwistConstraint;var ConeTwistConstraint_update_tmpVec1=new Vec3;var ConeTwistConstraint_update_tmpVec2=new Vec3;ConeTwistConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,cone=this.coneEquation,twist=this.twistEquation;PointToPointConstraint.prototype.update.call(this);bodyA.vectorToWorldFrame(this.axisA,cone.axisA);bodyB.vectorToWorldFrame(this.axisB,cone.axisB);this.axisA.tangents(twist.axisA,twist.axisA);bodyA.vectorToWorldFrame(twist.axisA,twist.axisA);this.axisB.tangents(twist.axisB,twist.axisB);bodyB.vectorToWorldFrame(twist.axisB,twist.axisB);cone.angle=this.angle;twist.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(_dereq_,module,exports){module.exports=Constraint;var Utils=_dereq_("../utils/Utils");function Constraint(bodyA,bodyB,options){options=Utils.defaults(options,{collideConnected:true,wakeUpBodies:true});this.equations=[];this.bodyA=bodyA;this.bodyB=bodyB;this.id=Constraint.idCounter++;this.collideConnected=options.collideConnected;if(options.wakeUpBodies){if(bodyA){bodyA.wakeUp()}if(bodyB){bodyB.wakeUp()}}}Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};Constraint.prototype.enable=function(){var eqs=this.equations;for(var i=0;i<eqs.length;i++){eqs[i].enabled=true}};Constraint.prototype.disable=function(){var eqs=this.equations;for(var i=0;i<eqs.length;i++){eqs[i].enabled=false}};Constraint.idCounter=0},{"../utils/Utils":53}],14:[function(_dereq_,module,exports){module.exports=DistanceConstraint;var Constraint=_dereq_("./Constraint");var ContactEquation=_dereq_("../equations/ContactEquation");function DistanceConstraint(bodyA,bodyB,distance,maxForce){Constraint.call(this,bodyA,bodyB);if(typeof distance==="undefined"){distance=bodyA.position.distanceTo(bodyB.position)}if(typeof maxForce==="undefined"){maxForce=1e6}this.distance=distance;var eq=this.distanceEquation=new ContactEquation(bodyA,bodyB);this.equations.push(eq);eq.minForce=-maxForce;eq.maxForce=maxForce}DistanceConstraint.prototype=new Constraint;DistanceConstraint.prototype.update=function(){var bodyA=this.bodyA;var bodyB=this.bodyB;var eq=this.distanceEquation;var halfDist=this.distance*.5;var normal=eq.ni;bodyB.position.vsub(bodyA.position,normal);normal.normalize();normal.mult(halfDist,eq.ri);normal.mult(-halfDist,eq.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(_dereq_,module,exports){module.exports=HingeConstraint;var Constraint=_dereq_("./Constraint");var PointToPointConstraint=_dereq_("./PointToPointConstraint");var RotationalEquation=_dereq_("../equations/RotationalEquation");var RotationalMotorEquation=_dereq_("../equations/RotationalMotorEquation");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function HingeConstraint(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;var pivotA=options.pivotA?options.pivotA.clone():new Vec3;var pivotB=options.pivotB?options.pivotB.clone():new Vec3;PointToPointConstraint.call(this,bodyA,pivotA,bodyB,pivotB,maxForce);var axisA=this.axisA=options.axisA?options.axisA.clone():new Vec3(1,0,0);axisA.normalize();var axisB=this.axisB=options.axisB?options.axisB.clone():new Vec3(1,0,0);axisB.normalize();var r1=this.rotationalEquation1=new RotationalEquation(bodyA,bodyB,options);var r2=this.rotationalEquation2=new RotationalEquation(bodyA,bodyB,options);var motor=this.motorEquation=new RotationalMotorEquation(bodyA,bodyB,maxForce);motor.enabled=false;this.equations.push(r1,r2,motor)}HingeConstraint.prototype=new PointToPointConstraint;HingeConstraint.constructor=HingeConstraint;HingeConstraint.prototype.enableMotor=function(){this.motorEquation.enabled=true};HingeConstraint.prototype.disableMotor=function(){this.motorEquation.enabled=false};HingeConstraint.prototype.setMotorSpeed=function(speed){this.motorEquation.targetVelocity=speed};HingeConstraint.prototype.setMotorMaxForce=function(maxForce){this.motorEquation.maxForce=maxForce;this.motorEquation.minForce=-maxForce};var HingeConstraint_update_tmpVec1=new Vec3;var HingeConstraint_update_tmpVec2=new Vec3;HingeConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,motor=this.motorEquation,r1=this.rotationalEquation1,r2=this.rotationalEquation2,worldAxisA=HingeConstraint_update_tmpVec1,worldAxisB=HingeConstraint_update_tmpVec2;var axisA=this.axisA;var axisB=this.axisB;PointToPointConstraint.prototype.update.call(this);bodyA.quaternion.vmult(axisA,worldAxisA);bodyB.quaternion.vmult(axisB,worldAxisB);worldAxisA.tangents(r1.axisA,r2.axisA);r1.axisB.copy(worldAxisB);r2.axisB.copy(worldAxisB);if(this.motorEquation.enabled){bodyA.quaternion.vmult(this.axisA,motor.axisA);bodyB.quaternion.vmult(this.axisB,motor.axisB)}}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(_dereq_,module,exports){module.exports=LockConstraint;var Constraint=_dereq_("./Constraint");var PointToPointConstraint=_dereq_("./PointToPointConstraint");var RotationalEquation=_dereq_("../equations/RotationalEquation");var RotationalMotorEquation=_dereq_("../equations/RotationalMotorEquation");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function LockConstraint(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;var pivotA=new Vec3;var pivotB=new Vec3;var halfWay=new Vec3;bodyA.position.vadd(bodyB.position,halfWay);halfWay.scale(.5,halfWay);bodyB.pointToLocalFrame(halfWay,pivotB);bodyA.pointToLocalFrame(halfWay,pivotA);PointToPointConstraint.call(this,bodyA,pivotA,bodyB,pivotB,maxForce);var r1=this.rotationalEquation1=new RotationalEquation(bodyA,bodyB,options);var r2=this.rotationalEquation2=new RotationalEquation(bodyA,bodyB,options);var r3=this.rotationalEquation3=new RotationalEquation(bodyA,bodyB,options);this.equations.push(r1,r2,r3)}LockConstraint.prototype=new PointToPointConstraint;LockConstraint.constructor=LockConstraint;var LockConstraint_update_tmpVec1=new Vec3;var LockConstraint_update_tmpVec2=new Vec3;LockConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,motor=this.motorEquation,r1=this.rotationalEquation1,r2=this.rotationalEquation2,r3=this.rotationalEquation3,worldAxisA=LockConstraint_update_tmpVec1,worldAxisB=LockConstraint_update_tmpVec2;PointToPointConstraint.prototype.update.call(this);bodyA.vectorToWorldFrame(Vec3.UNIT_X,r1.axisA);bodyB.vectorToWorldFrame(Vec3.UNIT_Y,r1.axisB);bodyA.vectorToWorldFrame(Vec3.UNIT_Y,r2.axisA);bodyB.vectorToWorldFrame(Vec3.UNIT_Z,r2.axisB);bodyA.vectorToWorldFrame(Vec3.UNIT_Z,r3.axisA);bodyB.vectorToWorldFrame(Vec3.UNIT_X,r3.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(_dereq_,module,exports){module.exports=PointToPointConstraint;var Constraint=_dereq_("./Constraint");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function PointToPointConstraint(bodyA,pivotA,bodyB,pivotB,maxForce){Constraint.call(this,bodyA,bodyB);maxForce=typeof maxForce!=="undefined"?maxForce:1e6;this.pivotA=pivotA?pivotA.clone():new Vec3;this.pivotB=pivotB?pivotB.clone():new Vec3;var x=this.equationX=new ContactEquation(bodyA,bodyB);var y=this.equationY=new ContactEquation(bodyA,bodyB);var z=this.equationZ=new ContactEquation(bodyA,bodyB);this.equations.push(x,y,z);x.minForce=y.minForce=z.minForce=-maxForce;x.maxForce=y.maxForce=z.maxForce=maxForce;x.ni.set(1,0,0);y.ni.set(0,1,0);z.ni.set(0,0,1)}PointToPointConstraint.prototype=new Constraint;PointToPointConstraint.prototype.update=function(){var bodyA=this.bodyA;var bodyB=this.bodyB;var x=this.equationX;var y=this.equationY;var z=this.equationZ;bodyA.quaternion.vmult(this.pivotA,x.ri);bodyB.quaternion.vmult(this.pivotB,x.rj);y.ri.copy(x.ri);y.rj.copy(x.rj);z.ri.copy(x.ri);z.rj.copy(x.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(_dereq_,module,exports){module.exports=ConeEquation;var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Equation=_dereq_("./Equation");function ConeEquation(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=options.axisA?options.axisA.clone():new Vec3(1,0,0);this.axisB=options.axisB?options.axisB.clone():new Vec3(0,1,0);this.angle=typeof options.angle!=="undefined"?options.angle:0}ConeEquation.prototype=new Equation;ConeEquation.prototype.constructor=ConeEquation;var tmpVec1=new Vec3;var tmpVec2=new Vec3;ConeEquation.prototype.computeB=function(h){var a=this.a,b=this.b,ni=this.axisA,nj=this.axisB,nixnj=tmpVec1,njxni=tmpVec2,GA=this.jacobianElementA,GB=this.jacobianElementB;ni.cross(nj,nixnj);nj.cross(ni,njxni);GA.rotational.copy(njxni);GB.rotational.copy(nixnj);var g=Math.cos(this.angle)-ni.dot(nj),GW=this.computeGW(),GiMf=this.computeGiMf();var B=-g*a-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(_dereq_,module,exports){module.exports=ContactEquation;var Equation=_dereq_("./Equation");var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");function ContactEquation(bodyA,bodyB,maxForce){maxForce=typeof maxForce!=="undefined"?maxForce:1e6;Equation.call(this,bodyA,bodyB,0,maxForce);this.restitution=0;this.ri=new Vec3;this.rj=new Vec3;this.ni=new Vec3}ContactEquation.prototype=new Equation;ContactEquation.prototype.constructor=ContactEquation;var ContactEquation_computeB_temp1=new Vec3;var ContactEquation_computeB_temp2=new Vec3;var ContactEquation_computeB_temp3=new Vec3;ContactEquation.prototype.computeB=function(h){var a=this.a,b=this.b,bi=this.bi,bj=this.bj,ri=this.ri,rj=this.rj,rixn=ContactEquation_computeB_temp1,rjxn=ContactEquation_computeB_temp2,vi=bi.velocity,wi=bi.angularVelocity,fi=bi.force,taui=bi.torque,vj=bj.velocity,wj=bj.angularVelocity,fj=bj.force,tauj=bj.torque,penetrationVec=ContactEquation_computeB_temp3,GA=this.jacobianElementA,GB=this.jacobianElementB,n=this.ni;ri.cross(n,rixn);rj.cross(n,rjxn);n.negate(GA.spatial);rixn.negate(GA.rotational);GB.spatial.copy(n);GB.rotational.copy(rjxn);penetrationVec.copy(bj.position);penetrationVec.vadd(rj,penetrationVec);penetrationVec.vsub(bi.position,penetrationVec);penetrationVec.vsub(ri,penetrationVec);var g=n.dot(penetrationVec);var ePlusOne=this.restitution+1;var GW=ePlusOne*vj.dot(n)-ePlusOne*vi.dot(n)+wj.dot(rjxn)-wi.dot(rixn);var GiMf=this.computeGiMf();var B=-g*a-GW*b-h*GiMf;return B};var ContactEquation_getImpactVelocityAlongNormal_vi=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_vj=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_xi=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_xj=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_relVel=new Vec3;ContactEquation.prototype.getImpactVelocityAlongNormal=function(){var vi=ContactEquation_getImpactVelocityAlongNormal_vi;var vj=ContactEquation_getImpactVelocityAlongNormal_vj;var xi=ContactEquation_getImpactVelocityAlongNormal_xi;var xj=ContactEquation_getImpactVelocityAlongNormal_xj;var relVel=ContactEquation_getImpactVelocityAlongNormal_relVel;this.bi.position.vadd(this.ri,xi);this.bj.position.vadd(this.rj,xj);this.bi.getVelocityAtWorldPoint(xi,vi);this.bj.getVelocityAtWorldPoint(xj,vj);vi.vsub(vj,relVel);return this.ni.dot(relVel)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(_dereq_,module,exports){module.exports=Equation;var JacobianElement=_dereq_("../math/JacobianElement"),Vec3=_dereq_("../math/Vec3");function Equation(bi,bj,minForce,maxForce){this.id=Equation.id++;this.minForce=typeof minForce==="undefined"?-1e6:minForce;this.maxForce=typeof maxForce==="undefined"?1e6:maxForce;this.bi=bi;this.bj=bj;this.a=0;this.b=0;this.eps=0;this.jacobianElementA=new JacobianElement;this.jacobianElementB=new JacobianElement;this.enabled=true;this.setSpookParams(1e7,4,1/60)}Equation.prototype.constructor=Equation;Equation.id=0;Equation.prototype.setSpookParams=function(stiffness,relaxation,timeStep){var d=relaxation,k=stiffness,h=timeStep;this.a=4/(h*(1+4*d));this.b=4*d/(1+4*d);this.eps=4/(h*h*k*(1+4*d))};Equation.prototype.computeB=function(a,b,h){var GW=this.computeGW(),Gq=this.computeGq(),GiMf=this.computeGiMf();return-Gq*a-GW*b-GiMf*h};Equation.prototype.computeGq=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,xi=bi.position,xj=bj.position;return GA.spatial.dot(xi)+GB.spatial.dot(xj)};var zero=new Vec3;Equation.prototype.computeGW=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,vi=bi.velocity,vj=bj.velocity,wi=bi.angularVelocity||zero,wj=bj.angularVelocity||zero;return GA.multiplyVectors(vi,wi)+GB.multiplyVectors(vj,wj)};Equation.prototype.computeGWlambda=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,vi=bi.vlambda,vj=bj.vlambda,wi=bi.wlambda||zero,wj=bj.wlambda||zero;return GA.multiplyVectors(vi,wi)+GB.multiplyVectors(vj,wj)};var iMfi=new Vec3,iMfj=new Vec3,invIi_vmult_taui=new Vec3,invIj_vmult_tauj=new Vec3;Equation.prototype.computeGiMf=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,fi=bi.force,ti=bi.torque,fj=bj.force,tj=bj.torque,invMassi=bi.invMassSolve,invMassj=bj.invMassSolve;if(bi.invInertiaWorldSolve){bi.invInertiaWorldSolve.vmult(ti,invIi_vmult_taui)}else{invIi_vmult_taui.set(0,0,0)}if(bj.invInertiaWorldSolve){bj.invInertiaWorldSolve.vmult(tj,invIj_vmult_tauj)}else{invIj_vmult_tauj.set(0,0,0)}fi.mult(invMassi,iMfi);fj.mult(invMassj,iMfj);return GA.multiplyVectors(iMfi,invIi_vmult_taui)+GB.multiplyVectors(iMfj,invIj_vmult_tauj)};var tmp=new Vec3;Equation.prototype.computeGiMGt=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,invMassi=bi.invMassSolve,invMassj=bj.invMassSolve,invIi=bi.invInertiaWorldSolve,invIj=bj.invInertiaWorldSolve,result=invMassi+invMassj;if(invIi){invIi.vmult(GA.rotational,tmp);result+=tmp.dot(GA.rotational)}if(invIj){invIj.vmult(GB.rotational,tmp);result+=tmp.dot(GB.rotational)}return result};var addToWlambda_temp=new Vec3,addToWlambda_Gi=new Vec3,addToWlambda_Gj=new Vec3,addToWlambda_ri=new Vec3,addToWlambda_rj=new Vec3,addToWlambda_Mdiag=new Vec3;Equation.prototype.addToWlambda=function(deltalambda){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,temp=addToWlambda_temp;GA.spatial.mult(bi.invMassSolve*deltalambda,temp);bi.vlambda.vadd(temp,bi.vlambda);GB.spatial.mult(bj.invMassSolve*deltalambda,temp);bj.vlambda.vadd(temp,bj.vlambda);if(bi.invInertiaWorldSolve){bi.invInertiaWorldSolve.vmult(GA.rotational,temp);temp.mult(deltalambda,temp);bi.wlambda.vadd(temp,bi.wlambda)}if(bj.invInertiaWorldSolve){bj.invInertiaWorldSolve.vmult(GB.rotational,temp);temp.mult(deltalambda,temp);bj.wlambda.vadd(temp,bj.wlambda)}};Equation.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(_dereq_,module,exports){module.exports=FrictionEquation;var Equation=_dereq_("./Equation");var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");function FrictionEquation(bodyA,bodyB,slipForce){Equation.call(this,bodyA,bodyB,-slipForce,slipForce);this.ri=new Vec3;this.rj=new Vec3;this.t=new Vec3}FrictionEquation.prototype=new Equation;FrictionEquation.prototype.constructor=FrictionEquation;var FrictionEquation_computeB_temp1=new Vec3;var FrictionEquation_computeB_temp2=new Vec3;FrictionEquation.prototype.computeB=function(h){var a=this.a,b=this.b,bi=this.bi,bj=this.bj,ri=this.ri,rj=this.rj,rixt=FrictionEquation_computeB_temp1,rjxt=FrictionEquation_computeB_temp2,t=this.t;ri.cross(t,rixt);rj.cross(t,rjxt);var GA=this.jacobianElementA,GB=this.jacobianElementB;t.negate(GA.spatial);rixt.negate(GA.rotational);GB.spatial.copy(t);GB.rotational.copy(rjxt);var GW=this.computeGW();var GiMf=this.computeGiMf();var B=-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(_dereq_,module,exports){module.exports=RotationalEquation;var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Equation=_dereq_("./Equation");function RotationalEquation(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=options.axisA?options.axisA.clone():new Vec3(1,0,0);this.axisB=options.axisB?options.axisB.clone():new Vec3(0,1,0);this.maxAngle=Math.PI/2}RotationalEquation.prototype=new Equation;RotationalEquation.prototype.constructor=RotationalEquation;var tmpVec1=new Vec3;var tmpVec2=new Vec3;RotationalEquation.prototype.computeB=function(h){var a=this.a,b=this.b,ni=this.axisA,nj=this.axisB,nixnj=tmpVec1,njxni=tmpVec2,GA=this.jacobianElementA,GB=this.jacobianElementB;ni.cross(nj,nixnj);nj.cross(ni,njxni);GA.rotational.copy(njxni);GB.rotational.copy(nixnj);var g=Math.cos(this.maxAngle)-ni.dot(nj),GW=this.computeGW(),GiMf=this.computeGiMf();var B=-g*a-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(_dereq_,module,exports){module.exports=RotationalMotorEquation;var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Equation=_dereq_("./Equation");function RotationalMotorEquation(bodyA,bodyB,maxForce){maxForce=typeof maxForce!=="undefined"?maxForce:1e6;Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=new Vec3;this.axisB=new Vec3;this.targetVelocity=0}RotationalMotorEquation.prototype=new Equation;RotationalMotorEquation.prototype.constructor=RotationalMotorEquation;RotationalMotorEquation.prototype.computeB=function(h){var a=this.a,b=this.b,bi=this.bi,bj=this.bj,axisA=this.axisA,axisB=this.axisB,GA=this.jacobianElementA,GB=this.jacobianElementB;GA.rotational.copy(axisA);axisB.negate(GB.rotational);var GW=this.computeGW()-this.targetVelocity,GiMf=this.computeGiMf();var B=-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(_dereq_,module,exports){var Utils=_dereq_("../utils/Utils");module.exports=ContactMaterial;function ContactMaterial(m1,m2,options){options=Utils.defaults(options,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.id=ContactMaterial.idCounter++;this.materials=[m1,m2];this.friction=options.friction;this.restitution=options.restitution;this.contactEquationStiffness=options.contactEquationStiffness;this.contactEquationRelaxation=options.contactEquationRelaxation;this.frictionEquationStiffness=options.frictionEquationStiffness;this.frictionEquationRelaxation=options.frictionEquationRelaxation}ContactMaterial.idCounter=0},{"../utils/Utils":53}],25:[function(_dereq_,module,exports){module.exports=Material;function Material(options){var name="";options=options||{};if(typeof options==="string"){name=options;options={}}else if(typeof options==="object"){name=""}this.name=name;this.id=Material.idCounter++;this.friction=typeof options.friction!=="undefined"?options.friction:-1;this.restitution=typeof options.restitution!=="undefined"?options.restitution:-1}Material.idCounter=0},{}],26:[function(_dereq_,module,exports){module.exports=JacobianElement;var Vec3=_dereq_("./Vec3");function JacobianElement(){this.spatial=new Vec3;this.rotational=new Vec3}JacobianElement.prototype.multiplyElement=function(element){return element.spatial.dot(this.spatial)+element.rotational.dot(this.rotational)};JacobianElement.prototype.multiplyVectors=function(spatial,rotational){return spatial.dot(this.spatial)+rotational.dot(this.rotational)}},{"./Vec3":30}],27:[function(_dereq_,module,exports){module.exports=Mat3;var Vec3=_dereq_("./Vec3");function Mat3(elements){if(elements){this.elements=elements}else{this.elements=[0,0,0,0,0,0,0,0,0]}}Mat3.prototype.identity=function(){var e=this.elements;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1};Mat3.prototype.setZero=function(){var e=this.elements;e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=0;e[6]=0;e[7]=0;e[8]=0};Mat3.prototype.setTrace=function(vec3){var e=this.elements;e[0]=vec3.x;e[4]=vec3.y;e[8]=vec3.z};Mat3.prototype.getTrace=function(target){var target=target||new Vec3;var e=this.elements;target.x=e[0];target.y=e[4];target.z=e[8]};Mat3.prototype.vmult=function(v,target){target=target||new Vec3;var e=this.elements,x=v.x,y=v.y,z=v.z;target.x=e[0]*x+e[1]*y+e[2]*z;target.y=e[3]*x+e[4]*y+e[5]*z;target.z=e[6]*x+e[7]*y+e[8]*z;return target};Mat3.prototype.smult=function(s){for(var i=0;i<this.elements.length;i++){this.elements[i]*=s}};Mat3.prototype.mmult=function(m,target){var r=target||new Mat3;for(var i=0;i<3;i++){for(var j=0;j<3;j++){var sum=0;for(var k=0;k<3;k++){sum+=m.elements[i+k*3]*this.elements[k+j*3]}r.elements[i+j*3]=sum}}return r};Mat3.prototype.scale=function(v,target){target=target||new Mat3;var e=this.elements,t=target.elements;for(var i=0;i!==3;i++){t[3*i+0]=v.x*e[3*i+0];t[3*i+1]=v.y*e[3*i+1];t[3*i+2]=v.z*e[3*i+2]}return target};Mat3.prototype.solve=function(b,target){target=target||new Vec3;var nr=3;var nc=4;var eqns=[];for(var i=0;i<nr*nc;i++){eqns.push(0)}var i,j;for(i=0;i<3;i++){for(j=0;j<3;j++){eqns[i+nc*j]=this.elements[i+3*j]}}eqns[3+4*0]=b.x;eqns[3+4*1]=b.y;eqns[3+4*2]=b.z;var n=3,k=n,np;var kp=4;var p,els;do{i=k-n;if(eqns[i+nc*i]===0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!==0){np=kp;do{p=kp-np;eqns[p+nc*i]+=eqns[p+nc*j]}while(--np);break}}}if(eqns[i+nc*i]!==0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=kp;do{p=kp-np;eqns[p+nc*j]=p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}}}while(--n);target.z=eqns[2*nc+3]/eqns[2*nc+2];target.y=(eqns[1*nc+3]-eqns[1*nc+2]*target.z)/eqns[1*nc+1];target.x=(eqns[0*nc+3]-eqns[0*nc+2]*target.z-eqns[0*nc+1]*target.y)/eqns[0*nc+0];if(isNaN(target.x)||isNaN(target.y)||isNaN(target.z)||target.x===Infinity||target.y===Infinity||target.z===Infinity){throw"Could not solve equation! Got x=["+target.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]"}return target};Mat3.prototype.e=function(row,column,value){if(value===undefined){return this.elements[column+3*row]}else{this.elements[column+3*row]=value}};Mat3.prototype.copy=function(source){for(var i=0;i<source.elements.length;i++){this.elements[i]=source.elements[i]}return this};Mat3.prototype.toString=function(){var r="";var sep=",";for(var i=0;i<9;i++){r+=this.elements[i]+sep}return r};Mat3.prototype.reverse=function(target){target=target||new Mat3;var nr=3;var nc=6;var eqns=[];for(var i=0;i<nr*nc;i++){eqns.push(0)}var i,j;for(i=0;i<3;i++){for(j=0;j<3;j++){eqns[i+nc*j]=this.elements[i+3*j]}}eqns[3+6*0]=1;eqns[3+6*1]=0;eqns[3+6*2]=0;eqns[4+6*0]=0;eqns[4+6*1]=1;eqns[4+6*2]=0;eqns[5+6*0]=0;eqns[5+6*1]=0;eqns[5+6*2]=1;var n=3,k=n,np;var kp=nc;var p;do{i=k-n;if(eqns[i+nc*i]===0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!==0){np=kp;do{p=kp-np;eqns[p+nc*i]+=eqns[p+nc*j]}while(--np);break}}}if(eqns[i+nc*i]!==0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=kp;do{p=kp-np;eqns[p+nc*j]=p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}}}while(--n);i=2;do{j=i-1;do{var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=nc;do{p=nc-np;eqns[p+nc*j]=eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}while(j--)}while(--i);i=2;do{var multiplier=1/eqns[i+nc*i];np=nc;do{p=nc-np;eqns[p+nc*i]=eqns[p+nc*i]*multiplier}while(--np)}while(i--);i=2;do{j=2;do{p=eqns[nr+j+nc*i];if(isNaN(p)||p===Infinity){throw"Could not reverse! A=["+this.toString()+"]"}target.e(i,j,p)}while(j--)}while(i--);return target};Mat3.prototype.setRotationFromQuaternion=function(q){var x=q.x,y=q.y,z=q.z,w=q.w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2,e=this.elements;e[3*0+0]=1-(yy+zz);e[3*0+1]=xy-wz;e[3*0+2]=xz+wy;e[3*1+0]=xy+wz;e[3*1+1]=1-(xx+zz);e[3*1+2]=yz-wx;e[3*2+0]=xz-wy;e[3*2+1]=yz+wx;e[3*2+2]=1-(xx+yy);return this};Mat3.prototype.transpose=function(target){target=target||new Mat3;var Mt=target.elements,M=this.elements;for(var i=0;i!==3;i++){for(var j=0;j!==3;j++){Mt[3*i+j]=M[3*j+i]}}return target}},{"./Vec3":30}],28:[function(_dereq_,module,exports){module.exports=Quaternion;var Vec3=_dereq_("./Vec3");function Quaternion(x,y,z,w){this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;this.z=z!==undefined?z:0;this.w=w!==undefined?w:1}Quaternion.prototype.set=function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w};Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};Quaternion.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]};Quaternion.prototype.setFromAxisAngle=function(axis,angle){var s=Math.sin(angle*.5);this.x=axis.x*s;this.y=axis.y*s;this.z=axis.z*s;this.w=Math.cos(angle*.5)};Quaternion.prototype.toAxisAngle=function(targetAxis){targetAxis=targetAxis||new Vec3;this.normalize();var angle=2*Math.acos(this.w);var s=Math.sqrt(1-this.w*this.w);if(s<.001){targetAxis.x=this.x;targetAxis.y=this.y;targetAxis.z=this.z}else{targetAxis.x=this.x/s;targetAxis.y=this.y/s;targetAxis.z=this.z/s}return[targetAxis,angle]};var sfv_t1=new Vec3,sfv_t2=new Vec3;Quaternion.prototype.setFromVectors=function(u,v){if(u.isAntiparallelTo(v)){var t1=sfv_t1;var t2=sfv_t2;u.tangents(t1,t2);this.setFromAxisAngle(t1,Math.PI)}else{var a=u.cross(v);this.x=a.x;this.y=a.y;this.z=a.z;this.w=Math.sqrt(Math.pow(u.norm(),2)*Math.pow(v.norm(),2))+u.dot(v);this.normalize()}};var Quaternion_mult_va=new Vec3;var Quaternion_mult_vb=new Vec3;var Quaternion_mult_vaxvb=new Vec3;Quaternion.prototype.mult=function(q,target){target=target||new Quaternion;var w=this.w,va=Quaternion_mult_va,vb=Quaternion_mult_vb,vaxvb=Quaternion_mult_vaxvb;va.set(this.x,this.y,this.z);vb.set(q.x,q.y,q.z);target.w=w*q.w-va.dot(vb);va.cross(vb,vaxvb);target.x=w*vb.x+q.w*va.x+vaxvb.x;target.y=w*vb.y+q.w*va.y+vaxvb.y;target.z=w*vb.z+q.w*va.z+vaxvb.z;return target};Quaternion.prototype.inverse=function(target){var x=this.x,y=this.y,z=this.z,w=this.w;target=target||new Quaternion;this.conjugate(target);var inorm2=1/(x*x+y*y+z*z+w*w);target.x*=inorm2;target.y*=inorm2;target.z*=inorm2;target.w*=inorm2;return target};Quaternion.prototype.conjugate=function(target){target=target||new Quaternion;target.x=-this.x;target.y=-this.y;target.z=-this.z;target.w=this.w;return target};Quaternion.prototype.normalize=function(){var l=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(l===0){this.x=0;this.y=0;this.z=0;this.w=0}else{l=1/l;this.x*=l;this.y*=l;this.z*=l;this.w*=l}};Quaternion.prototype.normalizeFast=function(){var f=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;if(f===0){this.x=0;this.y=0;this.z=0;this.w=0}else{this.x*=f;this.y*=f;this.z*=f;this.w*=f}};Quaternion.prototype.vmult=function(v,target){target=target||new Vec3;var x=v.x,y=v.y,z=v.z;var qx=this.x,qy=this.y,qz=this.z,qw=this.w;var ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;target.x=ix*qw+iw*-qx+iy*-qz-iz*-qy;target.y=iy*qw+iw*-qy+iz*-qx-ix*-qz;target.z=iz*qw+iw*-qz+ix*-qy-iy*-qx;return target};Quaternion.prototype.copy=function(source){this.x=source.x;this.y=source.y;this.z=source.z;this.w=source.w;return this};Quaternion.prototype.toEuler=function(target,order){order=order||"YZX";var heading,attitude,bank;var x=this.x,y=this.y,z=this.z,w=this.w;switch(order){case"YZX":var test=x*y+z*w;if(test>.499){heading=2*Math.atan2(x,w);attitude=Math.PI/2;bank=0}if(test<-.499){heading=-2*Math.atan2(x,w);attitude=-Math.PI/2;bank=0}if(isNaN(heading)){var sqx=x*x;var sqy=y*y;var sqz=z*z;heading=Math.atan2(2*y*w-2*x*z,1-2*sqy-2*sqz);attitude=Math.asin(2*test);bank=Math.atan2(2*x*w-2*y*z,1-2*sqx-2*sqz)}break;default:throw new Error("Euler order "+order+" not supported yet.")}target.y=heading;target.z=attitude;target.x=bank};Quaternion.prototype.setFromEuler=function(x,y,z,order){order=order||"XYZ";var c1=Math.cos(x/2);var c2=Math.cos(y/2);var c3=Math.cos(z/2);var s1=Math.sin(x/2);var s2=Math.sin(y/2);var s3=Math.sin(z/2);if(order==="XYZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="YXZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="ZXY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="ZYX"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="YZX"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="XZY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}return this};Quaternion.prototype.clone=function(){return new Quaternion(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(_dereq_,module,exports){var Vec3=_dereq_("./Vec3");var Quaternion=_dereq_("./Quaternion");module.exports=Transform;function Transform(options){options=options||{};this.position=new Vec3;if(options.position){this.position.copy(options.position)}this.quaternion=new Quaternion;if(options.quaternion){this.quaternion.copy(options.quaternion)}}var tmpQuat=new Quaternion;Transform.pointToLocalFrame=function(position,quaternion,worldPoint,result){var result=result||new Vec3;worldPoint.vsub(position,result);quaternion.conjugate(tmpQuat);tmpQuat.vmult(result,result);return result};Transform.prototype.pointToLocal=function(worldPoint,result){return Transform.pointToLocalFrame(this.position,this.quaternion,worldPoint,result)};Transform.pointToWorldFrame=function(position,quaternion,localPoint,result){var result=result||new Vec3;quaternion.vmult(localPoint,result);result.vadd(position,result);return result};Transform.prototype.pointToWorld=function(localPoint,result){return Transform.pointToWorldFrame(this.position,this.quaternion,localPoint,result)};Transform.prototype.vectorToWorldFrame=function(localVector,result){var result=result||new Vec3;this.quaternion.vmult(localVector,result);return result};Transform.vectorToWorldFrame=function(quaternion,localVector,result){quaternion.vmult(localVector,result);return result};Transform.vectorToLocalFrame=function(position,quaternion,worldVector,result){var result=result||new Vec3;quaternion.w*=-1;quaternion.vmult(worldVector,result);quaternion.w*=-1;return result}},{"./Quaternion":28,"./Vec3":30}],30:[function(_dereq_,module,exports){module.exports=Vec3;var Mat3=_dereq_("./Mat3");function Vec3(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0}Vec3.ZERO=new Vec3(0,0,0);Vec3.UNIT_X=new Vec3(1,0,0);Vec3.UNIT_Y=new Vec3(0,1,0);Vec3.UNIT_Z=new Vec3(0,0,1);Vec3.prototype.cross=function(v,target){var vx=v.x,vy=v.y,vz=v.z,x=this.x,y=this.y,z=this.z;target=target||new Vec3;target.x=y*vz-z*vy;target.y=z*vx-x*vz;target.z=x*vy-y*vx;return target};Vec3.prototype.set=function(x,y,z){this.x=x;this.y=y;this.z=z;return this};Vec3.prototype.setZero=function(){this.x=this.y=this.z=0};Vec3.prototype.vadd=function(v,target){if(target){target.x=v.x+this.x;target.y=v.y+this.y;target.z=v.z+this.z}else{return new Vec3(this.x+v.x,this.y+v.y,this.z+v.z)}};Vec3.prototype.vsub=function(v,target){if(target){target.x=this.x-v.x;target.y=this.y-v.y;target.z=this.z-v.z}else{return new Vec3(this.x-v.x,this.y-v.y,this.z-v.z)}};Vec3.prototype.crossmat=function(){return new Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};Vec3.prototype.normalize=function(){var x=this.x,y=this.y,z=this.z;var n=Math.sqrt(x*x+y*y+z*z);if(n>0){var invN=1/n;this.x*=invN;this.y*=invN;this.z*=invN}else{this.x=0;this.y=0;this.z=0}return n};Vec3.prototype.unit=function(target){target=target||new Vec3;var x=this.x,y=this.y,z=this.z;var ninv=Math.sqrt(x*x+y*y+z*z);if(ninv>0){ninv=1/ninv;target.x=x*ninv;target.y=y*ninv;target.z=z*ninv}else{target.x=1;target.y=0;target.z=0}return target};Vec3.prototype.norm=function(){var x=this.x,y=this.y,z=this.z;return Math.sqrt(x*x+y*y+z*z)};Vec3.prototype.length=Vec3.prototype.norm;Vec3.prototype.norm2=function(){return this.dot(this)};Vec3.prototype.lengthSquared=Vec3.prototype.norm2;Vec3.prototype.distanceTo=function(p){var x=this.x,y=this.y,z=this.z;var px=p.x,py=p.y,pz=p.z;return Math.sqrt((px-x)*(px-x)+(py-y)*(py-y)+(pz-z)*(pz-z))};Vec3.prototype.distanceSquared=function(p){var x=this.x,y=this.y,z=this.z;var px=p.x,py=p.y,pz=p.z;return(px-x)*(px-x)+(py-y)*(py-y)+(pz-z)*(pz-z)};Vec3.prototype.mult=function(scalar,target){target=target||new Vec3;var x=this.x,y=this.y,z=this.z;target.x=scalar*x;target.y=scalar*y;target.z=scalar*z;return target};Vec3.prototype.scale=Vec3.prototype.mult;Vec3.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z};Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};Vec3.prototype.negate=function(target){target=target||new Vec3;target.x=-this.x;target.y=-this.y;target.z=-this.z;return target};var Vec3_tangents_n=new Vec3;var Vec3_tangents_randVec=new Vec3;Vec3.prototype.tangents=function(t1,t2){var norm=this.norm();if(norm>0){var n=Vec3_tangents_n;var inorm=1/norm;n.set(this.x*inorm,this.y*inorm,this.z*inorm);var randVec=Vec3_tangents_randVec;if(Math.abs(n.x)<.9){randVec.set(1,0,0);n.cross(randVec,t1)}else{randVec.set(0,1,0);n.cross(randVec,t1)}n.cross(t1,t2)}else{t1.set(1,0,0);t2.set(0,1,0)}};Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z};Vec3.prototype.toArray=function(){return[this.x,this.y,this.z]};Vec3.prototype.copy=function(source){this.x=source.x;this.y=source.y;this.z=source.z;return this};Vec3.prototype.lerp=function(v,t,target){var x=this.x,y=this.y,z=this.z;target.x=x+(v.x-x)*t;target.y=y+(v.y-y)*t;target.z=z+(v.z-z)*t};Vec3.prototype.almostEquals=function(v,precision){if(precision===undefined){precision=1e-6}if(Math.abs(this.x-v.x)>precision||Math.abs(this.y-v.y)>precision||Math.abs(this.z-v.z)>precision){return false}return true};Vec3.prototype.almostZero=function(precision){if(precision===undefined){precision=1e-6}if(Math.abs(this.x)>precision||Math.abs(this.y)>precision||Math.abs(this.z)>precision){return false}return true};var antip_neg=new Vec3;Vec3.prototype.isAntiparallelTo=function(v,precision){this.negate(antip_neg);return antip_neg.almostEquals(v,precision)};Vec3.prototype.clone=function(){return new Vec3(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(_dereq_,module,exports){module.exports=Body;var EventTarget=_dereq_("../utils/EventTarget");var Shape=_dereq_("../shapes/Shape");var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Quaternion=_dereq_("../math/Quaternion");var Material=_dereq_("../material/Material");var AABB=_dereq_("../collision/AABB");var Box=_dereq_("../shapes/Box");function Body(options){options=options||{};EventTarget.apply(this);this.id=Body.idCounter++;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new Vec3;this.collisionFilterGroup=typeof options.collisionFilterGroup==="number"?options.collisionFilterGroup:1;this.collisionFilterMask=typeof options.collisionFilterMask==="number"?options.collisionFilterMask:1;this.collisionResponse=true;this.position=new Vec3;if(options.position){this.position.copy(options.position)}this.previousPosition=new Vec3;this.initPosition=new Vec3;this.velocity=new Vec3;if(options.velocity){this.velocity.copy(options.velocity)}this.initVelocity=new Vec3;this.force=new Vec3;var mass=typeof options.mass==="number"?options.mass:0;this.mass=mass;this.invMass=mass>0?1/mass:0;this.material=options.material||null;this.linearDamping=typeof options.linearDamping==="number"?options.linearDamping:.01;this.type=mass<=0?Body.STATIC:Body.DYNAMIC;if(typeof options.type===typeof Body.STATIC){this.type=options.type}this.allowSleep=typeof options.allowSleep!=="undefined"?options.allowSleep:true;this.sleepState=0;this.sleepSpeedLimit=typeof options.sleepSpeedLimit!=="undefined"?options.sleepSpeedLimit:.1;this.sleepTimeLimit=typeof options.sleepTimeLimit!=="undefined"?options.sleepTimeLimit:1;this.timeLastSleepy=0;this._wakeUpAfterNarrowphase=false;this.torque=new Vec3;this.quaternion=new Quaternion;if(options.quaternion){this.quaternion.copy(options.quaternion)}this.initQuaternion=new Quaternion;this.angularVelocity=new Vec3;if(options.angularVelocity){this.angularVelocity.copy(options.angularVelocity)}this.initAngularVelocity=new Vec3;this.interpolatedPosition=new Vec3;this.interpolatedQuaternion=new Quaternion;this.shapes=[];this.shapeOffsets=[];this.shapeOrientations=[];this.inertia=new Vec3;this.invInertia=new Vec3;this.invInertiaWorld=new Mat3;this.invMassSolve=0;this.invInertiaSolve=new Vec3;this.invInertiaWorldSolve=new Mat3;this.fixedRotation=typeof options.fixedRotation!=="undefined"?options.fixedRotation:false;this.angularDamping=typeof options.angularDamping!=="undefined"?options.angularDamping:.01;this.userData=typeof options.userData!=="undefined"?options.userData:null;this.aabb=new AABB;this.aabbNeedsUpdate=true;this.wlambda=new Vec3;if(options.shape){this.addShape(options.shape)}this.updateMassProperties()}Body.prototype=new EventTarget;Body.prototype.constructor=Body;Body.DYNAMIC=1;Body.STATIC=2;Body.KINEMATIC=4;Body.AWAKE=0;Body.SLEEPY=1;Body.SLEEPING=2;Body.idCounter=0;Body.prototype.wakeUp=function(){var s=this.sleepState;this.sleepState=0;if(s===Body.SLEEPING){this.dispatchEvent({type:"wakeup"})}};Body.prototype.sleep=function(){this.sleepState=Body.SLEEPING;this.velocity.set(0,0,0);this.angularVelocity.set(0,0,0)};Body.sleepyEvent={type:"sleepy"};Body.sleepEvent={type:"sleep"};Body.prototype.sleepTick=function(time){if(this.allowSleep){var sleepState=this.sleepState;var speedSquared=this.velocity.norm2()+this.angularVelocity.norm2();var speedLimitSquared=Math.pow(this.sleepSpeedLimit,2);if(sleepState===Body.AWAKE&&speedSquared<speedLimitSquared){this.sleepState=Body.SLEEPY;this.timeLastSleepy=time;this.dispatchEvent(Body.sleepyEvent)}else if(sleepState===Body.SLEEPY&&speedSquared>speedLimitSquared){this.wakeUp()}else if(sleepState===Body.SLEEPY&&time-this.timeLastSleepy>this.sleepTimeLimit){this.sleep();this.dispatchEvent(Body.sleepEvent)}}};Body.prototype.updateSolveMassProperties=function(){if(this.sleepState===Body.SLEEPING||this.type===Body.KINEMATIC){this.invMassSolve=0;this.invInertiaSolve.setZero();this.invInertiaWorldSolve.setZero()}else{this.invMassSolve=this.invMass;this.invInertiaSolve.copy(this.invInertia);this.invInertiaWorldSolve.copy(this.invInertiaWorld)}};Body.prototype.pointToLocalFrame=function(worldPoint,result){var result=result||new Vec3;worldPoint.vsub(this.position,result);this.quaternion.conjugate().vmult(result,result);return result};Body.prototype.vectorToLocalFrame=function(worldVector,result){var result=result||new Vec3;this.quaternion.conjugate().vmult(worldVector,result);return result};Body.prototype.pointToWorldFrame=function(localPoint,result){var result=result||new Vec3;this.quaternion.vmult(localPoint,result);result.vadd(this.position,result);return result};Body.prototype.vectorToWorldFrame=function(localVector,result){var result=result||new Vec3;this.quaternion.vmult(localVector,result);return result};var tmpVec=new Vec3;var tmpQuat=new Quaternion;Body.prototype.addShape=function(shape,_offset,_orientation){var offset=new Vec3;var orientation=new Quaternion;if(_offset){offset.copy(_offset)}if(_orientation){orientation.copy(_orientation)}this.shapes.push(shape);this.shapeOffsets.push(offset);this.shapeOrientations.push(orientation);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=true;return this};Body.prototype.updateBoundingRadius=function(){var shapes=this.shapes,shapeOffsets=this.shapeOffsets,N=shapes.length,radius=0;for(var i=0;i!==N;i++){var shape=shapes[i];shape.updateBoundingSphereRadius();var offset=shapeOffsets[i].norm(),r=shape.boundingSphereRadius;if(offset+r>radius){radius=offset+r}}this.boundingRadius=radius};var computeAABB_shapeAABB=new AABB;Body.prototype.computeAABB=function(){var shapes=this.shapes,shapeOffsets=this.shapeOffsets,shapeOrientations=this.shapeOrientations,N=shapes.length,offset=tmpVec,orientation=tmpQuat,bodyQuat=this.quaternion,aabb=this.aabb,shapeAABB=computeAABB_shapeAABB;for(var i=0;i!==N;i++){var shape=shapes[i];shapeOrientations[i].mult(bodyQuat,orientation);orientation.vmult(shapeOffsets[i],offset);offset.vadd(this.position,offset);shape.calculateWorldAABB(offset,orientation,shapeAABB.lowerBound,shapeAABB.upperBound);if(i===0){aabb.copy(shapeAABB)}else{aabb.extend(shapeAABB)}}this.aabbNeedsUpdate=false};var uiw_m1=new Mat3,uiw_m2=new Mat3,uiw_m3=new Mat3;Body.prototype.updateInertiaWorld=function(force){var I=this.invInertia;if(I.x===I.y&&I.y===I.z&&!force){}else{var m1=uiw_m1,m2=uiw_m2,m3=uiw_m3;m1.setRotationFromQuaternion(this.quaternion);m1.transpose(m2);m1.scale(I,m1);m1.mmult(m2,this.invInertiaWorld)}};var Body_applyForce_r=new Vec3;var Body_applyForce_rotForce=new Vec3;Body.prototype.applyForce=function(force,worldPoint){if(this.type!==Body.DYNAMIC){return}var r=Body_applyForce_r;worldPoint.vsub(this.position,r);var rotForce=Body_applyForce_rotForce;r.cross(force,rotForce);this.force.vadd(force,this.force);this.torque.vadd(rotForce,this.torque)};var Body_applyLocalForce_worldForce=new Vec3;var Body_applyLocalForce_worldPoint=new Vec3;Body.prototype.applyLocalForce=function(localForce,localPoint){if(this.type!==Body.DYNAMIC){return}var worldForce=Body_applyLocalForce_worldForce;var worldPoint=Body_applyLocalForce_worldPoint;this.vectorToWorldFrame(localForce,worldForce);this.pointToWorldFrame(localPoint,worldPoint);this.applyForce(worldForce,worldPoint)};var Body_applyImpulse_r=new Vec3;var Body_applyImpulse_velo=new Vec3;var Body_applyImpulse_rotVelo=new Vec3;Body.prototype.applyImpulse=function(impulse,worldPoint){if(this.type!==Body.DYNAMIC){return}var r=Body_applyImpulse_r;worldPoint.vsub(this.position,r);var velo=Body_applyImpulse_velo;velo.copy(impulse);velo.mult(this.invMass,velo);this.velocity.vadd(velo,this.velocity);var rotVelo=Body_applyImpulse_rotVelo;r.cross(impulse,rotVelo);this.invInertiaWorld.vmult(rotVelo,rotVelo);this.angularVelocity.vadd(rotVelo,this.angularVelocity)};var Body_applyLocalImpulse_worldImpulse=new Vec3;var Body_applyLocalImpulse_worldPoint=new Vec3;Body.prototype.applyLocalImpulse=function(localImpulse,localPoint){if(this.type!==Body.DYNAMIC){return}var worldImpulse=Body_applyLocalImpulse_worldImpulse;var worldPoint=Body_applyLocalImpulse_worldPoint;this.vectorToWorldFrame(localImpulse,worldImpulse);this.pointToWorldFrame(localPoint,worldPoint);this.applyImpulse(worldImpulse,worldPoint)};var Body_updateMassProperties_halfExtents=new Vec3;Body.prototype.updateMassProperties=function(){var halfExtents=Body_updateMassProperties_halfExtents;this.invMass=this.mass>0?1/this.mass:0;var I=this.inertia;var fixed=this.fixedRotation;this.computeAABB();halfExtents.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2);Box.calculateInertia(halfExtents,this.mass,I);this.invInertia.set(I.x>0&&!fixed?1/I.x:0,I.y>0&&!fixed?1/I.y:0,I.z>0&&!fixed?1/I.z:0);this.updateInertiaWorld(true)};Body.prototype.getVelocityAtWorldPoint=function(worldPoint,result){var r=new Vec3;worldPoint.vsub(this.position,r);this.angularVelocity.cross(r,result);this.velocity.vadd(result,result);return result}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(_dereq_,module,exports){var Body=_dereq_("./Body");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var RaycastResult=_dereq_("../collision/RaycastResult");var Ray=_dereq_("../collision/Ray");var WheelInfo=_dereq_("../objects/WheelInfo");module.exports=RaycastVehicle;function RaycastVehicle(options){this.chassisBody=options.chassisBody;this.wheelInfos=[];this.sliding=false;this.world=null;this.indexRightAxis=typeof options.indexRightAxis!=="undefined"?options.indexRightAxis:1;this.indexForwardAxis=typeof options.indexForwardAxis!=="undefined"?options.indexForwardAxis:0;this.indexUpAxis=typeof options.indexUpAxis!=="undefined"?options.indexUpAxis:2}var tmpVec1=new Vec3;var tmpVec2=new Vec3;var tmpVec3=new Vec3;var tmpVec4=new Vec3;var tmpVec5=new Vec3;var tmpVec6=new Vec3;var tmpRay=new Ray;RaycastVehicle.prototype.addWheel=function(options){options=options||{};var info=new WheelInfo(options);var index=this.wheelInfos.length;this.wheelInfos.push(info);return index};RaycastVehicle.prototype.setSteeringValue=function(value,wheelIndex){var wheel=this.wheelInfos[wheelIndex];wheel.steering=value};var torque=new Vec3;RaycastVehicle.prototype.applyEngineForce=function(value,wheelIndex){this.wheelInfos[wheelIndex].engineForce=value};RaycastVehicle.prototype.setBrake=function(brake,wheelIndex){this.wheelInfos[wheelIndex].brake=brake};RaycastVehicle.prototype.addToWorld=function(world){var constraints=this.constraints;world.add(this.chassisBody);var that=this;this.preStepCallback=function(){that.updateVehicle(world.dt)};world.addEventListener("preStep",this.preStepCallback);this.world=world};RaycastVehicle.prototype.getVehicleAxisWorld=function(axisIndex,result){result.set(axisIndex===0?1:0,axisIndex===1?1:0,axisIndex===2?1:0);this.chassisBody.vectorToWorldFrame(result,result)};RaycastVehicle.prototype.updateVehicle=function(timeStep){var wheelInfos=this.wheelInfos;var numWheels=wheelInfos.length;var chassisBody=this.chassisBody;for(var i=0;i<numWheels;i++){this.updateWheelTransform(i)}this.currentVehicleSpeedKmHour=3.6*chassisBody.velocity.norm();var forwardWorld=new Vec3;this.getVehicleAxisWorld(this.indexForwardAxis,forwardWorld);if(forwardWorld.dot(chassisBody.velocity)<0){this.currentVehicleSpeedKmHour*=-1}for(var i=0;i<numWheels;i++){this.castRay(wheelInfos[i])}this.updateSuspension(timeStep);var impulse=new Vec3;var relpos=new Vec3;for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var suspensionForce=wheel.suspensionForce;if(suspensionForce>wheel.maxSuspensionForce){suspensionForce=wheel.maxSuspensionForce}wheel.raycastResult.hitNormalWorld.scale(suspensionForce*timeStep,impulse);wheel.raycastResult.hitPointWorld.vsub(chassisBody.position,relpos);chassisBody.applyImpulse(impulse,wheel.raycastResult.hitPointWorld)}this.updateFriction(timeStep);var hitNormalWorldScaledWithProj=new Vec3;var fwd=new Vec3;var vel=new Vec3;for(i=0;i<numWheels;i++){var wheel=wheelInfos[i];chassisBody.getVelocityAtWorldPoint(wheel.chassisConnectionPointWorld,vel);var m=1;switch(this.indexUpAxis){case 1:m=-1;break}if(wheel.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,fwd);var proj=fwd.dot(wheel.raycastResult.hitNormalWorld);wheel.raycastResult.hitNormalWorld.scale(proj,hitNormalWorldScaledWithProj);fwd.vsub(hitNormalWorldScaledWithProj,fwd);var proj2=fwd.dot(vel);wheel.deltaRotation=m*proj2*timeStep/wheel.radius}if((wheel.sliding||!wheel.isInContact)&&wheel.engineForce!==0&&wheel.useCustomSlidingRotationalSpeed){wheel.deltaRotation=(wheel.engineForce>0?1:-1)*wheel.customSlidingRotationalSpeed*timeStep}if(Math.abs(wheel.brake)>Math.abs(wheel.engineForce)){wheel.deltaRotation=0}wheel.rotation+=wheel.deltaRotation;wheel.deltaRotation*=.99}};RaycastVehicle.prototype.updateSuspension=function(deltaTime){var chassisBody=this.chassisBody;var chassisMass=chassisBody.mass;var wheelInfos=this.wheelInfos;var numWheels=wheelInfos.length;for(var w_it=0;w_it<numWheels;w_it++){var wheel=wheelInfos[w_it];if(wheel.isInContact){var force;var susp_length=wheel.suspensionRestLength;var current_length=wheel.suspensionLength;var length_diff=susp_length-current_length;force=wheel.suspensionStiffness*length_diff*wheel.clippedInvContactDotSuspension;var projected_rel_vel=wheel.suspensionRelativeVelocity;var susp_damping;if(projected_rel_vel<0){susp_damping=wheel.dampingCompression}else{susp_damping=wheel.dampingRelaxation}force-=susp_damping*projected_rel_vel;wheel.suspensionForce=force*chassisMass;if(wheel.suspensionForce<0){wheel.suspensionForce=0}}else{wheel.suspensionForce=0}}};RaycastVehicle.prototype.removeFromWorld=function(world){var constraints=this.constraints;world.remove(this.chassisBody);world.removeEventListener("preStep",this.preStepCallback);this.world=null};var castRay_rayvector=new Vec3;var castRay_target=new Vec3;RaycastVehicle.prototype.castRay=function(wheel){var rayvector=castRay_rayvector;var target=castRay_target;this.updateWheelTransformWorld(wheel);var chassisBody=this.chassisBody;var depth=-1;var raylen=wheel.suspensionRestLength+wheel.radius;wheel.directionWorld.scale(raylen,rayvector);var source=wheel.chassisConnectionPointWorld;source.vadd(rayvector,target);var raycastResult=wheel.raycastResult;var param=0;raycastResult.reset();var oldState=chassisBody.collisionResponse;chassisBody.collisionResponse=false;this.world.rayTest(source,target,raycastResult);chassisBody.collisionResponse=oldState;var object=raycastResult.body;wheel.raycastResult.groundObject=0;if(object){depth=raycastResult.distance;wheel.raycastResult.hitNormalWorld=raycastResult.hitNormalWorld;wheel.isInContact=true;var hitDistance=raycastResult.distance;wheel.suspensionLength=hitDistance-wheel.radius;var minSuspensionLength=wheel.suspensionRestLength-wheel.maxSuspensionTravel;var maxSuspensionLength=wheel.suspensionRestLength+wheel.maxSuspensionTravel;if(wheel.suspensionLength<minSuspensionLength){wheel.suspensionLength=minSuspensionLength}if(wheel.suspensionLength>maxSuspensionLength){wheel.suspensionLength=maxSuspensionLength;wheel.raycastResult.reset()}var denominator=wheel.raycastResult.hitNormalWorld.dot(wheel.directionWorld);var chassis_velocity_at_contactPoint=new Vec3;chassisBody.getVelocityAtWorldPoint(wheel.raycastResult.hitPointWorld,chassis_velocity_at_contactPoint);var projVel=wheel.raycastResult.hitNormalWorld.dot(chassis_velocity_at_contactPoint);if(denominator>=-.1){wheel.suspensionRelativeVelocity=0;wheel.clippedInvContactDotSuspension=1/.1}else{var inv=-1/denominator;wheel.suspensionRelativeVelocity=projVel*inv;wheel.clippedInvContactDotSuspension=inv}}else{wheel.suspensionLength=wheel.suspensionRestLength+0*wheel.maxSuspensionTravel;wheel.suspensionRelativeVelocity=0;wheel.directionWorld.scale(-1,wheel.raycastResult.hitNormalWorld);wheel.clippedInvContactDotSuspension=1}return depth};RaycastVehicle.prototype.updateWheelTransformWorld=function(wheel){wheel.isInContact=false;var chassisBody=this.chassisBody;chassisBody.pointToWorldFrame(wheel.chassisConnectionPointLocal,wheel.chassisConnectionPointWorld);chassisBody.vectorToWorldFrame(wheel.directionLocal,wheel.directionWorld);chassisBody.vectorToWorldFrame(wheel.axleLocal,wheel.axleWorld)};RaycastVehicle.prototype.updateWheelTransform=function(wheelIndex){var up=tmpVec4;var right=tmpVec5;var fwd=tmpVec6;var wheel=this.wheelInfos[wheelIndex];this.updateWheelTransformWorld(wheel);wheel.directionLocal.scale(-1,up);right.copy(wheel.axleLocal);up.cross(right,fwd);fwd.normalize();right.normalize();var steering=wheel.steering;var steeringOrn=new Quaternion;steeringOrn.setFromAxisAngle(up,steering);var rotatingOrn=new Quaternion;rotatingOrn.setFromAxisAngle(right,wheel.rotation);var q=wheel.worldTransform.quaternion;this.chassisBody.quaternion.mult(steeringOrn,q);q.mult(rotatingOrn,q);q.normalize();var p=wheel.worldTransform.position;p.copy(wheel.directionWorld);p.scale(wheel.suspensionLength,p);p.vadd(wheel.chassisConnectionPointWorld,p)};var directions=[new Vec3(1,0,0),new Vec3(0,1,0),new Vec3(0,0,1)];RaycastVehicle.prototype.getWheelTransformWorld=function(wheelIndex){return this.wheelInfos[wheelIndex].worldTransform};var updateFriction_surfNormalWS_scaled_proj=new Vec3;var updateFriction_axle=[];var updateFriction_forwardWS=[];var sideFrictionStiffness2=1;RaycastVehicle.prototype.updateFriction=function(timeStep){var surfNormalWS_scaled_proj=updateFriction_surfNormalWS_scaled_proj;var wheelInfos=this.wheelInfos;var numWheels=wheelInfos.length;var chassisBody=this.chassisBody;var forwardWS=updateFriction_forwardWS;var axle=updateFriction_axle;var numWheelsOnGround=0;for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var groundObject=wheel.raycastResult.body;if(groundObject){numWheelsOnGround++}wheel.sideImpulse=0;wheel.forwardImpulse=0;if(!forwardWS[i]){forwardWS[i]=new Vec3}if(!axle[i]){axle[i]=new Vec3}}for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var groundObject=wheel.raycastResult.body;if(groundObject){var axlei=axle[i];var wheelTrans=this.getWheelTransformWorld(i);wheelTrans.vectorToWorldFrame(directions[this.indexRightAxis],axlei);var surfNormalWS=wheel.raycastResult.hitNormalWorld;var proj=axlei.dot(surfNormalWS);surfNormalWS.scale(proj,surfNormalWS_scaled_proj);axlei.vsub(surfNormalWS_scaled_proj,axlei);axlei.normalize();surfNormalWS.cross(axlei,forwardWS[i]);forwardWS[i].normalize();wheel.sideImpulse=resolveSingleBilateral(chassisBody,wheel.raycastResult.hitPointWorld,groundObject,wheel.raycastResult.hitPointWorld,axlei);wheel.sideImpulse*=sideFrictionStiffness2}}var sideFactor=1;var fwdFactor=.5;this.sliding=false;for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var groundObject=wheel.raycastResult.body;var rollingFriction=0;wheel.slipInfo=1;if(groundObject){var defaultRollingFrictionImpulse=0;var maxImpulse=wheel.brake?wheel.brake:defaultRollingFrictionImpulse;rollingFriction=calcRollingFriction(chassisBody,groundObject,wheel.raycastResult.hitPointWorld,forwardWS[i],maxImpulse);rollingFriction+=wheel.engineForce*timeStep;var factor=maxImpulse/rollingFriction;wheel.slipInfo*=factor}wheel.forwardImpulse=0;wheel.skidInfo=1;if(groundObject){wheel.skidInfo=1;var maximp=wheel.suspensionForce*timeStep*wheel.frictionSlip;var maximpSide=maximp;var maximpSquared=maximp*maximpSide;wheel.forwardImpulse=rollingFriction;var x=wheel.forwardImpulse*fwdFactor;var y=wheel.sideImpulse*sideFactor;var impulseSquared=x*x+y*y;wheel.sliding=false;if(impulseSquared>maximpSquared){this.sliding=true;wheel.sliding=true;var factor=maximp/Math.sqrt(impulseSquared);wheel.skidInfo*=factor}}}if(this.sliding){for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];if(wheel.sideImpulse!==0){if(wheel.skidInfo<1){wheel.forwardImpulse*=wheel.skidInfo;wheel.sideImpulse*=wheel.skidInfo}}}}for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var rel_pos=new Vec3;rel_pos.copy(wheel.raycastResult.hitPointWorld);if(wheel.forwardImpulse!==0){var impulse=new Vec3;forwardWS[i].scale(wheel.forwardImpulse,impulse);chassisBody.applyImpulse(impulse,rel_pos)}if(wheel.sideImpulse!==0){var groundObject=wheel.raycastResult.body;var rel_pos2=new Vec3;rel_pos2.copy(wheel.raycastResult.hitPointWorld);var sideImp=new Vec3;axle[i].scale(wheel.sideImpulse,sideImp);chassisBody.pointToLocalFrame(rel_pos,rel_pos);rel_pos["xyz"[this.indexUpAxis]]*=wheel.rollInfluence;chassisBody.pointToWorldFrame(rel_pos,rel_pos);chassisBody.applyImpulse(sideImp,rel_pos);sideImp.scale(-1,sideImp);groundObject.applyImpulse(sideImp,rel_pos2)}}};var calcRollingFriction_vel1=new Vec3;var calcRollingFriction_vel2=new Vec3;var calcRollingFriction_vel=new Vec3;function calcRollingFriction(body0,body1,frictionPosWorld,frictionDirectionWorld,maxImpulse){var j1=0;var contactPosWorld=frictionPosWorld;var vel1=calcRollingFriction_vel1;var vel2=calcRollingFriction_vel2;var vel=calcRollingFriction_vel;body0.getVelocityAtWorldPoint(contactPosWorld,vel1);body1.getVelocityAtWorldPoint(contactPosWorld,vel2);vel1.vsub(vel2,vel);var vrel=frictionDirectionWorld.dot(vel);var denom0=computeImpulseDenominator(body0,frictionPosWorld,frictionDirectionWorld);var denom1=computeImpulseDenominator(body1,frictionPosWorld,frictionDirectionWorld);var relaxation=1;var jacDiagABInv=relaxation/(denom0+denom1);j1=-vrel*jacDiagABInv;if(maxImpulse<j1){j1=maxImpulse}if(j1<-maxImpulse){j1=-maxImpulse}return j1}var computeImpulseDenominator_r0=new Vec3;var computeImpulseDenominator_c0=new Vec3;var computeImpulseDenominator_vec=new Vec3;var computeImpulseDenominator_m=new Vec3;function computeImpulseDenominator(body,pos,normal){var r0=computeImpulseDenominator_r0;var c0=computeImpulseDenominator_c0;var vec=computeImpulseDenominator_vec;var m=computeImpulseDenominator_m;pos.vsub(body.position,r0);r0.cross(normal,c0);body.invInertiaWorld.vmult(c0,m);m.cross(r0,vec);return body.invMass+normal.dot(vec)}var resolveSingleBilateral_vel1=new Vec3;var resolveSingleBilateral_vel2=new Vec3;var resolveSingleBilateral_vel=new Vec3;function resolveSingleBilateral(body1,pos1,body2,pos2,normal,impulse){var normalLenSqr=normal.norm2();if(normalLenSqr>1.1){return 0}var vel1=resolveSingleBilateral_vel1;var vel2=resolveSingleBilateral_vel2;var vel=resolveSingleBilateral_vel;body1.getVelocityAtWorldPoint(pos1,vel1);body2.getVelocityAtWorldPoint(pos2,vel2);vel1.vsub(vel2,vel);var rel_vel=normal.dot(vel);var contactDamping=.2;var massTerm=1/(body1.invMass+body2.invMass);var impulse=-contactDamping*rel_vel*massTerm;return impulse}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(_dereq_,module,exports){var Body=_dereq_("./Body");var Sphere=_dereq_("../shapes/Sphere");var Box=_dereq_("../shapes/Box");var Vec3=_dereq_("../math/Vec3");var HingeConstraint=_dereq_("../constraints/HingeConstraint");module.exports=RigidVehicle;function RigidVehicle(options){this.wheelBodies=[];this.coordinateSystem=typeof options.coordinateSystem==="undefined"?new Vec3(1,2,3):options.coordinateSystem.clone();this.chassisBody=options.chassisBody;if(!this.chassisBody){var chassisShape=new Box(new Vec3(5,2,.5));this.chassisBody=new Body(1,chassisShape)}this.constraints=[];this.wheelAxes=[];this.wheelForces=[]}RigidVehicle.prototype.addWheel=function(options){options=options||{};var wheelBody=options.body;if(!wheelBody){wheelBody=new Body(1,new Sphere(1.2))}this.wheelBodies.push(wheelBody);this.wheelForces.push(0);var zero=new Vec3;var position=typeof options.position!=="undefined"?options.position.clone():new Vec3;var worldPosition=new Vec3;this.chassisBody.pointToWorldFrame(position,worldPosition);wheelBody.position.set(worldPosition.x,worldPosition.y,worldPosition.z);var axis=typeof options.axis!=="undefined"?options.axis.clone():new Vec3(0,1,0);this.wheelAxes.push(axis);var hingeConstraint=new HingeConstraint(this.chassisBody,wheelBody,{pivotA:position,axisA:axis,pivotB:Vec3.ZERO,axisB:axis,collideConnected:false});this.constraints.push(hingeConstraint);return this.wheelBodies.length-1};RigidVehicle.prototype.setSteeringValue=function(value,wheelIndex){var axis=this.wheelAxes[wheelIndex];var c=Math.cos(value),s=Math.sin(value),x=axis.x,y=axis.y;this.constraints[wheelIndex].axisA.set(c*x-s*y,s*x+c*y,0)};RigidVehicle.prototype.setMotorSpeed=function(value,wheelIndex){var hingeConstraint=this.constraints[wheelIndex];hingeConstraint.enableMotor();hingeConstraint.motorTargetVelocity=value};RigidVehicle.prototype.disableMotor=function(wheelIndex){var hingeConstraint=this.constraints[wheelIndex];hingeConstraint.disableMotor()};var torque=new Vec3;RigidVehicle.prototype.setWheelForce=function(value,wheelIndex){this.wheelForces[wheelIndex]=value};RigidVehicle.prototype.applyWheelForce=function(value,wheelIndex){var axis=this.wheelAxes[wheelIndex];var wheelBody=this.wheelBodies[wheelIndex];var bodyTorque=wheelBody.torque;axis.scale(value,torque);wheelBody.vectorToWorldFrame(torque,torque);bodyTorque.vadd(torque,bodyTorque)};RigidVehicle.prototype.addToWorld=function(world){var constraints=this.constraints;var bodies=this.wheelBodies.concat([this.chassisBody]);for(var i=0;i<bodies.length;i++){world.add(bodies[i])}for(var i=0;i<constraints.length;i++){world.addConstraint(constraints[i])}world.addEventListener("preStep",this._update.bind(this))};RigidVehicle.prototype._update=function(){var wheelForces=this.wheelForces;for(var i=0;i<wheelForces.length;i++){this.applyWheelForce(wheelForces[i],i)}};RigidVehicle.prototype.removeFromWorld=function(world){var constraints=this.constraints;var bodies=this.wheelBodies.concat([this.chassisBody]);for(var i=0;i<bodies.length;i++){world.remove(bodies[i])}for(var i=0;i<constraints.length;i++){world.removeConstraint(constraints[i])}};var worldAxis=new Vec3;RigidVehicle.prototype.getWheelSpeed=function(wheelIndex){var axis=this.wheelAxes[wheelIndex];var wheelBody=this.wheelBodies[wheelIndex];var w=wheelBody.angularVelocity;this.chassisBody.vectorToWorldFrame(axis,worldAxis);return w.dot(worldAxis)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(_dereq_,module,exports){module.exports=SPHSystem;var Shape=_dereq_("../shapes/Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Particle=_dereq_("../shapes/Particle");var Body=_dereq_("../objects/Body");var Material=_dereq_("../material/Material");function SPHSystem(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]}SPHSystem.prototype.add=function(particle){this.particles.push(particle);if(this.neighbors.length<this.particles.length){this.neighbors.push([])}};SPHSystem.prototype.remove=function(particle){var idx=this.particles.indexOf(particle);if(idx!==-1){this.particles.splice(idx,1);if(this.neighbors.length>this.particles.length){this.neighbors.pop()}}};var SPHSystem_getNeighbors_dist=new Vec3;SPHSystem.prototype.getNeighbors=function(particle,neighbors){var N=this.particles.length,id=particle.id,R2=this.smoothingRadius*this.smoothingRadius,dist=SPHSystem_getNeighbors_dist;for(var i=0;i!==N;i++){var p=this.particles[i];p.position.vsub(particle.position,dist);if(id!==p.id&&dist.norm2()<R2){neighbors.push(p)}}};var SPHSystem_update_dist=new Vec3,SPHSystem_update_a_pressure=new Vec3,SPHSystem_update_a_visc=new Vec3,SPHSystem_update_gradW=new Vec3,SPHSystem_update_r_vec=new Vec3,SPHSystem_update_u=new Vec3;SPHSystem.prototype.update=function(){var N=this.particles.length,dist=SPHSystem_update_dist,cs=this.speedOfSound,eps=this.eps;for(var i=0;i!==N;i++){var p=this.particles[i];var neighbors=this.neighbors[i];neighbors.length=0;this.getNeighbors(p,neighbors);neighbors.push(this.particles[i]);var numNeighbors=neighbors.length;var sum=0;for(var j=0;j!==numNeighbors;j++){p.position.vsub(neighbors[j].position,dist);var len=dist.norm();var weight=this.w(len);sum+=neighbors[j].mass*weight}this.densities[i]=sum;this.pressures[i]=cs*cs*(this.densities[i]-this.density)}var a_pressure=SPHSystem_update_a_pressure;var a_visc=SPHSystem_update_a_visc;var gradW=SPHSystem_update_gradW;var r_vec=SPHSystem_update_r_vec;var u=SPHSystem_update_u;for(var i=0;i!==N;i++){var particle=this.particles[i];a_pressure.set(0,0,0);a_visc.set(0,0,0);var Pij;var nabla;var Vij;var neighbors=this.neighbors[i];var numNeighbors=neighbors.length;for(var j=0;j!==numNeighbors;j++){var neighbor=neighbors[j];particle.position.vsub(neighbor.position,r_vec);var r=r_vec.norm();Pij=-neighbor.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+eps)+this.pressures[j]/(this.densities[j]*this.densities[j]+eps));this.gradw(r_vec,gradW);gradW.mult(Pij,gradW);a_pressure.vadd(gradW,a_pressure);neighbor.velocity.vsub(particle.velocity,u);u.mult(1/(1e-4+this.densities[i]*this.densities[j])*this.viscosity*neighbor.mass,u);nabla=this.nablaw(r);u.mult(nabla,u);a_visc.vadd(u,a_visc)}a_visc.mult(particle.mass,a_visc);a_pressure.mult(particle.mass,a_pressure);particle.force.vadd(a_visc,particle.force);particle.force.vadd(a_pressure,particle.force)}};SPHSystem.prototype.w=function(r){var h=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(h,9))*Math.pow(h*h-r*r,3)};SPHSystem.prototype.gradw=function(rVec,resultVec){var r=rVec.norm(),h=this.smoothingRadius;rVec.mult(945/(32*Math.PI*Math.pow(h,9))*Math.pow(h*h-r*r,2),resultVec)};SPHSystem.prototype.nablaw=function(r){var h=this.smoothingRadius;var nabla=945/(32*Math.PI*Math.pow(h,9))*(h*h-r*r)*(7*r*r-3*h*h);return nabla}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");module.exports=Spring;function Spring(bodyA,bodyB,options){options=options||{};this.restLength=typeof options.restLength==="number"?options.restLength:1;this.stiffness=options.stiffness||100;this.damping=options.damping||1;this.bodyA=bodyA;this.bodyB=bodyB;this.localAnchorA=new Vec3;this.localAnchorB=new Vec3;if(options.localAnchorA){this.localAnchorA.copy(options.localAnchorA)}if(options.localAnchorB){this.localAnchorB.copy(options.localAnchorB)}if(options.worldAnchorA){this.setWorldAnchorA(options.worldAnchorA)}if(options.worldAnchorB){this.setWorldAnchorB(options.worldAnchorB)}}Spring.prototype.setWorldAnchorA=function(worldAnchorA){this.bodyA.pointToLocalFrame(worldAnchorA,this.localAnchorA)};Spring.prototype.setWorldAnchorB=function(worldAnchorB){this.bodyB.pointToLocalFrame(worldAnchorB,this.localAnchorB)};Spring.prototype.getWorldAnchorA=function(result){this.bodyA.pointToWorldFrame(this.localAnchorA,result)};Spring.prototype.getWorldAnchorB=function(result){this.bodyB.pointToWorldFrame(this.localAnchorB,result)};var applyForce_r=new Vec3,applyForce_r_unit=new Vec3,applyForce_u=new Vec3,applyForce_f=new Vec3,applyForce_worldAnchorA=new Vec3,applyForce_worldAnchorB=new Vec3,applyForce_ri=new Vec3,applyForce_rj=new Vec3,applyForce_ri_x_f=new Vec3,applyForce_rj_x_f=new Vec3,applyForce_tmp=new Vec3;Spring.prototype.applyForce=function(){var k=this.stiffness,d=this.damping,l=this.restLength,bodyA=this.bodyA,bodyB=this.bodyB,r=applyForce_r,r_unit=applyForce_r_unit,u=applyForce_u,f=applyForce_f,tmp=applyForce_tmp;var worldAnchorA=applyForce_worldAnchorA,worldAnchorB=applyForce_worldAnchorB,ri=applyForce_ri,rj=applyForce_rj,ri_x_f=applyForce_ri_x_f,rj_x_f=applyForce_rj_x_f;this.getWorldAnchorA(worldAnchorA);this.getWorldAnchorB(worldAnchorB);worldAnchorA.vsub(bodyA.position,ri);worldAnchorB.vsub(bodyB.position,rj);worldAnchorB.vsub(worldAnchorA,r);var rlen=r.norm();r_unit.copy(r);r_unit.normalize();bodyB.velocity.vsub(bodyA.velocity,u);bodyB.angularVelocity.cross(rj,tmp);u.vadd(tmp,u);bodyA.angularVelocity.cross(ri,tmp);u.vsub(tmp,u);r_unit.mult(-k*(rlen-l)-d*u.dot(r_unit),f);bodyA.force.vsub(f,bodyA.force);bodyB.force.vadd(f,bodyB.force);ri.cross(f,ri_x_f);rj.cross(f,rj_x_f);bodyA.torque.vsub(ri_x_f,bodyA.torque);bodyB.torque.vadd(rj_x_f,bodyB.torque)}},{"../math/Vec3":30}],36:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");var Transform=_dereq_("../math/Transform");var RaycastResult=_dereq_("../collision/RaycastResult");var Utils=_dereq_("../utils/Utils");module.exports=WheelInfo;function WheelInfo(options){options=Utils.defaults(options,{chassisConnectionPointLocal:new Vec3,chassisConnectionPointWorld:new Vec3,directionLocal:new Vec3,directionWorld:new Vec3,axleLocal:new Vec3,axleWorld:new Vec3,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:true,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:false,customSlidingRotationalSpeed:-.1});this.maxSuspensionTravel=options.maxSuspensionTravel;this.customSlidingRotationalSpeed=options.customSlidingRotationalSpeed;this.useCustomSlidingRotationalSpeed=options.useCustomSlidingRotationalSpeed;this.sliding=false;this.chassisConnectionPointLocal=options.chassisConnectionPointLocal.clone();this.chassisConnectionPointWorld=options.chassisConnectionPointWorld.clone();this.directionLocal=options.directionLocal.clone();this.directionWorld=options.directionWorld.clone();this.axleLocal=options.axleLocal.clone();this.axleWorld=options.axleWorld.clone();this.suspensionRestLength=options.suspensionRestLength;this.suspensionMaxLength=options.suspensionMaxLength;this.radius=options.radius;this.suspensionStiffness=options.suspensionStiffness;this.dampingCompression=options.dampingCompression;this.dampingRelaxation=options.dampingRelaxation;this.frictionSlip=options.frictionSlip;this.steering=0;this.rotation=0;this.deltaRotation=0;this.rollInfluence=options.rollInfluence;this.maxSuspensionForce=options.maxSuspensionForce;this.engineForce=0;this.brake=0;this.isFrontWheel=options.isFrontWheel;this.clippedInvContactDotSuspension=1;this.suspensionRelativeVelocity=0;this.suspensionForce=0;this.skidInfo=0;this.suspensionLength=0;this.sideImpulse=0;this.forwardImpulse=0;this.raycastResult=new RaycastResult;this.worldTransform=new Transform;this.isInContact=false}var chassis_velocity_at_contactPoint=new Vec3;var relpos=new Vec3;var chassis_velocity_at_contactPoint=new Vec3;WheelInfo.prototype.updateWheel=function(chassis){var raycastResult=this.raycastResult;if(this.isInContact){var project=raycastResult.hitNormalWorld.dot(raycastResult.directionWorld);raycastResult.hitPointWorld.vsub(chassis.position,relpos);chassis.getVelocityAtWorldPoint(relpos,chassis_velocity_at_contactPoint);var projVel=raycastResult.hitNormalWorld.dot(chassis_velocity_at_contactPoint);if(project>=-.1){this.suspensionRelativeVelocity=0;this.clippedInvContactDotSuspension=1/.1}else{var inv=-1/project;this.suspensionRelativeVelocity=projVel*inv;this.clippedInvContactDotSuspension=inv}}else{raycastResult.suspensionLength=this.suspensionRestLength;this.suspensionRelativeVelocity=0;raycastResult.directionWorld.scale(-1,raycastResult.hitNormalWorld);this.clippedInvContactDotSuspension=1}}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(_dereq_,module,exports){module.exports=Box;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var ConvexPolyhedron=_dereq_("./ConvexPolyhedron");function Box(halfExtents){Shape.call(this);this.type=Shape.types.BOX;this.halfExtents=halfExtents;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation();this.updateBoundingSphereRadius()}Box.prototype=new Shape;Box.prototype.constructor=Box;Box.prototype.updateConvexPolyhedronRepresentation=function(){var sx=this.halfExtents.x;var sy=this.halfExtents.y;var sz=this.halfExtents.z;var V=Vec3;var vertices=[new V(-sx,-sy,-sz),new V(sx,-sy,-sz),new V(sx,sy,-sz),new V(-sx,sy,-sz),new V(-sx,-sy,sz),new V(sx,-sy,sz),new V(sx,sy,sz),new V(-sx,sy,sz)];var indices=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];var axes=[new V(0,0,1),new V(0,1,0),new V(1,0,0)];var h=new ConvexPolyhedron(vertices,indices);this.convexPolyhedronRepresentation=h;h.material=this.material};Box.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;Box.calculateInertia(this.halfExtents,mass,target);return target};Box.calculateInertia=function(halfExtents,mass,target){var e=halfExtents;target.x=1/12*mass*(2*e.y*2*e.y+2*e.z*2*e.z);target.y=1/12*mass*(2*e.x*2*e.x+2*e.z*2*e.z);target.z=1/12*mass*(2*e.y*2*e.y+2*e.x*2*e.x)};Box.prototype.getSideNormals=function(sixTargetVectors,quat){var sides=sixTargetVectors;var ex=this.halfExtents;sides[0].set(ex.x,0,0);sides[1].set(0,ex.y,0);sides[2].set(0,0,ex.z);sides[3].set(-ex.x,0,0);sides[4].set(0,-ex.y,0);sides[5].set(0,0,-ex.z);if(quat!==undefined){for(var i=0;i!==sides.length;i++){quat.vmult(sides[i],sides[i])}}return sides};Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};Box.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var worldCornerTempPos=new Vec3;var worldCornerTempNeg=new Vec3;Box.prototype.forEachWorldCorner=function(pos,quat,callback){var e=this.halfExtents;var corners=[[e.x,e.y,e.z],[-e.x,e.y,e.z],[-e.x,-e.y,e.z],[-e.x,-e.y,-e.z],[e.x,-e.y,-e.z],[e.x,e.y,-e.z],[-e.x,e.y,-e.z],[e.x,-e.y,e.z]];for(var i=0;i<corners.length;i++){worldCornerTempPos.set(corners[i][0],corners[i][1],corners[i][2]);quat.vmult(worldCornerTempPos,worldCornerTempPos);pos.vadd(worldCornerTempPos,worldCornerTempPos);callback(worldCornerTempPos.x,worldCornerTempPos.y,worldCornerTempPos.z)}};var worldCornersTemp=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];Box.prototype.calculateWorldAABB=function(pos,quat,min,max){var e=this.halfExtents;worldCornersTemp[0].set(e.x,e.y,e.z);worldCornersTemp[1].set(-e.x,e.y,e.z);worldCornersTemp[2].set(-e.x,-e.y,e.z);worldCornersTemp[3].set(-e.x,-e.y,-e.z);worldCornersTemp[4].set(e.x,-e.y,-e.z);worldCornersTemp[5].set(e.x,e.y,-e.z);worldCornersTemp[6].set(-e.x,e.y,-e.z);worldCornersTemp[7].set(e.x,-e.y,e.z);var wc=worldCornersTemp[0];quat.vmult(wc,wc);pos.vadd(wc,wc);max.copy(wc);min.copy(wc);for(var i=1;i<8;i++){var wc=worldCornersTemp[i];quat.vmult(wc,wc);pos.vadd(wc,wc);var x=wc.x;var y=wc.y;var z=wc.z;if(x>max.x){max.x=x}if(y>max.y){max.y=y}if(z>max.z){max.z=z}if(x<min.x){min.x=x}if(y<min.y){min.y=y}if(z<min.z){min.z=z}}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(_dereq_,module,exports){module.exports=ConvexPolyhedron;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Transform=_dereq_("../math/Transform");function ConvexPolyhedron(points,faces,uniqueAxes){var that=this;Shape.call(this);this.type=Shape.types.CONVEXPOLYHEDRON;this.vertices=points||[];this.worldVertices=[];this.worldVerticesNeedsUpdate=true;this.faces=faces||[];this.faceNormals=[];this.computeNormals();this.worldFaceNormalsNeedsUpdate=true;this.worldFaceNormals=[];this.uniqueEdges=[];this.uniqueAxes=uniqueAxes?uniqueAxes.slice():null;this.computeEdges();this.updateBoundingSphereRadius()}ConvexPolyhedron.prototype=new Shape;ConvexPolyhedron.prototype.constructor=ConvexPolyhedron;var computeEdges_tmpEdge=new Vec3;ConvexPolyhedron.prototype.computeEdges=function(){var faces=this.faces;var vertices=this.vertices;var nv=vertices.length;var edges=this.uniqueEdges;edges.length=0;var edge=computeEdges_tmpEdge;for(var i=0;i!==faces.length;i++){var face=faces[i];var numVertices=face.length;for(var j=0;j!==numVertices;j++){var k=(j+1)%numVertices;vertices[face[j]].vsub(vertices[face[k]],edge);edge.normalize();var found=false;for(var p=0;p!==edges.length;p++){if(edges[p].almostEquals(edge)||edges[p].almostEquals(edge)){found=true;break}}if(!found){edges.push(edge.clone())}}}};ConvexPolyhedron.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var i=0;i<this.faces.length;i++){for(var j=0;j<this.faces[i].length;j++){if(!this.vertices[this.faces[i][j]]){throw new Error("Vertex "+this.faces[i][j]+" not found!")}}var n=this.faceNormals[i]||new Vec3;this.getFaceNormal(i,n);n.negate(n);this.faceNormals[i]=n;var vertex=this.vertices[this.faces[i][0]];if(n.dot(vertex)<0){console.error(".faceNormals["+i+"] = Vec3("+n.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var j=0;j<this.faces[i].length;j++){console.warn(".vertices["+this.faces[i][j]+"] = Vec3("+this.vertices[this.faces[i][j]].toString()+")")}}}};var cb=new Vec3;var ab=new Vec3;ConvexPolyhedron.computeNormal=function(va,vb,vc,target){vb.vsub(va,ab);vc.vsub(vb,cb);cb.cross(ab,target);if(!target.isZero()){target.normalize()}};ConvexPolyhedron.prototype.getFaceNormal=function(i,target){var f=this.faces[i];var va=this.vertices[f[0]];var vb=this.vertices[f[1]];var vc=this.vertices[f[2]];return ConvexPolyhedron.computeNormal(va,vb,vc,target)};var cah_WorldNormal=new Vec3;ConvexPolyhedron.prototype.clipAgainstHull=function(posA,quatA,hullB,posB,quatB,separatingNormal,minDist,maxDist,result){var WorldNormal=cah_WorldNormal;var hullA=this;var curMaxDist=maxDist;var closestFaceB=-1;var dmax=-Number.MAX_VALUE;for(var face=0;face<hullB.faces.length;face++){WorldNormal.copy(hullB.faceNormals[face]);quatB.vmult(WorldNormal,WorldNormal);var d=WorldNormal.dot(separatingNormal);if(d>dmax){dmax=d;closestFaceB=face}}var worldVertsB1=[];var polyB=hullB.faces[closestFaceB];var numVertices=polyB.length;for(var e0=0;e0<numVertices;e0++){var b=hullB.vertices[polyB[e0]];var worldb=new Vec3;worldb.copy(b);quatB.vmult(worldb,worldb);posB.vadd(worldb,worldb);worldVertsB1.push(worldb)}if(closestFaceB>=0){this.clipFaceAgainstHull(separatingNormal,posA,quatA,worldVertsB1,minDist,maxDist,result)}};var fsa_faceANormalWS3=new Vec3,fsa_Worldnormal1=new Vec3,fsa_deltaC=new Vec3,fsa_worldEdge0=new Vec3,fsa_worldEdge1=new Vec3,fsa_Cross=new Vec3;ConvexPolyhedron.prototype.findSeparatingAxis=function(hullB,posA,quatA,posB,quatB,target,faceListA,faceListB){var faceANormalWS3=fsa_faceANormalWS3,Worldnormal1=fsa_Worldnormal1,deltaC=fsa_deltaC,worldEdge0=fsa_worldEdge0,worldEdge1=fsa_worldEdge1,Cross=fsa_Cross;var dmin=Number.MAX_VALUE;var hullA=this;var curPlaneTests=0;if(!hullA.uniqueAxes){var numFacesA=faceListA?faceListA.length:hullA.faces.length;for(var i=0;i<numFacesA;i++){var fi=faceListA?faceListA[i]:i;faceANormalWS3.copy(hullA.faceNormals[fi]);quatA.vmult(faceANormalWS3,faceANormalWS3);var d=hullA.testSepAxis(faceANormalWS3,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(faceANormalWS3)}}}else{for(var i=0;i!==hullA.uniqueAxes.length;i++){quatA.vmult(hullA.uniqueAxes[i],faceANormalWS3);var d=hullA.testSepAxis(faceANormalWS3,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(faceANormalWS3)}}}if(!hullB.uniqueAxes){var numFacesB=faceListB?faceListB.length:hullB.faces.length;for(var i=0;i<numFacesB;i++){var fi=faceListB?faceListB[i]:i;Worldnormal1.copy(hullB.faceNormals[fi]);quatB.vmult(Worldnormal1,Worldnormal1);curPlaneTests++;var d=hullA.testSepAxis(Worldnormal1,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(Worldnormal1)}}}else{for(var i=0;i!==hullB.uniqueAxes.length;i++){quatB.vmult(hullB.uniqueAxes[i],Worldnormal1);curPlaneTests++;var d=hullA.testSepAxis(Worldnormal1,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(Worldnormal1)}}}for(var e0=0;e0!==hullA.uniqueEdges.length;e0++){quatA.vmult(hullA.uniqueEdges[e0],worldEdge0);for(var e1=0;e1!==hullB.uniqueEdges.length;e1++){quatB.vmult(hullB.uniqueEdges[e1],worldEdge1);worldEdge0.cross(worldEdge1,Cross);if(!Cross.almostZero()){Cross.normalize();var dist=hullA.testSepAxis(Cross,hullB,posA,quatA,posB,quatB);if(dist===false){return false}if(dist<dmin){dmin=dist;target.copy(Cross)}}}}posB.vsub(posA,deltaC);if(deltaC.dot(target)>0){target.negate(target)}return true};var maxminA=[],maxminB=[];ConvexPolyhedron.prototype.testSepAxis=function(axis,hullB,posA,quatA,posB,quatB){var hullA=this;ConvexPolyhedron.project(hullA,axis,posA,quatA,maxminA);ConvexPolyhedron.project(hullB,axis,posB,quatB,maxminB);var maxA=maxminA[0];var minA=maxminA[1];var maxB=maxminB[0];var minB=maxminB[1];if(maxA<minB||maxB<minA){return false}var d0=maxA-minB;var d1=maxB-minA;var depth=d0<d1?d0:d1;return depth};var cli_aabbmin=new Vec3,cli_aabbmax=new Vec3;ConvexPolyhedron.prototype.calculateLocalInertia=function(mass,target){this.computeLocalAABB(cli_aabbmin,cli_aabbmax);var x=cli_aabbmax.x-cli_aabbmin.x,y=cli_aabbmax.y-cli_aabbmin.y,z=cli_aabbmax.z-cli_aabbmin.z;target.x=1/12*mass*(2*y*2*y+2*z*2*z);target.y=1/12*mass*(2*x*2*x+2*z*2*z);target.z=1/12*mass*(2*y*2*y+2*x*2*x)};ConvexPolyhedron.prototype.getPlaneConstantOfFace=function(face_i){var f=this.faces[face_i];var n=this.faceNormals[face_i];var v=this.vertices[f[0]];var c=-n.dot(v);return c};var cfah_faceANormalWS=new Vec3,cfah_edge0=new Vec3,cfah_WorldEdge0=new Vec3,cfah_worldPlaneAnormal1=new Vec3,cfah_planeNormalWS1=new Vec3,cfah_worldA1=new Vec3,cfah_localPlaneNormal=new Vec3,cfah_planeNormalWS=new Vec3;ConvexPolyhedron.prototype.clipFaceAgainstHull=function(separatingNormal,posA,quatA,worldVertsB1,minDist,maxDist,result){var faceANormalWS=cfah_faceANormalWS,edge0=cfah_edge0,WorldEdge0=cfah_WorldEdge0,worldPlaneAnormal1=cfah_worldPlaneAnormal1,planeNormalWS1=cfah_planeNormalWS1,worldA1=cfah_worldA1,localPlaneNormal=cfah_localPlaneNormal,planeNormalWS=cfah_planeNormalWS;var hullA=this;var worldVertsB2=[];var pVtxIn=worldVertsB1;var pVtxOut=worldVertsB2;var closestFaceA=-1;var dmin=Number.MAX_VALUE;for(var face=0;face<hullA.faces.length;face++){faceANormalWS.copy(hullA.faceNormals[face]);quatA.vmult(faceANormalWS,faceANormalWS);var d=faceANormalWS.dot(separatingNormal);if(d<dmin){dmin=d;closestFaceA=face}}if(closestFaceA<0){return}var polyA=hullA.faces[closestFaceA];polyA.connectedFaces=[];for(var i=0;i<hullA.faces.length;i++){for(var j=0;j<hullA.faces[i].length;j++){if(polyA.indexOf(hullA.faces[i][j])!==-1&&i!==closestFaceA&&polyA.connectedFaces.indexOf(i)===-1){polyA.connectedFaces.push(i)}}}var numContacts=pVtxIn.length;var numVerticesA=polyA.length;var res=[];for(var e0=0;e0<numVerticesA;e0++){var a=hullA.vertices[polyA[e0]];var b=hullA.vertices[polyA[(e0+1)%numVerticesA]];a.vsub(b,edge0);WorldEdge0.copy(edge0);quatA.vmult(WorldEdge0,WorldEdge0);posA.vadd(WorldEdge0,WorldEdge0);worldPlaneAnormal1.copy(this.faceNormals[closestFaceA]);quatA.vmult(worldPlaneAnormal1,worldPlaneAnormal1);posA.vadd(worldPlaneAnormal1,worldPlaneAnormal1);WorldEdge0.cross(worldPlaneAnormal1,planeNormalWS1);planeNormalWS1.negate(planeNormalWS1);worldA1.copy(a);quatA.vmult(worldA1,worldA1);posA.vadd(worldA1,worldA1);var planeEqWS1=-worldA1.dot(planeNormalWS1);var planeEqWS;if(true){var otherFace=polyA.connectedFaces[e0];localPlaneNormal.copy(this.faceNormals[otherFace]);var localPlaneEq=this.getPlaneConstantOfFace(otherFace);planeNormalWS.copy(localPlaneNormal);quatA.vmult(planeNormalWS,planeNormalWS);var planeEqWS=localPlaneEq-planeNormalWS.dot(posA)}else{planeNormalWS.copy(planeNormalWS1);planeEqWS=planeEqWS1}this.clipFaceAgainstPlane(pVtxIn,pVtxOut,planeNormalWS,planeEqWS);while(pVtxIn.length){pVtxIn.shift()}while(pVtxOut.length){pVtxIn.push(pVtxOut.shift())}}localPlaneNormal.copy(this.faceNormals[closestFaceA]);var localPlaneEq=this.getPlaneConstantOfFace(closestFaceA);planeNormalWS.copy(localPlaneNormal);quatA.vmult(planeNormalWS,planeNormalWS);var planeEqWS=localPlaneEq-planeNormalWS.dot(posA);for(var i=0;i<pVtxIn.length;i++){var depth=planeNormalWS.dot(pVtxIn[i])+planeEqWS;if(depth<=minDist){console.log("clamped: depth="+depth+" to minDist="+(minDist+""));depth=minDist}if(depth<=maxDist){var point=pVtxIn[i];if(depth<=0){var p={point:point,normal:planeNormalWS,depth:depth};result.push(p)}}}};ConvexPolyhedron.prototype.clipFaceAgainstPlane=function(inVertices,outVertices,planeNormal,planeConstant){var n_dot_first,n_dot_last;var numVerts=inVertices.length;if(numVerts<2){return outVertices}var firstVertex=inVertices[inVertices.length-1],lastVertex=inVertices[0];n_dot_first=planeNormal.dot(firstVertex)+planeConstant;for(var vi=0;vi<numVerts;vi++){lastVertex=inVertices[vi];n_dot_last=planeNormal.dot(lastVertex)+planeConstant;if(n_dot_first<0){if(n_dot_last<0){var newv=new Vec3;newv.copy(lastVertex);outVertices.push(newv)}else{var newv=new Vec3;firstVertex.lerp(lastVertex,n_dot_first/(n_dot_first-n_dot_last),newv);outVertices.push(newv)}}else{if(n_dot_last<0){var newv=new Vec3;firstVertex.lerp(lastVertex,n_dot_first/(n_dot_first-n_dot_last),newv);outVertices.push(newv);outVertices.push(lastVertex)}}firstVertex=lastVertex;n_dot_first=n_dot_last}return outVertices};ConvexPolyhedron.prototype.computeWorldVertices=function(position,quat){var N=this.vertices.length;while(this.worldVertices.length<N){this.worldVertices.push(new Vec3)}var verts=this.vertices,worldVerts=this.worldVertices;for(var i=0;i!==N;i++){quat.vmult(verts[i],worldVerts[i]);position.vadd(worldVerts[i],worldVerts[i])}this.worldVerticesNeedsUpdate=false};var computeLocalAABB_worldVert=new Vec3;ConvexPolyhedron.prototype.computeLocalAABB=function(aabbmin,aabbmax){var n=this.vertices.length,vertices=this.vertices,worldVert=computeLocalAABB_worldVert;aabbmin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);aabbmax.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<n;i++){var v=vertices[i];if(v.x<aabbmin.x){aabbmin.x=v.x}else if(v.x>aabbmax.x){aabbmax.x=v.x}if(v.y<aabbmin.y){aabbmin.y=v.y}else if(v.y>aabbmax.y){aabbmax.y=v.y}if(v.z<aabbmin.z){aabbmin.z=v.z}else if(v.z>aabbmax.z){aabbmax.z=v.z}}};ConvexPolyhedron.prototype.computeWorldFaceNormals=function(quat){var N=this.faceNormals.length;while(this.worldFaceNormals.length<N){this.worldFaceNormals.push(new Vec3)}var normals=this.faceNormals,worldNormals=this.worldFaceNormals;for(var i=0;i!==N;i++){quat.vmult(normals[i],worldNormals[i])}this.worldFaceNormalsNeedsUpdate=false};ConvexPolyhedron.prototype.updateBoundingSphereRadius=function(){var max2=0;var verts=this.vertices;for(var i=0,N=verts.length;i!==N;i++){var norm2=verts[i].norm2();if(norm2>max2){max2=norm2}}this.boundingSphereRadius=Math.sqrt(max2)};var tempWorldVertex=new Vec3;ConvexPolyhedron.prototype.calculateWorldAABB=function(pos,quat,min,max){var n=this.vertices.length,verts=this.vertices;var minx,miny,minz,maxx,maxy,maxz;for(var i=0;i<n;i++){tempWorldVertex.copy(verts[i]);quat.vmult(tempWorldVertex,tempWorldVertex);pos.vadd(tempWorldVertex,tempWorldVertex);var v=tempWorldVertex;if(v.x<minx||minx===undefined){minx=v.x}else if(v.x>maxx||maxx===undefined){maxx=v.x}if(v.y<miny||miny===undefined){miny=v.y}else if(v.y>maxy||maxy===undefined){maxy=v.y}if(v.z<minz||minz===undefined){minz=v.z}else if(v.z>maxz||maxz===undefined){maxz=v.z}}min.set(minx,miny,minz);max.set(maxx,maxy,maxz)};ConvexPolyhedron.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};ConvexPolyhedron.prototype.getAveragePointLocal=function(target){target=target||new Vec3;var n=this.vertices.length,verts=this.vertices;for(var i=0;i<n;i++){target.vadd(verts[i],target)}target.mult(1/n,target);return target};ConvexPolyhedron.prototype.transformAllPoints=function(offset,quat){var n=this.vertices.length,verts=this.vertices;if(quat){for(var i=0;i<n;i++){var v=verts[i];quat.vmult(v,v)}for(var i=0;i<this.faceNormals.length;i++){var v=this.faceNormals[i];quat.vmult(v,v)}}if(offset){for(var i=0;i<n;i++){var v=verts[i];v.vadd(offset,v)}}};var ConvexPolyhedron_pointIsInside=new Vec3;var ConvexPolyhedron_vToP=new Vec3;var ConvexPolyhedron_vToPointInside=new Vec3;ConvexPolyhedron.prototype.pointIsInside=function(p){var n=this.vertices.length,verts=this.vertices,faces=this.faces,normals=this.faceNormals;var positiveResult=null;var N=this.faces.length;var pointInside=ConvexPolyhedron_pointIsInside;this.getAveragePointLocal(pointInside);for(var i=0;i<N;i++){var numVertices=this.faces[i].length;var n=normals[i];var v=verts[faces[i][0]];var vToP=ConvexPolyhedron_vToP;p.vsub(v,vToP);var r1=n.dot(vToP);var vToPointInside=ConvexPolyhedron_vToPointInside;pointInside.vsub(v,vToPointInside);var r2=n.dot(vToPointInside);if(r1<0&&r2>0||r1>0&&r2<0){return false}else{}}return positiveResult?1:-1};var project_worldVertex=new Vec3;var project_localAxis=new Vec3;var project_localOrigin=new Vec3;ConvexPolyhedron.project=function(hull,axis,pos,quat,result){var n=hull.vertices.length,worldVertex=project_worldVertex,localAxis=project_localAxis,max=0,min=0,localOrigin=project_localOrigin,vs=hull.vertices;localOrigin.setZero();Transform.vectorToLocalFrame(pos,quat,axis,localAxis);Transform.pointToLocalFrame(pos,quat,localOrigin,localOrigin);var add=localOrigin.dot(localAxis);min=max=vs[0].dot(localAxis);for(var i=1;i<n;i++){var val=vs[i].dot(localAxis);if(val>max){max=val}if(val<min){min=val}}min-=add;max-=add;if(min>max){var temp=min;min=max;max=temp}result[0]=max;result[1]=min}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(_dereq_,module,exports){module.exports=Cylinder;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var ConvexPolyhedron=_dereq_("./ConvexPolyhedron");function Cylinder(radiusTop,radiusBottom,height,numSegments){var N=numSegments,verts=[],axes=[],faces=[],bottomface=[],topface=[],cos=Math.cos,sin=Math.sin;verts.push(new Vec3(radiusBottom*cos(0),radiusBottom*sin(0),-height*.5));bottomface.push(0);verts.push(new Vec3(radiusTop*cos(0),radiusTop*sin(0),height*.5));topface.push(1);for(var i=0;i<N;i++){var theta=2*Math.PI/N*(i+1);var thetaN=2*Math.PI/N*(i+.5);if(i<N-1){verts.push(new Vec3(radiusBottom*cos(theta),radiusBottom*sin(theta),-height*.5));bottomface.push(2*i+2);verts.push(new Vec3(radiusTop*cos(theta),radiusTop*sin(theta),height*.5));topface.push(2*i+3);faces.push([2*i+2,2*i+3,2*i+1,2*i])}else{faces.push([0,1,2*i+1,2*i])}if(N%2===1||i<N/2){axes.push(new Vec3(cos(thetaN),sin(thetaN),0))}}faces.push(topface);axes.push(new Vec3(0,0,1));var temp=[];for(var i=0;i<bottomface.length;i++){temp.push(bottomface[bottomface.length-i-1])}faces.push(temp);this.type=Shape.types.CONVEXPOLYHEDRON;ConvexPolyhedron.call(this,verts,faces,axes)}Cylinder.prototype=new ConvexPolyhedron},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape");var ConvexPolyhedron=_dereq_("./ConvexPolyhedron");var Vec3=_dereq_("../math/Vec3");var Utils=_dereq_("../utils/Utils");module.exports=Heightfield;function Heightfield(data,options){options=Utils.defaults(options,{maxValue:null,minValue:null,elementSize:1});this.data=data;this.maxValue=options.maxValue;this.minValue=options.minValue;this.elementSize=options.elementSize;if(options.minValue===null){this.updateMinValue()}if(options.maxValue===null){this.updateMaxValue()}this.cacheEnabled=true;Shape.call(this);this.pillarConvex=new ConvexPolyhedron;this.pillarOffset=new Vec3;this.type=Shape.types.HEIGHTFIELD;this.updateBoundingSphereRadius();this._cachedPillars={}}Heightfield.prototype=new Shape;Heightfield.prototype.update=function(){this._cachedPillars={}};Heightfield.prototype.updateMinValue=function(){var data=this.data;var minValue=data[0][0];for(var i=0;i!==data.length;i++){for(var j=0;j!==data[i].length;j++){var v=data[i][j];if(v<minValue){minValue=v}}}this.minValue=minValue};Heightfield.prototype.updateMaxValue=function(){var data=this.data;var maxValue=data[0][0];for(var i=0;i!==data.length;i++){for(var j=0;j!==data[i].length;j++){var v=data[i][j];if(v>maxValue){maxValue=v}}}this.maxValue=maxValue};Heightfield.prototype.setHeightValueAtIndex=function(xi,yi,value){var data=this.data;data[xi][yi]=value;this.clearCachedConvexTrianglePillar(xi,yi,false);if(xi>0){this.clearCachedConvexTrianglePillar(xi-1,yi,true);this.clearCachedConvexTrianglePillar(xi-1,yi,false)}if(yi>0){this.clearCachedConvexTrianglePillar(xi,yi-1,true);this.clearCachedConvexTrianglePillar(xi,yi-1,false)}if(yi>0&&xi>0){this.clearCachedConvexTrianglePillar(xi-1,yi-1,true)}};Heightfield.prototype.getRectMinMax=function(iMinX,iMinY,iMaxX,iMaxY,result){result=result||[];var data=this.data,max=this.minValue;for(var i=iMinX;i<=iMaxX;i++){for(var j=iMinY;j<=iMaxY;j++){var height=data[i][j];if(height>max){max=height}}}result[0]=this.minValue;result[1]=max};Heightfield.prototype.getIndexOfPosition=function(x,y,result,clamp){var w=this.elementSize;var data=this.data;var xi=Math.floor(x/w);var yi=Math.floor(y/w);result[0]=xi;result[1]=yi;if(clamp){if(xi<0){xi=0}if(yi<0){yi=0}if(xi>=data.length-1){xi=data.length-1}if(yi>=data[0].length-1){yi=data[0].length-1}}if(xi<0||yi<0||xi>=data.length-1||yi>=data[0].length-1){return false}return true};Heightfield.prototype.getHeightAt=function(x,y,edgeClamp){var idx=[];this.getIndexOfPosition(x,y,idx,edgeClamp);var minmax=[];this.getRectMinMax(idx[0],idx[1]+1,idx[0],idx[1]+1,minmax);return(minmax[0]+minmax[1])/2};Heightfield.prototype.getCacheConvexTrianglePillarKey=function(xi,yi,getUpperTriangle){return xi+"_"+yi+"_"+(getUpperTriangle?1:0)};Heightfield.prototype.getCachedConvexTrianglePillar=function(xi,yi,getUpperTriangle){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(xi,yi,getUpperTriangle)]};Heightfield.prototype.setCachedConvexTrianglePillar=function(xi,yi,getUpperTriangle,convex,offset){this._cachedPillars[this.getCacheConvexTrianglePillarKey(xi,yi,getUpperTriangle)]={convex:convex,offset:offset}};Heightfield.prototype.clearCachedConvexTrianglePillar=function(xi,yi,getUpperTriangle){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(xi,yi,getUpperTriangle)]};Heightfield.prototype.getConvexTrianglePillar=function(xi,yi,getUpperTriangle){var result=this.pillarConvex;var offsetResult=this.pillarOffset;if(this.cacheEnabled){var data=this.getCachedConvexTrianglePillar(xi,yi,getUpperTriangle);if(data){this.pillarConvex=data.convex;this.pillarOffset=data.offset;return}result=new ConvexPolyhedron;offsetResult=new Vec3;this.pillarConvex=result;this.pillarOffset=offsetResult}var data=this.data;var elementSize=this.elementSize;var faces=result.faces;result.vertices.length=6;for(var i=0;i<6;i++){if(!result.vertices[i]){result.vertices[i]=new Vec3}}faces.length=5;for(var i=0;i<5;i++){if(!faces[i]){faces[i]=[]}}var verts=result.vertices;var h=(Math.min(data[xi][yi],data[xi+1][yi],data[xi][yi+1],data[xi+1][yi+1])-this.minValue)/2+this.minValue;if(!getUpperTriangle){offsetResult.set((xi+.25)*elementSize,(yi+.25)*elementSize,h);verts[0].set(-.25*elementSize,-.25*elementSize,data[xi][yi]-h);verts[1].set(.75*elementSize,-.25*elementSize,data[xi+1][yi]-h);verts[2].set(-.25*elementSize,.75*elementSize,data[xi][yi+1]-h);verts[3].set(-.25*elementSize,-.25*elementSize,-h-1);verts[4].set(.75*elementSize,-.25*elementSize,-h-1);verts[5].set(-.25*elementSize,.75*elementSize,-h-1);faces[0][0]=0;faces[0][1]=1;faces[0][2]=2;faces[1][0]=5;faces[1][1]=4;faces[1][2]=3;faces[2][0]=0;faces[2][1]=2;faces[2][2]=5;faces[2][3]=3;faces[3][0]=1;faces[3][1]=0;faces[3][2]=3;faces[3][3]=4;faces[4][0]=4;faces[4][1]=5;faces[4][2]=2;faces[4][3]=1}else{offsetResult.set((xi+.75)*elementSize,(yi+.75)*elementSize,h);verts[0].set(.25*elementSize,.25*elementSize,data[xi+1][yi+1]-h);verts[1].set(-.75*elementSize,.25*elementSize,data[xi][yi+1]-h);verts[2].set(.25*elementSize,-.75*elementSize,data[xi+1][yi]-h);verts[3].set(.25*elementSize,.25*elementSize,-h-1);verts[4].set(-.75*elementSize,.25*elementSize,-h-1);verts[5].set(.25*elementSize,-.75*elementSize,-h-1);faces[0][0]=0;faces[0][1]=1;faces[0][2]=2;faces[1][0]=5;faces[1][1]=4;faces[1][2]=3;faces[2][0]=2;faces[2][1]=5;faces[2][2]=3;faces[2][3]=0;faces[3][0]=3;faces[3][1]=4;faces[3][2]=1;faces[3][3]=0;faces[4][0]=1;faces[4][1]=4;faces[4][2]=5;faces[4][3]=2}result.computeNormals();result.computeEdges();result.updateBoundingSphereRadius();this.setCachedConvexTrianglePillar(xi,yi,getUpperTriangle,result,offsetResult)};Heightfield.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;target.set(0,0,0);return target};Heightfield.prototype.volume=function(){return Number.MAX_VALUE};Heightfield.prototype.calculateWorldAABB=function(pos,quat,min,max){min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};Heightfield.prototype.updateBoundingSphereRadius=function(){var data=this.data,s=this.elementSize;this.boundingSphereRadius=new Vec3(data.length*s,data[0].length*s,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(_dereq_,module,exports){module.exports=Particle;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");function Particle(){Shape.call(this);this.type=Shape.types.PARTICLE}Particle.prototype=new Shape;Particle.prototype.constructor=Particle;Particle.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;target.set(0,0,0);return target};Particle.prototype.volume=function(){return 0};Particle.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0};Particle.prototype.calculateWorldAABB=function(pos,quat,min,max){min.copy(pos);max.copy(pos)}},{"../math/Vec3":30,"./Shape":43}],42:[function(_dereq_,module,exports){module.exports=Plane;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");function Plane(){Shape.call(this);this.type=Shape.types.PLANE;this.worldNormal=new Vec3;this.worldNormalNeedsUpdate=true;this.boundingSphereRadius=Number.MAX_VALUE}Plane.prototype=new Shape;Plane.prototype.constructor=Plane;Plane.prototype.computeWorldNormal=function(quat){var n=this.worldNormal;n.set(0,0,1);quat.vmult(n,n);this.worldNormalNeedsUpdate=false};Plane.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;return target};Plane.prototype.volume=function(){return Number.MAX_VALUE};var tempNormal=new Vec3;Plane.prototype.calculateWorldAABB=function(pos,quat,min,max){tempNormal.set(0,0,1);quat.vmult(tempNormal,tempNormal);var maxVal=Number.MAX_VALUE;min.set(-maxVal,-maxVal,-maxVal);max.set(maxVal,maxVal,maxVal);if(tempNormal.x===1){max.x=pos.x}if(tempNormal.y===1){max.y=pos.y}if(tempNormal.z===1){max.z=pos.z}if(tempNormal.x===-1){min.x=pos.x}if(tempNormal.y===-1){min.y=pos.y}if(tempNormal.z===-1){min.z=pos.z}};Plane.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(_dereq_,module,exports){module.exports=Shape;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Material=_dereq_("../material/Material");function Shape(){this.id=Shape.idCounter++;this.type=0;this.boundingSphereRadius=0;this.collisionResponse=true;this.material=null}Shape.prototype.constructor=Shape;Shape.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type};Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type};Shape.prototype.calculateLocalInertia=function(mass,target){throw"calculateLocalInertia() not implemented for shape type "+this.type};Shape.idCounter=0;Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(_dereq_,module,exports){module.exports=Sphere;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");function Sphere(radius){Shape.call(this);this.radius=radius!==undefined?Number(radius):1;this.type=Shape.types.SPHERE;if(this.radius<0){throw new Error("The sphere radius cannot be negative.")}this.updateBoundingSphereRadius()}Sphere.prototype=new Shape;Sphere.prototype.constructor=Sphere;Sphere.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;var I=2*mass*this.radius*this.radius/5;target.x=I;target.y=I;target.z=I;return target};Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3};Sphere.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius};Sphere.prototype.calculateWorldAABB=function(pos,quat,min,max){var r=this.radius;var axes=["x","y","z"];for(var i=0;i<axes.length;i++){var ax=axes[i];min[ax]=pos[ax]-r;max[ax]=pos[ax]+r}}},{"../math/Vec3":30,"./Shape":43}],45:[function(_dereq_,module,exports){module.exports=Trimesh;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Transform=_dereq_("../math/Transform");var AABB=_dereq_("../collision/AABB");var Octree=_dereq_("../utils/Octree");function Trimesh(vertices,indices){Shape.call(this);this.type=Shape.types.TRIMESH;this.vertices=new Float32Array(vertices);this.indices=new Int16Array(indices);this.normals=new Float32Array(indices.length);this.aabb=new AABB;this.edges=null;this.scale=new Vec3(1,1,1);this.tree=new Octree;this.updateEdges();this.updateNormals();this.updateAABB();this.updateBoundingSphereRadius();this.updateTree()}Trimesh.prototype=new Shape;Trimesh.prototype.constructor=Trimesh;var computeNormals_n=new Vec3;Trimesh.prototype.updateTree=function(){var tree=this.tree;tree.reset();tree.aabb.copy(this.aabb);var scale=this.scale;tree.aabb.lowerBound.x*=1/scale.x;tree.aabb.lowerBound.y*=1/scale.y;tree.aabb.lowerBound.z*=1/scale.z;tree.aabb.upperBound.x*=1/scale.x;tree.aabb.upperBound.y*=1/scale.y;tree.aabb.upperBound.z*=1/scale.z;var triangleAABB=new AABB;var a=new Vec3;var b=new Vec3;var c=new Vec3;var points=[a,b,c];for(var i=0;i<this.indices.length/3;i++){var i3=i*3;this._getUnscaledVertex(this.indices[i3],a);this._getUnscaledVertex(this.indices[i3+1],b);this._getUnscaledVertex(this.indices[i3+2],c);triangleAABB.setFromPoints(points);tree.insert(triangleAABB,i)}tree.removeEmptyNodes()};var unscaledAABB=new AABB;Trimesh.prototype.getTrianglesInAABB=function(aabb,result){unscaledAABB.copy(aabb);var scale=this.scale;var isx=scale.x;var isy=scale.y;var isz=scale.z;var l=unscaledAABB.lowerBound;var u=unscaledAABB.upperBound;l.x/=isx;l.y/=isy;l.z/=isz;u.x/=isx;u.y/=isy;u.z/=isz;return this.tree.aabbQuery(unscaledAABB,result)};Trimesh.prototype.setScale=function(scale){var wasUniform=this.scale.x===this.scale.y===this.scale.z;var isUniform=scale.x===scale.y===scale.z;if(!(wasUniform&&isUniform)){this.updateNormals()}this.scale.copy(scale);this.updateAABB();this.updateBoundingSphereRadius()};Trimesh.prototype.updateNormals=function(){var n=computeNormals_n;var normals=this.normals;for(var i=0;i<this.indices.length/3;i++){var i3=i*3;var a=this.indices[i3],b=this.indices[i3+1],c=this.indices[i3+2];this.getVertex(a,va);this.getVertex(b,vb);this.getVertex(c,vc);Trimesh.computeNormal(vb,va,vc,n);normals[i3]=n.x;normals[i3+1]=n.y;normals[i3+2]=n.z}};Trimesh.prototype.updateEdges=function(){var edges={};var add=function(indexA,indexB){var key=a<b?a+"_"+b:b+"_"+a;edges[key]=true};for(var i=0;i<this.indices.length/3;i++){var i3=i*3;var a=this.indices[i3],b=this.indices[i3+1],c=this.indices[i3+2];add(a,b);add(b,c);add(c,a)}var keys=Object.keys(edges);this.edges=new Int16Array(keys.length*2);for(var i=0;i<keys.length;i++){var indices=keys[i].split("_");this.edges[2*i]=parseInt(indices[0],10);this.edges[2*i+1]=parseInt(indices[1],10)}};Trimesh.prototype.getEdgeVertex=function(edgeIndex,firstOrSecond,vertexStore){var vertexIndex=this.edges[edgeIndex*2+(firstOrSecond?1:0)];this.getVertex(vertexIndex,vertexStore)};var getEdgeVector_va=new Vec3;var getEdgeVector_vb=new Vec3;Trimesh.prototype.getEdgeVector=function(edgeIndex,vectorStore){var va=getEdgeVector_va;var vb=getEdgeVector_vb;this.getEdgeVertex(edgeIndex,0,va);this.getEdgeVertex(edgeIndex,1,vb);vb.vsub(va,vectorStore)};var cb=new Vec3;var ab=new Vec3;Trimesh.computeNormal=function(va,vb,vc,target){vb.vsub(va,ab);vc.vsub(vb,cb);cb.cross(ab,target);if(!target.isZero()){target.normalize()}};var va=new Vec3;var vb=new Vec3;var vc=new Vec3;Trimesh.prototype.getVertex=function(i,out){var scale=this.scale;this._getUnscaledVertex(i,out);out.x*=scale.x;out.y*=scale.y;out.z*=scale.z;return out};Trimesh.prototype._getUnscaledVertex=function(i,out){var i3=i*3;var vertices=this.vertices;return out.set(vertices[i3],vertices[i3+1],vertices[i3+2])};Trimesh.prototype.getWorldVertex=function(i,pos,quat,out){this.getVertex(i,out);Transform.pointToWorldFrame(pos,quat,out,out);return out};Trimesh.prototype.getTriangleVertices=function(i,a,b,c){var i3=i*3;this.getVertex(this.indices[i3],a);this.getVertex(this.indices[i3+1],b);this.getVertex(this.indices[i3+2],c)};Trimesh.prototype.getNormal=function(i,target){var i3=i*3;return target.set(this.normals[i3],this.normals[i3+1],this.normals[i3+2])};var cli_aabb=new AABB;Trimesh.prototype.calculateLocalInertia=function(mass,target){this.computeLocalAABB(cli_aabb);var x=cli_aabb.upperBound.x-cli_aabb.lowerBound.x,y=cli_aabb.upperBound.y-cli_aabb.lowerBound.y,z=cli_aabb.upperBound.z-cli_aabb.lowerBound.z;return target.set(1/12*mass*(2*y*2*y+2*z*2*z),1/12*mass*(2*x*2*x+2*z*2*z),1/12*mass*(2*y*2*y+2*x*2*x))};var computeLocalAABB_worldVert=new Vec3;Trimesh.prototype.computeLocalAABB=function(aabb){var l=aabb.lowerBound,u=aabb.upperBound,n=this.vertices.length,vertices=this.vertices,v=computeLocalAABB_worldVert;this.getVertex(0,v);l.copy(v);u.copy(v);for(var i=0;i!==n;i++){this.getVertex(i,v);if(v.x<l.x){l.x=v.x}else if(v.x>u.x){u.x=v.x}if(v.y<l.y){l.y=v.y}else if(v.y>u.y){u.y=v.y}if(v.z<l.z){l.z=v.z}else if(v.z>u.z){u.z=v.z}}};Trimesh.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)};Trimesh.prototype.updateBoundingSphereRadius=function(){var max2=0;var vertices=this.vertices;var v=new Vec3;for(var i=0,N=vertices.length/3;i!==N;i++){this.getVertex(i,v);var norm2=v.norm2();if(norm2>max2){max2=norm2}}this.boundingSphereRadius=Math.sqrt(max2)};var tempWorldVertex=new Vec3;var calculateWorldAABB_frame=new Transform;var calculateWorldAABB_aabb=new AABB;Trimesh.prototype.calculateWorldAABB=function(pos,quat,min,max){var frame=calculateWorldAABB_frame;var result=calculateWorldAABB_aabb;frame.position=pos;frame.quaternion=quat;this.aabb.toWorldFrame(frame,result);min.copy(result.lowerBound);max.copy(result.upperBound)};Trimesh.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};Trimesh.createTorus=function(radius,tube,radialSegments,tubularSegments,arc){radius=radius||1;tube=tube||.5;radialSegments=radialSegments||8;tubularSegments=tubularSegments||6;arc=arc||Math.PI*2;var vertices=[];var indices=[];for(var j=0;j<=radialSegments;j++){for(var i=0;i<=tubularSegments;i++){var u=i/tubularSegments*arc;var v=j/radialSegments*Math.PI*2;var x=(radius+tube*Math.cos(v))*Math.cos(u);var y=(radius+tube*Math.cos(v))*Math.sin(u);var z=tube*Math.sin(v);vertices.push(x,y,z)}}for(var j=1;j<=radialSegments;j++){for(var i=1;i<=tubularSegments;i++){var a=(tubularSegments+1)*j+i-1;var b=(tubularSegments+1)*(j-1)+i-1;var c=(tubularSegments+1)*(j-1)+i;var d=(tubularSegments+1)*j+i;indices.push(a,b,d);indices.push(b,c,d)}}return new Trimesh(vertices,indices)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(_dereq_,module,exports){module.exports=GSSolver;var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Solver=_dereq_("./Solver");function GSSolver(){Solver.call(this);this.iterations=10;this.tolerance=1e-7}GSSolver.prototype=new Solver;var GSSolver_solve_lambda=[];var GSSolver_solve_invCs=[];var GSSolver_solve_Bs=[];GSSolver.prototype.solve=function(dt,world){var iter=0,maxIter=this.iterations,tolSquared=this.tolerance*this.tolerance,equations=this.equations,Neq=equations.length,bodies=world.bodies,Nbodies=bodies.length,h=dt,q,B,invC,deltalambda,deltalambdaTot,GWlambda,lambdaj;if(Neq!==0){for(var i=0;i!==Nbodies;i++){bodies[i].updateSolveMassProperties()}}var invCs=GSSolver_solve_invCs,Bs=GSSolver_solve_Bs,lambda=GSSolver_solve_lambda;invCs.length=Neq;Bs.length=Neq;lambda.length=Neq;for(var i=0;i!==Neq;i++){var c=equations[i];lambda[i]=0;Bs[i]=c.computeB(h);invCs[i]=1/c.computeC()}if(Neq!==0){for(var i=0;i!==Nbodies;i++){var b=bodies[i],vlambda=b.vlambda,wlambda=b.wlambda;vlambda.set(0,0,0);if(wlambda){wlambda.set(0,0,0)}}for(iter=0;iter!==maxIter;iter++){deltalambdaTot=0;for(var j=0;j!==Neq;j++){var c=equations[j];B=Bs[j];invC=invCs[j];lambdaj=lambda[j];GWlambda=c.computeGWlambda();deltalambda=invC*(B-GWlambda-c.eps*lambdaj);if(lambdaj+deltalambda<c.minForce){deltalambda=c.minForce-lambdaj}else if(lambdaj+deltalambda>c.maxForce){deltalambda=c.maxForce-lambdaj}lambda[j]+=deltalambda;deltalambdaTot+=deltalambda>0?deltalambda:-deltalambda;c.addToWlambda(deltalambda)}if(deltalambdaTot*deltalambdaTot<tolSquared){break}}for(var i=0;i!==Nbodies;i++){var b=bodies[i],v=b.velocity,w=b.angularVelocity;v.vadd(b.vlambda,v);if(w){w.vadd(b.wlambda,w)}}}return iter}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(_dereq_,module,exports){module.exports=Solver;function Solver(){this.equations=[]}Solver.prototype.solve=function(dt,world){return 0};Solver.prototype.addEquation=function(eq){if(eq.enabled){this.equations.push(eq)}};Solver.prototype.removeEquation=function(eq){var eqs=this.equations;var i=eqs.indexOf(eq);if(i!==-1){eqs.splice(i,1)}};Solver.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(_dereq_,module,exports){module.exports=SplitSolver;var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Solver=_dereq_("./Solver");var Body=_dereq_("../objects/Body");function SplitSolver(subsolver,iteration,tollerance){Solver.call(this);this.iterations=iteration;this.tolerance=tollerance;this.subsolver=subsolver;this.nodes=[];this.nodePool=[];while(this.nodePool.length<128){this.nodePool.push(this.createNode())}}SplitSolver.prototype=new Solver;var SplitSolver_solve_nodes=[];var SplitSolver_solve_nodePool=[];var SplitSolver_solve_eqs=[];var SplitSolver_solve_bds=[];var SplitSolver_solve_dummyWorld={bodies:[]};var STATIC=Body.STATIC;function getUnvisitedNode(nodes){var Nnodes=nodes.length;for(var i=0;i!==Nnodes;i++){var node=nodes[i];if(!node.visited&&!(node.body.type&STATIC)){return node}}return false}var queue=[];function bfs(root,visitFunc,bds,eqs){queue.push(root);root.visited=true;visitFunc(root,bds,eqs);while(queue.length){var node=queue.pop();var child;while(child=getUnvisitedNode(node.children)){child.visited=true;visitFunc(child,bds,eqs);queue.push(child)}}}function visitFunc(node,bds,eqs){bds.push(node.body);var Neqs=node.eqs.length;for(var i=0;i!==Neqs;i++){var eq=node.eqs[i];if(eqs.indexOf(eq)===-1){eqs.push(eq)}}}SplitSolver.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:false}};SplitSolver.prototype.solve=function(dt,world){var nodes=SplitSolver_solve_nodes,nodePool=this.nodePool,bodies=world.bodies,equations=this.equations,Neq=equations.length,Nbodies=bodies.length,subsolver=this.subsolver;while(nodePool.length<Nbodies){nodePool.push(this.createNode())}nodes.length=Nbodies;for(var i=0;i<Nbodies;i++){nodes[i]=nodePool[i]}for(var i=0;i!==Nbodies;i++){var node=nodes[i];node.body=bodies[i];node.children.length=0;node.eqs.length=0;node.visited=false}for(var k=0;k!==Neq;k++){var eq=equations[k],i=bodies.indexOf(eq.bi),j=bodies.indexOf(eq.bj),ni=nodes[i],nj=nodes[j];ni.children.push(nj);ni.eqs.push(eq);nj.children.push(ni);nj.eqs.push(eq)}var child,n=0,eqs=SplitSolver_solve_eqs;subsolver.tolerance=this.tolerance;subsolver.iterations=this.iterations;var dummyWorld=SplitSolver_solve_dummyWorld;while(child=getUnvisitedNode(nodes)){eqs.length=0;dummyWorld.bodies.length=0;bfs(child,visitFunc,dummyWorld.bodies,eqs);var Neqs=eqs.length;eqs=eqs.sort(sortById);for(var i=0;i!==Neqs;i++){subsolver.addEquation(eqs[i])}var iter=subsolver.solve(dt,dummyWorld);subsolver.removeAllEquations();n++}return n};function sortById(a,b){return b.id-a.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(_dereq_,module,exports){var EventTarget=function(){};module.exports=EventTarget;EventTarget.prototype={constructor:EventTarget,addEventListener:function(type,listener){if(this._listeners===undefined){this._listeners={}}var listeners=this._listeners;if(listeners[type]===undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}return this},hasEventListener:function(type,listener){if(this._listeners===undefined){return false}var listeners=this._listeners;if(listeners[type]!==undefined&&listeners[type].indexOf(listener)!==-1){return true}return false},removeEventListener:function(type,listener){if(this._listeners===undefined){return this}var listeners=this._listeners;if(listeners[type]===undefined){return this}var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}return this},dispatchEvent:function(event){if(this._listeners===undefined){return this}var listeners=this._listeners;var listenerArray=listeners[event.type];if(listenerArray!==undefined){event.target=this;for(var i=0,l=listenerArray.length;i<l;i++){listenerArray[i].call(this,event)}}return this}}},{}],50:[function(_dereq_,module,exports){var AABB=_dereq_("../collision/AABB");var Vec3=_dereq_("../math/Vec3");module.exports=Octree;function OctreeNode(options){options=options||{};this.root=options.root||null;this.aabb=options.aabb?options.aabb.clone():new AABB;this.data=[];this.children=[]}function Octree(aabb,options){options=options||{};options.root=null;options.aabb=aabb;OctreeNode.call(this,options);this.maxDepth=typeof options.maxDepth!=="undefined"?options.maxDepth:8}Octree.prototype=new OctreeNode;OctreeNode.prototype.reset=function(aabb,options){this.children.length=this.data.length=0};OctreeNode.prototype.insert=function(aabb,elementData,level){var nodeData=this.data;level=level||0;if(!this.aabb.contains(aabb)){return false}var children=this.children;if(level<(this.maxDepth||this.root.maxDepth)){var subdivided=false;if(!children.length){this.subdivide();subdivided=true}for(var i=0;i!==8;i++){if(children[i].insert(aabb,elementData,level+1)){return true}}if(subdivided){children.length=0}}nodeData.push(elementData);return true};var halfDiagonal=new Vec3;OctreeNode.prototype.subdivide=function(){var aabb=this.aabb;var l=aabb.lowerBound;var u=aabb.upperBound;var children=this.children;children.push(new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,0,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,0,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,1,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,1,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,1,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,0,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,0,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,1,0)})}));u.vsub(l,halfDiagonal);halfDiagonal.scale(.5,halfDiagonal);var root=this.root||this;for(var i=0;i!==8;i++){var child=children[i];child.root=root;var lowerBound=child.aabb.lowerBound;lowerBound.x*=halfDiagonal.x;lowerBound.y*=halfDiagonal.y;lowerBound.z*=halfDiagonal.z;lowerBound.vadd(l,lowerBound);lowerBound.vadd(halfDiagonal,child.aabb.upperBound)}};OctreeNode.prototype.aabbQuery=function(aabb,result){var nodeData=this.data;var children=this.children;var queue=[this];while(queue.length){var node=queue.pop();if(node.aabb.overlaps(aabb)){Array.prototype.push.apply(result,node.data)}Array.prototype.push.apply(queue,node.children)}return result};var tmpAABB=new AABB;OctreeNode.prototype.rayQuery=function(ray,treeTransform,result){ray.getAABB(tmpAABB);tmpAABB.toLocalFrame(treeTransform,tmpAABB);this.aabbQuery(tmpAABB,result);return result};OctreeNode.prototype.removeEmptyNodes=function(){var queue=[this];while(queue.length){var node=queue.pop();for(var i=node.children.length-1;i>=0;i--){if(!node.children[i].data.length){node.children.splice(i,1)}}Array.prototype.push.apply(queue,node.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(_dereq_,module,exports){module.exports=Pool;function Pool(){this.objects=[];this.type=Object}Pool.prototype.release=function(){var Nargs=arguments.length;for(var i=0;i!==Nargs;i++){this.objects.push(arguments[i])}};Pool.prototype.get=function(){if(this.objects.length===0){return this.constructObject()}else{return this.objects.pop()}};Pool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(_dereq_,module,exports){module.exports=TupleDictionary;function TupleDictionary(){this.data={keys:[]}}TupleDictionary.prototype.get=function(i,j){if(i>j){var temp=j;j=i;i=temp}return this.data[i+"-"+j]};TupleDictionary.prototype.set=function(i,j,value){if(i>j){var temp=j;j=i;i=temp}var key=i+"-"+j;if(!this.get(i,j)){this.data.keys.push(key)}this.data[key]=value};TupleDictionary.prototype.reset=function(){var data=this.data,keys=data.keys;while(keys.length>0){var key=keys.pop();delete data[key]}}},{}],53:[function(_dereq_,module,exports){function Utils(){}module.exports=Utils;Utils.defaults=function(options,defaults){options=options||{};for(var key in defaults){if(!(key in options)){options[key]=defaults[key]}}return options}},{}],54:[function(_dereq_,module,exports){module.exports=Vec3Pool;var Vec3=_dereq_("../math/Vec3");var Pool=_dereq_("./Pool");function Vec3Pool(){Pool.call(this);this.type=Vec3}Vec3Pool.prototype=new Pool;Vec3Pool.prototype.constructObject=function(){return new Vec3}},{"../math/Vec3":30,"./Pool":51}],55:[function(_dereq_,module,exports){module.exports=Narrowphase;var AABB=_dereq_("../collision/AABB");var Shape=_dereq_("../shapes/Shape");var Ray=_dereq_("../collision/Ray");var Vec3=_dereq_("../math/Vec3");var Transform=_dereq_("../math/Transform");var ConvexPolyhedron=_dereq_("../shapes/ConvexPolyhedron");var Quaternion=_dereq_("../math/Quaternion");var Solver=_dereq_("../solver/Solver");var Vec3Pool=_dereq_("../utils/Vec3Pool");var ContactEquation=_dereq_("../equations/ContactEquation");var FrictionEquation=_dereq_("../equations/FrictionEquation");function Narrowphase(world){this.contactPointPool=[];this.frictionEquationPool=[];this.result=[];this.frictionResult=[];this.v3pool=new Vec3Pool;this.world=world;this.currentContactMaterial=null;this.enableFrictionReduction=false}Narrowphase.prototype.createContactEquation=function(bi,bj,si,sj,rsi,rsj){var c;if(this.contactPointPool.length){c=this.contactPointPool.pop();c.bi=bi;c.bj=bj}else{c=new ContactEquation(bi,bj)}c.enabled=bi.collisionResponse&&bj.collisionResponse&&si.collisionResponse&&sj.collisionResponse;var cm=this.currentContactMaterial;c.restitution=cm.restitution;c.setSpookParams(cm.contactEquationStiffness,cm.contactEquationRelaxation,this.world.dt);var matA=si.material||bi.material;var matB=sj.material||bj.material;if(matA&&matB&&matA.restitution>=0&&matB.restitution>=0){c.restitution=matA.restitution*matB.restitution}c.si=rsi||si;c.sj=rsj||sj;return c};Narrowphase.prototype.createFrictionEquationsFromContact=function(contactEquation,outArray){var bodyA=contactEquation.bi;var bodyB=contactEquation.bj;var shapeA=contactEquation.si;var shapeB=contactEquation.sj;var world=this.world;var cm=this.currentContactMaterial;var friction=cm.friction;var matA=shapeA.material||bodyA.material;var matB=shapeB.material||bodyB.material;if(matA&&matB&&matA.friction>=0&&matB.friction>=0){friction=matA.friction*matB.friction}if(friction>0){var mug=friction*world.gravity.length();var reducedMass=bodyA.invMass+bodyB.invMass;if(reducedMass>0){reducedMass=1/reducedMass}var pool=this.frictionEquationPool;var c1=pool.length?pool.pop():new FrictionEquation(bodyA,bodyB,mug*reducedMass);var c2=pool.length?pool.pop():new FrictionEquation(bodyA,bodyB,mug*reducedMass);c1.bi=c2.bi=bodyA;c1.bj=c2.bj=bodyB;c1.minForce=c2.minForce=-mug*reducedMass;c1.maxForce=c2.maxForce=mug*reducedMass;c1.ri.copy(contactEquation.ri);c1.rj.copy(contactEquation.rj);c2.ri.copy(contactEquation.ri);c2.rj.copy(contactEquation.rj);contactEquation.ni.tangents(c1.t,c2.t);c1.setSpookParams(cm.frictionEquationStiffness,cm.frictionEquationRelaxation,world.dt);c2.setSpookParams(cm.frictionEquationStiffness,cm.frictionEquationRelaxation,world.dt);c1.enabled=c2.enabled=contactEquation.enabled;outArray.push(c1,c2);return true}return false};var averageNormal=new Vec3;var averageContactPointA=new Vec3;var averageContactPointB=new Vec3;Narrowphase.prototype.createFrictionFromAverage=function(numContacts){var c=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(c,this.frictionResult)||numContacts===1){return}var f1=this.frictionResult[this.frictionResult.length-2];var f2=this.frictionResult[this.frictionResult.length-1];averageNormal.setZero();averageContactPointA.setZero();averageContactPointB.setZero();var bodyA=c.bi;var bodyB=c.bj;for(var i=0;i!==numContacts;i++){c=this.result[this.result.length-1-i];if(c.bodyA!==bodyA){averageNormal.vadd(c.ni,averageNormal);averageContactPointA.vadd(c.ri,averageContactPointA);averageContactPointB.vadd(c.rj,averageContactPointB)}else{averageNormal.vsub(c.ni,averageNormal);averageContactPointA.vadd(c.rj,averageContactPointA);averageContactPointB.vadd(c.ri,averageContactPointB)}}var invNumContacts=1/numContacts;averageContactPointA.scale(invNumContacts,f1.ri);averageContactPointB.scale(invNumContacts,f1.rj);f2.ri.copy(f1.ri);f2.rj.copy(f1.rj);averageNormal.normalize();averageNormal.tangents(f1.t,f2.t)};var tmpVec1=new Vec3;var tmpVec2=new Vec3;var tmpQuat1=new Quaternion;var tmpQuat2=new Quaternion;Narrowphase.prototype.getContacts=function(p1,p2,world,result,oldcontacts,frictionResult,frictionPool){this.contactPointPool=oldcontacts;this.frictionEquationPool=frictionPool;this.result=result;this.frictionResult=frictionResult;var qi=tmpQuat1;var qj=tmpQuat2;var xi=tmpVec1;var xj=tmpVec2;for(var k=0,N=p1.length;k!==N;k++){var bi=p1[k],bj=p2[k];var bodyContactMaterial=null;if(bi.material&&bj.material){bodyContactMaterial=world.getContactMaterial(bi.material,bj.material)||null}for(var i=0;i<bi.shapes.length;i++){bi.quaternion.mult(bi.shapeOrientations[i],qi);bi.quaternion.vmult(bi.shapeOffsets[i],xi);xi.vadd(bi.position,xi);var si=bi.shapes[i];for(var j=0;j<bj.shapes.length;j++){bj.quaternion.mult(bj.shapeOrientations[j],qj);bj.quaternion.vmult(bj.shapeOffsets[j],xj);xj.vadd(bj.position,xj);var sj=bj.shapes[j];if(xi.distanceTo(xj)>si.boundingSphereRadius+sj.boundingSphereRadius){continue}var shapeContactMaterial=null;if(si.material&&sj.material){shapeContactMaterial=world.getContactMaterial(si.material,sj.material)||null}this.currentContactMaterial=shapeContactMaterial||bodyContactMaterial||world.defaultContactMaterial;var resolver=this[si.type|sj.type];if(resolver){if(si.type<sj.type){resolver.call(this,si,sj,xi,xj,qi,qj,bi,bj,si,sj)}else{resolver.call(this,sj,si,xj,xi,qj,qi,bj,bi,si,sj)}}}}}};var numWarnings=0;var maxWarnings=10;function warn(msg){if(numWarnings>maxWarnings){return}numWarnings++;console.warn(msg)}Narrowphase.prototype[Shape.types.BOX|Shape.types.BOX]=Narrowphase.prototype.boxBox=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;sj.convexPolyhedronRepresentation.material=sj.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;sj.convexPolyhedronRepresentation.collisionResponse=sj.collisionResponse;this.convexConvex(si.convexPolyhedronRepresentation,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj,si,sj)};Narrowphase.prototype[Shape.types.BOX|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.boxConvex=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;this.convexConvex(si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj,si,sj)};Narrowphase.prototype[Shape.types.BOX|Shape.types.PARTICLE]=Narrowphase.prototype.boxParticle=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;this.convexParticle(si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj,si,sj)};Narrowphase.prototype[Shape.types.SPHERE]=Narrowphase.prototype.sphereSphere=function(si,sj,xi,xj,qi,qj,bi,bj){var r=this.createContactEquation(bi,bj,si,sj);xj.vsub(xi,r.ni);r.ni.normalize();r.ri.copy(r.ni);r.rj.copy(r.ni);r.ri.mult(si.radius,r.ri);r.rj.mult(-sj.radius,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)};var planeTrimesh_normal=new Vec3;var planeTrimesh_relpos=new Vec3;var planeTrimesh_projected=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.TRIMESH]=Narrowphase.prototype.planeTrimesh=function(planeShape,trimeshShape,planePos,trimeshPos,planeQuat,trimeshQuat,planeBody,trimeshBody){var v=new Vec3;var normal=planeTrimesh_normal;normal.set(0,0,1);planeQuat.vmult(normal,normal);for(var i=0;i<trimeshShape.vertices.length/3;i++){trimeshShape.getVertex(i,v);var v2=new Vec3;v2.copy(v);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,v2,v);var relpos=planeTrimesh_relpos;v.vsub(planePos,relpos);var dot=normal.dot(relpos);if(dot<=0){var r=this.createContactEquation(planeBody,trimeshBody,planeShape,trimeshShape);r.ni.copy(normal);var projected=planeTrimesh_projected;normal.scale(relpos.dot(normal),projected);v.vsub(projected,projected);r.ri.copy(projected);r.ri.vsub(planeBody.position,r.ri);r.rj.copy(v);r.rj.vsub(trimeshBody.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}};var sphereTrimesh_normal=new Vec3;var sphereTrimesh_relpos=new Vec3;var sphereTrimesh_projected=new Vec3;var sphereTrimesh_v=new Vec3;var sphereTrimesh_v2=new Vec3;var sphereTrimesh_edgeVertexA=new Vec3;var sphereTrimesh_edgeVertexB=new Vec3;var sphereTrimesh_edgeVector=new Vec3;var sphereTrimesh_edgeVectorUnit=new Vec3;var sphereTrimesh_localSpherePos=new Vec3;var sphereTrimesh_tmp=new Vec3;var sphereTrimesh_va=new Vec3;var sphereTrimesh_vb=new Vec3;var sphereTrimesh_vc=new Vec3;var sphereTrimesh_localSphereAABB=new AABB;var sphereTrimesh_triangles=[];Narrowphase.prototype[Shape.types.SPHERE|Shape.types.TRIMESH]=Narrowphase.prototype.sphereTrimesh=function(sphereShape,trimeshShape,spherePos,trimeshPos,sphereQuat,trimeshQuat,sphereBody,trimeshBody){var edgeVertexA=sphereTrimesh_edgeVertexA;var edgeVertexB=sphereTrimesh_edgeVertexB;var edgeVector=sphereTrimesh_edgeVector;var edgeVectorUnit=sphereTrimesh_edgeVectorUnit;var localSpherePos=sphereTrimesh_localSpherePos;var tmp=sphereTrimesh_tmp;var localSphereAABB=sphereTrimesh_localSphereAABB;var v2=sphereTrimesh_v2;var relpos=sphereTrimesh_relpos;var triangles=sphereTrimesh_triangles;Transform.pointToLocalFrame(trimeshPos,trimeshQuat,spherePos,localSpherePos);var sphereRadius=sphereShape.radius;localSphereAABB.lowerBound.set(localSpherePos.x-sphereRadius,localSpherePos.y-sphereRadius,localSpherePos.z-sphereRadius);localSphereAABB.upperBound.set(localSpherePos.x+sphereRadius,localSpherePos.y+sphereRadius,localSpherePos.z+sphereRadius);trimeshShape.getTrianglesInAABB(localSphereAABB,triangles);var v=sphereTrimesh_v;var radiusSquared=sphereShape.radius*sphereShape.radius;for(var i=0;i<triangles.length;i++){for(var j=0;j<3;j++){trimeshShape.getVertex(trimeshShape.indices[triangles[i]*3+j],v);v.vsub(localSpherePos,relpos);if(relpos.norm2()<=radiusSquared){v2.copy(v);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,v2,v);v.vsub(spherePos,relpos);var r=this.createContactEquation(sphereBody,trimeshBody,sphereShape,trimeshShape);r.ni.copy(relpos);r.ni.normalize();r.ri.copy(r.ni);r.ri.scale(sphereShape.radius,r.ri);r.ri.vadd(spherePos,r.ri);r.ri.vsub(sphereBody.position,r.ri);r.rj.copy(v);r.rj.vsub(trimeshBody.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}}for(var i=0;i<triangles.length;i++){for(var j=0;j<3;j++){trimeshShape.getVertex(trimeshShape.indices[triangles[i]*3+j],edgeVertexA);trimeshShape.getVertex(trimeshShape.indices[triangles[i]*3+(j+1)%3],edgeVertexB);edgeVertexB.vsub(edgeVertexA,edgeVector);localSpherePos.vsub(edgeVertexB,tmp);var positionAlongEdgeB=tmp.dot(edgeVector);localSpherePos.vsub(edgeVertexA,tmp);var positionAlongEdgeA=tmp.dot(edgeVector);if(positionAlongEdgeA>0&&positionAlongEdgeB<0){localSpherePos.vsub(edgeVertexA,tmp);edgeVectorUnit.copy(edgeVector);edgeVectorUnit.normalize();positionAlongEdgeA=tmp.dot(edgeVectorUnit);edgeVectorUnit.scale(positionAlongEdgeA,tmp);tmp.vadd(edgeVertexA,tmp);var dist=tmp.distanceTo(localSpherePos);if(dist<sphereShape.radius){var r=this.createContactEquation(sphereBody,trimeshBody,sphereShape,trimeshShape);tmp.vsub(localSpherePos,r.ni);r.ni.normalize();r.ni.scale(sphereShape.radius,r.ri);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,tmp,tmp);tmp.vsub(trimeshBody.position,r.rj);Transform.vectorToWorldFrame(trimeshQuat,r.ni,r.ni);Transform.vectorToWorldFrame(trimeshQuat,r.ri,r.ri);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}}}var va=sphereTrimesh_va;var vb=sphereTrimesh_vb;var vc=sphereTrimesh_vc;var normal=sphereTrimesh_normal;for(var i=0,N=triangles.length;i!==N;i++){trimeshShape.getTriangleVertices(triangles[i],va,vb,vc);trimeshShape.getNormal(triangles[i],normal);localSpherePos.vsub(va,tmp);var dist=tmp.dot(normal);normal.scale(dist,tmp);localSpherePos.vsub(tmp,tmp);dist=tmp.distanceTo(localSpherePos);if(Ray.pointInTriangle(tmp,va,vb,vc)&&dist<sphereShape.radius){var r=this.createContactEquation(sphereBody,trimeshBody,sphereShape,trimeshShape);tmp.vsub(localSpherePos,r.ni);r.ni.normalize();r.ni.scale(sphereShape.radius,r.ri);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,tmp,tmp);tmp.vsub(trimeshBody.position,r.rj);Transform.vectorToWorldFrame(trimeshQuat,r.ni,r.ni);Transform.vectorToWorldFrame(trimeshQuat,r.ri,r.ri);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}triangles.length=0};var point_on_plane_to_sphere=new Vec3;var plane_to_sphere_ortho=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.PLANE]=Narrowphase.prototype.spherePlane=function(si,sj,xi,xj,qi,qj,bi,bj){var r=this.createContactEquation(bi,bj,si,sj);r.ni.set(0,0,1);qj.vmult(r.ni,r.ni);r.ni.negate(r.ni);r.ni.normalize();r.ni.mult(si.radius,r.ri);xi.vsub(xj,point_on_plane_to_sphere);r.ni.mult(r.ni.dot(point_on_plane_to_sphere),plane_to_sphere_ortho);point_on_plane_to_sphere.vsub(plane_to_sphere_ortho,r.rj);if(-point_on_plane_to_sphere.dot(r.ni)<=si.radius){var ri=r.ri;var rj=r.rj;ri.vadd(xi,ri);ri.vsub(bi.position,ri);rj.vadd(xj,rj);rj.vsub(bj.position,rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}};var pointInPolygon_edge=new Vec3;var pointInPolygon_edge_x_normal=new Vec3;var pointInPolygon_vtp=new Vec3;function pointInPolygon(verts,normal,p){var positiveResult=null;var N=verts.length;for(var i=0;i!==N;i++){var v=verts[i];var edge=pointInPolygon_edge;verts[(i+1)%N].vsub(v,edge);var edge_x_normal=pointInPolygon_edge_x_normal;edge.cross(normal,edge_x_normal);var vertex_to_p=pointInPolygon_vtp;p.vsub(v,vertex_to_p);var r=edge_x_normal.dot(vertex_to_p);if(positiveResult===null||r>0&&positiveResult===true||r<=0&&positiveResult===false){if(positiveResult===null){positiveResult=r>0}continue}else{return false}}return true}var box_to_sphere=new Vec3;var sphereBox_ns=new Vec3;var sphereBox_ns1=new Vec3;var sphereBox_ns2=new Vec3;var sphereBox_sides=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];var sphereBox_sphere_to_corner=new Vec3;var sphereBox_side_ns=new Vec3;var sphereBox_side_ns1=new Vec3;var sphereBox_side_ns2=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.BOX]=Narrowphase.prototype.sphereBox=function(si,sj,xi,xj,qi,qj,bi,bj){var v3pool=this.v3pool;var sides=sphereBox_sides;xi.vsub(xj,box_to_sphere);sj.getSideNormals(sides,qj);var R=si.radius;var penetrating_sides=[];var found=false;var side_ns=sphereBox_side_ns;var side_ns1=sphereBox_side_ns1;var side_ns2=sphereBox_side_ns2;var side_h=null;var side_penetrations=0;var side_dot1=0;var side_dot2=0;var side_distance=null;for(var idx=0,nsides=sides.length;idx!==nsides&&found===false;idx++){var ns=sphereBox_ns;ns.copy(sides[idx]);var h=ns.norm();ns.normalize();var dot=box_to_sphere.dot(ns);if(dot<h+R&&dot>0){var ns1=sphereBox_ns1;var ns2=sphereBox_ns2;ns1.copy(sides[(idx+1)%3]);ns2.copy(sides[(idx+2)%3]);var h1=ns1.norm();var h2=ns2.norm();ns1.normalize();ns2.normalize();var dot1=box_to_sphere.dot(ns1);var dot2=box_to_sphere.dot(ns2);if(dot1<h1&&dot1>-h1&&dot2<h2&&dot2>-h2){var dist=Math.abs(dot-h-R);if(side_distance===null||dist<side_distance){side_distance=dist;side_dot1=dot1;side_dot2=dot2;side_h=h;side_ns.copy(ns);side_ns1.copy(ns1);side_ns2.copy(ns2);side_penetrations++}}}}if(side_penetrations){found=true;var r=this.createContactEquation(bi,bj,si,sj);side_ns.mult(-R,r.ri);r.ni.copy(side_ns);r.ni.negate(r.ni);side_ns.mult(side_h,side_ns);side_ns1.mult(side_dot1,side_ns1);side_ns.vadd(side_ns1,side_ns);side_ns2.mult(side_dot2,side_ns2);side_ns.vadd(side_ns2,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}var rj=v3pool.get();var sphere_to_corner=sphereBox_sphere_to_corner;for(var j=0;j!==2&&!found;j++){for(var k=0;k!==2&&!found;k++){for(var l=0;l!==2&&!found;l++){rj.set(0,0,0);if(j){rj.vadd(sides[0],rj)}else{rj.vsub(sides[0],rj)}if(k){rj.vadd(sides[1],rj)}else{rj.vsub(sides[1],rj)}if(l){rj.vadd(sides[2],rj)}else{rj.vsub(sides[2],rj)}xj.vadd(rj,sphere_to_corner);sphere_to_corner.vsub(xi,sphere_to_corner);if(sphere_to_corner.norm2()<R*R){found=true;var r=this.createContactEquation(bi,bj,si,sj);r.ri.copy(sphere_to_corner);r.ri.normalize();r.ni.copy(r.ri);r.ri.mult(R,r.ri);r.rj.copy(rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}}}v3pool.release(rj);rj=null;var edgeTangent=v3pool.get();var edgeCenter=v3pool.get();var r=v3pool.get();var orthogonal=v3pool.get();var dist=v3pool.get();var Nsides=sides.length;for(var j=0;j!==Nsides&&!found;j++){for(var k=0;k!==Nsides&&!found;k++){if(j%3!==k%3){sides[k].cross(sides[j],edgeTangent);edgeTangent.normalize();sides[j].vadd(sides[k],edgeCenter);r.copy(xi);r.vsub(edgeCenter,r);r.vsub(xj,r);var orthonorm=r.dot(edgeTangent);edgeTangent.mult(orthonorm,orthogonal);var l=0;while(l===j%3||l===k%3){l++}dist.copy(xi);dist.vsub(orthogonal,dist);dist.vsub(edgeCenter,dist);dist.vsub(xj,dist);var tdist=Math.abs(orthonorm);var ndist=dist.norm();if(tdist<sides[l].norm()&&ndist<R){found=true;var res=this.createContactEquation(bi,bj,si,sj);edgeCenter.vadd(orthogonal,res.rj);res.rj.copy(res.rj);dist.negate(res.ni);res.ni.normalize();res.ri.copy(res.rj);res.ri.vadd(xj,res.ri);res.ri.vsub(xi,res.ri);res.ri.normalize();res.ri.mult(R,res.ri);res.ri.vadd(xi,res.ri);res.ri.vsub(bi.position,res.ri);res.rj.vadd(xj,res.rj);res.rj.vsub(bj.position,res.rj);this.result.push(res);this.createFrictionEquationsFromContact(res,this.frictionResult)}}}}v3pool.release(edgeTangent,edgeCenter,r,orthogonal,dist)};var convex_to_sphere=new Vec3;var sphereConvex_edge=new Vec3;var sphereConvex_edgeUnit=new Vec3;var sphereConvex_sphereToCorner=new Vec3;var sphereConvex_worldCorner=new Vec3;var sphereConvex_worldNormal=new Vec3;var sphereConvex_worldPoint=new Vec3;var sphereConvex_worldSpherePointClosestToPlane=new Vec3;var sphereConvex_penetrationVec=new Vec3;var sphereConvex_sphereToWorldPoint=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.sphereConvex=function(si,sj,xi,xj,qi,qj,bi,bj){var v3pool=this.v3pool;xi.vsub(xj,convex_to_sphere);var normals=sj.faceNormals;var faces=sj.faces;var verts=sj.vertices;var R=si.radius;var penetrating_sides=[];for(var i=0;i!==verts.length;i++){var v=verts[i];var worldCorner=sphereConvex_worldCorner;qj.vmult(v,worldCorner);xj.vadd(worldCorner,worldCorner);var sphere_to_corner=sphereConvex_sphereToCorner;worldCorner.vsub(xi,sphere_to_corner);if(sphere_to_corner.norm2()<R*R){found=true;var r=this.createContactEquation(bi,bj,si,sj);r.ri.copy(sphere_to_corner);r.ri.normalize();r.ni.copy(r.ri);r.ri.mult(R,r.ri);worldCorner.vsub(xj,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult);return}}var found=false;for(var i=0,nfaces=faces.length;i!==nfaces&&found===false;i++){var normal=normals[i];var face=faces[i];var worldNormal=sphereConvex_worldNormal;qj.vmult(normal,worldNormal);var worldPoint=sphereConvex_worldPoint;qj.vmult(verts[face[0]],worldPoint);worldPoint.vadd(xj,worldPoint);var worldSpherePointClosestToPlane=sphereConvex_worldSpherePointClosestToPlane;worldNormal.mult(-R,worldSpherePointClosestToPlane);xi.vadd(worldSpherePointClosestToPlane,worldSpherePointClosestToPlane);var penetrationVec=sphereConvex_penetrationVec;worldSpherePointClosestToPlane.vsub(worldPoint,penetrationVec);var penetration=penetrationVec.dot(worldNormal);var worldPointToSphere=sphereConvex_sphereToWorldPoint;xi.vsub(worldPoint,worldPointToSphere);if(penetration<0&&worldPointToSphere.dot(worldNormal)>0){var faceVerts=[];for(var j=0,Nverts=face.length;j!==Nverts;j++){var worldVertex=v3pool.get();qj.vmult(verts[face[j]],worldVertex);xj.vadd(worldVertex,worldVertex);faceVerts.push(worldVertex)}if(pointInPolygon(faceVerts,worldNormal,xi)){found=true;var r=this.createContactEquation(bi,bj,si,sj);worldNormal.mult(-R,r.ri);worldNormal.negate(r.ni);var penetrationVec2=v3pool.get();worldNormal.mult(-penetration,penetrationVec2);var penetrationSpherePoint=v3pool.get();worldNormal.mult(-R,penetrationSpherePoint);xi.vsub(xj,r.rj);r.rj.vadd(penetrationSpherePoint,r.rj);r.rj.vadd(penetrationVec2,r.rj);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);v3pool.release(penetrationVec2);v3pool.release(penetrationSpherePoint);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult);for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}return}else{for(var j=0;j!==face.length;j++){var v1=v3pool.get();var v2=v3pool.get();qj.vmult(verts[face[(j+1)%face.length]],v1);qj.vmult(verts[face[(j+2)%face.length]],v2);xj.vadd(v1,v1);xj.vadd(v2,v2);var edge=sphereConvex_edge;v2.vsub(v1,edge);var edgeUnit=sphereConvex_edgeUnit;edge.unit(edgeUnit);var p=v3pool.get();var v1_to_xi=v3pool.get();xi.vsub(v1,v1_to_xi);var dot=v1_to_xi.dot(edgeUnit);edgeUnit.mult(dot,p);p.vadd(v1,p);var xi_to_p=v3pool.get();p.vsub(xi,xi_to_p);if(dot>0&&dot*dot<edge.norm2()&&xi_to_p.norm2()<R*R){var r=this.createContactEquation(bi,bj,si,sj);p.vsub(xj,r.rj);p.vsub(xi,r.ni);r.ni.normalize();r.ni.mult(R,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult);for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}v3pool.release(v1);v3pool.release(v2);v3pool.release(p);v3pool.release(xi_to_p);v3pool.release(v1_to_xi);return}v3pool.release(v1);v3pool.release(v2);v3pool.release(p);v3pool.release(xi_to_p);v3pool.release(v1_to_xi)}}for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}}}};var planeBox_normal=new Vec3;var plane_to_corner=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.BOX]=Narrowphase.prototype.planeBox=function(si,sj,xi,xj,qi,qj,bi,bj){sj.convexPolyhedronRepresentation.material=sj.material;sj.convexPolyhedronRepresentation.collisionResponse=sj.collisionResponse;this.planeConvex(si,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj)};var planeConvex_v=new Vec3;var planeConvex_normal=new Vec3;var planeConvex_relpos=new Vec3;var planeConvex_projected=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.planeConvex=function(planeShape,convexShape,planePosition,convexPosition,planeQuat,convexQuat,planeBody,convexBody){var worldVertex=planeConvex_v,worldNormal=planeConvex_normal;worldNormal.set(0,0,1);planeQuat.vmult(worldNormal,worldNormal);var numContacts=0;var relpos=planeConvex_relpos;for(var i=0;i!==convexShape.vertices.length;i++){worldVertex.copy(convexShape.vertices[i]);convexQuat.vmult(worldVertex,worldVertex);convexPosition.vadd(worldVertex,worldVertex);worldVertex.vsub(planePosition,relpos);var dot=worldNormal.dot(relpos);if(dot<=0){var r=this.createContactEquation(planeBody,convexBody,planeShape,convexShape);var projected=planeConvex_projected;worldNormal.mult(worldNormal.dot(relpos),projected);worldVertex.vsub(projected,projected);projected.vsub(planePosition,r.ri);r.ni.copy(worldNormal);worldVertex.vsub(convexPosition,r.rj);r.ri.vadd(planePosition,r.ri);r.ri.vsub(planeBody.position,r.ri);r.rj.vadd(convexPosition,r.rj);r.rj.vsub(convexBody.position,r.rj);this.result.push(r);numContacts++;if(!this.enableFrictionReduction){this.createFrictionEquationsFromContact(r,this.frictionResult)}}}if(this.enableFrictionReduction&&numContacts){this.createFrictionFromAverage(numContacts)}};var convexConvex_sepAxis=new Vec3;var convexConvex_q=new Vec3;Narrowphase.prototype[Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.convexConvex=function(si,sj,xi,xj,qi,qj,bi,bj,rsi,rsj,faceListA,faceListB){var sepAxis=convexConvex_sepAxis;if(xi.distanceTo(xj)>si.boundingSphereRadius+sj.boundingSphereRadius){return}if(si.findSeparatingAxis(sj,xi,qi,xj,qj,sepAxis,faceListA,faceListB)){var res=[];var q=convexConvex_q;si.clipAgainstHull(xi,qi,sj,xj,qj,sepAxis,-100,100,res);var numContacts=0;for(var j=0;j!==res.length;j++){var r=this.createContactEquation(bi,bj,si,sj,rsi,rsj),ri=r.ri,rj=r.rj;sepAxis.negate(r.ni);res[j].normal.negate(q);q.mult(res[j].depth,q);res[j].point.vadd(q,ri);rj.copy(res[j].point);ri.vsub(xi,ri);rj.vsub(xj,rj);ri.vadd(xi,ri);ri.vsub(bi.position,ri);rj.vadd(xj,rj);rj.vsub(bj.position,rj);this.result.push(r);numContacts++;if(!this.enableFrictionReduction){this.createFrictionEquationsFromContact(r,this.frictionResult)}}if(this.enableFrictionReduction&&numContacts){this.createFrictionFromAverage(numContacts)}}};var particlePlane_normal=new Vec3;var particlePlane_relpos=new Vec3;var particlePlane_projected=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.PARTICLE]=Narrowphase.prototype.planeParticle=function(sj,si,xj,xi,qj,qi,bj,bi){var normal=particlePlane_normal;normal.set(0,0,1);bj.quaternion.vmult(normal,normal);var relpos=particlePlane_relpos;xi.vsub(bj.position,relpos);var dot=normal.dot(relpos);if(dot<=0){var r=this.createContactEquation(bi,bj,si,sj);r.ni.copy(normal);r.ni.negate(r.ni);r.ri.set(0,0,0);var projected=particlePlane_projected;normal.mult(normal.dot(xi),projected);xi.vsub(projected,projected);r.rj.copy(projected);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}};var particleSphere_normal=new Vec3;Narrowphase.prototype[Shape.types.PARTICLE|Shape.types.SPHERE]=Narrowphase.prototype.sphereParticle=function(sj,si,xj,xi,qj,qi,bj,bi){var normal=particleSphere_normal;normal.set(0,0,1);xi.vsub(xj,normal);var lengthSquared=normal.norm2();if(lengthSquared<=sj.radius*sj.radius){var r=this.createContactEquation(bi,bj,si,sj);normal.normalize();r.rj.copy(normal);r.rj.mult(sj.radius,r.rj);r.ni.copy(normal);r.ni.negate(r.ni);r.ri.set(0,0,0);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}};var cqj=new Quaternion;var convexParticle_local=new Vec3;var convexParticle_normal=new Vec3;var convexParticle_penetratedFaceNormal=new Vec3;var convexParticle_vertexToParticle=new Vec3;var convexParticle_worldPenetrationVec=new Vec3;Narrowphase.prototype[Shape.types.PARTICLE|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.convexParticle=function(sj,si,xj,xi,qj,qi,bj,bi){var penetratedFaceIndex=-1;var penetratedFaceNormal=convexParticle_penetratedFaceNormal;var worldPenetrationVec=convexParticle_worldPenetrationVec;var minPenetration=null;var numDetectedFaces=0;var local=convexParticle_local;local.copy(xi);local.vsub(xj,local);qj.conjugate(cqj);cqj.vmult(local,local);if(sj.pointIsInside(local)){if(sj.worldVerticesNeedsUpdate){sj.computeWorldVertices(xj,qj)}if(sj.worldFaceNormalsNeedsUpdate){sj.computeWorldFaceNormals(qj)}for(var i=0,nfaces=sj.faces.length;i!==nfaces;i++){var verts=[sj.worldVertices[sj.faces[i][0]]];var normal=sj.worldFaceNormals[i];xi.vsub(verts[0],convexParticle_vertexToParticle);var penetration=-normal.dot(convexParticle_vertexToParticle);if(minPenetration===null||Math.abs(penetration)<Math.abs(minPenetration)){minPenetration=penetration;penetratedFaceIndex=i;penetratedFaceNormal.copy(normal);numDetectedFaces++}}if(penetratedFaceIndex!==-1){var r=this.createContactEquation(bi,bj,si,sj);penetratedFaceNormal.mult(minPenetration,worldPenetrationVec);worldPenetrationVec.vadd(xi,worldPenetrationVec);worldPenetrationVec.vsub(xj,worldPenetrationVec);r.rj.copy(worldPenetrationVec);penetratedFaceNormal.negate(r.ni);r.ri.set(0,0,0);var ri=r.ri,rj=r.rj;ri.vadd(xi,ri);ri.vsub(bi.position,ri);rj.vadd(xj,rj);rj.vsub(bj.position,rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}else{console.warn("Point found inside convex, but did not find penetrating face!")}}};Narrowphase.prototype[Shape.types.BOX|Shape.types.HEIGHTFIELD]=Narrowphase.prototype.boxHeightfield=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;this.convexHeightfield(si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj)};var convexHeightfield_tmp1=new Vec3;var convexHeightfield_tmp2=new Vec3;var convexHeightfield_faceList=[0];Narrowphase.prototype[Shape.types.CONVEXPOLYHEDRON|Shape.types.HEIGHTFIELD]=Narrowphase.prototype.convexHeightfield=function(convexShape,hfShape,convexPos,hfPos,convexQuat,hfQuat,convexBody,hfBody){var data=hfShape.data,w=hfShape.elementSize,radius=convexShape.boundingSphereRadius,worldPillarOffset=convexHeightfield_tmp2,faceList=convexHeightfield_faceList;var localConvexPos=convexHeightfield_tmp1;Transform.pointToLocalFrame(hfPos,hfQuat,convexPos,localConvexPos);var iMinX=Math.floor((localConvexPos.x-radius)/w)-1,iMaxX=Math.ceil((localConvexPos.x+radius)/w)+1,iMinY=Math.floor((localConvexPos.y-radius)/w)-1,iMaxY=Math.ceil((localConvexPos.y+radius)/w)+1;if(iMaxX<0||iMaxY<0||iMinX>data.length||iMinY>data[0].length){return}if(iMinX<0){iMinX=0}if(iMaxX<0){iMaxX=0}if(iMinY<0){iMinY=0}if(iMaxY<0){iMaxY=0}if(iMinX>=data.length){iMinX=data.length-1}if(iMaxX>=data.length){iMaxX=data.length-1}if(iMaxY>=data[0].length){iMaxY=data[0].length-1}if(iMinY>=data[0].length){iMinY=data[0].length-1}var minMax=[];hfShape.getRectMinMax(iMinX,iMinY,iMaxX,iMaxY,minMax);var min=minMax[0];var max=minMax[1];if(localConvexPos.z-radius>max||localConvexPos.z+radius<min){return}for(var i=iMinX;i<iMaxX;i++){for(var j=iMinY;j<iMaxY;j++){hfShape.getConvexTrianglePillar(i,j,false);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(convexPos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+convexShape.boundingSphereRadius){this.convexConvex(convexShape,hfShape.pillarConvex,convexPos,worldPillarOffset,convexQuat,hfQuat,convexBody,hfBody,null,null,faceList,null)}hfShape.getConvexTrianglePillar(i,j,true);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(convexPos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+convexShape.boundingSphereRadius){this.convexConvex(convexShape,hfShape.pillarConvex,convexPos,worldPillarOffset,convexQuat,hfQuat,convexBody,hfBody,null,null,faceList,null)}}}};var sphereHeightfield_tmp1=new Vec3;var sphereHeightfield_tmp2=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.HEIGHTFIELD]=Narrowphase.prototype.sphereHeightfield=function(sphereShape,hfShape,spherePos,hfPos,sphereQuat,hfQuat,sphereBody,hfBody){var data=hfShape.data,radius=sphereShape.radius,w=hfShape.elementSize,worldPillarOffset=sphereHeightfield_tmp2;var localSpherePos=sphereHeightfield_tmp1;Transform.pointToLocalFrame(hfPos,hfQuat,spherePos,localSpherePos);var iMinX=Math.floor((localSpherePos.x-radius)/w)-1,iMaxX=Math.ceil((localSpherePos.x+radius)/w)+1,iMinY=Math.floor((localSpherePos.y-radius)/w)-1,iMaxY=Math.ceil((localSpherePos.y+radius)/w)+1;if(iMaxX<0||iMaxY<0||iMinX>data.length||iMaxY>data[0].length){return}if(iMinX<0){iMinX=0}if(iMaxX<0){iMaxX=0}if(iMinY<0){iMinY=0}if(iMaxY<0){iMaxY=0}if(iMinX>=data.length){iMinX=data.length-1}if(iMaxX>=data.length){iMaxX=data.length-1}if(iMaxY>=data[0].length){iMaxY=data[0].length-1}if(iMinY>=data[0].length){iMinY=data[0].length-1}var minMax=[];hfShape.getRectMinMax(iMinX,iMinY,iMaxX,iMaxY,minMax);var min=minMax[0];var max=minMax[1];if(localSpherePos.z-radius>max||localSpherePos.z+radius<min){return}var result=this.result;for(var i=iMinX;i<iMaxX;i++){for(var j=iMinY;j<iMaxY;j++){var numContactsBefore=result.length;hfShape.getConvexTrianglePillar(i,j,false);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(spherePos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+sphereShape.boundingSphereRadius){this.sphereConvex(sphereShape,hfShape.pillarConvex,spherePos,worldPillarOffset,sphereQuat,hfQuat,sphereBody,hfBody)}hfShape.getConvexTrianglePillar(i,j,true);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(spherePos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+sphereShape.boundingSphereRadius){this.sphereConvex(sphereShape,hfShape.pillarConvex,spherePos,worldPillarOffset,sphereQuat,hfQuat,sphereBody,hfBody)}var numContacts=result.length-numContactsBefore;if(numContacts>2){return}}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(_dereq_,module,exports){module.exports=World;var Shape=_dereq_("../shapes/Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var GSSolver=_dereq_("../solver/GSSolver");var Vec3Pool=_dereq_("../utils/Vec3Pool");var ContactEquation=_dereq_("../equations/ContactEquation");var FrictionEquation=_dereq_("../equations/FrictionEquation");var Narrowphase=_dereq_("./Narrowphase");var EventTarget=_dereq_("../utils/EventTarget");var ArrayCollisionMatrix=_dereq_("../collision/ArrayCollisionMatrix");var Material=_dereq_("../material/Material");var ContactMaterial=_dereq_("../material/ContactMaterial");var Body=_dereq_("../objects/Body");var TupleDictionary=_dereq_("../utils/TupleDictionary");var RaycastResult=_dereq_("../collision/RaycastResult");var AABB=_dereq_("../collision/AABB");var Ray=_dereq_("../collision/Ray");var NaiveBroadphase=_dereq_("../collision/NaiveBroadphase");function World(){EventTarget.apply(this);this.dt=-1;this.allowSleep=false;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=false;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.nextId=0;this.gravity=new Vec3;this.broadphase=new NaiveBroadphase;this.bodies=[];this.solver=new GSSolver;this.constraints=[];this.narrowphase=new Narrowphase(this);this.collisionMatrix=new ArrayCollisionMatrix;this.collisionMatrixPrevious=new ArrayCollisionMatrix;this.materials=[];this.contactmaterials=[];this.contactMaterialTable=new TupleDictionary;this.defaultMaterial=new Material("default");this.defaultContactMaterial=new ContactMaterial(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0});this.doProfiling=false;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0};this.subsystems=[];this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null}}World.prototype=new EventTarget;var tmpAABB1=new AABB;var tmpArray1=[];var tmpRay=new Ray;World.prototype.getContactMaterial=function(m1,m2){return this.contactMaterialTable.get(m1.id,m2.id)};World.prototype.numObjects=function(){return this.bodies.length};World.prototype.collisionMatrixTick=function(){var temp=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix;this.collisionMatrix=temp;this.collisionMatrix.reset()};World.prototype.add=World.prototype.addBody=function(body){if(this.bodies.indexOf(body)!==-1){return}body.index=this.bodies.length;this.bodies.push(body);body.world=this;body.initPosition.copy(body.position);body.initVelocity.copy(body.velocity);body.timeLastSleepy=this.time;if(body instanceof Body){body.initAngularVelocity.copy(body.angularVelocity);body.initQuaternion.copy(body.quaternion)}this.collisionMatrix.setNumObjects(this.bodies.length);this.addBodyEvent.body=body;this.dispatchEvent(this.addBodyEvent)};World.prototype.addConstraint=function(c){this.constraints.push(c)};World.prototype.removeConstraint=function(c){var idx=this.constraints.indexOf(c);if(idx!==-1){this.constraints.splice(idx,1)}};World.prototype.rayTest=function(from,to,result){if(result instanceof RaycastResult){this.raycastClosest(from,to,{skipBackfaces:true},result)}else{this.raycastAll(from,to,{skipBackfaces:true},result)}};World.prototype.raycastAll=function(from,to,options,callback){options.mode=Ray.ALL;options.from=from;options.to=to;options.callback=callback;return tmpRay.intersectWorld(this,options)};World.prototype.raycastAny=function(from,to,options,result){options.mode=Ray.ANY;options.from=from;options.to=to;options.result=result;return tmpRay.intersectWorld(this,options)};World.prototype.raycastClosest=function(from,to,options,result){options.mode=Ray.CLOSEST;options.from=from;options.to=to;options.result=result;return tmpRay.intersectWorld(this,options)};World.prototype.remove=function(body){body.world=null;var n=this.bodies.length-1,bodies=this.bodies,idx=bodies.indexOf(body);if(idx!==-1){bodies.splice(idx,1);for(var i=0;i!==bodies.length;i++){bodies[i].index=i}this.collisionMatrix.setNumObjects(n);this.removeBodyEvent.body=body;this.dispatchEvent(this.removeBodyEvent)}};World.prototype.removeBody=World.prototype.remove;World.prototype.addMaterial=function(m){this.materials.push(m)};World.prototype.addContactMaterial=function(cmat){this.contactmaterials.push(cmat);this.contactMaterialTable.set(cmat.materials[0].id,cmat.materials[1].id,cmat)};if(typeof performance==="undefined"){performance={}}if(!performance.now){var nowOffset=Date.now();if(performance.timing&&performance.timing.navigationStart){nowOffset=performance.timing.navigationStart}performance.now=function(){return Date.now()-nowOffset}}var step_tmp1=new Vec3;World.prototype.step=function(dt,timeSinceLastCalled,maxSubSteps){maxSubSteps=maxSubSteps||10;timeSinceLastCalled=timeSinceLastCalled||0;if(timeSinceLastCalled===0){this.internalStep(dt);this.time+=dt}else{var internalSteps=Math.floor((this.time+timeSinceLastCalled)/dt)-Math.floor(this.time/dt);internalSteps=Math.min(internalSteps,maxSubSteps);var t0=performance.now();for(var i=0;i!==internalSteps;i++){this.internalStep(dt);if(performance.now()-t0>dt*1e3){break}}this.time+=timeSinceLastCalled;var h=this.time%dt;var h_div_dt=h/dt;var interpvelo=step_tmp1;var bodies=this.bodies;for(var j=0;j!==bodies.length;j++){var b=bodies[j];if(b.type!==Body.STATIC&&b.sleepState!==Body.SLEEPING){b.position.vsub(b.previousPosition,interpvelo);interpvelo.scale(h_div_dt,interpvelo);b.position.vadd(interpvelo,b.interpolatedPosition)}else{b.interpolatedPosition.copy(b.position);b.interpolatedQuaternion.copy(b.quaternion)}}}};var World_step_postStepEvent={type:"postStep"},World_step_preStepEvent={type:"preStep"},World_step_collideEvent={type:"collide",body:null,contact:null},World_step_oldContacts=[],World_step_frictionEquationPool=[],World_step_p1=[],World_step_p2=[],World_step_gvec=new Vec3,World_step_vi=new Vec3,World_step_vj=new Vec3,World_step_wi=new Vec3,World_step_wj=new Vec3,World_step_t1=new Vec3,World_step_t2=new Vec3,World_step_rixn=new Vec3,World_step_rjxn=new Vec3,World_step_step_q=new Quaternion,World_step_step_w=new Quaternion,World_step_step_wq=new Quaternion,invI_tau_dt=new Vec3;World.prototype.internalStep=function(dt){this.dt=dt;var world=this,that=this,contacts=this.contacts,p1=World_step_p1,p2=World_step_p2,N=this.numObjects(),bodies=this.bodies,solver=this.solver,gravity=this.gravity,doProfiling=this.doProfiling,profile=this.profile,DYNAMIC=Body.DYNAMIC,profilingStart,constraints=this.constraints,frictionEquationPool=World_step_frictionEquationPool,gnorm=gravity.norm(),gx=gravity.x,gy=gravity.y,gz=gravity.z,i=0;if(doProfiling){profilingStart=performance.now()}for(i=0;i!==N;i++){var bi=bodies[i];if(bi.type&DYNAMIC){var f=bi.force,m=bi.mass;f.x+=m*gx;f.y+=m*gy;f.z+=m*gz}}for(var i=0,Nsubsystems=this.subsystems.length;i!==Nsubsystems;i++){this.subsystems[i].update()}if(doProfiling){profilingStart=performance.now()}p1.length=0;p2.length=0;this.broadphase.collisionPairs(this,p1,p2);if(doProfiling){profile.broadphase=performance.now()-profilingStart}var Nconstraints=constraints.length;for(i=0;i!==Nconstraints;i++){var c=constraints[i];if(!c.collideConnected){for(var j=p1.length-1;j>=0;j-=1){if(c.bodyA===p1[j]&&c.bodyB===p2[j]||c.bodyB===p1[j]&&c.bodyA===p2[j]){p1.splice(j,1);p2.splice(j,1)}}}}this.collisionMatrixTick();if(doProfiling){profilingStart=performance.now()}var oldcontacts=World_step_oldContacts;var NoldContacts=contacts.length;for(i=0;i!==NoldContacts;i++){oldcontacts.push(contacts[i])}contacts.length=0;var NoldFrictionEquations=this.frictionEquations.length;for(i=0;i!==NoldFrictionEquations;i++){frictionEquationPool.push(this.frictionEquations[i])}this.frictionEquations.length=0;this.narrowphase.getContacts(p1,p2,this,contacts,oldcontacts,this.frictionEquations,frictionEquationPool);if(doProfiling){profile.narrowphase=performance.now()-profilingStart}if(doProfiling){profilingStart=performance.now()}for(var i=0;i<this.frictionEquations.length;i++){solver.addEquation(this.frictionEquations[i])}var ncontacts=contacts.length;for(var k=0;k!==ncontacts;k++){var c=contacts[k];var bi=c.bi,bj=c.bj,si=c.si,sj=c.sj;var cm;if(bi.material&&bj.material){cm=this.getContactMaterial(bi.material,bj.material)||this.defaultContactMaterial}else{cm=this.defaultContactMaterial}var mu=cm.friction;if(bi.material&&bj.material){if(bi.material.friction>=0&&bj.material.friction>=0){mu=bi.material.friction*bj.material.friction}if(bi.material.restitution>=0&&bj.material.restitution>=0){c.restitution=bi.material.restitution*bj.material.restitution}}solver.addEquation(c);if(bi.allowSleep&&bi.type===Body.DYNAMIC&&bi.sleepState===Body.SLEEPING&&bj.sleepState===Body.AWAKE&&bj.type!==Body.STATIC){var speedSquaredB=bj.velocity.norm2()+bj.angularVelocity.norm2();var speedLimitSquaredB=Math.pow(bj.sleepSpeedLimit,2);if(speedSquaredB>=speedLimitSquaredB*2){bi._wakeUpAfterNarrowphase=true}}if(bj.allowSleep&&bj.type===Body.DYNAMIC&&bj.sleepState===Body.SLEEPING&&bi.sleepState===Body.AWAKE&&bi.type!==Body.STATIC){var speedSquaredA=bi.velocity.norm2()+bi.angularVelocity.norm2();var speedLimitSquaredA=Math.pow(bi.sleepSpeedLimit,2);if(speedSquaredA>=speedLimitSquaredA*2){bj._wakeUpAfterNarrowphase=true}}this.collisionMatrix.set(bi,bj,true);if(!this.collisionMatrixPrevious.get(bi,bj)){World_step_collideEvent.body=bj;World_step_collideEvent.contact=c;bi.dispatchEvent(World_step_collideEvent);World_step_collideEvent.body=bi;bj.dispatchEvent(World_step_collideEvent)}}if(doProfiling){profile.makeContactConstraints=performance.now()-profilingStart;profilingStart=performance.now()}for(i=0;i!==N;i++){var bi=bodies[i];if(bi._wakeUpAfterNarrowphase){bi.wakeUp();bi._wakeUpAfterNarrowphase=false}}var Nconstraints=constraints.length;for(i=0;i!==Nconstraints;i++){var c=constraints[i];c.update();for(var j=0,Neq=c.equations.length;j!==Neq;j++){var eq=c.equations[j];solver.addEquation(eq)}}solver.solve(dt,this);if(doProfiling){profile.solve=performance.now()-profilingStart}solver.removeAllEquations();var pow=Math.pow;for(i=0;i!==N;i++){var bi=bodies[i];if(bi.type&DYNAMIC){var ld=pow(1-bi.linearDamping,dt);var v=bi.velocity;v.mult(ld,v);var av=bi.angularVelocity;if(av){var ad=pow(1-bi.angularDamping,dt);av.mult(ad,av)}}}this.dispatchEvent(World_step_preStepEvent);for(i=0;i!==N;i++){var bi=bodies[i];if(bi.preStep){bi.preStep.call(bi)}}if(doProfiling){profilingStart=performance.now()}var q=World_step_step_q;var w=World_step_step_w;var wq=World_step_step_wq;var stepnumber=this.stepnumber;var DYNAMIC_OR_KINEMATIC=Body.DYNAMIC|Body.KINEMATIC;var quatNormalize=stepnumber%(this.quatNormalizeSkip+1)===0;var quatNormalizeFast=this.quatNormalizeFast;var half_dt=dt*.5;var PLANE=Shape.types.PLANE,CONVEX=Shape.types.CONVEXPOLYHEDRON;for(i=0;i!==N;i++){var b=bodies[i],force=b.force,tau=b.torque;if(b.type&DYNAMIC_OR_KINEMATIC&&b.sleepState!==Body.SLEEPING){var velo=b.velocity,angularVelo=b.angularVelocity,pos=b.position,quat=b.quaternion,invMass=b.invMass,invInertia=b.invInertiaWorld;velo.x+=force.x*invMass*dt;velo.y+=force.y*invMass*dt;velo.z+=force.z*invMass*dt;if(b.angularVelocity){invInertia.vmult(tau,invI_tau_dt);invI_tau_dt.mult(dt,invI_tau_dt);invI_tau_dt.vadd(angularVelo,angularVelo)}pos.x+=velo.x*dt;pos.y+=velo.y*dt;pos.z+=velo.z*dt;if(b.angularVelocity){w.set(angularVelo.x,angularVelo.y,angularVelo.z,0);w.mult(quat,wq);quat.x+=half_dt*wq.x;quat.y+=half_dt*wq.y;quat.z+=half_dt*wq.z;quat.w+=half_dt*wq.w;if(quatNormalize){if(quatNormalizeFast){quat.normalizeFast()}else{quat.normalize()}}}if(b.aabb){b.aabbNeedsUpdate=true}if(b.updateInertiaWorld){b.updateInertiaWorld()}}}this.clearForces();this.broadphase.dirty=true;if(doProfiling){profile.integrate=performance.now()-profilingStart}this.time+=dt;this.stepnumber+=1;this.dispatchEvent(World_step_postStepEvent);for(i=0;i!==N;i++){var bi=bodies[i];var postStep=bi.postStep;if(postStep){postStep.call(bi)}}if(this.allowSleep){for(i=0;i!==N;i++){bodies[i].sleepTick(this.time)}}};World.prototype.clearForces=function(){var bodies=this.bodies;var N=bodies.length;for(var i=0;i!==N;i++){var b=bodies[i],force=b.force,tau=b.torque;b.force.set(0,0,0);b.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)});CANNON=CANNON||{};var camera,scene,renderer,controls=null;var s_oRender;CANNON.Demo=function(options){var that=this;this.addScene=addScene;this.restartCurrentScene=restartCurrentScene;this.changeScene=changeScene;this.start=start;var sceneFolder;var settings=this.settings={stepFrequency:60,quatNormalizeSkip:2,quatNormalizeFast:true,gx:0,gy:0,gz:0,iterations:3,tolerance:1e-4,k:1e6,d:3,scene:0,paused:false,rendermode:"solid",constraints:false,contacts:false,cm2contact:false,normals:false,axes:false,particleSize:.1,shadows:false,aabbs:false,profiling:false,maxSubSteps:3};options=options||{};for(var key in options){if(key in settings){settings[key]=options[key]}}if(settings.stepFrequency%60!==0){throw new Error("stepFrequency must be a multiple of 60.")}var bodies=this.bodies=[];var visuals=this.visuals=[];var scenes=[];var gui=null;var smoothie=null;var smoothieCanvas=null;var scenePicker={};var three_contactpoint_geo=new THREE.SphereGeometry(.1,6,6);var particleGeo=this.particleGeo=new THREE.SphereGeometry(1,16,8);var materialColor=11184810;var solidMaterial=new THREE.MeshPhongMaterial({color:materialColor,specular:1118481,shininess:50});var wireframeMaterial=new THREE.MeshLambertMaterial({color:16777215,wireframe:true});this.currentMaterial=solidMaterial;var contactDotMaterial=new THREE.MeshPhongMaterial({color:16711680});var particleMaterial=this.particleMaterial=new THREE.MeshLambertMaterial({color:16711680});var contactMeshCache=new GeometryCache(function(){return new THREE.Mesh(three_contactpoint_geo,contactDotMaterial)});var cm2contactMeshCache=new GeometryCache(function(){var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3(0,0,0));geometry.vertices.push(new THREE.Vector3(1,1,1));return new THREE.Line(geometry,new THREE.LineBasicMaterial({color:16711680}))});var bboxGeometry=new THREE.BoxGeometry(1,1,1);var bboxMaterial=new THREE.MeshBasicMaterial({color:materialColor,wireframe:true});var bboxMeshCache=new GeometryCache(function(){return new THREE.Mesh(bboxGeometry,bboxMaterial)});var distanceConstraintMeshCache=new GeometryCache(function(){var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3(0,0,0));geometry.vertices.push(new THREE.Vector3(1,1,1));return new THREE.Line(geometry,new THREE.LineBasicMaterial({color:16711680}))});var p2pConstraintMeshCache=new GeometryCache(function(){var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3(0,0,0));geometry.vertices.push(new THREE.Vector3(1,1,1));return new THREE.Line(geometry,new THREE.LineBasicMaterial({color:16711680}))});var normalMeshCache=new GeometryCache(function(){var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3(0,0,0));geometry.vertices.push(new THREE.Vector3(1,1,1));return new THREE.Line(geometry,new THREE.LineBasicMaterial({color:65280}))});var axesMeshCache=new GeometryCache(function(){var mesh=new THREE.Object3D;var origin=new THREE.Vector3(0,0,0);var gX=new THREE.Geometry;var gY=new THREE.Geometry;var gZ=new THREE.Geometry;gX.vertices.push(origin);gY.vertices.push(origin);gZ.vertices.push(origin);gX.vertices.push(new THREE.Vector3(1,0,0));gY.vertices.push(new THREE.Vector3(0,1,0));gZ.vertices.push(new THREE.Vector3(0,0,1));var lineX=new THREE.Line(gX,new THREE.LineBasicMaterial({color:16711680}));var lineY=new THREE.Line(gY,new THREE.LineBasicMaterial({color:65280}));var lineZ=new THREE.Line(gZ,new THREE.LineBasicMaterial({color:255}));mesh.add(lineX);mesh.add(lineY);mesh.add(lineZ);return mesh});function restartGeometryCaches(){contactMeshCache.restart();contactMeshCache.hideCached();cm2contactMeshCache.restart();cm2contactMeshCache.hideCached();distanceConstraintMeshCache.restart();distanceConstraintMeshCache.hideCached();normalMeshCache.restart();normalMeshCache.hideCached()}var world=this.world=new CANNON.World;world.broadphase=new CANNON.NaiveBroadphase;var renderModes=["solid","wireframe"];function updategui(){if(gui){for(var i in gui.__controllers){gui.__controllers[i].updateDisplay()}for(var f in gui.__folders){for(var i in gui.__folders[f].__controllers){gui.__folders[f].__controllers[i].updateDisplay()}}}}var light,ambient,stats,info;function setRenderMode(mode){if(renderModes.indexOf(mode)===-1){throw new Error("Render mode "+mode+" not found!")}switch(mode){case"solid":that.currentMaterial=solidMaterial;light.intensity=1;ambient.color.setHex(2236962);break;case"wireframe":that.currentMaterial=wireframeMaterial;light.intensity=0;ambient.color.setHex(16777215);break}function setMaterial(node,mat){if(node.material){node.material=mat}for(var i=0;i<node.children.length;i++){setMaterial(node.children[i],mat)}}for(var i=0;i<visuals.length;i++){setMaterial(visuals[i],that.currentMaterial)}settings.rendermode=mode}function addScene(title,initfunc){if(typeof title!=="string"){throw new Error("1st argument of Demo.addScene(title,initfunc) must be a string!")}if(typeof initfunc!=="function"){throw new Error("2nd argument of Demo.addScene(title,initfunc) must be a function!")}scenes.push(initfunc);var idx=scenes.length-1;scenePicker[title]=function(){changeScene(idx)};sceneFolder.add(scenePicker,title)}function restartCurrentScene(){var N=bodies.length;for(var i=0;i<N;i++){var b=bodies[i];b.position.copy(b.initPosition);b.velocity.copy(b.initVelocity);if(b.initAngularVelocity){b.angularVelocity.copy(b.initAngularVelocity);b.quaternion.copy(b.initQuaternion)}}}function makeSureNotZero(vec){if(vec.x===0){vec.x=1e-6}if(vec.y===0){vec.y=1e-6}if(vec.z===0){vec.z=1e-6}}function updateVisuals(){var N=bodies.length;for(var i=0;i<N;i++){var b=bodies[i],visual=visuals[i];visual.position.copy(b.position);if(b.quaternion){visual.quaternion.copy(b.quaternion)}}contactMeshCache.restart();if(settings.contacts){for(var ci=0;ci<world.contacts.length;ci++){for(var ij=0;ij<2;ij++){var mesh=contactMeshCache.request(),c=world.contacts[ci],b=ij===0?c.bi:c.bj,r=ij===0?c.ri:c.rj;mesh.position.set(b.position.x+r.x,b.position.y+r.y,b.position.z+r.z)}}}contactMeshCache.hideCached();cm2contactMeshCache.restart();if(settings.cm2contact){for(var ci=0;ci<world.contacts.length;ci++){for(var ij=0;ij<2;ij++){var line=cm2contactMeshCache.request(),c=world.contacts[ci],b=ij===0?c.bi:c.bj,r=ij===0?c.ri:c.rj;line.scale.set(r.x,r.y,r.z);makeSureNotZero(line.scale);line.position.copy(b.position)}}}cm2contactMeshCache.hideCached();distanceConstraintMeshCache.restart();p2pConstraintMeshCache.restart();if(settings.constraints){for(var ci=0;ci<world.constraints.length;ci++){var c=world.constraints[ci];if(!(c instanceof CANNON.DistanceConstraint)){continue}var nc=c.equations.normal;var bi=nc.bi,bj=nc.bj,line=distanceConstraintMeshCache.request();var i=bi.id,j=bj.id;var v;if(bj.position){v=bj.position}else{v=bj}line.scale.set(v.x-bi.position.x,v.y-bi.position.y,v.z-bi.position.z);makeSureNotZero(line.scale);line.position.copy(bi.position)}for(var ci=0;ci<world.constraints.length;ci++){var c=world.constraints[ci];if(!(c instanceof CANNON.PointToPointConstraint)){continue}var n=c.equations.normal;var bi=n.bi,bj=n.bj,relLine1=p2pConstraintMeshCache.request(),relLine2=p2pConstraintMeshCache.request(),diffLine=p2pConstraintMeshCache.request();var i=bi.id,j=bj.id;relLine1.scale.set(n.ri.x,n.ri.y,n.ri.z);relLine2.scale.set(n.rj.x,n.rj.y,n.rj.z);diffLine.scale.set(-n.penetrationVec.x,-n.penetrationVec.y,-n.penetrationVec.z);makeSureNotZero(relLine1.scale);makeSureNotZero(relLine2.scale);makeSureNotZero(diffLine.scale);relLine1.position.copy(bi.position);relLine2.position.copy(bj.position);n.bj.position.vadd(n.rj,diffLine.position)}}p2pConstraintMeshCache.hideCached();distanceConstraintMeshCache.hideCached();normalMeshCache.restart();if(settings.normals){for(var ci=0;ci<world.contacts.length;ci++){var c=world.contacts[ci];var bi=c.bi,bj=c.bj,line=normalMeshCache.request();var i=bi.id,j=bj.id;var n=c.ni;var b=bi;line.scale.set(n.x,n.y,n.z);makeSureNotZero(line.scale);line.position.copy(b.position);c.ri.vadd(line.position,line.position)}}normalMeshCache.hideCached();axesMeshCache.restart();if(settings.axes){for(var bi=0;bi<bodies.length;bi++){var b=bodies[bi],mesh=axesMeshCache.request();mesh.position.copy(b.position);if(b.quaternion){mesh.quaternion.copy(b.quaternion)}}}axesMeshCache.hideCached();bboxMeshCache.restart();if(settings.aabbs){for(var i=0;i<bodies.length;i++){var b=bodies[i];if(b.computeAABB){if(b.aabbNeedsUpdate){b.computeAABB()}if(isFinite(b.aabb.lowerBound.x)&&isFinite(b.aabb.lowerBound.y)&&isFinite(b.aabb.lowerBound.z)&&isFinite(b.aabb.upperBound.x)&&isFinite(b.aabb.upperBound.y)&&isFinite(b.aabb.upperBound.z)&&b.aabb.lowerBound.x-b.aabb.upperBound.x!=0&&b.aabb.lowerBound.y-b.aabb.upperBound.y!=0&&b.aabb.lowerBound.z-b.aabb.upperBound.z!=0){var mesh=bboxMeshCache.request();mesh.scale.set(b.aabb.lowerBound.x-b.aabb.upperBound.x,b.aabb.lowerBound.y-b.aabb.upperBound.y,b.aabb.lowerBound.z-b.aabb.upperBound.z);mesh.position.set((b.aabb.lowerBound.x+b.aabb.upperBound.x)*.5,(b.aabb.lowerBound.y+b.aabb.upperBound.y)*.5,(b.aabb.lowerBound.z+b.aabb.upperBound.z)*.5)}}}}bboxMeshCache.hideCached()}if(!Detector.webgl){Detector.addGetWebGLMessage()}var SHADOW_MAP_WIDTH=1024;var SHADOW_MAP_HEIGHT=1024;var MARGIN=0;var SCREEN_WIDTH=s_iCanvasResizeWidth+s_iCanvasOffsetWidth;var SCREEN_HEIGHT=s_iCanvasResizeHeight+s_iCanvasOffsetHeight;var container;var windowHalfX=SCREEN_WIDTH/2;var windowHalfY=SCREEN_HEIGHT/2;init();animate();function init(){container=document.createElement("div");document.body.appendChild(container);if(CAMERA_TEST_TRACKBALL){NEAR=1;camera=new THREE.PerspectiveCamera(45,SCREEN_WIDTH/SCREEN_HEIGHT,NEAR,FAR);camera.lookAt(new THREE.Vector3(CAMERA_TEST_LOOK_AT.x,CAMERA_TEST_LOOK_AT.y,CAMERA_TEST_LOOK_AT.z));camera.position.set(0,500,500);camera.up.set(0,0,1)}else{camera=createOrthoGraphicCamera()}scene=that.scene=new THREE.Scene;scene.fog=new THREE.Fog(8306926,FAR*.5,FAR);ambient=new THREE.AmbientLight(4473924);scene.add(ambient);light=new THREE.DirectionalLight(16777181,1);light.position.set(180,0,180);light.target.position.set(0,0,0);light.castShadow=true;light.shadow.camera.near=10;light.shadow.camera.far=100;light.shadow.camera.fov=FOV;light.shadowMapBias=.0139;light.shadowMapDarkness=.1;light.shadow.mapSize.width=SHADOW_MAP_WIDTH;light.shadow.mapSize.height=SHADOW_MAP_HEIGHT;new THREE.CameraHelper(light.shadow.camera);scene.add(light);scene.add(camera);if(SHOW_3D_RENDER){renderer=new THREE.WebGLRenderer({clearColor:0,clearAlpha:.5,antialias:true,alpha:true})}else{renderer=new THREE.CanvasRenderer({clearColor:0,clearAlpha:.5,antialias:false,alpha:true})}renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);renderer.domElement.style.position="relative";renderer.domElement.style.top=MARGIN+"px";renderer.domElement.style.opacity=CANVAS_3D_OPACITY;container.appendChild(renderer.domElement);info=document.createElement("div");info.style.position="absolute";info.style.top="10px";info.style.width="100%";info.style.textAlign="center";info.innerHTML='<a href="http://github.com/schteppe/cannon.js">cannon.js</a> - javascript 3d physics';container.appendChild(info);document.addEventListener("mousemove",onDocumentMouseMove);window.addEventListener("resize",onWindowResize);renderer.setClearColor(scene.fog.color,1);renderer.autoClear=false;smoothieCanvas=document.createElement("canvas");smoothieCanvas.width=SCREEN_WIDTH;smoothieCanvas.height=SCREEN_HEIGHT;smoothieCanvas.style.opacity=.5;smoothieCanvas.style.position="absolute";smoothieCanvas.style.top="0px";smoothieCanvas.style.zIndex=90;container.appendChild(smoothieCanvas);smoothie=new SmoothieChart({labelOffsetY:50,maxDataSetLength:100,millisPerPixel:2,grid:{strokeStyle:"none",fillStyle:"none",lineWidth:1,millisPerLine:250,verticalSections:6},labels:{fillStyle:"rgb(180, 180, 180)"}});smoothie.streamTo(smoothieCanvas);var lines={};var colors=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255]];var i=0;for(var label in world.profile){var c=colors[i%colors.length];lines[label]=new TimeSeries({label:label,fillStyle:"rgb("+c[0]+","+c[1]+","+c[2]+")",maxDataLength:500});i++}world.addEventListener("postStep",function(evt){for(var label in world.profile)lines[label].append(world.time*1e3,world.profile[label])});var i=0;for(var label in world.profile){var c=colors[i%colors.length];smoothie.addTimeSeries(lines[label],{strokeStyle:"rgb("+c[0]+","+c[1]+","+c[2]+")",lineWidth:2});i++}world.doProfiling=false;smoothie.stop();smoothieCanvas.style.display="none";stats=new Stats;stats.domElement.style.position="absolute";stats.domElement.style.top="0px";stats.domElement.style.zIndex=100;container.appendChild(stats.domElement);if(window.dat!=undefined){gui=new dat.GUI;gui.domElement.parentNode.style.zIndex=120;var rf=gui.addFolder("Rendering");rf.add(settings,"rendermode",{Solid:"solid",Wireframe:"wireframe"}).onChange(function(mode){setRenderMode(mode)});rf.add(settings,"contacts");rf.add(settings,"cm2contact");rf.add(settings,"normals");rf.add(settings,"constraints");rf.add(settings,"axes");rf.add(settings,"particleSize").min(0).max(1).onChange(function(size){for(var i=0;i<visuals.length;i++){if(bodies[i]instanceof CANNON.Particle)visuals[i].scale.set(size,size,size)}});rf.add(settings,"shadows").onChange(function(shadows){if(shadows){renderer.shadowMapAutoUpdate=true}else{renderer.shadowMapAutoUpdate=false;renderer.clearTarget(light.shadowMap)}});rf.add(settings,"aabbs");rf.add(settings,"profiling").onChange(function(profiling){if(profiling){world.doProfiling=true;smoothie.start();smoothieCanvas.style.display="block"}else{world.doProfiling=false;smoothie.stop();smoothieCanvas.style.display="none"}});var wf=gui.addFolder("World");wf.add(settings,"paused").onChange(function(p){});wf.add(settings,"stepFrequency",60,60*10).step(60);var maxg=100;wf.add(settings,"gx",-maxg,maxg).onChange(function(gx){if(!isNaN(gx)){world.gravity.set(gx,settings.gy,settings.gz)}});wf.add(settings,"gy",-maxg,maxg).onChange(function(gy){if(!isNaN(gy))world.gravity.set(settings.gx,gy,settings.gz)});wf.add(settings,"gz",-maxg,maxg).onChange(function(gz){if(!isNaN(gz))world.gravity.set(settings.gx,settings.gy,gz)});wf.add(settings,"quatNormalizeSkip",0,50).step(1).onChange(function(skip){if(!isNaN(skip)){world.quatNormalizeSkip=skip}});wf.add(settings,"quatNormalizeFast").onChange(function(fast){world.quatNormalizeFast=!!fast});var sf=gui.addFolder("Solver");sf.add(settings,"iterations",1,50).step(1).onChange(function(it){world.solver.iterations=it});sf.add(settings,"k",10,1e7).onChange(function(k){that.setGlobalSpookParams(settings.k,settings.d,1/settings.stepFrequency)});sf.add(settings,"d",0,20).step(.1).onChange(function(d){that.setGlobalSpookParams(settings.k,settings.d,1/settings.stepFrequency)});sf.add(settings,"tolerance",0,10).step(.01).onChange(function(t){world.solver.tolerance=t});sceneFolder=gui.addFolder("Scenes");sceneFolder.open()}if(CAMERA_TEST_TRACKBALL){controls=new THREE.TrackballControls(camera,renderer.domElement);controls.rotateSpeed=1;controls.zoomSpeed=1.2;controls.panSpeed=.2;controls.noZoom=false;controls.noPan=false;controls.staticMoving=false;controls.dynamicDampingFactor=.3;var radius=100;controls.minDistance=0;controls.maxDistance=radius*1e3;controls.keys=[65,83,68];controls.screen.width=SCREEN_WIDTH;controls.screen.height=SCREEN_HEIGHT}}var t=0,newTime,delta;function animate(){requestAnimationFrame(animate);if(!settings.paused){updateVisuals();updatePhysics()}render();stats.update()}var lastCallTime=0;function updatePhysics(){}function onDocumentMouseMove(event){mouseX=event.clientX-windowHalfX;mouseY=event.clientY-windowHalfY}function onWindowResize(event){SCREEN_WIDTH=s_iCanvasResizeWidth+s_iCanvasOffsetWidth*2;SCREEN_HEIGHT=s_iCanvasResizeHeight+s_iCanvasOffsetHeight*2;if(CAMERA_TEST_TRACKBALL){controls.screen.width=SCREEN_WIDTH;controls.screen.height=SCREEN_HEIGHT}}function render(){if(CAMERA_TEST_TRACKBALL||CAMERA_TEST_TRANSFORM&&controls!==null){controls.update()}renderer.clear();renderer.render(that.scene,camera)}s_oRender=render;document.addEventListener("keypress",function(e){if(e.keyCode){switch(e.keyCode){case 32:restartCurrentScene();break;case 104:if(stats.domElement.style.display=="none"){stats.domElement.style.display="block";info.style.display="block"}else{stats.domElement.style.display="none";info.style.display="none"}break;case 97:settings.aabbs=!settings.aabbs;updategui();break;case 99:settings.constraints=!settings.constraints;updategui();break;case 112:settings.paused=!settings.paused;updategui();break;case 115:var timeStep=1/settings.stepFrequency;world.step(timeStep);updateVisuals();break;case 109:var idx=renderModes.indexOf(settings.rendermode);idx++;idx=idx%renderModes.length;setRenderMode(renderModes[idx]);updategui();break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(scenes.length>e.keyCode-49&&!document.activeElement.localName.match(/input/)){changeScene(e.keyCode-49)}break}}});function changeScene(n){that.dispatchEvent({type:"destroy"});settings.paused=false;updategui();buildScene(n)}function start(){buildScene(0)}function buildScene(n){var num=visuals.length;for(var i=0;i<num;i++){world.remove(bodies.pop());var mesh=visuals.pop();that.scene.remove(mesh)}while(world.constraints.length){world.removeConstraint(world.constraints[0])}scenes[n]();settings.iterations=world.solver.iterations;settings.gx=world.gravity.x+0;settings.gy=world.gravity.y+0;settings.gz=world.gravity.z+0;settings.quatNormalizeSkip=world.quatNormalizeSkip;settings.quatNormalizeFast=world.quatNormalizeFast;updategui();restartGeometryCaches()}function GeometryCache(createFunc){var that=this,geometries=[],gone=[];this.request=function(){if(geometries.length){geo=geometries.pop()}else{geo=createFunc()}scene.add(geo);gone.push(geo);return geo};this.restart=function(){while(gone.length){geometries.push(gone.pop())}};this.hideCached=function(){for(var i=0;i<geometries.length;i++){scene.remove(geometries[i])}}}};CANNON.Demo.prototype=new CANNON.EventTarget;CANNON.Demo.constructor=CANNON.Demo;CANNON.Demo.prototype.setGlobalSpookParams=function(k,d,h){var world=this.world;for(var i=0;i<world.constraints.length;i++){var c=world.constraints[i];for(var j=0;j<c.equations.length;j++){var eq=c.equations[j];eq.setSpookParams(k,d,h)}}for(var i=0;i<world.contactmaterials.length;i++){var cm=world.contactmaterials[i];cm.contactEquationStiffness=k;cm.frictionEquationStiffness=k;cm.contactEquationRelaxation=d;cm.frictionEquationRelaxation=d}world.defaultContactMaterial.contactEquationStiffness=k;world.defaultContactMaterial.frictionEquationStiffness=k;world.defaultContactMaterial.contactEquationRelaxation=d;world.defaultContactMaterial.frictionEquationRelaxation=d};CANNON.Demo.prototype.createTransformControl=function(oMesh,oBody){controls=new THREE.TransformControls(camera,renderer.domElement);scene.add(oMesh);controls.attach(oMesh,oBody);scene.add(controls);console.log("CREATE");window.addEventListener("keydown",function(event){switch(event.keyCode){case 81:controls.setSpace(controls.space==="local"?"world":"local");break;case 17:controls.setTranslationSnap(100);controls.setRotationSnap(THREE.Math.degToRad(15));break;case 87:controls.setMode("translate");break;case 69:controls.setMode("rotate");break;case 82:controls.setMode("scale");break;case 187:case 107:controls.setSize(controls.size+.1);break;case 189:case 109:controls.setSize(Math.max(controls.size-.1,.1));break}});window.addEventListener("keyup",function(event){switch(event.keyCode){case 17:controls.setTranslationSnap(null);controls.setRotationSnap(null);break}})};CANNON.Demo.prototype.getWorld=function(){return this.world};CANNON.Demo.prototype.addVisual=function(body,material){var s=this.settings;var mesh;if(body instanceof CANNON.Body){mesh=this.shape2mesh(body,material)}if(mesh){this.bodies.push(body);this.visuals.push(mesh);body.visualref=mesh;body.visualref.visualId=this.bodies.length-1;this.scene.add(mesh)}return mesh};CANNON.Demo.prototype.addVisuals=function(bodies){for(var i=0;i<bodies.length;i++){this.addVisual(bodies[i])}};CANNON.Demo.prototype.removeVisual=function(body){if(body.visualref){var bodies=this.bodies,visuals=this.visuals,old_b=[],old_v=[],n=bodies.length;for(var i=0;i<n;i++){old_b.unshift(bodies.pop());old_v.unshift(visuals.pop())}var id=body.visualref.visualId;for(var j=0;j<old_b.length;j++){if(j!==id){var i=j>id?j-1:j;bodies[i]=old_b[j];visuals[i]=old_v[j];bodies[i].visualref=old_b[j].visualref;bodies[i].visualref.visualId=i}}body.visualref.visualId=null;this.scene.remove(body.visualref);body.visualref=null}};CANNON.Demo.prototype.removeAllVisuals=function(){while(this.bodies.length){this.removeVisual(this.bodies[0])}};CANNON.Demo.prototype.shape2mesh=function(body,material){var wireframe=this.settings.renderMode==="wireframe";var obj=new THREE.Object3D;for(var l=0;l<body.shapes.length;l++){var shape=body.shapes[l];var mesh;switch(shape.type){case CANNON.Shape.types.SPHERE:var sphere_geometry=new THREE.SphereGeometry(shape.radius,8,8);if(material===undefined){mesh=new THREE.Mesh(sphere_geometry,this.currentMaterial)}else{mesh=new THREE.Mesh(sphere_geometry,material)}mesh.castShadow=true;break;case CANNON.Shape.types.PARTICLE:mesh=new THREE.Mesh(this.particleGeo,this.particleMaterial);var s=this.settings;mesh.scale.set(s.particleSize,s.particleSize,s.particleSize);break;case CANNON.Shape.types.PLANE:var geometry=new THREE.PlaneGeometry(10,10,4,4);mesh=new THREE.Object3D;var submesh=new THREE.Object3D;var ground;if(material===undefined){ground=new THREE.Mesh(geometry,this.currentMaterial)}else{ground=new THREE.Mesh(geometry,material)}ground.scale.set(100,100,100);submesh.add(ground);ground.castShadow=false;ground.receiveShadow=true;mesh.add(submesh);break;case CANNON.Shape.types.BOX:var box_geometry=new THREE.BoxGeometry(shape.halfExtents.x*2,shape.halfExtents.y*2,shape.halfExtents.z*2);if(material===undefined){mesh=new THREE.Mesh(box_geometry,this.currentMaterial)}else{mesh=new THREE.Mesh(box_geometry,material)}break;case CANNON.Shape.types.CONVEXPOLYHEDRON:var geo=new THREE.Geometry;for(var i=0;i<shape.vertices.length;i++){var v=shape.vertices[i];geo.vertices.push(new THREE.Vector3(v.x,v.y,v.z))}for(var i=0;i<shape.faces.length;i++){var face=shape.faces[i];var a=face[0];for(var j=1;j<face.length-1;j++){var b=face[j];var c=face[j+1];geo.faces.push(new THREE.Face3(a,b,c))}}geo.computeBoundingSphere();geo.computeFaceNormals();if(material===undefined){mesh=new THREE.Mesh(geo,this.currentMaterial)}else{mesh=new THREE.Mesh(geo,material)}break;case CANNON.Shape.types.HEIGHTFIELD:var geometry=new THREE.Geometry;var v0=new CANNON.Vec3;var v1=new CANNON.Vec3;var v2=new CANNON.Vec3;for(var xi=0;xi<shape.data.length-1;xi++){for(var yi=0;yi<shape.data[xi].length-1;yi++){for(var k=0;k<2;k++){shape.getConvexTrianglePillar(xi,yi,k===0);v0.copy(shape.pillarConvex.vertices[0]);v1.copy(shape.pillarConvex.vertices[1]);v2.copy(shape.pillarConvex.vertices[2]);v0.vadd(shape.pillarOffset,v0);v1.vadd(shape.pillarOffset,v1);v2.vadd(shape.pillarOffset,v2);geometry.vertices.push(new THREE.Vector3(v0.x,v0.y,v0.z),new THREE.Vector3(v1.x,v1.y,v1.z),new THREE.Vector3(v2.x,v2.y,v2.z));var i=geometry.vertices.length-3;geometry.faces.push(new THREE.Face3(i,i+1,i+2))}}}geometry.computeBoundingSphere();geometry.computeFaceNormals();if(material===undefined){mesh=new THREE.Mesh(geometry,this.currentMaterial)}else{mesh=new THREE.Mesh(geometry,material)}break;case CANNON.Shape.types.TRIMESH:var geometry=new THREE.Geometry;var v0=new CANNON.Vec3;var v1=new CANNON.Vec3;var v2=new CANNON.Vec3;for(var i=0;i<shape.indices.length/3;i++){shape.getTriangleVertices(i,v0,v1,v2);geometry.vertices.push(new THREE.Vector3(v0.x,v0.y,v0.z),new THREE.Vector3(v1.x,v1.y,v1.z),new THREE.Vector3(v2.x,v2.y,v2.z));var j=geometry.vertices.length-3;geometry.faces.push(new THREE.Face3(j,j+1,j+2))}geometry.computeBoundingSphere();geometry.computeFaceNormals();if(material===undefined){mesh=new THREE.Mesh(geometry,this.currentMaterial)}else{mesh=new THREE.Mesh(geometry,material)}break;default:throw"Visual type not recognized: "+shape.type}mesh.receiveShadow=true;mesh.castShadow=true;if(mesh.children){for(var i=0;i<mesh.children.length;i++){mesh.children[i].castShadow=true;mesh.children[i].receiveShadow=true;if(mesh.children[i]){for(var j=0;j<mesh.children[i].length;j++){mesh.children[i].children[j].castShadow=true;mesh.children[i].children[j].receiveShadow=true}}}}var o=body.shapeOffsets[l];var q=body.shapeOrientations[l];mesh.position.set(o.x,o.y,o.z);mesh.quaternion.set(q.x,q.y,q.z,q.w);obj.add(mesh)}this.camera=function(){return camera};this.getScene=function(){return scene};return obj};Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return false}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var element=document.createElement("div");element.id="webgl-error-message";element.style.fontFamily="monospace";element.style.fontSize="13px";element.style.fontWeight="normal";element.style.textAlign="center";element.style.background="#fff";element.style.color="#000";element.style.padding="1.5em";element.style.width="400px";element.style.margin="5em auto 0";if(!this.webgl){element.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")}return element},addGetWebGLMessage:function(parameters){var parent,id,element;parameters=parameters||{};parent=parameters.parent!==undefined?parameters.parent:document.body;id=parameters.id!==undefined?parameters.id:"oldie";element=Detector.getWebGLErrorMessage();element.id=id;parent.appendChild(element)}};function TimeSeries(options){options=options||{};options.resetBoundsInterval=options.resetBoundsInterval||3e3;options.resetBounds=options.resetBounds===undefined?true:options.resetBounds;this.options=options;this.data=[];this.label=options.label||"";this.maxDataLength=options.maxDataLength||1e3;this.dataPool=[];this.maxValue=Number.NaN;this.minValue=Number.NaN;if(options.resetBounds){this.boundsTimer=setInterval(function(thisObj){return function(){thisObj.resetBounds()}}(this),options.resetBoundsInterval)}}TimeSeries.prototype.resetBounds=function(){this.maxValue=Number.NaN;this.minValue=Number.NaN;for(var i=0;i<this.data.length;i++){this.maxValue=!isNaN(this.maxValue)?Math.max(this.maxValue,this.data[i][1]):this.data[i][1];this.minValue=!isNaN(this.minValue)?Math.min(this.minValue,this.data[i][1]):this.data[i][1]}};TimeSeries.prototype.append=function(timestamp,value){this.lastTimeStamp=timestamp;var newData=this.dataPool.length?this.dataPool.pop():[timestamp,value];newData[0]=timestamp;newData[1]=value;this.data.push(newData);this.maxValue=!isNaN(this.maxValue)?Math.max(this.maxValue,value):value;this.minValue=!isNaN(this.minValue)?Math.min(this.minValue,value):value;while(this.data.length>this.maxDataLength)this.dataPool.push(this.data.shift())};function SmoothieChart(options){options=options||{};options.grid=options.grid||{fillStyle:"#000000",strokeStyle:"#777777",lineWidth:1,millisPerLine:1e3,verticalSections:2};options.millisPerPixel=options.millisPerPixel||20;options.fps=options.fps||50;options.maxValueScale=options.maxValueScale||1;options.minValue=options.minValue;options.maxValue=options.maxValue;options.labels=options.labels||{fillStyle:"#ffffff"};options.interpolation=options.interpolation||"bezier";options.scaleSmoothing=options.scaleSmoothing||.125;options.maxDataSetLength=options.maxDataSetLength||2;options.timestampFormatter=options.timestampFormatter||null;this.options=options;this.seriesSet=[];this.currentValueRange=1;this.currentVisMinValue=0}SmoothieChart.prototype.addTimeSeries=function(timeSeries,options){this.seriesSet.push({timeSeries:timeSeries,options:options||{}})};SmoothieChart.prototype.removeTimeSeries=function(timeSeries){this.seriesSet.splice(this.seriesSet.indexOf(timeSeries),1)};SmoothieChart.prototype.streamTo=function(canvas,delay){var self=this;this.render_on_tick=function(){var timeSeries=self.seriesSet[0].timeSeries;var dataSet=timeSeries.data;self.render(canvas,timeSeries.lastTimeStamp)};this.start()};SmoothieChart.prototype.start=function(){if(!this.timer)this.timer=setInterval(this.render_on_tick,1e3/this.options.fps)};SmoothieChart.prototype.stop=function(){if(this.timer){clearInterval(this.timer);this.timer=undefined}};SmoothieChart.timeFormatter=function(dateObject){function pad2(number){return(number<10?"0":"")+number}return pad2(dateObject.getHours())+":"+pad2(dateObject.getMinutes())+":"+pad2(dateObject.getSeconds())};SmoothieChart.prototype.render=function(canvas,time){var canvasContext=canvas.getContext("2d");var options=this.options;var dimensions={top:0,left:0,width:canvas.clientWidth,height:canvas.clientHeight};canvasContext.save();time=time-time%options.millisPerPixel;canvasContext.translate(dimensions.left,dimensions.top);canvasContext.beginPath();canvasContext.rect(0,0,dimensions.width,dimensions.height);canvasContext.clip();canvasContext.save();canvasContext.fillStyle=options.grid.fillStyle;canvasContext.clearRect(0,0,dimensions.width,dimensions.height);canvasContext.fillRect(0,0,dimensions.width,dimensions.height);canvasContext.restore();canvasContext.save();canvasContext.lineWidth=options.grid.lineWidth||1;canvasContext.strokeStyle=options.grid.strokeStyle||"#ffffff";if(options.grid.millisPerLine>0){for(var t=time-time%options.grid.millisPerLine;t>=time-dimensions.width*options.millisPerPixel;t-=options.grid.millisPerLine){canvasContext.beginPath();var gx=Math.round(dimensions.width-(time-t)/options.millisPerPixel);canvasContext.moveTo(gx,0);canvasContext.lineTo(gx,dimensions.height);canvasContext.stroke();if(options.timestampFormatter){var tx=new Date(t);var ts=options.timestampFormatter(tx);var txtwidth=canvasContext.measureText(ts).width/2+canvasContext.measureText(minValueString).width+4;if(gx<dimensions.width-txtwidth){canvasContext.fillStyle=options.labels.fillStyle;canvasContext.fillText(ts,gx-canvasContext.measureText(ts).width/2,dimensions.height-2)}}canvasContext.closePath()}}for(var v=1;v<options.grid.verticalSections;v++){var gy=Math.round(v*dimensions.height/options.grid.verticalSections);canvasContext.beginPath();canvasContext.moveTo(0,gy);canvasContext.lineTo(dimensions.width,gy);canvasContext.stroke();canvasContext.closePath()}canvasContext.beginPath();canvasContext.strokeRect(0,0,dimensions.width,dimensions.height);canvasContext.closePath();canvasContext.restore();var maxValue=Number.NaN;var minValue=Number.NaN;for(var d=0;d<this.seriesSet.length;d++){var timeSeries=this.seriesSet[d].timeSeries;if(!isNaN(timeSeries.maxValue)){maxValue=!isNaN(maxValue)?Math.max(maxValue,timeSeries.maxValue):timeSeries.maxValue}if(!isNaN(timeSeries.minValue)){minValue=!isNaN(minValue)?Math.min(minValue,timeSeries.minValue):timeSeries.minValue}}if(isNaN(maxValue)&&isNaN(minValue)){canvasContext.restore();return}if(options.maxValue!=null)maxValue=options.maxValue;else maxValue=maxValue*options.maxValueScale;if(options.minValue!=null)minValue=options.minValue;var targetValueRange=maxValue-minValue;this.currentValueRange+=options.scaleSmoothing*(targetValueRange-this.currentValueRange);this.currentVisMinValue+=options.scaleSmoothing*(minValue-this.currentVisMinValue);var valueRange=this.currentValueRange;var visMinValue=this.currentVisMinValue;for(var d=0;d<this.seriesSet.length;d++){canvasContext.save();var timeSeries=this.seriesSet[d].timeSeries;var dataSet=timeSeries.data;var seriesOptions=this.seriesSet[d].options;while(dataSet.length>=options.maxDataSetLength&&dataSet[1][0]<time-dimensions.width*options.millisPerPixel){dataSet.splice(0,1)}canvasContext.lineWidth=seriesOptions.lineWidth||1;canvasContext.fillStyle=seriesOptions.fillStyle;canvasContext.strokeStyle=seriesOptions.strokeStyle||"#ffffff";canvasContext.beginPath();var firstX=0,lastX=0,lastY=0;for(var i=0;i<dataSet.length;i++){var x=Math.round(dimensions.width-(time-dataSet[i][0])/options.millisPerPixel);var value=dataSet[i][1];var offset=value-visMinValue;var scaledValue=dimensions.height-(valueRange?Math.round(offset/valueRange*dimensions.height):0);var y=Math.max(Math.min(scaledValue,dimensions.height-1),1);if(i==0){firstX=x;canvasContext.moveTo(x,y)}else{switch(options.interpolation){case"line":canvasContext.lineTo(x,y);break;case"bezier":default:canvasContext.bezierCurveTo(Math.round((lastX+x)/2),lastY,Math.round(lastX+x)/2,y,x,y);break}}lastX=x,lastY=y}if(dataSet.length>0&&seriesOptions.fillStyle){canvasContext.lineTo(dimensions.width+seriesOptions.lineWidth+1,lastY);canvasContext.lineTo(dimensions.width+seriesOptions.lineWidth+1,dimensions.height+seriesOptions.lineWidth+1);canvasContext.lineTo(firstX,dimensions.height+seriesOptions.lineWidth);canvasContext.fill()}canvasContext.stroke();canvasContext.closePath();canvasContext.restore()}if(!options.labels.disabled){if(!options.labelOffsetY)options.labelOffsetY=0;canvasContext.fillStyle=options.labels.fillStyle;var maxValueString=parseFloat(maxValue).toFixed(2);var minValueString=parseFloat(minValue).toFixed(2);canvasContext.fillText(maxValueString,dimensions.width-canvasContext.measureText(maxValueString).width-2,10);canvasContext.fillText(minValueString,dimensions.width-canvasContext.measureText(minValueString).width-2,dimensions.height-2);for(var i=0;i<this.seriesSet.length;i++){var timeSeries=this.seriesSet[i].timeSeries;var label=timeSeries.label;canvasContext.fillStyle=timeSeries.options.fillStyle||"rgb(255,255,255)";if(label)canvasContext.fillText(label,2,10*(i+1)+options.labelOffsetY)}}canvasContext.restore()};var Stats=function(){var h,a,n=0,o=0,i=Date.now(),u=i,p=i,l=0,q=1e3,r=0,e,j,f,b=[[16,16,48],[0,255,255]],m=0,s=1e3,t=0,d,k,g,c=[[16,48,16],[0,255,0]];h=document.createElement("div");h.style.cursor="pointer";h.style.width="80px";h.style.opacity="0.9";h.style.zIndex="10001";h.addEventListener("mousedown",function(a){a.preventDefault();n=(n+1)%2;n==0?(e.style.display="block",d.style.display="none"):(e.style.display="none",d.style.display="block")},!1);e=document.createElement("div");e.style.textAlign="left";e.style.lineHeight="1.2em";e.style.backgroundColor="rgb("+Math.floor(b[0][0]/2)+","+Math.floor(b[0][1]/2)+","+Math.floor(b[0][2]/2)+")";e.style.padding="0 0 3px 3px";h.appendChild(e);j=document.createElement("div");j.style.fontFamily="Helvetica, Arial, sans-serif";j.style.fontSize="9px";j.style.color="rgb("+b[1][0]+","+b[1][1]+","+b[1][2]+")";j.style.fontWeight="bold";j.innerHTML="FPS";e.appendChild(j);f=document.createElement("div");f.style.position="relative";f.style.width="74px";f.style.height="30px";f.style.backgroundColor="rgb("+b[1][0]+","+b[1][1]+","+b[1][2]+")";for(e.appendChild(f);f.children.length<74;)a=document.createElement("span"),a.style.width="1px",a.style.height="30px",a.style.cssFloat="left",a.style.backgroundColor="rgb("+b[0][0]+","+b[0][1]+","+b[0][2]+")",f.appendChild(a);d=document.createElement("div");d.style.textAlign="left";d.style.lineHeight="1.2em";d.style.backgroundColor="rgb("+Math.floor(c[0][0]/2)+","+Math.floor(c[0][1]/2)+","+Math.floor(c[0][2]/2)+")";d.style.padding="0 0 3px 3px";d.style.display="none";h.appendChild(d);k=document.createElement("div");k.style.fontFamily="Helvetica, Arial, sans-serif";k.style.fontSize="9px";k.style.color="rgb("+c[1][0]+","+c[1][1]+","+c[1][2]+")";k.style.fontWeight="bold";k.innerHTML="MS";d.appendChild(k);g=document.createElement("div");g.style.position="relative";g.style.width="74px";g.style.height="30px";g.style.backgroundColor="rgb("+c[1][0]+","+c[1][1]+","+c[1][2]+")";for(d.appendChild(g);g.children.length<74;)a=document.createElement("span"),a.style.width="1px",a.style.height=Math.random()*30+"px",a.style.cssFloat="left",a.style.backgroundColor="rgb("+c[0][0]+","+c[0][1]+","+c[0][2]+")",g.appendChild(a);return{domElement:h,update:function(){i=Date.now();m=i-u;s=Math.min(s,m);t=Math.max(t,m);k.textContent=m+" MS ("+s+"-"+t+")";var a=Math.min(30,30-m/200*30);g.appendChild(g.firstChild).style.height=a+"px";u=i;o++;if(i>p+1e3)l=Math.round(o*1e3/(i-p)),q=Math.min(q,l),r=Math.max(r,l),j.textContent=l+" FPS ("+q+"-"+r+")",a=Math.min(30,30-l/100*30),f.appendChild(f.firstChild).style.height=a+"px",p=i,o=0}}};THREE.TrackballControls=function(object,domElement){var _this=this;var STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=object;this.domElement=domElement!==undefined?domElement:document;this.enabled=true;this.screen={left:0,top:0,width:0,height:0};this.rotateSpeed=1;this.zoomSpeed=1.2;this.panSpeed=.3;this.noRotate=false;this.noZoom=false;this.noPan=false;this.noRoll=false;this.staticMoving=false;this.dynamicDampingFactor=.2;this.minDistance=0;this.maxDistance=Infinity;this.keys=[65,83,68];this.target=new THREE.Vector3;var EPS=1e-6;var lastPosition=new THREE.Vector3;var _state=STATE.NONE,_prevState=STATE.NONE,_eye=new THREE.Vector3,_rotateStart=new THREE.Vector3,_rotateEnd=new THREE.Vector3,_zoomStart=new THREE.Vector2,_zoomEnd=new THREE.Vector2,_touchZoomDistanceStart=0,_touchZoomDistanceEnd=0,_panStart=new THREE.Vector2,_panEnd=new THREE.Vector2;this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();var changeEvent={type:"change"};var startEvent={type:"start"};var endEvent={type:"end"};this.handleResize=function(){if(this.domElement===document){this.screen.left=0;this.screen.top=0;this.screen.width=window.innerWidth;this.screen.height=window.innerHeight}else{var box=this.domElement.getBoundingClientRect();var d=this.domElement.ownerDocument.documentElement;this.screen.left=box.left+window.pageXOffset-d.clientLeft;this.screen.top=box.top+window.pageYOffset-d.clientTop;this.screen.width=box.width;this.screen.height=box.height}};this.handleEvent=function(event){if(typeof this[event.type]=="function"){this[event.type](event)}};var getMouseOnScreen=function(){var vector=new THREE.Vector2;return function(pageX,pageY){vector.set((pageX-_this.screen.left)/_this.screen.width,(pageY-_this.screen.top)/_this.screen.height);return vector}}();var getMouseProjectionOnBall=function(){var vector=new THREE.Vector3;var objectUp=new THREE.Vector3;var mouseOnBall=new THREE.Vector3;return function(pageX,pageY){mouseOnBall.set((pageX-_this.screen.width*.5-_this.screen.left)/(_this.screen.width*.5),(_this.screen.height*.5+_this.screen.top-pageY)/(_this.screen.height*.5),0);var length=mouseOnBall.length();if(_this.noRoll){if(length<Math.SQRT1_2){mouseOnBall.z=Math.sqrt(1-length*length)}else{mouseOnBall.z=.5/length}}else if(length>1){mouseOnBall.normalize()}else{mouseOnBall.z=Math.sqrt(1-length*length)}_eye.copy(_this.object.position).sub(_this.target);vector.copy(_this.object.up).setLength(mouseOnBall.y);vector.add(objectUp.copy(_this.object.up).cross(_eye).setLength(mouseOnBall.x));vector.add(_eye.setLength(mouseOnBall.z));return vector}}();this.rotateCamera=function(){var axis=new THREE.Vector3,quaternion=new THREE.Quaternion;return function(){var angle=Math.acos(_rotateStart.dot(_rotateEnd)/_rotateStart.length()/_rotateEnd.length());if(angle){axis.crossVectors(_rotateStart,_rotateEnd).normalize();angle*=_this.rotateSpeed;quaternion.setFromAxisAngle(axis,-angle);_eye.applyQuaternion(quaternion);_this.object.up.applyQuaternion(quaternion);_rotateEnd.applyQuaternion(quaternion);if(_this.staticMoving){_rotateStart.copy(_rotateEnd)}else{quaternion.setFromAxisAngle(axis,angle*(_this.dynamicDampingFactor-1));_rotateStart.applyQuaternion(quaternion)}}}}();this.zoomCamera=function(){if(_state===STATE.TOUCH_ZOOM_PAN){var factor=_touchZoomDistanceStart/_touchZoomDistanceEnd;_touchZoomDistanceStart=_touchZoomDistanceEnd;_eye.multiplyScalar(factor)}else{var factor=1+(_zoomEnd.y-_zoomStart.y)*_this.zoomSpeed;if(factor!==1&&factor>0){_eye.multiplyScalar(factor);if(_this.staticMoving){_zoomStart.copy(_zoomEnd)}else{_zoomStart.y+=(_zoomEnd.y-_zoomStart.y)*this.dynamicDampingFactor}}}};this.panCamera=function(){var mouseChange=new THREE.Vector2,objectUp=new THREE.Vector3,pan=new THREE.Vector3;return function(){mouseChange.copy(_panEnd).sub(_panStart);if(mouseChange.lengthSq()){mouseChange.multiplyScalar(_eye.length()*_this.panSpeed);pan.copy(_eye).cross(_this.object.up).setLength(mouseChange.x);pan.add(objectUp.copy(_this.object.up).setLength(mouseChange.y));_this.object.position.add(pan);_this.target.add(pan);if(_this.staticMoving){_panStart.copy(_panEnd)}else{_panStart.add(mouseChange.subVectors(_panEnd,_panStart).multiplyScalar(_this.dynamicDampingFactor))}}}}();this.checkDistances=function(){if(!_this.noZoom||!_this.noPan){if(_eye.lengthSq()>_this.maxDistance*_this.maxDistance){_this.object.position.addVectors(_this.target,_eye.setLength(_this.maxDistance))}if(_eye.lengthSq()<_this.minDistance*_this.minDistance){_this.object.position.addVectors(_this.target,_eye.setLength(_this.minDistance))}}};this.update=function(){_eye.subVectors(_this.object.position,_this.target);if(!_this.noRotate){_this.rotateCamera()}if(!_this.noZoom){_this.zoomCamera()}if(!_this.noPan){_this.panCamera()}_this.object.position.addVectors(_this.target,_eye);_this.checkDistances();_this.object.lookAt(_this.target);if(lastPosition.distanceToSquared(_this.object.position)>EPS){_this.dispatchEvent(changeEvent);lastPosition.copy(_this.object.position)}};this.reset=function(){_state=STATE.NONE;_prevState=STATE.NONE;_this.target.copy(_this.target0);_this.object.position.copy(_this.position0);_this.object.up.copy(_this.up0);_eye.subVectors(_this.object.position,_this.target);_this.object.lookAt(_this.target);_this.dispatchEvent(changeEvent);lastPosition.copy(_this.object.position)};function keydown(event){if(_this.enabled===false)return;window.removeEventListener("keydown",keydown);_prevState=_state;if(_state!==STATE.NONE){return}else if(event.keyCode===_this.keys[STATE.ROTATE]&&!_this.noRotate){_state=STATE.ROTATE}else if(event.keyCode===_this.keys[STATE.ZOOM]&&!_this.noZoom){_state=STATE.ZOOM}else if(event.keyCode===_this.keys[STATE.PAN]&&!_this.noPan){_state=STATE.PAN}}function keyup(event){if(_this.enabled===false)return;_state=_prevState;window.addEventListener("keydown",keydown,false)}function mousedown(event){if(_this.enabled===false)return;event.preventDefault();event.stopPropagation();if(_state===STATE.NONE){_state=event.button}if(_state===STATE.ROTATE&&!_this.noRotate){_rotateStart.copy(getMouseProjectionOnBall(event.pageX,event.pageY));_rotateEnd.copy(_rotateStart)}else if(_state===STATE.ZOOM&&!_this.noZoom){_zoomStart.copy(getMouseOnScreen(event.pageX,event.pageY));_zoomEnd.copy(_zoomStart)}else if(_state===STATE.PAN&&!_this.noPan){_panStart.copy(getMouseOnScreen(event.pageX,event.pageY));_panEnd.copy(_panStart)}document.addEventListener("mousemove",mousemove,false);document.addEventListener("mouseup",mouseup,false);_this.dispatchEvent(startEvent)}function mousemove(event){if(_this.enabled===false)return;event.preventDefault();event.stopPropagation();if(_state===STATE.ROTATE&&!_this.noRotate){_rotateEnd.copy(getMouseProjectionOnBall(event.pageX,event.pageY))}else if(_state===STATE.ZOOM&&!_this.noZoom){_zoomEnd.copy(getMouseOnScreen(event.pageX,event.pageY))}else if(_state===STATE.PAN&&!_this.noPan){_panEnd.copy(getMouseOnScreen(event.pageX,event.pageY))}}function mouseup(event){if(_this.enabled===false)return;event.preventDefault();event.stopPropagation();_state=STATE.NONE;document.removeEventListener("mousemove",mousemove);document.removeEventListener("mouseup",mouseup);_this.dispatchEvent(endEvent)}function mousewheel(event){if(_this.enabled===false)return;event.preventDefault();event.stopPropagation();var delta=0;if(event.wheelDelta){delta=event.wheelDelta/40}else if(event.detail){delta=-event.detail/3}_zoomStart.y+=delta*.01;_this.dispatchEvent(startEvent);_this.dispatchEvent(endEvent)}function touchstart(event){if(_this.enabled===false)return;switch(event.touches.length){case 1:_state=STATE.TOUCH_ROTATE;_rotateStart.copy(getMouseProjectionOnBall(event.touches[0].pageX,event.touches[0].pageY));_rotateEnd.copy(_rotateStart);break;case 2:_state=STATE.TOUCH_ZOOM_PAN;var dx=event.touches[0].pageX-event.touches[1].pageX;var dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=_touchZoomDistanceStart=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2;var y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panStart.copy(getMouseOnScreen(x,y));_panEnd.copy(_panStart);break;default:_state=STATE.NONE}_this.dispatchEvent(startEvent)}function touchmove(event){if(_this.enabled===false)return;event.preventDefault();event.stopPropagation();switch(event.touches.length){case 1:_rotateEnd.copy(getMouseProjectionOnBall(event.touches[0].pageX,event.touches[0].pageY));break;case 2:var dx=event.touches[0].pageX-event.touches[1].pageX;var dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2;var y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(getMouseOnScreen(x,y));break;default:_state=STATE.NONE}}function touchend(event){if(_this.enabled===false)return;switch(event.touches.length){case 1:_rotateEnd.copy(getMouseProjectionOnBall(event.touches[0].pageX,event.touches[0].pageY));_rotateStart.copy(_rotateEnd);break;case 2:_touchZoomDistanceStart=_touchZoomDistanceEnd=0;var x=(event.touches[0].pageX+event.touches[1].pageX)/2;var y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(getMouseOnScreen(x,y));_panStart.copy(_panEnd);break}_state=STATE.NONE;_this.dispatchEvent(endEvent)}this.domElement.addEventListener("contextmenu",function(event){event.preventDefault()},false);this.domElement.addEventListener("mousedown",mousedown,false);this.domElement.addEventListener("mousewheel",mousewheel,false);this.domElement.addEventListener("DOMMouseScroll",mousewheel,false);this.domElement.addEventListener("touchstart",touchstart,false);this.domElement.addEventListener("touchend",touchend,false);this.domElement.addEventListener("touchmove",touchmove,false);window.addEventListener("keydown",keydown,false);window.addEventListener("keyup",keyup,false);this.handleResize();this.update()};THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);var dat=dat||{};dat.gui=dat.gui||{};dat.utils=dat.utils||{};dat.controllers=dat.controllers||{};dat.dom=dat.dom||{};dat.color=dat.color||{};dat.utils.css=function(){return{load:function(url,doc){doc=doc||document;var link=doc.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=url;doc.getElementsByTagName("head")[0].appendChild(link)},inject:function(css,doc){doc=doc||document;var injected=document.createElement("style");injected.type="text/css";injected.innerHTML=css;doc.getElementsByTagName("head")[0].appendChild(injected)}}}();dat.utils.common=function(){var ARR_EACH=Array.prototype.forEach;var ARR_SLICE=Array.prototype.slice;return{BREAK:{},extend:function(target){this.each(ARR_SLICE.call(arguments,1),function(obj){for(var key in obj)if(!this.isUndefined(obj[key]))target[key]=obj[key]},this);return target},defaults:function(target){this.each(ARR_SLICE.call(arguments,1),function(obj){for(var key in obj)if(this.isUndefined(target[key]))target[key]=obj[key]},this);return target},compose:function(){var toCall=ARR_SLICE.call(arguments);return function(){var args=ARR_SLICE.call(arguments);for(var i=toCall.length-1;i>=0;i--){args=[toCall[i].apply(this,args)]}return args[0]}},each:function(obj,itr,scope){if(ARR_EACH&&obj.forEach===ARR_EACH){obj.forEach(itr,scope)}else if(obj.length===obj.length+0){for(var key=0,l=obj.length;key<l;key++)if(key in obj&&itr.call(scope,obj[key],key)===this.BREAK)return}else{for(var key in obj)if(itr.call(scope,obj[key],key)===this.BREAK)return}},defer:function(fnc){setTimeout(fnc,0)},toArray:function(obj){if(obj.toArray)return obj.toArray();return ARR_SLICE.call(obj)},isUndefined:function(obj){return obj===undefined},isNull:function(obj){return obj===null},isNaN:function(obj){return obj!==obj},isArray:Array.isArray||function(obj){return obj.constructor===Array},isObject:function(obj){return obj===Object(obj)},isNumber:function(obj){return obj===obj+0},isString:function(obj){return obj===obj+""},isBoolean:function(obj){return obj===false||obj===true},isFunction:function(obj){return Object.prototype.toString.call(obj)==="[object Function]"}}}();dat.controllers.Controller=function(common){var Controller=function(object,property){this.initialValue=object[property];this.domElement=document.createElement("div");this.object=object;this.property=property;this.__onChange=undefined;this.__onFinishChange=undefined};common.extend(Controller.prototype,{onChange:function(fnc){this.__onChange=fnc;return this},onFinishChange:function(fnc){this.__onFinishChange=fnc;return this},setValue:function(newValue){this.object[this.property]=newValue;if(this.__onChange){this.__onChange.call(this,newValue)}this.updateDisplay();return this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}});return Controller}(dat.utils.common);dat.dom.dom=function(common){var EVENT_MAP={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]};var EVENT_MAP_INV={};common.each(EVENT_MAP,function(v,k){common.each(v,function(e){EVENT_MAP_INV[e]=k})});var CSS_VALUE_PIXELS=/(\d+(\.\d+)?)px/;function cssValueToPixels(val){if(val==="0"||common.isUndefined(val))return 0;var match=val.match(CSS_VALUE_PIXELS);if(!common.isNull(match)){return parseFloat(match[1])}return 0}var dom={makeSelectable:function(elem,selectable){if(elem===undefined||elem.style===undefined)return;elem.onselectstart=selectable?function(){return false}:function(){};elem.style.MozUserSelect=selectable?"auto":"none";elem.style.KhtmlUserSelect=selectable?"auto":"none";elem.unselectable=selectable?"on":"off"},makeFullscreen:function(elem,horizontal,vertical){if(common.isUndefined(horizontal))horizontal=true;if(common.isUndefined(vertical))vertical=true;elem.style.position="absolute";if(horizontal){elem.style.left=0;elem.style.right=0}if(vertical){elem.style.top=0;elem.style.bottom=0}},fakeEvent:function(elem,eventType,params,aux){params=params||{};var className=EVENT_MAP_INV[eventType];if(!className){throw new Error("Event type "+eventType+" not supported.")}var evt=document.createEvent(className);switch(className){case"MouseEvents":var clientX=params.x||params.clientX||0;var clientY=params.y||params.clientY||0;evt.initMouseEvent(eventType,params.bubbles||false,params.cancelable||true,window,params.clickCount||1,0,0,clientX,clientY,false,false,false,false,0,null);break;case"KeyboardEvents":var init=evt.initKeyboardEvent||evt.initKeyEvent;common.defaults(params,{cancelable:true,ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,keyCode:undefined,charCode:undefined});init(eventType,params.bubbles||false,params.cancelable,window,params.ctrlKey,params.altKey,params.shiftKey,params.metaKey,params.keyCode,params.charCode);break;default:evt.initEvent(eventType,params.bubbles||false,params.cancelable||true);break}common.defaults(evt,aux);elem.dispatchEvent(evt)},bind:function(elem,event,func,bool){bool=bool||false;if(elem.addEventListener)elem.addEventListener(event,func,bool);else if(elem.attachEvent)elem.attachEvent("on"+event,func);return dom},unbind:function(elem,event,func,bool){bool=bool||false;if(elem.removeEventListener)elem.removeEventListener(event,func,bool);else if(elem.detachEvent)elem.detachEvent("on"+event,func);return dom},addClass:function(elem,className){if(elem.className===undefined){elem.className=className}else if(elem.className!==className){var classes=elem.className.split(/ +/);if(classes.indexOf(className)==-1){classes.push(className);elem.className=classes.join(" ").replace(/^\s+/,"").replace(/\s+$/,"")}}return dom},removeClass:function(elem,className){if(className){if(elem.className===undefined){}else if(elem.className===className){elem.removeAttribute("class")}else{var classes=elem.className.split(/ +/);var index=classes.indexOf(className);if(index!=-1){classes.splice(index,1);elem.className=classes.join(" ")}}}else{elem.className=undefined}return dom},hasClass:function(elem,className){return new RegExp("(?:^|\\s+)"+className+"(?:\\s+|$)").test(elem.className)||false},getWidth:function(elem){var style=getComputedStyle(elem);return cssValueToPixels(style["border-left-width"])+cssValueToPixels(style["border-right-width"])+cssValueToPixels(style["padding-left"])+cssValueToPixels(style["padding-right"])+cssValueToPixels(style["width"])},getHeight:function(elem){var style=getComputedStyle(elem);return cssValueToPixels(style["border-top-width"])+cssValueToPixels(style["border-bottom-width"])+cssValueToPixels(style["padding-top"])+cssValueToPixels(style["padding-bottom"])+cssValueToPixels(style["height"])},getOffset:function(elem){var offset={left:0,top:0};if(elem.offsetParent){do{offset.left+=elem.offsetLeft;offset.top+=elem.offsetTop}while(elem=elem.offsetParent)}return offset},isActive:function(elem){return elem===document.activeElement&&(elem.type||elem.href)}};return dom}(dat.utils.common);dat.controllers.OptionController=function(Controller,dom,common){var OptionController=function(object,property,options){OptionController.superclass.call(this,object,property);var _this=this;this.__select=document.createElement("select");if(common.isArray(options)){var map={};common.each(options,function(element){map[element]=element});options=map}common.each(options,function(value,key){var opt=document.createElement("option");opt.innerHTML=key;opt.setAttribute("value",value);_this.__select.appendChild(opt)});this.updateDisplay();dom.bind(this.__select,"change",function(){var desiredValue=this.options[this.selectedIndex].value;_this.setValue(desiredValue)});this.domElement.appendChild(this.__select)};OptionController.superclass=Controller;common.extend(OptionController.prototype,Controller.prototype,{setValue:function(v){var toReturn=OptionController.superclass.prototype.setValue.call(this,v);if(this.__onFinishChange){this.__onFinishChange.call(this,this.getValue())}return toReturn},updateDisplay:function(){this.__select.value=this.getValue();return OptionController.superclass.prototype.updateDisplay.call(this)}});return OptionController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);dat.controllers.NumberController=function(Controller,common){var NumberController=function(object,property,params){NumberController.superclass.call(this,object,property);params=params||{};this.__min=params.min;this.__max=params.max;this.__step=params.step;if(common.isUndefined(this.__step)){if(this.initialValue==0){this.__impliedStep=1}else{this.__impliedStep=Math.pow(10,Math.floor(Math.log(this.initialValue)/Math.LN10))/10}}else{this.__impliedStep=this.__step}this.__precision=numDecimals(this.__impliedStep)};NumberController.superclass=Controller;common.extend(NumberController.prototype,Controller.prototype,{setValue:function(v){if(this.__min!==undefined&&v<this.__min){v=this.__min}else if(this.__max!==undefined&&v>this.__max){v=this.__max}if(this.__step!==undefined&&v%this.__step!=0){v=Math.round(v/this.__step)*this.__step}return NumberController.superclass.prototype.setValue.call(this,v)},min:function(v){this.__min=v;return this},max:function(v){this.__max=v;return this},step:function(v){this.__step=v;return this}});function numDecimals(x){x=x.toString();if(x.indexOf(".")>-1){return x.length-x.indexOf(".")-1}else{return 0}}return NumberController}(dat.controllers.Controller,dat.utils.common);dat.controllers.NumberControllerBox=function(NumberController,dom,common){var NumberControllerBox=function(object,property,params){this.__truncationSuspended=false;NumberControllerBox.superclass.call(this,object,property,params);var _this=this;var prev_y;this.__input=document.createElement("input");this.__input.setAttribute("type","text");dom.bind(this.__input,"change",onChange);dom.bind(this.__input,"blur",onBlur);dom.bind(this.__input,"mousedown",onMouseDown);dom.bind(this.__input,"keydown",function(e){if(e.keyCode===13){_this.__truncationSuspended=true;this.blur();_this.__truncationSuspended=false}});function onChange(){var attempted=parseFloat(_this.__input.value);if(!common.isNaN(attempted))_this.setValue(attempted)}function onBlur(){onChange();if(_this.__onFinishChange){_this.__onFinishChange.call(_this,_this.getValue())}}function onMouseDown(e){dom.bind(window,"mousemove",onMouseDrag);dom.bind(window,"mouseup",onMouseUp);prev_y=e.clientY}function onMouseDrag(e){var diff=prev_y-e.clientY;_this.setValue(_this.getValue()+diff*_this.__impliedStep);prev_y=e.clientY}function onMouseUp(){dom.unbind(window,"mousemove",onMouseDrag);dom.unbind(window,"mouseup",onMouseUp)}this.updateDisplay();this.domElement.appendChild(this.__input)};NumberControllerBox.superclass=NumberController;common.extend(NumberControllerBox.prototype,NumberController.prototype,{updateDisplay:function(){this.__input.value=this.__truncationSuspended?this.getValue():roundToDecimal(this.getValue(),this.__precision);return NumberControllerBox.superclass.prototype.updateDisplay.call(this)}});function roundToDecimal(value,decimals){var tenTo=Math.pow(10,decimals);return Math.round(value*tenTo)/tenTo}return NumberControllerBox}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common);dat.controllers.NumberControllerSlider=function(NumberController,dom,css,common,styleSheet){var NumberControllerSlider=function(object,property,min,max,step){NumberControllerSlider.superclass.call(this,object,property,{min:min,max:max,step:step});var _this=this;this.__background=document.createElement("div");this.__foreground=document.createElement("div");dom.bind(this.__background,"mousedown",onMouseDown);dom.addClass(this.__background,"slider");dom.addClass(this.__foreground,"slider-fg");function onMouseDown(e){dom.bind(window,"mousemove",onMouseDrag);dom.bind(window,"mouseup",onMouseUp);onMouseDrag(e)}function onMouseDrag(e){e.preventDefault();var offset=dom.getOffset(_this.__background);var width=dom.getWidth(_this.__background);_this.setValue(map(e.clientX,offset.left,offset.left+width,_this.__min,_this.__max));return false}function onMouseUp(){dom.unbind(window,"mousemove",onMouseDrag);dom.unbind(window,"mouseup",onMouseUp);if(_this.__onFinishChange){_this.__onFinishChange.call(_this,_this.getValue())}}this.updateDisplay();this.__background.appendChild(this.__foreground);this.domElement.appendChild(this.__background)};NumberControllerSlider.superclass=NumberController;NumberControllerSlider.useDefaultStyles=function(){css.inject(styleSheet)};common.extend(NumberControllerSlider.prototype,NumberController.prototype,{updateDisplay:function(){var pct=(this.getValue()-this.__min)/(this.__max-this.__min);this.__foreground.style.width=pct*100+"%";return NumberControllerSlider.superclass.prototype.updateDisplay.call(this)}});function map(v,i1,i2,o1,o2){return o1+(o2-o1)*((v-i1)/(i2-i1))}return NumberControllerSlider}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,".slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}");dat.controllers.FunctionController=function(Controller,dom,common){var FunctionController=function(object,property,text){FunctionController.superclass.call(this,object,property);var _this=this;this.__button=document.createElement("div");this.__button.innerHTML=text===undefined?"Fire":text;dom.bind(this.__button,"click",function(e){e.preventDefault();_this.fire();return false});dom.addClass(this.__button,"button");this.domElement.appendChild(this.__button)};FunctionController.superclass=Controller;common.extend(FunctionController.prototype,Controller.prototype,{fire:function(){if(this.__onChange){this.__onChange.call(this)}if(this.__onFinishChange){this.__onFinishChange.call(this,this.getValue())}this.getValue().call(this.object)}});return FunctionController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);dat.controllers.BooleanController=function(Controller,dom,common){var BooleanController=function(object,property){BooleanController.superclass.call(this,object,property);var _this=this;this.__prev=this.getValue();this.__checkbox=document.createElement("input");this.__checkbox.setAttribute("type","checkbox");dom.bind(this.__checkbox,"change",onChange,false);this.domElement.appendChild(this.__checkbox);this.updateDisplay();function onChange(){_this.setValue(!_this.__prev)}};BooleanController.superclass=Controller;common.extend(BooleanController.prototype,Controller.prototype,{setValue:function(v){var toReturn=BooleanController.superclass.prototype.setValue.call(this,v);if(this.__onFinishChange){this.__onFinishChange.call(this,this.getValue())}this.__prev=this.getValue();return toReturn},updateDisplay:function(){if(this.getValue()===true){this.__checkbox.setAttribute("checked","checked");this.__checkbox.checked=true}else{this.__checkbox.checked=false}return BooleanController.superclass.prototype.updateDisplay.call(this)}});return BooleanController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);dat.color.toString=function(common){return function(color){if(color.a==1||common.isUndefined(color.a)){var s=color.hex.toString(16);while(s.length<6){s="0"+s}return"#"+s}else{return"rgba("+Math.round(color.r)+","+Math.round(color.g)+","+Math.round(color.b)+","+color.a+")"}}}(dat.utils.common);dat.color.interpret=function(toString,common){var result,toReturn;var interpret=function(){toReturn=false;var original=arguments.length>1?common.toArray(arguments):arguments[0];common.each(INTERPRETATIONS,function(family){if(family.litmus(original)){common.each(family.conversions,function(conversion,conversionName){result=conversion.read(original);if(toReturn===false&&result!==false){toReturn=result;result.conversionName=conversionName;result.conversion=conversion;return common.BREAK}});return common.BREAK}});return toReturn};var INTERPRETATIONS=[{litmus:common.isString,conversions:{THREE_CHAR_HEX:{read:function(original){var test=original.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString()+test[1].toString()+test[2].toString()+test[2].toString()+test[3].toString()+test[3].toString())}},write:toString},SIX_CHAR_HEX:{read:function(original){var test=original.match(/^#([A-F0-9]{6})$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString())}},write:toString},CSS_RGB:{read:function(original){var test=original.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3])}},write:toString},CSS_RGBA:{read:function(original){var test=original.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3]),a:parseFloat(test[4])}},write:toString}}},{litmus:common.isNumber,conversions:{HEX:{read:function(original){return{space:"HEX",hex:original,conversionName:"HEX"}},write:function(color){return color.hex}}}},{litmus:common.isArray,conversions:{RGB_ARRAY:{read:function(original){if(original.length!=3)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2]}},write:function(color){return[color.r,color.g,color.b]}},RGBA_ARRAY:{read:function(original){if(original.length!=4)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2],a:original[3]}},write:function(color){return[color.r,color.g,color.b,color.a]}}}},{litmus:common.isObject,conversions:{RGBA_OBJ:{read:function(original){if(common.isNumber(original.r)&&common.isNumber(original.g)&&common.isNumber(original.b)&&common.isNumber(original.a)){return{space:"RGB",r:original.r,g:original.g,b:original.b,a:original.a}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b,a:color.a}}},RGB_OBJ:{read:function(original){if(common.isNumber(original.r)&&common.isNumber(original.g)&&common.isNumber(original.b)){return{space:"RGB",r:original.r,g:original.g,b:original.b}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b}}},HSVA_OBJ:{read:function(original){if(common.isNumber(original.h)&&common.isNumber(original.s)&&common.isNumber(original.v)&&common.isNumber(original.a)){return{space:"HSV",h:original.h,s:original.s,v:original.v,a:original.a}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v,a:color.a}}},HSV_OBJ:{read:function(original){if(common.isNumber(original.h)&&common.isNumber(original.s)&&common.isNumber(original.v)){return{space:"HSV",h:original.h,s:original.s,v:original.v}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v}}}}}];return interpret}(dat.color.toString,dat.utils.common);dat.GUI=dat.gui.GUI=function(css,saveDialogueContents,styleSheet,controllerFactory,Controller,BooleanController,FunctionController,NumberControllerBox,NumberControllerSlider,OptionController,ColorController,requestAnimationFrame,CenteredDiv,dom,common){css.inject(styleSheet);var CSS_NAMESPACE="dg";var HIDE_KEY_CODE=72;var CLOSE_BUTTON_HEIGHT=20;var DEFAULT_DEFAULT_PRESET_NAME="Default";var SUPPORTS_LOCAL_STORAGE=function(){try{return"localStorage"in window&&window["localStorage"]!==null}catch(e){return false}}();var SAVE_DIALOGUE;var auto_place_virgin=true;var auto_place_container;var hide=false;var hideable_guis=[];var GUI=function(params){var _this=this;this.domElement=document.createElement("div");this.__ul=document.createElement("ul");this.domElement.appendChild(this.__ul);dom.addClass(this.domElement,CSS_NAMESPACE);this.__folders={};this.__controllers=[];this.__rememberedObjects=[];this.__rememberedObjectIndecesToControllers=[];this.__listening=[];params=params||{};params=common.defaults(params,{autoPlace:true,width:GUI.DEFAULT_WIDTH});params=common.defaults(params,{resizable:params.autoPlace,hideable:params.autoPlace});if(!common.isUndefined(params.load)){if(params.preset)params.load.preset=params.preset}else{params.load={preset:DEFAULT_DEFAULT_PRESET_NAME}}if(common.isUndefined(params.parent)&&params.hideable){hideable_guis.push(this)}params.resizable=common.isUndefined(params.parent)&&params.resizable;if(params.autoPlace&&common.isUndefined(params.scrollable)){params.scrollable=true}var use_local_storage=SUPPORTS_LOCAL_STORAGE&&localStorage.getItem(getLocalStorageHash(this,"isLocal"))==="true";Object.defineProperties(this,{parent:{get:function(){return params.parent}},scrollable:{get:function(){return params.scrollable}},autoPlace:{get:function(){return params.autoPlace}},preset:{get:function(){if(_this.parent){return _this.getRoot().preset}else{return params.load.preset}},set:function(v){if(_this.parent){_this.getRoot().preset=v}else{params.load.preset=v}setPresetSelectIndex(this);_this.revert()}},width:{get:function(){return params.width},set:function(v){params.width=v;setWidth(_this,v)}},name:{get:function(){return params.name},set:function(v){params.name=v;if(title_row_name){title_row_name.innerHTML=params.name}}},closed:{get:function(){return params.closed},set:function(v){params.closed=v;if(params.closed){dom.addClass(_this.__ul,GUI.CLASS_CLOSED)}else{dom.removeClass(_this.__ul,GUI.CLASS_CLOSED)}this.onResize();if(_this.__closeButton){_this.__closeButton.innerHTML=v?GUI.TEXT_OPEN:GUI.TEXT_CLOSED}}},load:{get:function(){return params.load}},useLocalStorage:{get:function(){return use_local_storage},set:function(bool){if(SUPPORTS_LOCAL_STORAGE){use_local_storage=bool;if(bool){dom.bind(window,"unload",saveToLocalStorage)}else{dom.unbind(window,"unload",saveToLocalStorage)}localStorage.setItem(getLocalStorageHash(_this,"isLocal"),bool)}}}});if(common.isUndefined(params.parent)){params.closed=false;dom.addClass(this.domElement,GUI.CLASS_MAIN);dom.makeSelectable(this.domElement,false);if(SUPPORTS_LOCAL_STORAGE){if(use_local_storage){_this.useLocalStorage=true;var saved_gui=localStorage.getItem(getLocalStorageHash(this,"gui"));if(saved_gui){params.load=JSON.parse(saved_gui)}}}this.__closeButton=document.createElement("div");this.__closeButton.innerHTML=GUI.TEXT_CLOSED;dom.addClass(this.__closeButton,GUI.CLASS_CLOSE_BUTTON);this.domElement.appendChild(this.__closeButton);dom.bind(this.__closeButton,"click",function(){_this.closed=!_this.closed})}else{if(params.closed===undefined){params.closed=true}var title_row_name=document.createTextNode(params.name);dom.addClass(title_row_name,"controller-name");var title_row=addRow(_this,title_row_name);var on_click_title=function(e){e.preventDefault();_this.closed=!_this.closed;return false};dom.addClass(this.__ul,GUI.CLASS_CLOSED);dom.addClass(title_row,"title");dom.bind(title_row,"click",on_click_title);if(!params.closed){this.closed=false}}if(params.autoPlace){if(common.isUndefined(params.parent)){if(auto_place_virgin){auto_place_container=document.createElement("div");dom.addClass(auto_place_container,CSS_NAMESPACE);dom.addClass(auto_place_container,GUI.CLASS_AUTO_PLACE_CONTAINER);document.body.appendChild(auto_place_container);auto_place_virgin=false}auto_place_container.appendChild(this.domElement);dom.addClass(this.domElement,GUI.CLASS_AUTO_PLACE)}if(!this.parent)setWidth(_this,params.width)}dom.bind(window,"resize",function(){_this.onResize()});dom.bind(this.__ul,"webkitTransitionEnd",function(){_this.onResize()});dom.bind(this.__ul,"transitionend",function(){_this.onResize()});dom.bind(this.__ul,"oTransitionEnd",function(){_this.onResize()});this.onResize();if(params.resizable){addResizeHandle(this)}function saveToLocalStorage(){localStorage.setItem(getLocalStorageHash(_this,"gui"),JSON.stringify(_this.getSaveObject()))}var root=_this.getRoot();function resetWidth(){var root=_this.getRoot();root.width+=1;common.defer(function(){root.width-=1})}if(!params.parent){resetWidth()}};GUI.toggleHide=function(){hide=!hide;common.each(hideable_guis,function(gui){gui.domElement.style.zIndex=hide?-999:999;gui.domElement.style.opacity=hide?0:1})};GUI.CLASS_AUTO_PLACE="a";GUI.CLASS_AUTO_PLACE_CONTAINER="ac";GUI.CLASS_MAIN="main";GUI.CLASS_CONTROLLER_ROW="cr";GUI.CLASS_TOO_TALL="taller-than-window";GUI.CLASS_CLOSED="closed";GUI.CLASS_CLOSE_BUTTON="close-button";GUI.CLASS_DRAG="drag";GUI.DEFAULT_WIDTH=245;GUI.TEXT_CLOSED="Close Controls";GUI.TEXT_OPEN="Open Controls";dom.bind(window,"keydown",function(e){if(document.activeElement.type!=="text"&&(e.which===HIDE_KEY_CODE||e.keyCode==HIDE_KEY_CODE)){GUI.toggleHide()}},false);common.extend(GUI.prototype,{add:function(object,property){return add(this,object,property,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(object,property){return add(this,object,property,{color:true})},remove:function(controller){this.__ul.removeChild(controller.__li);this.__controllers.slice(this.__controllers.indexOf(controller),1);var _this=this;common.defer(function(){_this.onResize()})},destroy:function(){if(this.autoPlace){auto_place_container.removeChild(this.domElement)}},addFolder:function(name){if(this.__folders[name]!==undefined){throw new Error("You already have a folder in this GUI by the"+' name "'+name+'"')}var new_gui_params={name:name,parent:this};new_gui_params.autoPlace=this.autoPlace;if(this.load&&this.load.folders&&this.load.folders[name]){new_gui_params.closed=this.load.folders[name].closed;new_gui_params.load=this.load.folders[name]}var gui=new GUI(new_gui_params);this.__folders[name]=gui;var li=addRow(this,gui.domElement);dom.addClass(li,"folder");return gui},open:function(){this.closed=false},close:function(){this.closed=true},onResize:function(){var root=this.getRoot();if(root.scrollable){var top=dom.getOffset(root.__ul).top;var h=0;common.each(root.__ul.childNodes,function(node){if(!(root.autoPlace&&node===root.__save_row))h+=dom.getHeight(node)});if(window.innerHeight-top-CLOSE_BUTTON_HEIGHT<h){dom.addClass(root.domElement,GUI.CLASS_TOO_TALL);root.__ul.style.height=window.innerHeight-top-CLOSE_BUTTON_HEIGHT+"px"}else{dom.removeClass(root.domElement,GUI.CLASS_TOO_TALL);root.__ul.style.height="auto"}}if(root.__resize_handle){common.defer(function(){root.__resize_handle.style.height=root.__ul.offsetHeight+"px"})}if(root.__closeButton){root.__closeButton.style.width=root.width+"px"}},remember:function(){if(common.isUndefined(SAVE_DIALOGUE)){SAVE_DIALOGUE=new CenteredDiv;SAVE_DIALOGUE.domElement.innerHTML=saveDialogueContents}if(this.parent){throw new Error("You can only call remember on a top level GUI.")}var _this=this;common.each(Array.prototype.slice.call(arguments),function(object){if(_this.__rememberedObjects.length==0){addSaveMenu(_this)}if(_this.__rememberedObjects.indexOf(object)==-1){_this.__rememberedObjects.push(object)}});if(this.autoPlace){setWidth(this,this.width)}},getRoot:function(){var gui=this;while(gui.parent){gui=gui.parent}return gui},getSaveObject:function(){var toReturn=this.load;toReturn.closed=this.closed;if(this.__rememberedObjects.length>0){toReturn.preset=this.preset;if(!toReturn.remembered){toReturn.remembered={}}toReturn.remembered[this.preset]=getCurrentPreset(this)}toReturn.folders={};common.each(this.__folders,function(element,key){toReturn.folders[key]=element.getSaveObject()});return toReturn},save:function(){if(!this.load.remembered){this.load.remembered={}}this.load.remembered[this.preset]=getCurrentPreset(this);markPresetModified(this,false)},saveAs:function(presetName){if(!this.load.remembered){this.load.remembered={};this.load.remembered[DEFAULT_DEFAULT_PRESET_NAME]=getCurrentPreset(this,true)}this.load.remembered[presetName]=getCurrentPreset(this);this.preset=presetName;addPresetOption(this,presetName,true)},revert:function(gui){common.each(this.__controllers,function(controller){if(!this.getRoot().load.remembered){controller.setValue(controller.initialValue)}else{recallSavedValue(gui||this.getRoot(),controller)}},this);common.each(this.__folders,function(folder){folder.revert(folder)});if(!gui){markPresetModified(this.getRoot(),false)}},listen:function(controller){var init=this.__listening.length==0;this.__listening.push(controller);if(init)updateDisplays(this.__listening)}});function add(gui,object,property,params){if(object[property]===undefined){throw new Error("Object "+object+' has no property "'+property+'"')}var controller;if(params.color){controller=new ColorController(object,property)}else{var factoryArgs=[object,property].concat(params.factoryArgs);controller=controllerFactory.apply(gui,factoryArgs)}if(params.before instanceof Controller){params.before=params.before.__li}recallSavedValue(gui,controller);dom.addClass(controller.domElement,"c");var name=document.createElement("span");dom.addClass(name,"property-name");name.innerHTML=controller.property;var container=document.createElement("div");container.appendChild(name);container.appendChild(controller.domElement);var li=addRow(gui,container,params.before);dom.addClass(li,GUI.CLASS_CONTROLLER_ROW);dom.addClass(li,typeof controller.getValue());augmentController(gui,li,controller);gui.__controllers.push(controller);return controller}function addRow(gui,dom,liBefore){var li=document.createElement("li");if(dom)li.appendChild(dom);if(liBefore){gui.__ul.insertBefore(li,params.before)}else{gui.__ul.appendChild(li)}gui.onResize();return li}function augmentController(gui,li,controller){controller.__li=li;controller.__gui=gui;common.extend(controller,{options:function(options){if(arguments.length>1){controller.remove();return add(gui,controller.object,controller.property,{before:controller.__li.nextElementSibling,factoryArgs:[common.toArray(arguments)]})}if(common.isArray(options)||common.isObject(options)){controller.remove();return add(gui,controller.object,controller.property,{before:controller.__li.nextElementSibling,factoryArgs:[options]})}},name:function(v){controller.__li.firstElementChild.firstElementChild.innerHTML=v;return controller},listen:function(){controller.__gui.listen(controller);return controller},remove:function(){controller.__gui.remove(controller);return controller}});if(controller instanceof NumberControllerSlider){var box=new NumberControllerBox(controller.object,controller.property,{min:controller.__min,max:controller.__max,step:controller.__step});common.each(["updateDisplay","onChange","onFinishChange"],function(method){var pc=controller[method];var pb=box[method];controller[method]=box[method]=function(){var args=Array.prototype.slice.call(arguments);pc.apply(controller,args);return pb.apply(box,args)}});dom.addClass(li,"has-slider");controller.domElement.insertBefore(box.domElement,controller.domElement.firstElementChild)}else if(controller instanceof NumberControllerBox){var r=function(returned){if(common.isNumber(controller.__min)&&common.isNumber(controller.__max)){controller.remove();return add(gui,controller.object,controller.property,{before:controller.__li.nextElementSibling,factoryArgs:[controller.__min,controller.__max,controller.__step]})}return returned};controller.min=common.compose(r,controller.min);controller.max=common.compose(r,controller.max)}else if(controller instanceof BooleanController){dom.bind(li,"click",function(){dom.fakeEvent(controller.__checkbox,"click")});dom.bind(controller.__checkbox,"click",function(e){e.stopPropagation()})}else if(controller instanceof FunctionController){dom.bind(li,"click",function(){dom.fakeEvent(controller.__button,"click")});dom.bind(li,"mouseover",function(){dom.addClass(controller.__button,"hover")});dom.bind(li,"mouseout",function(){dom.removeClass(controller.__button,"hover")})}else if(controller instanceof ColorController){dom.addClass(li,"color");controller.updateDisplay=common.compose(function(r){li.style.borderLeftColor=controller.__color.toString();return r},controller.updateDisplay);controller.updateDisplay()}controller.setValue=common.compose(function(r){if(gui.getRoot().__preset_select&&controller.isModified()){markPresetModified(gui.getRoot(),true)}return r},controller.setValue)}function recallSavedValue(gui,controller){var root=gui.getRoot();var matched_index=root.__rememberedObjects.indexOf(controller.object);if(matched_index!=-1){var controller_map=root.__rememberedObjectIndecesToControllers[matched_index];if(controller_map===undefined){controller_map={};root.__rememberedObjectIndecesToControllers[matched_index]=controller_map}controller_map[controller.property]=controller;if(root.load&&root.load.remembered){var preset_map=root.load.remembered;var preset;if(preset_map[gui.preset]){preset=preset_map[gui.preset]}else if(preset_map[DEFAULT_DEFAULT_PRESET_NAME]){preset=preset_map[DEFAULT_DEFAULT_PRESET_NAME]}else{return}if(preset[matched_index]&&preset[matched_index][controller.property]!==undefined){var value=preset[matched_index][controller.property];controller.initialValue=value;controller.setValue(value)}}}}function getLocalStorageHash(gui,key){return document.location.href+"."+key}function addSaveMenu(gui){var div=gui.__save_row=document.createElement("li");dom.addClass(gui.domElement,"has-save");gui.__ul.insertBefore(div,gui.__ul.firstChild);dom.addClass(div,"save-row");var gears=document.createElement("span");gears.innerHTML="&nbsp;";dom.addClass(gears,"button gears");var button=document.createElement("span");button.innerHTML="Save";dom.addClass(button,"button");dom.addClass(button,"save");var button2=document.createElement("span");button2.innerHTML="New";dom.addClass(button2,"button");dom.addClass(button2,"save-as");var button3=document.createElement("span");button3.innerHTML="Revert";dom.addClass(button3,"button");dom.addClass(button3,"revert");var select=gui.__preset_select=document.createElement("select");if(gui.load&&gui.load.remembered){common.each(gui.load.remembered,function(value,key){addPresetOption(gui,key,key==gui.preset)})}else{addPresetOption(gui,DEFAULT_DEFAULT_PRESET_NAME,false)}dom.bind(select,"change",function(){for(var index=0;index<gui.__preset_select.length;index++){gui.__preset_select[index].innerHTML=gui.__preset_select[index].value}gui.preset=this.value});div.appendChild(select);div.appendChild(gears);div.appendChild(button);div.appendChild(button2);div.appendChild(button3);if(SUPPORTS_LOCAL_STORAGE){var saveLocally=document.getElementById("dg-save-locally");var explain=document.getElementById("dg-local-explain");saveLocally.style.display="block";var localStorageCheckBox=document.getElementById("dg-local-storage");if(localStorage.getItem(getLocalStorageHash(gui,"isLocal"))==="true"){localStorageCheckBox.setAttribute("checked","checked")}function showHideExplain(){explain.style.display=gui.useLocalStorage?"block":"none"}showHideExplain();dom.bind(localStorageCheckBox,"change",function(){gui.useLocalStorage=!gui.useLocalStorage;showHideExplain()})}var newConstructorTextArea=document.getElementById("dg-new-constructor");dom.bind(newConstructorTextArea,"keydown",function(e){if(e.metaKey&&(e.which===67||e.keyCode==67)){SAVE_DIALOGUE.hide()}});dom.bind(gears,"click",function(){newConstructorTextArea.innerHTML=JSON.stringify(gui.getSaveObject(),undefined,2);SAVE_DIALOGUE.show();newConstructorTextArea.focus();newConstructorTextArea.select()});dom.bind(button,"click",function(){gui.save()});dom.bind(button2,"click",function(){var presetName=prompt("Enter a new preset name.");if(presetName)gui.saveAs(presetName)});dom.bind(button3,"click",function(){gui.revert()})}function addResizeHandle(gui){gui.__resize_handle=document.createElement("div");common.extend(gui.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var pmouseX;dom.bind(gui.__resize_handle,"mousedown",dragStart);dom.bind(gui.__closeButton,"mousedown",dragStart);gui.domElement.insertBefore(gui.__resize_handle,gui.domElement.firstElementChild);function dragStart(e){e.preventDefault();pmouseX=e.clientX;dom.addClass(gui.__closeButton,GUI.CLASS_DRAG);dom.bind(window,"mousemove",drag);dom.bind(window,"mouseup",dragStop);return false}function drag(e){e.preventDefault();gui.width+=pmouseX-e.clientX;gui.onResize();pmouseX=e.clientX;return false}function dragStop(){dom.removeClass(gui.__closeButton,GUI.CLASS_DRAG);dom.unbind(window,"mousemove",drag);dom.unbind(window,"mouseup",dragStop)}}function setWidth(gui,w){gui.domElement.style.width=w+"px";if(gui.__save_row&&gui.autoPlace){gui.__save_row.style.width=w+"px"}if(gui.__closeButton){gui.__closeButton.style.width=w+"px"}}function getCurrentPreset(gui,useInitialValues){var toReturn={};common.each(gui.__rememberedObjects,function(val,index){var saved_values={};var controller_map=gui.__rememberedObjectIndecesToControllers[index];common.each(controller_map,function(controller,property){saved_values[property]=useInitialValues?controller.initialValue:controller.getValue()});toReturn[index]=saved_values});return toReturn}function addPresetOption(gui,name,setSelected){var opt=document.createElement("option");opt.innerHTML=name;opt.value=name;gui.__preset_select.appendChild(opt);if(setSelected){gui.__preset_select.selectedIndex=gui.__preset_select.length-1}}function setPresetSelectIndex(gui){for(var index=0;index<gui.__preset_select.length;index++){if(gui.__preset_select[index].value==gui.preset){gui.__preset_select.selectedIndex=index}}}function markPresetModified(gui,modified){var opt=gui.__preset_select[gui.__preset_select.selectedIndex];if(modified){opt.innerHTML=opt.value+"*"}else{opt.innerHTML=opt.value}}function updateDisplays(controllerArray){if(controllerArray.length!=0){requestAnimationFrame(function(){updateDisplays(controllerArray)})}common.each(controllerArray,function(c){c.updateDisplay()})}return GUI}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear;border:0;position:absolute;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-x:hidden}.dg.a.has-save ul{margin-top:27px}.dg.a.has-save ul.closed{margin-top:0}.dg.a .save-row{position:fixed;top:0;z-index:1002}.dg li{-webkit-transition:height 0.1s ease-out;-o-transition:height 0.1s ease-out;-moz-transition:height 0.1s ease-out;transition:height 0.1s ease-out}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;overflow:hidden;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li > *{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:9px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2fa1d6}.dg .cr.number input[type=text]{color:#2fa1d6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2fa1d6}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n",dat.controllers.factory=function(OptionController,NumberControllerBox,NumberControllerSlider,StringController,FunctionController,BooleanController,common){return function(object,property){var initialValue=object[property];if(common.isArray(arguments[2])||common.isObject(arguments[2])){return new OptionController(object,property,arguments[2])}if(common.isNumber(initialValue)){if(common.isNumber(arguments[2])&&common.isNumber(arguments[3])){return new NumberControllerSlider(object,property,arguments[2],arguments[3])}else{return new NumberControllerBox(object,property,{min:arguments[2],max:arguments[3]})}}if(common.isString(initialValue)){return new StringController(object,property)}if(common.isFunction(initialValue)){return new FunctionController(object,property,"")}if(common.isBoolean(initialValue)){return new BooleanController(object,property)}}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(Controller,dom,common){var StringController=function(object,property){StringController.superclass.call(this,object,property);var _this=this;this.__input=document.createElement("input");this.__input.setAttribute("type","text");dom.bind(this.__input,"keyup",onChange);dom.bind(this.__input,"change",onChange);dom.bind(this.__input,"blur",onBlur);dom.bind(this.__input,"keydown",function(e){if(e.keyCode===13){this.blur()}});function onChange(){_this.setValue(_this.__input.value)}function onBlur(){if(_this.__onFinishChange){_this.__onFinishChange.call(_this,_this.getValue())}}this.updateDisplay();this.domElement.appendChild(this.__input)};StringController.superclass=Controller;common.extend(StringController.prototype,Controller.prototype,{updateDisplay:function(){if(!dom.isActive(this.__input)){this.__input.value=this.getValue()}return StringController.superclass.prototype.updateDisplay.call(this)}});return StringController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(Controller,dom,Color,interpret,common){var ColorController=function(object,property){ColorController.superclass.call(this,object,property);this.__color=new Color(this.getValue());this.__temp=new Color(0);var _this=this;this.domElement=document.createElement("div");dom.makeSelectable(this.domElement,false);this.__selector=document.createElement("div");this.__selector.className="selector";this.__saturation_field=document.createElement("div");this.__saturation_field.className="saturation-field";this.__field_knob=document.createElement("div");this.__field_knob.className="field-knob";this.__field_knob_border="2px solid ";this.__hue_knob=document.createElement("div");this.__hue_knob.className="hue-knob";this.__hue_field=document.createElement("div");this.__hue_field.className="hue-field";this.__input=document.createElement("input");this.__input.type="text";this.__input_textShadow="0 1px 1px ";dom.bind(this.__input,"keydown",function(e){if(e.keyCode===13){onBlur.call(this)}});dom.bind(this.__input,"blur",onBlur);dom.bind(this.__selector,"mousedown",function(e){dom.addClass(this,"drag").bind(window,"mouseup",function(e){dom.removeClass(_this.__selector,"drag")})});var value_field=document.createElement("div");common.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"});common.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(this.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1});common.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1});common.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"});common.extend(value_field.style,{width:"100%",height:"100%",background:"none"});linearGradient(value_field,"top","rgba(0,0,0,0)","#000");common.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"});hueGradient(this.__hue_field);common.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"});dom.bind(this.__saturation_field,"mousedown",fieldDown);dom.bind(this.__field_knob,"mousedown",fieldDown);dom.bind(this.__hue_field,"mousedown",function(e){setH(e);dom.bind(window,"mousemove",setH);dom.bind(window,"mouseup",unbindH)});function fieldDown(e){setSV(e);dom.bind(window,"mousemove",setSV);dom.bind(window,"mouseup",unbindSV)}function unbindSV(){dom.unbind(window,"mousemove",setSV);dom.unbind(window,"mouseup",unbindSV)}function onBlur(){var i=interpret(this.value);if(i!==false){_this.__color.__state=i;_this.setValue(_this.__color.toOriginal())}else{this.value=_this.__color.toString()}}function unbindH(){dom.unbind(window,"mousemove",setH);dom.unbind(window,"mouseup",unbindH)}this.__saturation_field.appendChild(value_field);this.__selector.appendChild(this.__field_knob);this.__selector.appendChild(this.__saturation_field);this.__selector.appendChild(this.__hue_field);this.__hue_field.appendChild(this.__hue_knob);this.domElement.appendChild(this.__input);this.domElement.appendChild(this.__selector);this.updateDisplay();function setSV(e){e.preventDefault();var w=dom.getWidth(_this.__saturation_field);var o=dom.getOffset(_this.__saturation_field);var s=(e.clientX-o.left+document.body.scrollLeft)/w;var v=1-(e.clientY-o.top+document.body.scrollTop)/w;if(v>1)v=1;else if(v<0)v=0;if(s>1)s=1;else if(s<0)s=0;_this.__color.v=v;_this.__color.s=s;_this.setValue(_this.__color.toOriginal());return false}function setH(e){e.preventDefault();var s=dom.getHeight(_this.__hue_field);var o=dom.getOffset(_this.__hue_field);var h=1-(e.clientY-o.top+document.body.scrollTop)/s;if(h>1)h=1;else if(h<0)h=0;_this.__color.h=h*360;_this.setValue(_this.__color.toOriginal());return false}};ColorController.superclass=Controller;common.extend(ColorController.prototype,Controller.prototype,{updateDisplay:function(){var i=interpret(this.getValue());if(i!==false){var mismatch=false;common.each(Color.COMPONENTS,function(component){if(!common.isUndefined(i[component])&&!common.isUndefined(this.__color.__state[component])&&i[component]!==this.__color.__state[component]){mismatch=true;return{}}},this);if(mismatch){common.extend(this.__color.__state,i)}}common.extend(this.__temp.__state,this.__color.__state);this.__temp.a=1;var flip=this.__color.v<.5||this.__color.s>.5?255:0;var _flip=255-flip;common.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+flip+","+flip+","+flip+")"});this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px";this.__temp.s=1;this.__temp.v=1;linearGradient(this.__saturation_field,"left","#fff",this.__temp.toString());common.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+flip+","+flip+","+flip+")",textShadow:this.__input_textShadow+"rgba("+_flip+","+_flip+","+_flip+",.7)"})}});var vendors=["-moz-","-o-","-webkit-","-ms-",""];function linearGradient(elem,x,a,b){elem.style.background="";common.each(vendors,function(vendor){elem.style.cssText+="background: "+vendor+"linear-gradient("+x+", "+a+" 0%, "+b+" 100%); "})}function hueGradient(elem){elem.style.background="";elem.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);";elem.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";elem.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";elem.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";elem.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}return ColorController}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(interpret,math,toString,common){var Color=function(){this.__state=interpret.apply(this,arguments);if(this.__state===false){throw"Failed to interpret color arguments"}this.__state.a=this.__state.a||1};Color.COMPONENTS=["r","g","b","h","s","v","hex","a"];common.extend(Color.prototype,{toString:function(){return toString(this)},toOriginal:function(){return this.__state.conversion.write(this)}});defineRGBComponent(Color.prototype,"r",2);defineRGBComponent(Color.prototype,"g",1);defineRGBComponent(Color.prototype,"b",0);defineHSVComponent(Color.prototype,"h");defineHSVComponent(Color.prototype,"s");defineHSVComponent(Color.prototype,"v");Object.defineProperty(Color.prototype,"a",{get:function(){return this.__state.a},set:function(v){this.__state.a=v}});Object.defineProperty(Color.prototype,"hex",{get:function(){if(!this.__state.space!=="HEX"){this.__state.hex=math.rgb_to_hex(this.r,this.g,this.b)}return this.__state.hex},set:function(v){this.__state.space="HEX";this.__state.hex=v}});function defineRGBComponent(target,component,componentHexIndex){Object.defineProperty(target,component,{get:function(){if(this.__state.space==="RGB"){return this.__state[component]}recalculateRGB(this,component,componentHexIndex);return this.__state[component]},set:function(v){if(this.__state.space!=="RGB"){recalculateRGB(this,component,componentHexIndex);this.__state.space="RGB"}this.__state[component]=v}})}function defineHSVComponent(target,component){Object.defineProperty(target,component,{get:function(){if(this.__state.space==="HSV")return this.__state[component];recalculateHSV(this);return this.__state[component]},set:function(v){if(this.__state.space!=="HSV"){recalculateHSV(this);this.__state.space="HSV"}this.__state[component]=v}})}function recalculateRGB(color,component,componentHexIndex){if(color.__state.space==="HEX"){color.__state[component]=math.component_from_hex(color.__state.hex,componentHexIndex)}else if(color.__state.space==="HSV"){common.extend(color.__state,math.hsv_to_rgb(color.__state.h,color.__state.s,color.__state.v))}else{throw"Corrupted color state"}}function recalculateHSV(color){var result=math.rgb_to_hsv(color.r,color.g,color.b);common.extend(color.__state,{s:result.s,v:result.v});if(!common.isNaN(result.h)){color.__state.h=result.h}else if(common.isUndefined(color.__state.h)){color.__state.h=0}}return Color}(dat.color.interpret,dat.color.math=function(){var tmpComponent;return{hsv_to_rgb:function(h,s,v){var hi=Math.floor(h/60)%6;var f=h/60-Math.floor(h/60);var p=v*(1-s);var q=v*(1-f*s);var t=v*(1-(1-f)*s);var c=[[v,t,p],[q,v,p],[p,v,t],[p,q,v],[t,p,v],[v,p,q]][hi];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(r,g,b){var min=Math.min(r,g,b),max=Math.max(r,g,b),delta=max-min,h,s;if(max!=0){s=delta/max}else{return{h:NaN,s:0,v:0}}if(r==max){h=(g-b)/delta}else if(g==max){h=2+(b-r)/delta}else{h=4+(r-g)/delta}h/=6;if(h<0){h+=1}return{h:h*360,s:s,v:max/255}},rgb_to_hex:function(r,g,b){var hex=this.hex_with_component(0,2,r);hex=this.hex_with_component(hex,1,g);hex=this.hex_with_component(hex,0,b);return hex},component_from_hex:function(hex,componentIndex){return hex>>componentIndex*8&255},hex_with_component:function(hex,componentIndex,value){return value<<(tmpComponent=componentIndex*8)|hex&~(255<<tmpComponent)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)}}(),dat.dom.CenteredDiv=function(dom,common){var CenteredDiv=function(){this.backgroundElement=document.createElement("div");common.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear"});dom.makeFullscreen(this.backgroundElement);this.backgroundElement.style.position="fixed";this.domElement=document.createElement("div");common.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear"});document.body.appendChild(this.backgroundElement);document.body.appendChild(this.domElement);var _this=this;dom.bind(this.backgroundElement,"click",function(){_this.hide()})};CenteredDiv.prototype.show=function(){var _this=this;this.backgroundElement.style.display="block";this.domElement.style.display="block";this.domElement.style.opacity=0;this.domElement.style.webkitTransform="scale(1.1)";this.layout();common.defer(function(){_this.backgroundElement.style.opacity=1;_this.domElement.style.opacity=1;_this.domElement.style.webkitTransform="scale(1)"})};CenteredDiv.prototype.hide=function(){var _this=this;var hide=function(){_this.domElement.style.display="none";_this.backgroundElement.style.display="none";dom.unbind(_this.domElement,"webkitTransitionEnd",hide);dom.unbind(_this.domElement,"transitionend",hide);dom.unbind(_this.domElement,"oTransitionEnd",hide)};dom.bind(this.domElement,"webkitTransitionEnd",hide);dom.bind(this.domElement,"transitionend",hide);dom.bind(this.domElement,"oTransitionEnd",hide);this.backgroundElement.style.opacity=0;this.domElement.style.opacity=0;this.domElement.style.webkitTransform="scale(1.1)"};CenteredDiv.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-dom.getWidth(this.domElement)/2+"px";this.domElement.style.top=window.innerHeight/2-dom.getHeight(this.domElement)/2+"px"};function lockScroll(e){console.log(e)}return CenteredDiv}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common);function CVector2(iX,iY){var x;var y;this._init=function(iX,iY){x=iX;y=iY};this.add=function(vx,vy){x+=vx;y+=vy};this.addV=function(v){x+=v.getX();y+=v.getY()};this.scalarDivision=function(n){x/=n;y/=n};this.subtract=function(v){x-=v.getX();y-=v.getY()};this.scalarProduct=function(n){x*=n;y*=n};this.invert=function(){x*=-1;y*=-1};this.dotProduct=function(v){return x*v.getX()+y*v.getY()};this.set=function(fx,fy){x=fx;y=fy};this.setV=function(v){x=v.getX();y=v.getY()};this.length=function(){return Math.sqrt(x*x+y*y)};this.length2=function(){return x*x+y*y};this.normalize=function(){var len=this.length();if(len>0){x/=len;y/=len}};this.angleBetweenVectors=function(v2){var iAngle=Math.acos(this.dotProduct(v2)/(this.length()*v2.length()));if(isNaN(iAngle)===true){return 0}else{return iAngle}};this.getNormalize=function(outV){var len=this.length();outV.set(x,y);outV.normalize()};this.rot90CCW=function(){var a=x;x=-y;y=a};this.rot90CW=function(){var a=x;x=y;y=-a};this.getRotCCW=function(outV){outV.set(x,y);outV.rot90CCW()};this.getRotCW=function(outV){outV.set(x,y);outV.rot90CW()};this.ceil=function(){x=Math.ceil(x);y=Math.ceil(y)};this.round=function(){x=Math.round(x);y=Math.round(y)};this.toString=function(){return"Vector2: "+x+", "+y};this.print=function(){trace("Vector2: "+x+", "+y+"")};this.getX=function(){return x};this.getY=function(){return y};this.rotate=function(iAngle){var fNewX=x;var fNewY=y;x=fNewX*Math.cos(iAngle)-fNewY*Math.sin(iAngle);y=fNewX*Math.sin(iAngle)+fNewY*Math.cos(iAngle)};this._init(iX,iY)}function CAreYouSurePanel(oParentContainer){var _aCbCompleted;var _aCbOwner;var _oBg;var _oMsg;var _oButYes;var _oButNo;var _oContainer;var _oParentContainer;var _oFade;var _oThis=this;this._init=function(){_aCbCompleted=new Array;_aCbOwner=new Array;_oContainer=new createjs.Container;_oContainer.visible=false;_oParentContainer.addChild(_oContainer);_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oFade.alpha=.5;_oFade.on("click",function(){});_oContainer.addChild(_oFade);var oSpriteBg=s_oSpriteLibrary.getSprite("msg_box_small");_oBg=createBitmap(oSpriteBg);_oBg.x=CANVAS_WIDTH_HALF;_oBg.y=CANVAS_HEIGHT_HALF;_oBg.regX=oSpriteBg.width*.5;_oBg.regY=oSpriteBg.height*.5;_oContainer.addChild(_oBg);var iWidth=oSpriteBg.width-100;var iHeight=160;_oMsg=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,CANVAS_HEIGHT/2-iHeight/2-60,iWidth,iHeight,60,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_ARE_SURE,true,true,true,false);_oButYes=new CGfxButton(CANVAS_WIDTH/2+180,CANVAS_HEIGHT*.5+100,s_oSpriteLibrary.getSprite("but_yes"),_oContainer);_oButYes.addEventListener(ON_MOUSE_UP,this._onButYes,this);_oButNo=new CGfxButton(CANVAS_WIDTH/2-180,CANVAS_HEIGHT*.5+100,s_oSpriteLibrary.getSprite("but_no"),_oContainer);_oButNo.addEventListener(ON_MOUSE_UP,this._onButNo,this)};this.addEventListener=function(iEvent,cbCompleted,cbOwner){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner};this.show=function(szMsg){_oMsg.text=szMsg;_oContainer.alpha=0;_oContainer.visible=true;createjs.Tween.get(_oContainer).to({alpha:1},300,createjs.Ease.quartOut).call(function(){s_oMain.stopUpdateNoBlock()})};this.hide=function(){s_oMain.startUpdateNoBlock();createjs.Tween.get(_oContainer).to({alpha:0},500,createjs.Ease.quartOut).call(function(){_oContainer.visible=false})};this.unload=function(){_oButNo.unload();_oButYes.unload()};this._onButYes=function(){_oThis.hide();if(_aCbCompleted[ON_BUT_YES_DOWN]){_aCbCompleted[ON_BUT_YES_DOWN].call(_aCbOwner[ON_BUT_YES_DOWN])}};this._onButNo=function(){_oThis.hide()};_oParentContainer=oParentContainer;this._init()}function CInterface(iLevel,_iTotScore,oParentContainer){var _aKickIcons;var _pStartPosAudio;var _pStartPosFullscreen;var _pStartPosScore;var _pStartPosExit;var _pStartPosKicks;var _oScoreText;var _oTextMult;var _oTextMultStroke;var _oButExit;var _oButFullscreen;var _oAudioToggle;var _oScoreBoard;var _oResultPanel;var _oContainerKicks;var _oHelpText;var _oFinalPanel;var _oVsPanel;var _oAreYouSurePanel;var _oContainerMult;var _oParentContainer=oParentContainer;var _fRequestFullScreen=null;var _fCancelFullScreen=null;this._init=function(iLevel){_pStartPosScore={x:CANVAS_WIDTH-20,y:CANVAS_HEIGHT-20};_oScoreText=new createjs.Text(TEXT_SCORE+" "+_iTotScore,"42px "+PRIMARY_FONT,"#fff");_oScoreText.x=_pStartPosScore.x;_oScoreText.y=_pStartPosScore.y;_oScoreText.textAlign="right";_oScoreText.textBaseline="alphabetic";_oScoreText.shadow=new createjs.Shadow("#000000",2,2,4);_oParentContainer.addChild(_oScoreText);_oContainerMult=new createjs.Container;_oContainerMult.x=CANVAS_WIDTH+100;_oContainerMult.y=_oScoreText.y-50;_oParentContainer.addChild(_oContainerMult);_oTextMultStroke=new createjs.Text("x2","42px "+PRIMARY_FONT,"#000");_oTextMultStroke.textAlign="right";_oTextMultStroke.outline=2;_oTextMultStroke.textBaseline="alphabetic";_oContainerMult.addChild(_oTextMultStroke);_oTextMult=new createjs.Text("x2","42px "+PRIMARY_FONT,"#fff");_oTextMult.textAlign="right";_oTextMult.textBaseline="alphabetic";_oContainerMult.addChild(_oTextMult);if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){var oSprite=s_oSpriteLibrary.getSprite("audio_icon");_pStartPosAudio={x:CANVAS_WIDTH-oSprite.height/2-10,y:oSprite.height/2+10};_oAudioToggle=new CToggle(_pStartPosAudio.x,_pStartPosAudio.y,oSprite,s_bAudioActive,_oParentContainer);_oAudioToggle.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this);oSprite=s_oSpriteLibrary.getSprite("but_fullscreen");_pStartPosFullscreen={x:_pStartPosAudio.x-oSprite.width/2-10,y:_pStartPosAudio.y}}else{oSprite=s_oSpriteLibrary.getSprite("but_fullscreen");_pStartPosFullscreen={x:CANVAS_WIDTH-oSprite.height/2-10,y:oSprite.height/2+10}}var doc=window.document;var docEl=doc.documentElement;_fRequestFullScreen=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;_fCancelFullScreen=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;if(ENABLE_FULLSCREEN===false){_fRequestFullScreen=false}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen=new CToggle(_pStartPosFullscreen.x,_pStartPosFullscreen.y,oSprite,s_bFullscreen,_oParentContainer);_oButFullscreen.addEventListener(ON_MOUSE_UP,this._onFullscreenRelease,this)}_oScoreBoard=new CScoreBoard(iLevel,{x:10,y:4},_oParentContainer);_aKickIcons=new Array;var iX=0;var oSpriteKick=s_oSpriteLibrary.getSprite("ball_kick");_pStartPosKicks={x:oSpriteKick.width/3/2+10,y:CANVAS_HEIGHT-oSpriteKick.height/2-10};_oContainerKicks=new createjs.Container;_oContainerKicks.x=_pStartPosKicks.x;_oContainerKicks.y=_pStartPosKicks.y;_oParentContainer.addChild(_oContainerKicks);var oData={images:[oSpriteKick],frames:{width:oSpriteKick.width/3,height:oSpriteKick.height,regX:oSpriteKick.width/3/2,regY:oSpriteKick.height/2},animations:{empty:0,state_0:1,state_1:2}};var oSpriteSheet=new createjs.SpriteSheet(oData);for(var i=0;i<5;i++){var oKick=new CKickIcon(iX,0,oSpriteSheet,_oContainerKicks);_aKickIcons.push(oKick);iX+=oSpriteKick.width/3+5}_oResultPanel=new CResultPanel(iLevel,_oParentContainer);_oHelpText=new CHelpText(_oParentContainer);_oVsPanel=new CVersusPanel(_oParentContainer);_oFinalPanel=new CFinalPanel(iLevel,_oParentContainer);_oAreYouSurePanel=new CAreYouSurePanel(s_oStage);_oAreYouSurePanel.addEventListener(ON_BUT_YES_DOWN,s_oGame.onExit,s_oGame);this.refreshButtonPos()};this.refreshButtonPos=function(){_oScoreText.x=_pStartPosScore.x-s_iOffsetX;_oScoreText.y=_pStartPosScore.y-s_iOffsetY;_oContainerMult.y=_oScoreText.y-50;if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.setPosition(_pStartPosAudio.x-s_iOffsetX,s_iOffsetY+_pStartPosAudio.y)}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setPosition(_pStartPosFullscreen.x-s_iOffsetX,_pStartPosFullscreen.y+s_iOffsetY)}_oContainerKicks.x=_pStartPosKicks.x+s_iOffsetX;_oContainerKicks.y=_pStartPosKicks.y-s_iOffsetY;_oScoreBoard.refreshButtonPos()};this.unload=function(){if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.unload();_oAudioToggle=null}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.unload();_oButFullscreen=null}_oButExit=null;_oFinalPanel.unload();_oAreYouSurePanel.unload();s_oInterface=null};this.reset=function(iOpponent,iLevel){_oResultPanel.reset(iOpponent);_oScoreBoard.reset(iOpponent);for(var i=0;i<_aKickIcons.length;i++){_aKickIcons[i].changeState("empty")}this.showVsPanel(iOpponent,iLevel)};this.showMultiplierAnim=function(iMult){_oTextMult.text=_oTextMultStroke.text="X"+iMult;createjs.Tween.get(_oContainerMult).to({x:_oScoreText.x},250,createjs.Ease.cubicOut).call(function(){createjs.Tween.get(_oContainerMult).wait(1e3).to({x:CANVAS_WIDTH+100},250,createjs.Ease.cubicIn).call(function(){})})};this.showVsPanel=function(iOpponent,iLevel){_oVsPanel.show(iOpponent,iLevel)};this.resetFullscreenBut=function(){if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setActive(s_bFullscreen)}};this._onFullscreenRelease=function(){if(s_bFullscreen){_fCancelFullScreen.call(window.document)}else{_fRequestFullScreen.call(window.document.documentElement)}sizeHandler()};this.refreshScoreBoard=function(szResult,iPlayerGoals,iCpuGoals){_oScoreBoard.setScore(iPlayerGoals,iCpuGoals);_oResultPanel.show(szResult,iPlayerGoals,iCpuGoals)};this.refreshKicks=function(aKicks){for(var i=0;i<_aKickIcons.length;i++){if(i<aKicks.length){_aKickIcons[i].changeState("state_"+aKicks[i])}else{_aKickIcons[i].changeState("empty")}}};this.refreshScore=function(iTotScore){_oScoreText.text=TEXT_SCORE+" "+iTotScore};this.showHelpText=function(szText){_oHelpText.show(szText)};this.hideHelpText=function(){_oHelpText.hide()};this.showFinalPanel=function(szResult,iTotScore,iTime,bGameOver,bLastLevel){_oFinalPanel.show(szResult,iTotScore,iTime,bGameOver,bLastLevel)};this.isHelpTextVisible=function(){return _oHelpText.visible};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=!s_bAudioActive};this._onExit=function(){_oAreYouSurePanel.show(TEXT_ARE_SURE)};s_oInterface=this;this._init(iLevel)}var s_oInterface=null;function CGame(oData,iLevel){var _bExtraPenalty;var _iPlayerGoals;var _iCpuGoals;var _iNumKicks;var _iCurLevel;var _iLevelScore;var _iTotScore;var _iMultiplier;var _aHistoryPlayer;var _aHistoryOpponent;var _aResults;var _oInterface;var _oCurScenario=null;var _oContainerGame;var _oContainer;var _iStartDate;var _iEndDate;this._init=function(iLevel){$(s_oMain).trigger("start_session");$(s_oMain).trigger("start_level",iLevel);_iStartDate=Date.now();_iCurLevel=iLevel;this.reset();_aResults=new Array;if(s_bMobile){for(var i=0;i<BALL_FORCE_Y.length;i++){BALL_FORCE_Y[i]*=BALL_VELOCITY_MULTIPLIER;BALL_FORCE_Z[i].min/=BALL_VELOCITY_MULTIPLIER+.1;BALL_FORCE_Z[i].max*=BALL_VELOCITY_MULTIPLIER+.1;BALL_FORCE_X[i]*=BALL_VELOCITY_MULTIPLIER}}_oContainer=new createjs.Container;s_oStage.addChild(_oContainer);var oFade=new createjs.Shape;oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oContainer.addChild(oFade);_oContainerGame=new createjs.Container;_oContainer.addChild(_oContainerGame);_oInterface=new CInterface(_iCurLevel,_iTotScore,_oContainer);_oCurScenario=new CGameStriker(_oContainerGame,_iCurLevel);_oInterface.showVsPanel(s_aMatches[iLevel-1],_iCurLevel)};this.reset=function(){_iTotScore=s_oMain.getScoreTillLevel(_iCurLevel);_bExtraPenalty=false;s_iCurState=STRIKER_MODE;_iPlayerGoals=0;_iLevelScore=0;_iCpuGoals=0;_iNumKicks=1;_iMultiplier=1;_aHistoryPlayer=new Array;_aHistoryOpponent=new Array;refreshSettings(s_iCurState);setVolume("soundtrack",SOUNDTRACK_VOLUME_IN_GAME);playSound("crowd",1,true)};this.unload=function(){_oCurScenario.unload();_oInterface.unload();s_oStage.removeChild(_oContainer)};this.changeScenario=function(){_iNumKicks++;if(s_iCurState===GOALKEEPER_MODE&&_iNumKicks>NUM_KICKS){_aResults.push({player:_iPlayerGoals,cpu:_iCpuGoals});var bGameOver=false;var bLastMatch=true;setVolume("soundtrack",1);stopSound("crowd");$(s_oMain).trigger("end_level",_iCurLevel);_iEndDate=Date.now();var time=_iEndDate-_iStartDate;_oInterface.showFinalPanel(_iPlayerGoals+"-"+_iCpuGoals,_iTotScore,time,bGameOver,bLastMatch);s_oMain.saveMatch(_iCurLevel,s_aMatches[_iCurLevel-1],_iPlayerGoals+"-"+_iCpuGoals,_iLevelScore,_iTotScore)}else{_oCurScenario.unload();_oCurScenario=null;if(s_iCurState===STRIKER_MODE){s_iCurState=GOALKEEPER_MODE;refreshSettings(s_iCurState);if(_iNumKicks>NUM_KICKS){_bExtraPenalty=true;if(BALL_FORCE_Y[_iCurLevel]<HIT_BALL_MAX_FORCE){BALL_FORCE_Y[_iCurLevel]+=2}}_oInterface.refreshKicks(_aHistoryOpponent);_oCurScenario=new CGameGoalkeeper(_iCurLevel,BALL_FORCE_Y[_iCurLevel-1],_oContainerGame)}else{s_iCurState=STRIKER_MODE;refreshSettings(s_iCurState);if(_iNumKicks>NUM_KICKS){_bExtraPenalty=true}_oInterface.refreshKicks(_aHistoryPlayer);_oCurScenario=new CGameStriker(_oContainerGame,_iCurLevel)}}};this.endShotPlayer=function(bGoal,bSaved){if(bGoal){_aHistoryPlayer.push(1);_iPlayerGoals++;if(!_bExtraPenalty){this.increaseScore(GOAL_SCORED*_iMultiplier)}}else{_iMultiplier=1;if(!_bExtraPenalty){this.increaseScore(GOAL_MISSED)}_aHistoryPlayer.push(0)}_oInterface.refreshKicks(_aHistoryPlayer);var szResult=TEXT_MISSED;if(bGoal){szResult=TEXT_GOAL}_oInterface.refreshScoreBoard(szResult,_iPlayerGoals,_iCpuGoals)};this.endShotCpu=function(bGoal,bSaved){if(bGoal){_aHistoryOpponent.push(1);_iCpuGoals++;_iMultiplier=1;if(!_bExtraPenalty){this.increaseScore(GOAL_SUFFERED)}}else{_aHistoryOpponent.push(0);if(!_bExtraPenalty){this.increaseScore(GOAL_SAVED*_iMultiplier)}}_oInterface.refreshKicks(_aHistoryOpponent);var szResult=TEXT_MISSED;if(bGoal){szResult=TEXT_GOAL}else if(bSaved){szResult=TEXT_SAVED}_oInterface.refreshScoreBoard(szResult,_iPlayerGoals,_iCpuGoals)};this._increaseMultiplier=function(){if(_iMultiplier>1){_oInterface.showMultiplierAnim(_iMultiplier)}_iMultiplier++};this.increaseScore=function(iAmount){_iLevelScore+=iAmount;_iTotScore+=iAmount;if(_iTotScore<0){_iTotScore=0;_iLevelScore=0}_oInterface.refreshScore(_iTotScore)};this.nextRound=function(){_iCurLevel++;this.reset();_oInterface.reset(s_aMatches[_iCurLevel-1],_iCurLevel);_oCurScenario=new CGameStriker(_oContainerGame,_iCurLevel)};this.retryLevel=function(){_iCurLevel--;this.nextRound();$(s_oMain).trigger("restart_level",_iCurLevel)};this.onExit=function(){this.unload();$(s_oMain).trigger("show_interlevel_ad");$(s_oMain).trigger("end_session");setVolume("soundtrack",1);s_oMain.gotoMenu()};this.update=function(){if(_oCurScenario!==null){_oCurScenario.update()}};GOAL_SCORED=oData.score_goal;GOAL_MISSED=oData.score_goal_missed;GOAL_SAVED=oData.score_ball_saved;GOAL_SUFFERED=oData.score_goal_opponent;AREAS_INFO=oData.area_goal;s_oGame=this;this._init(iLevel)}var s_iCurState;var s_oGame=null;function CScoreBoard(iLevel,pContainerPos,oParentContainer){var _pStartPos;var _oFlagOpponent;var _oCpuText;var _oScoreText;var _oContainerText;var _oContainer;var _oParentContainer=oParentContainer;this._init=function(iLevel,pContainerPos){_pStartPos=pContainerPos;_oContainer=new createjs.Container;_oContainer.x=pContainerPos.x;_oContainer.y=pContainerPos.y;_oParentContainer.addChild(_oContainer);var oSpriteBg=s_oSpriteLibrary.getSprite("score_side_bg");var oBg=createBitmap(oSpriteBg);_oContainer.addChild(oBg);_oContainerText=new createjs.Container;_oContainerText.x=oSpriteBg.width/2;_oContainer.addChild(_oContainerText);_oScoreText=new createjs.Text("0\n0","44px "+PRIMARY_FONT,TEXT_COLOR);_oScoreText.y=44;_oScoreText.textAlign="right";_oScoreText.textBaseline="alphabetic";_oContainerText.addChild(_oScoreText);var oFlagPlayer=createBitmap(s_oSpriteLibrary.getSprite("flag_"+TEAM_LABEL[s_iTeamSelected]));oFlagPlayer.scaleX=oFlagPlayer.scaleY=.4;oFlagPlayer.x=_oScoreText.x-_oScoreText.getBounds().width-50;oFlagPlayer.y=18;_oContainerText.addChild(oFlagPlayer);_oFlagOpponent=createBitmap(s_oSpriteLibrary.getSprite("flag_"+TEAM_LABEL[s_aMatches[iLevel-1]]));_oFlagOpponent.scaleX=_oFlagOpponent.scaleY=.4;_oFlagOpponent.x=oFlagPlayer.x;_oFlagOpponent.y=oFlagPlayer.y+42;_oContainerText.addChild(_oFlagOpponent);var oNicknameText=new createjs.Text(TEXT_TEAM[s_iTeamSelected],"32px "+PRIMARY_FONT,TEXT_COLOR);oNicknameText.x=oFlagPlayer.x-15;oNicknameText.y=40;oNicknameText.textAlign="right";oNicknameText.textBaseline="alphabetic";_oContainerText.addChild(oNicknameText);_oCpuText=new createjs.Text(TEXT_TEAM[s_aMatches[iLevel-1]],"32px "+PRIMARY_FONT,TEXT_COLOR);_oCpuText.x=oFlagPlayer.x-15;_oCpuText.y=oNicknameText.y+42;_oCpuText.textAlign="right";_oCpuText.textBaseline="alphabetic";_oContainerText.addChild(_oCpuText);_oContainerText.regX=-_oContainerText.getBounds().width/2};this.reset=function(iOpponent){_oCpuText.text=TEXT_TEAM[iOpponent];_oFlagOpponent.image=s_oSpriteLibrary.getSprite("flag_"+TEAM_LABEL[iOpponent]);_oScoreText.text="0\n0";_oContainerText.regX=-_oContainerText.getBounds().width/2};this.refreshButtonPos=function(){_oContainer.x=_pStartPos.x+s_iOffsetX;_oContainer.y=_pStartPos.y+s_iOffsetY};this.setScore=function(iPlayerScore,iCpuScore){_oScoreText.text=iPlayerScore+"\n"+iCpuScore};this.darken=function(){_oContainer.alpha=.7};this.show=function(){_oContainer.visible=true};this.hide=function(){_oContainer.visible=false};this._init(iLevel,pContainerPos);return this}function CResultPanel(iLevel,oParentContainer){var _oListener;var _oFade;var _oResultText;var _oScoreBoard;var _oContainer;var _oParentContainer=oParentContainer;this._init=function(iLevel){_oContainer=new createjs.Container;_oContainer.visible=false;_oContainer.x=CANVAS_WIDTH_HALF;_oContainer.y=CANVAS_HEIGHT_HALF;_oContainer.regX=CANVAS_WIDTH_HALF;_oContainer.regY=CANVAS_HEIGHT_HALF;_oParentContainer.addChild(_oContainer);_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oFade.alpha=.01;_oListener=_oFade.on("click",function(){});_oContainer.addChild(_oFade);var oSpriteBg=s_oSpriteLibrary.getSprite("msg_box_small");var oMsgBox=createBitmap(oSpriteBg);oMsgBox.x=CANVAS_WIDTH_HALF+6;oMsgBox.y=CANVAS_HEIGHT_HALF;oMsgBox.regX=oSpriteBg.width/2;oMsgBox.regY=oSpriteBg.height/2;_oContainer.addChild(oMsgBox);_oResultText=new createjs.Text("GOAL!","85px "+PRIMARY_FONT,"#fff");_oResultText.x=CANVAS_WIDTH_HALF;_oResultText.y=CANVAS_HEIGHT_HALF-50;_oResultText.textAlign="center";_oResultText.textBaseline="alphabetic";_oContainer.addChild(_oResultText);_oScoreBoard=new CScoreBoard(iLevel,{x:CANVAS_WIDTH_HALF-140,y:CANVAS_HEIGHT_HALF},_oContainer)};this.show=function(szResult,iPlayerGoals,iCpuGoals){_oResultText.text=szResult;if(szResult==TEXT_SAVED){_oResultText.font="60px "+PRIMARY_FONT}else{_oResultText.font="85px "+PRIMARY_FONT}_oScoreBoard.setScore(iPlayerGoals,iCpuGoals);_oContainer.alpha=0;_oContainer.visible=true;createjs.Tween.get(_oContainer).to({alpha:1},500,createjs.Ease.quartOut);var oParent=this;setTimeout(function(){oParent.hide()},2500)};this.hide=function(){createjs.Tween.get(_oContainer).to({alpha:0},500,createjs.Ease.quartOut).call(function(){_oContainer.visible=false;s_oGame.changeScenario()})};this.reset=function(iOpponent){_oScoreBoard.reset(iOpponent)};this._init(iLevel)}function CHelpText(oParentContainer){var _oParentContainer=oParentContainer;var _oHelpText;var _oHelpTextStroke;var _oContainer;this._init=function(){_oContainer=new createjs.Container;_oParentContainer.addChild(_oContainer);_oHelpText=new createjs.Text(TEXT_HELP,"42px "+PRIMARY_FONT,TEXT_COLOR);_oHelpText.x=CANVAS_WIDTH/2;_oHelpText.y=CANVAS_HEIGHT_HALF+100;_oHelpText.textAlign="center";_oContainer.addChild(_oHelpText);_oHelpTextStroke=new createjs.Text(TEXT_HELP,"42px "+PRIMARY_FONT,"#003470");_oHelpTextStroke.x=CANVAS_WIDTH/2;_oHelpTextStroke.y=_oHelpText.y;_oHelpTextStroke.textAlign="center";_oHelpTextStroke.outline=OUTLINE_WIDTH;_oContainer.addChild(_oHelpTextStroke);_oContainer.alpha=0};this.show=function(szText){_oHelpText.text=_oHelpTextStroke.text=szText;_oContainer.alpha=0;_oContainer.visible=true;createjs.Tween.get(_oContainer).to({alpha:1},MS_TIME_FADE_HELP_TEXT)};this.hide=function(){createjs.Tween.get(_oContainer).to({alpha:0},MS_TIME_FADE_HELP_TEXT).call(function(){_oContainer.visible=false})};this.unload=function(){createjs.Tween.removeTweens(_oContainer);_oParentContainer.removeChild(_oContainer)};this._init();return this}function CFinalPanel(iLevel,oParentContainer){var _oListener;var _oButNext;var _oButPlayAgain;var _oButHome;var _oResultText;var _oTextWinLose;var _oTimeText;var _oTotScoreText;var _oFlagPlayer;var _oFlagOpponent;var _oFade;var _oContainer;var _oParentContainer=oParentContainer;var _oThis=this;this._init=function(iLevel){_oContainer=new createjs.Container;_oContainer.visible=false;_oParentContainer.addChild(_oContainer);_oFade=new createjs.Shape;_oListener=_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oFade.alpha=.5;_oFade.on("click",function(){});_oContainer.addChild(_oFade);var oSpriteBg=s_oSpriteLibrary.getSprite("msg_box");var oBg=createBitmap(oSpriteBg);oBg.x=CANVAS_WIDTH_HALF;oBg.y=CANVAS_HEIGHT_HALF;oBg.regX=oSpriteBg.width/2;oBg.regY=oSpriteBg.height/2;_oContainer.addChild(oBg);var iWidth=700;var iHeight=120;_oTextWinLose=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,-iHeight/2+130,iWidth,iHeight,130,"center",TEXT_COLOR,PRIMARY_FONT,1,2,2,TEXT_WIN,true,true,true,false);_oResultText=new createjs.Text("YOU 3-2 CPU","80px "+PRIMARY_FONT,"#fff");_oResultText.x=CANVAS_WIDTH_HALF;_oResultText.y=260;_oResultText.textAlign="center";_oResultText.textBaseline="alphabetic";_oContainer.addChild(_oResultText);var oSpriteFlag=s_oSpriteLibrary.getSprite("flag_"+TEAM_LABEL[s_iTeamSelected]);_oFlagPlayer=createBitmap(oSpriteFlag);_oFlagPlayer.x=CANVAS_WIDTH_HALF-120;_oFlagPlayer.y=_oResultText.y-22;_oFlagPlayer.regX=oSpriteFlag.width/2;_oFlagPlayer.regY=oSpriteFlag.height/2;_oContainer.addChild(_oFlagPlayer);oSpriteFlag=s_oSpriteLibrary.getSprite("flag_"+TEAM_LABEL[s_aMatches[iLevel-1]]);_oFlagOpponent=createBitmap(oSpriteFlag);_oFlagOpponent.x=CANVAS_WIDTH_HALF+120;_oFlagOpponent.y=_oResultText.y-22;_oFlagOpponent.regX=oSpriteFlag.width/2;_oFlagOpponent.regY=oSpriteFlag.height/2;_oContainer.addChild(_oFlagOpponent);var iWidth=500;var iHeight=48;_oTimeText=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,CANVAS_HEIGHT/2-iHeight/2+30,iWidth,iHeight,48,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_TIME+" 00:00",true,true,true,false);var iWidth=550;var iHeight=58;_oTotScoreText=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,CANVAS_HEIGHT/2-iHeight/2+80,iWidth,iHeight,58,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_TOTAL+" 999999",true,true,true,false);_oButHome=new CGfxButton(CANVAS_WIDTH_HALF-130,CANVAS_HEIGHT_HALF+190,s_oSpriteLibrary.getSprite("but_home"),_oContainer);_oButHome.addEventListener(ON_MOUSE_UP,this._onHome,this);_oButPlayAgain=new CGfxButton(CANVAS_WIDTH_HALF,CANVAS_HEIGHT_HALF+190,s_oSpriteLibrary.getSprite("but_restart"),_oContainer);_oButPlayAgain.addEventListener(ON_MOUSE_UP,this._onRetry,this);_oButNext=new CGfxButton(CANVAS_WIDTH_HALF+130,CANVAS_HEIGHT_HALF+190,s_oSpriteLibrary.getSprite("but_next"),_oContainer);_oButNext.addEventListener(ON_MOUSE_UP,this._onNext,this)};this.unload=function(){_oButNext.unload();_oButHome.unload();_oButPlayAgain.unload();_oFade.off("click",_oListener);_oParentContainer.removeChild(_oContainer)};this.show=function(szResult,iTotScore,iTime,bLose,bLastLevel){setVolume("soundtrack",1);_oResultText.text=szResult;if(bLose){_oTextWinLose.refreshText(TEXT_LOSE);_oButNext.setVisible(false);_oButHome.setX(CANVAS_WIDTH_HALF-100);_oButPlayAgain.setX(CANVAS_WIDTH_HALF+100)}else{_oTextWinLose.refreshText(TEXT_WIN);_oButNext.setVisible(true);if(bLastLevel){_oButNext.setVisible(false);_oButHome.setX(CANVAS_WIDTH_HALF-80);_oButPlayAgain.setX(CANVAS_WIDTH_HALF+80)}else{_oButHome.setX(CANVAS_WIDTH_HALF-130);_oButPlayAgain.setX(CANVAS_WIDTH_HALF);_oButNext.setX(CANVAS_WIDTH_HALF+130)}}_oButNext.setVisible(false);_oButHome.setVisible(false);_oButPlayAgain.setVisible(false);_oTimeText.refreshText("");_oTimeText.refreshText(TEXT_TIME+" "+this.msToTime(iTime));_oTotScoreText.refreshText(TEXT_TOTAL+" "+iTotScore);_oContainer.alpha=0;_oContainer.visible=true;createjs.Tween.get(_oContainer).to({alpha:1},500,createjs.Ease.quartOut);$(s_oMain).trigger("end_session",{time:iTime,score:iTotScore});Howler.mute(s_bAudioActive)};this.hide=function(){createjs.Tween.get(_oContainer).to({alpha:0},500,createjs.Ease.quartOut).call(function(){_oContainer.visible=false})};this.hideScoreBoards=function(){for(var i=0;i<_aScoreBoards.length;i++){_aScoreBoards[i].hide()}};this._onConfirmExit=function(){s_oGame.onExit()};this._onNext=function(){_oThis.hide();s_oGame.nextRound()};this._onRetry=function(){_oThis.hide();s_oGame.retryLevel()};this._onHome=function(){s_oGame.onExit()};this.msToTime=function(s){function pad(n,z){z=z||2;return("00"+n).slice(-z)}var ms=s%1e3;s=(s-ms)/1e3;var secs=s%60;s=(s-secs)/60;var mins=s%60;var hrs=(s-mins)/60;return pad(hrs)+":"+pad(mins)+":"+pad(secs)+"."+pad(ms,3)};this._init(iLevel)}var NUM_ROWS_PAGE_LEVEL=2;var NUM_COLS_PAGE_LEVEL=5;function CLevelMenu(){var _iCurPage;var _iHeightToggle;var _iCurResources;var _iTotResources;var _iLevelSelected;var _aLevelButs;var _aPointsX;var _aResults;var _aContainerPage;var _pStartPosExit;var _pStartPosAudio;var _pStartPosRight;var _pStartPosLeft;var _pStartPosFullscreen;var _oListenerFade=null;var _oPreloaderFade;var _oButExit;var _oAudioToggle;var _oArrowRight=null;var _oArrowLeft=null;var _oContainer;var _oFade;var _oButFullscreen;var _fRequestFullScreen=null;var _fCancelFullScreen=null;this._init=function(){var aStoredMatches=s_oMain.getMatches();if(aStoredMatches===null){this._extractMatches()}else{s_aMatches=new Array;_aResults=new Array;for(var i=0;i<aStoredMatches.length;i++){s_aMatches[i]=aStoredMatches[i].opponent;var szResult=aStoredMatches[i].result;if(szResult===""){_aResults.push(["",""])}else{var aResultSplit=szResult.split("-");_aResults.push(aResultSplit)}}}_iCurPage=0;_oContainer=new createjs.Container;s_oStage.addChild(_oContainer);var oBg=createBitmap(s_oSpriteLibrary.getSprite("bg_levelselect"));_oContainer.addChild(oBg);var oSpriteMsgBox=s_oSpriteLibrary.getSprite("msg_box");var oMsgBox=createBitmap(oSpriteMsgBox);oMsgBox.x=CANVAS_WIDTH_HALF;oMsgBox.y=CANVAS_HEIGHT_HALF+30;oMsgBox.regX=oSpriteMsgBox.width*.5;oMsgBox.regY=oSpriteMsgBox.height*.5;_oContainer.addChild(oMsgBox);var iWidth=700;var iHeight=60;var oTextTitle=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,-iHeight/2+70,iWidth,iHeight,50,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_MATCHES,true,true,true,false);oTextTitle.setShadow("#000000",2,2,4);var oSprite=s_oSpriteLibrary.getSprite("but_exit");_pStartPosExit={x:CANVAS_WIDTH-oSprite.height/2-10,y:oSprite.height/2+10};_oButExit=new CGfxButton(_pStartPosExit.x,_pStartPosExit.y,oSprite,s_oStage);_oButExit.addEventListener(ON_MOUSE_UP,this._onExit,this);_iHeightToggle=oSprite.height;if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_pStartPosAudio={x:_oButExit.getX()-oSprite.width-10,y:oSprite.height/2+10};_oAudioToggle=new CToggle(_pStartPosAudio.x,_pStartPosAudio.y,s_oSpriteLibrary.getSprite("audio_icon"),s_bAudioActive);_oAudioToggle.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this)}var doc=window.document;var docEl=doc.documentElement;_fRequestFullScreen=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;_fCancelFullScreen=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;if(ENABLE_FULLSCREEN===false){_fRequestFullScreen=false}if(_fRequestFullScreen&&screenfull.enabled){oSprite=s_oSpriteLibrary.getSprite("but_fullscreen");_pStartPosFullscreen={x:oSprite.width/4+10,y:_pStartPosExit.y};_oButFullscreen=new CToggle(_pStartPosFullscreen.x,_pStartPosFullscreen.y,oSprite,s_bFullscreen,s_oStage);_oButFullscreen.addEventListener(ON_MOUSE_UP,this._onFullscreenRelease,this)}this._checkBoundLimits();_aPointsX=new Array;var iWidth=CANVAS_WIDTH+EDGEBOARD_X;var iOffsetX=Math.floor(iWidth/NUM_COLS_PAGE_LEVEL)/2;var iXPos=-EDGEBOARD_X*.7;for(var i=0;i<NUM_COLS_PAGE_LEVEL;i++){_aPointsX.push(iXPos);iXPos+=iOffsetX}_aContainerPage=new Array;this._createNewLevelPage(0,NUM_MATCHES);if(_aContainerPage.length>1){for(var k=1;k<_aContainerPage.length;k++){_aContainerPage[k].visible=false}_pStartPosRight={x:CANVAS_WIDTH-180,y:CANVAS_HEIGHT_HALF};_oArrowRight=new CGfxButton(_pStartPosRight.x,_pStartPosRight.y,s_oSpriteLibrary.getSprite("arrow_right"),s_oStage);_oArrowRight.addEventListener(ON_MOUSE_UP,this._onRight,this);_pStartPosLeft={x:180,y:CANVAS_HEIGHT_HALF};_oArrowLeft=new CGfxButton(_pStartPosLeft.x,_pStartPosLeft.y,s_oSpriteLibrary.getSprite("arrow_left"),s_oStage);_oArrowLeft.addEventListener(ON_MOUSE_UP,this._onLeft,this)}_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);s_oStage.addChild(_oFade);createjs.Tween.get(_oFade).to({alpha:0},1e3).call(function(){s_oStage.removeChild(_oFade);_oFade=null});this.refreshButtonPos(s_iOffsetX,s_iOffsetY)};this.unload=function(){for(var i=0;i<_aLevelButs.length;i++){_aLevelButs[i].unload()}if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.unload();_oAudioToggle=null}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.unload()}_oButExit.unload();_oButExit=null;if(_oArrowLeft!==null){_oArrowLeft.unload();_oArrowRight.unload()}if(_oListenerFade!==null){_oPreloaderFade.off("click",_oListenerFade)}s_oLevelMenu=null;s_oStage.removeAllChildren()};this.refreshButtonPos=function(){_oButExit.setPosition(_pStartPosExit.x-s_iOffsetX,_pStartPosExit.y+s_iOffsetY);if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.setPosition(_pStartPosAudio.x-s_iOffsetX,s_iOffsetY+_pStartPosAudio.y)}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setPosition(_pStartPosFullscreen.x+s_iOffsetX,_pStartPosFullscreen.y+s_iOffsetY)}};this._extractMatches=function(){s_aMatches=new Array;_aResults=new Array;var iCont=4;while(iCont>0){var iRand=Math.floor(Math.random()*EASY_TEAM.length);if(EASY_TEAM[iRand]!==s_iTeamSelected){s_aMatches.push(EASY_TEAM[iRand]);s_oMain.saveMatch(s_aMatches.length,EASY_TEAM[iRand],"",0,0);iCont--;EASY_TEAM.splice(iRand,1);_aResults.push(["",""])}}var iCont=3;while(iCont>0){var iRand=Math.floor(Math.random()*MEDIUM_TEAM.length);if(MEDIUM_TEAM[iRand]!==s_iTeamSelected){s_aMatches.push(MEDIUM_TEAM[iRand]);s_oMain.saveMatch(s_aMatches.length,MEDIUM_TEAM[iRand],"",0,0);iCont--;MEDIUM_TEAM.splice(iRand,1);_aResults.push(["",""])}}var iCont=3;while(iCont>0){var iRand=Math.floor(Math.random()*HARD_TEAM.length);if(HARD_TEAM[iRand]!==s_iTeamSelected){s_aMatches.push(HARD_TEAM[iRand]);s_oMain.saveMatch(s_aMatches.length,HARD_TEAM[iRand],"",0,0);iCont--;HARD_TEAM.splice(iRand,1);_aResults.push(["",""])}}};this._checkBoundLimits=function(){var oSprite=s_oSpriteLibrary.getSprite("but_level");var iY=0;var iHeightBound=CANVAS_HEIGHT-EDGEBOARD_Y*2-_iHeightToggle*2;var iNumRows=0;while(iY<iHeightBound){iY+=oSprite.height+20;iNumRows++}if(NUM_ROWS_PAGE_LEVEL>iNumRows){NUM_ROWS_PAGE_LEVEL=iNumRows}var iNumCols=0;var iX=0;var iWidthBounds=CANVAS_WIDTH-EDGEBOARD_X*2;var oSprite=s_oSpriteLibrary.getSprite("but_level");while(iX<iWidthBounds){iX+=oSprite.width/2+5;iNumCols++}if(NUM_COLS_PAGE_LEVEL>iNumCols){NUM_COLS_PAGE_LEVEL=iNumCols}};this._createNewLevelPage=function(iStartLevel,iEndLevel){var oContainerLevelBut=new createjs.Container;_oContainer.addChild(oContainerLevelBut);_aContainerPage.push(oContainerLevelBut);_aLevelButs=new Array;var iCont=0;var iY=50;var iNumRow=1;var bNewPage=false;var oSprite=s_oSpriteLibrary.getSprite("but_level");for(var i=iStartLevel;i<iEndLevel;i++){var oBut=new CLevelBut(_aPointsX[iCont]+oSprite.width/2,iY+oSprite.height/2,s_aMatches[i],_aResults[i],i+1,oSprite,i+1>s_iLastLevel?false:true,oContainerLevelBut);oBut.addEventListenerWithParams(ON_MOUSE_UP,this._onButLevelRelease,this,i+1);_aLevelButs.push(oBut);iCont++;if(iCont===_aPointsX.length){iCont=0;iY+=oSprite.height+50;iNumRow++;if(iNumRow>NUM_ROWS_PAGE_LEVEL&&i<iEndLevel-1){bNewPage=true;break}}}oContainerLevelBut.x=CANVAS_WIDTH/2+oSprite.width/2;oContainerLevelBut.y=CANVAS_HEIGHT/2;oContainerLevelBut.regX=oContainerLevelBut.getBounds().width/2;oContainerLevelBut.regY=oContainerLevelBut.getBounds().height/2;if(bNewPage){this._createNewLevelPage(i+1,iEndLevel)}};this._onRight=function(){_aContainerPage[_iCurPage].visible=false;_iCurPage++;if(_iCurPage>=_aContainerPage.length){_iCurPage=0}_aContainerPage[_iCurPage].visible=true};this._onLeft=function(){_aContainerPage[_iCurPage].visible=false;_iCurPage--;if(_iCurPage<0){_iCurPage=_aContainerPage.length-1}_aContainerPage[_iCurPage].visible=true};this._onButLevelRelease=function(iLevel){_iLevelSelected=iLevel;if(s_oSpriteLibrary.getSprite("player_"+TEAM_INFO[s_iTeamSelected].player+"_0")===null){_oPreloaderFade=new createjs.Shape;_oListenerFade=_oPreloaderFade.on("click",function(){});_oPreloaderFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oPreloaderFade.alpha=.5;_oContainer.addChild(_oPreloaderFade);s_oSpriteLibrary.init(function(){},this._onAllImagesLoaded,this);for(var i=0;i<31;i++){s_oSpriteLibrary.addSprite("player_"+TEAM_INFO[s_iTeamSelected].player+"_"+i,"./sprites/striker/player/player_"+TEAM_INFO[s_iTeamSelected].player+"_"+i+".png")}_iCurResources=0;_iTotResources=s_oSpriteLibrary.getNumSprites();s_oSpriteLibrary.loadSprites()}else{s_oLevelMenu.unload();s_oMain.gotoGame(iLevel)}};this._onAllImagesLoaded=function(){s_oLevelMenu.unload();s_oMain.gotoGame(_iLevelSelected)};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=!s_bAudioActive};this._onExit=function(){this.unload();s_oMain.gotoMenu()};this.resetFullscreenBut=function(){if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setActive(s_bFullscreen)}};this._onFullscreenRelease=function(){if(s_bFullscreen){_fCancelFullScreen.call(window.document)}else{_fRequestFullScreen.call(window.document.documentElement)}sizeHandler()};s_oLevelMenu=this;this._init()}var s_oLevelMenu=null;function CLevelBut(iXPos,iYPos,iOpponent,aResult,iLevel,oSprite,bActive,oParentContainer){var _bActive;var _aCbCompleted;var _aCbOwner;var _aParams=[];var _oLevelText;var _oScorePlayer;var _oScoreOpponent;var _oButton;var _oLocked;var _oContainer;var _oParentContainer;var _oEventMouseDown;var _oEventPressUp;this._init=function(iXPos,iYPos,iOpponent,aResult,iLevel,oSprite,bActive){_aCbCompleted=new Array;_aCbOwner=new Array;_oContainer=new createjs.Container;_oContainer.x=iXPos;_oContainer.y=iYPos;_oParentContainer.addChild(_oContainer);_bActive=bActive;_oButton=createBitmap(oSprite);_oButton.mouseEnabled=bActive;_oButton.regX=oSprite.width/2;_oButton.regY=oSprite.height/2;_oContainer.addChild(_oButton);var oSpriteFlag=s_oSpriteLibrary.getSprite("flag_"+s_iTeamSelected);var oMyFlag=createBitmap(oSpriteFlag);oMyFlag.y=-30;oMyFlag.regX=oSpriteFlag.width/2;oMyFlag.regY=oSpriteFlag.height/2;oMyFlag.scaleX=oMyFlag.scaleY=.5;_oContainer.addChild(oMyFlag);var oVsText=new createjs.Text(TEXT_VS,"20px "+PRIMARY_FONT,TEXT_COLOR);oVsText.y=3;oVsText.textAlign="center";oVsText.textBaseline="alphabetic";_oContainer.addChild(oVsText);var oSpriteFlag=s_oSpriteLibrary.getSprite("flag_"+iOpponent);var oOpponentFlag=createBitmap(oSpriteFlag);oOpponentFlag.y=24;oOpponentFlag.regX=oSpriteFlag.width/2;oOpponentFlag.regY=oSpriteFlag.height/2;oOpponentFlag.scaleX=oOpponentFlag.scaleY=.5;_oContainer.addChild(oOpponentFlag);_oScorePlayer=new createjs.Text(aResult[0],"30px "+PRIMARY_FONT,TEXT_COLOR);_oScorePlayer.x=40;_oScorePlayer.y=-20;_oScorePlayer.textAlign="center";_oScorePlayer.textBaseline="alphabetic";_oContainer.addChild(_oScorePlayer);_oScoreOpponent=new createjs.Text(aResult[1],"30px "+PRIMARY_FONT,TEXT_COLOR);_oScoreOpponent.x=40;_oScoreOpponent.y=32;_oScoreOpponent.textAlign="center";_oScoreOpponent.textBaseline="alphabetic";_oContainer.addChild(_oScoreOpponent);var oSpriteLocked=s_oSpriteLibrary.getSprite("but_level_locked");_oLocked=createBitmap(oSpriteLocked);_oLocked.regX=oSpriteLocked.width/2;_oLocked.regY=oSpriteLocked.height/2;_oContainer.addChild(_oLocked);var iWidth=120;var iHeight=30;_oLevelText=new CTLText(_oContainer,-iWidth/2+2,-iHeight/2-76,iWidth,iHeight,22,"center",TEXT_COLOR,PRIMARY_FONT,1,2,2,TEXT_MATCH+" "+iLevel,true,true,true,false);if(!bActive){_oLevelText.setColor("#b4b4b4");_oContainer.cursor="default"}else{_oContainer.cursor="pointer";_oLocked.visible=false}this._initListener()};this.unload=function(){_oContainer.off("mousedown",_oEventMouseDown);_oContainer.off("pressup",_oEventPressUp);_oContainer.removeChild(_oButton)};this._initListener=function(){_oEventMouseDown=_oContainer.on("mousedown",this.buttonDown);_oEventPressUp=_oContainer.on("pressup",this.buttonRelease)};this.viewBut=function(oButton){_oContainer.addChild(oButton)};this.addEventListener=function(iEvent,cbCompleted,cbOwner){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner};this.addEventListenerWithParams=function(iEvent,cbCompleted,cbOwner,aParams){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner;_aParams=aParams};this.ifClickable=function(){if(_oContainer.mouseEnabled===true){return 1}return 0};this.setActive=function(bActive){_bActive=bActive;_oButton.mouseEnabled=true;if(_bActive){_oLocked.visible=false;_oLevelText.setColor("#69b8d5")}else{_oLocked.visible=true;_oLevelText.setColor("#b4b4b4")}};this.setScore=function(iPlayerScore,iOpponentScore){_oScorePlayer.text=iPlayerScore;_oScoreOpponent.text=iOpponentScore};this.buttonRelease=function(){if(!_bActive){return}if(_aCbCompleted[ON_MOUSE_UP]){_aCbCompleted[ON_MOUSE_UP].call(_aCbOwner[ON_MOUSE_UP],_aParams)}};this.buttonDown=function(){if(_aCbCompleted[ON_MOUSE_DOWN]){_aCbCompleted[ON_MOUSE_DOWN].call(_aCbOwner[ON_MOUSE_DOWN],_aParams)}};this.setPosition=function(iXPos,iYPos){_oContainer.x=iXPos;_oContainer.y=iYPos};this.setVisible=function(bVisible){_oContainer.visible=bVisible};_oParentContainer=oParentContainer;this._init(iXPos,iYPos,iOpponent,aResult,iLevel,oSprite,bActive,oParentContainer)}function CCreditsPanel(){var _oBg;var _oButLogo;var _oButExit;var _oMsgText;var _oHitArea;var _oLink;var _pStartPosExit;var _oContainer;this._init=function(){_oContainer=new createjs.Container;s_oStage.addChild(_oContainer);var oSpriteBg=s_oSpriteLibrary.getSprite("msg_box_small");_oHitArea=new createjs.Shape;_oHitArea.graphics.beginFill("#000").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oHitArea.alpha=.5;_oHitArea.on("click",this._onLogoButRelease);_oHitArea.cursor="pointer";_oContainer.addChild(_oHitArea);_oBg=createBitmap(oSpriteBg);_oBg.x=CANVAS_WIDTH_HALF;_oBg.y=CANVAS_HEIGHT_HALF;_oBg.regX=oSpriteBg.width*.5;_oBg.regY=oSpriteBg.height*.5;_oContainer.addChild(_oBg);var oSprite=s_oSpriteLibrary.getSprite("but_exit");_pStartPosExit={x:CANVAS_WIDTH*.5+290,y:150};_oButExit=new CGfxButton(_pStartPosExit.x,_pStartPosExit.y,oSprite,_oContainer);_oButExit.addEventListener(ON_MOUSE_UP,this.unload,this);_oMsgText=new createjs.Text(TEXT_CREDITS_DEVELOPED,"50px "+PRIMARY_FONT,"#ffffff");_oMsgText.textAlign="center";_oMsgText.textBaseline="alphabetic";_oMsgText.x=CANVAS_WIDTH/2;_oMsgText.y=250;_oContainer.addChild(_oMsgText);oSprite=s_oSpriteLibrary.getSprite("logo_ctl");_oButLogo=createBitmap(oSprite);_oButLogo.regX=oSprite.width/2;_oButLogo.regY=oSprite.height/2;_oButLogo.x=CANVAS_WIDTH/2;_oButLogo.y=CANVAS_HEIGHT/2;_oContainer.addChild(_oButLogo);_oLink=new createjs.Text("WWW.CODETHISLAB.COM","44px "+PRIMARY_FONT,"#ffffff");_oLink.textAlign="center";_oLink.textBaseline="alphabetic";_oLink.x=CANVAS_WIDTH/2;_oLink.y=420;_oContainer.addChild(_oLink)};this.unload=function(){_oHitArea.off("click",this._onLogoButRelease);_oButExit.unload();_oButExit=null;s_oStage.removeChild(_oContainer)};this._onLogoButRelease=function(){window.open("http://www.codethislab.com/index.php?&l=en","_blank")};this._init()}function CSelectTeamMenu(){var _aFlagButs;var _pStartPosExit;var _pStartPosAudio;var _pStartPosFullscreen;var _oButExit;var _oAudioToggle;var _oButFullscreen;var _fRequestFullScreen=null;var _fCancelFullScreen=null;var _oContainerFlag;var _oContainer;var _oThis=this;this._init=function(){_oContainer=new createjs.Container;s_oStage.addChild(_oContainer);var oBg=createBitmap(s_oSpriteLibrary.getSprite("bg_levelselect"));_oContainer.addChild(oBg);var oSpriteMsgBox=s_oSpriteLibrary.getSprite("msg_box");var oMsgBox=createBitmap(oSpriteMsgBox);oMsgBox.x=CANVAS_WIDTH_HALF;oMsgBox.y=CANVAS_HEIGHT_HALF+30;oMsgBox.regX=oSpriteMsgBox.width*.5;oMsgBox.regY=oSpriteMsgBox.height*.5;_oContainer.addChild(oMsgBox);var iWidth=700;var iHeight=60;var oTextTitle=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,-iHeight/2+70,iWidth,iHeight,50,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_SELECT_TEAM,true,true,true,false);oTextTitle.setShadow("#000000",2,2,4);_oContainerFlag=new createjs.Container;_oContainerFlag.x=CANVAS_WIDTH_HALF+50;_oContainerFlag.y=CANVAS_HEIGHT_HALF+33;_oContainer.addChild(_oContainerFlag);_aFlagButs=new Array;var iX=0;var iY=30;for(var i=0;i<NUM_TEAMS;i++){var oFlag=new CButTeam(iX,iY,i,_oContainerFlag);oFlag.addEventListener(ON_MOUSE_UP,this._onSelectFlag,this);_aFlagButs[i]=oFlag;if(i>0&&(i+1)%8===0){iX=0;iY+=120}else{iX+=106}}_oContainerFlag.regX=_oContainerFlag.getBounds().width/2;_oContainerFlag.regY=_oContainerFlag.getBounds().height/2;var oSprite=s_oSpriteLibrary.getSprite("but_exit");_pStartPosExit={x:CANVAS_WIDTH-oSprite.height/2-10,y:oSprite.height/2+10};_oButExit=new CGfxButton(_pStartPosExit.x,_pStartPosExit.y,oSprite,s_oStage);_oButExit.addEventListener(ON_MOUSE_UP,this._onExit,this);if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_pStartPosAudio={x:_oButExit.getX()-oSprite.width-10,y:oSprite.height/2+10};_oAudioToggle=new CToggle(_pStartPosAudio.x,_pStartPosAudio.y,s_oSpriteLibrary.getSprite("audio_icon"),s_bAudioActive);_oAudioToggle.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this)}var doc=window.document;var docEl=doc.documentElement;_fRequestFullScreen=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;_fCancelFullScreen=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;if(ENABLE_FULLSCREEN===false){_fRequestFullScreen=false}if(_fRequestFullScreen&&screenfull.enabled){oSprite=s_oSpriteLibrary.getSprite("but_fullscreen");_pStartPosFullscreen={x:oSprite.width/4+10,y:_pStartPosExit.y};_oButFullscreen=new CToggle(_pStartPosFullscreen.x,_pStartPosFullscreen.y,oSprite,s_bFullscreen,s_oStage);_oButFullscreen.addEventListener(ON_MOUSE_UP,this._onFullscreenRelease,this)}this.refreshButtonPos()};this.unload=function(){for(var i=0;i<_aFlagButs.length;i++){_aFlagButs[i].unload()}if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.unload();_oAudioToggle=null}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.unload()}_oButExit.unload();_oButExit=null;s_oStage.removeAllChildren();s_oSelectMenu=null};this.refreshButtonPos=function(){_oButExit.setPosition(_pStartPosExit.x-s_iOffsetX,_pStartPosExit.y+s_iOffsetY);if(DISABLE_SOUND_MOBILE===false||s_bMobile===false){_oAudioToggle.setPosition(_pStartPosAudio.x-s_iOffsetX,s_iOffsetY+_pStartPosAudio.y)}if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setPosition(_pStartPosFullscreen.x+s_iOffsetX,_pStartPosFullscreen.y+s_iOffsetY)}};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=!s_bAudioActive};this._onExit=function(){this.unload();s_oMain.gotoMenu()};this.resetFullscreenBut=function(){if(_fRequestFullScreen&&screenfull.enabled){_oButFullscreen.setActive(s_bFullscreen)}};this._onFullscreenRelease=function(){if(s_bFullscreen){_fCancelFullScreen.call(window.document)}else{_fRequestFullScreen.call(window.document.documentElement)}sizeHandler()};this._onSelectFlag=function(iTeam){s_oMain.saveTeam(iTeam);_oThis.unload();s_oMain.gotoLevelPanel()};s_oSelectMenu=this;this._init()}var s_oSelectMenu=null;function CButTeam(iXPos,iYPos,iIndex,oParentContainer){var _iIndex;var _aCbCompleted;var _aCbOwner;var _oButton;var _oText;var _oContainer;var _aParams;var _fScaleX;var _fScaleY;var _oParent;var _aListener;var _bBlock=false;var _oParentContainer=oParentContainer;this._init=function(iXPos,iYPos,iIndex){_iIndex=iIndex;_aCbCompleted=new Array;_aCbOwner=new Array;_aParams=new Array;_fScaleX=1;_fScaleY=1;_oContainer=new createjs.Container;_oContainer.x=iXPos;_oContainer.y=iYPos;_oParentContainer.addChild(_oContainer);var oSprite=s_oSpriteLibrary.getSprite("flag_"+iIndex);_oContainer.regX=oSprite.width/2;_oContainer.regY=oSprite.height/2;_oContainer.scaleX=_fScaleX;_oContainer.scaleY=_fScaleY;_oContainer.cursor="pointer";_oButton=createBitmap(oSprite);_oContainer.addChild(_oButton);var iWidth=100;var iHeight=22;_oText=new CTLText(_oContainer,oSprite.width/2-iWidth/2,oSprite.height/2-iHeight/2+44,iWidth,iHeight,20,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_TEAM[_iIndex],true,true,true,false);this._initListener()};this.unload=function(){_oContainer.off("mousedown",_aListener[0]);_oContainer.off("pressup",_aListener[1]);if(s_bMobile===false){_oContainer.off("mouseover",_aListener[2]);_oContainer.off("mouseout",_aListener[3])}_oParentContainer.removeChild(_oContainer)};this.setVisible=function(bVisible){_oContainer.visible=bVisible};this._initListener=function(){_aListener=new Array;_aListener[0]=_oContainer.on("mousedown",this.buttonDown);_aListener[1]=_oContainer.on("pressup",this.buttonRelease);if(s_bMobile===false){_aListener[2]=_oContainer.on("mouseover",this.buttonOver);_aListener[3]=_oContainer.on("mouseout",this.buttonOut)}};this.addEventListener=function(iEvent,cbCompleted,cbOwner){_aCbCompleted[iEvent]=cbCompleted;_aCbOwner[iEvent]=cbOwner};this.buttonRelease=function(){if(_bBlock){return}playSound("click",1,false);if(_aCbCompleted[ON_MOUSE_UP]){_aCbCompleted[ON_MOUSE_UP].call(_aCbOwner[ON_MOUSE_UP],_iIndex)}};this.buttonDown=function(){if(_bBlock){return}if(_aCbCompleted[ON_MOUSE_DOWN]){_aCbCompleted[ON_MOUSE_DOWN].call(_aCbOwner[ON_MOUSE_DOWN],_aParams[ON_MOUSE_DOWN])}};this.buttonOver=function(){createjs.Tween.get(_oContainer).to({scaleX:1.1,scaleY:1.1},300,createjs.Ease.quartOut)};this.buttonOut=function(){createjs.Tween.get(_oContainer).to({scaleX:_fScaleX,scaleY:_fScaleY},300,createjs.Ease.quartOut)};this.block=function(bVal){_bBlock=bVal;_oContainer.scaleX=_fScaleX;_oContainer.scaleY=_fScaleY};this._init(iXPos,iYPos,iIndex);_oParent=this}var TEAM_LABEL=new Array;TEAM_LABEL[0]=0;TEAM_LABEL[1]=1;TEAM_LABEL[2]=2;TEAM_LABEL[3]=3;TEAM_LABEL[4]=4;TEAM_LABEL[5]=5;TEAM_LABEL[6]=6;TEAM_LABEL[7]=7;TEAM_LABEL[8]=8;TEAM_LABEL[9]=9;TEAM_LABEL[10]=10;TEAM_LABEL[11]=11;TEAM_LABEL[12]=12;TEAM_LABEL[13]=13;TEAM_LABEL[14]=14;TEAM_LABEL[15]=15;TEAM_LABEL[16]=16;TEAM_LABEL[17]=17;TEAM_LABEL[18]=18;TEAM_LABEL[19]=19;TEAM_LABEL[20]=20;TEAM_LABEL[21]=21;TEAM_LABEL[22]=22;TEAM_LABEL[23]=23;TEAM_LABEL[24]=24;TEAM_LABEL[25]=25;TEAM_LABEL[26]=26;TEAM_LABEL[27]=27;TEAM_LABEL[28]=28;TEAM_LABEL[29]=29;TEAM_LABEL[30]=30;TEAM_LABEL[31]=31;var TEAM_INFO=new Array;TEAM_INFO[0]={goalkeeper:0,player:0,opponent:0};TEAM_INFO[1]={goalkeeper:0,player:1,opponent:1};TEAM_INFO[2]={goalkeeper:0,player:2,opponent:2};TEAM_INFO[3]={goalkeeper:0,player:3,opponent:3};TEAM_INFO[4]={goalkeeper:0,player:4,opponent:4};TEAM_INFO[5]={goalkeeper:0,player:5,opponent:5};TEAM_INFO[6]={goalkeeper:0,player:4,opponent:6};TEAM_INFO[7]={goalkeeper:0,player:6,opponent:7};TEAM_INFO[8]={goalkeeper:0,player:7,opponent:8};TEAM_INFO[9]={goalkeeper:0,player:8,opponent:9};TEAM_INFO[10]={goalkeeper:0,player:9,opponent:10};TEAM_INFO[11]={goalkeeper:1,player:10,opponent:11};TEAM_INFO[12]={goalkeeper:1,player:3,opponent:12};TEAM_INFO[13]={goalkeeper:0,player:11,opponent:13};TEAM_INFO[14]={goalkeeper:0,player:12,opponent:14};TEAM_INFO[15]={goalkeeper:0,player:13,opponent:15};TEAM_INFO[16]={goalkeeper:0,player:1,opponent:16};TEAM_INFO[17]={goalkeeper:0,player:14,opponent:17};TEAM_INFO[18]={goalkeeper:0,player:15,opponent:18};TEAM_INFO[19]={goalkeeper:0,player:7,opponent:19};TEAM_INFO[20]={goalkeeper:0,player:7,opponent:20};TEAM_INFO[21]={goalkeeper:1,player:9,opponent:21};TEAM_INFO[22]={goalkeeper:1,player:17,opponent:22};TEAM_INFO[23]={goalkeeper:1,player:16,opponent:23};TEAM_INFO[24]={goalkeeper:0,player:18,opponent:24};TEAM_INFO[25]={goalkeeper:0,player:19,opponent:25};TEAM_INFO[26]={goalkeeper:0,player:4,opponent:26};TEAM_INFO[27]={goalkeeper:0,player:14,opponent:27};TEAM_INFO[28]={goalkeeper:0,player:21,opponent:28};TEAM_INFO[29]={goalkeeper:0,player:4,opponent:29};TEAM_INFO[30]={goalkeeper:0,player:20,opponent:30};TEAM_INFO[31]={goalkeeper:0,player:19,opponent:31};var NUM_TEAMS=TEAM_INFO.length;var EASY_TEAM=[2,6,7,12,14,16,22,23,24,25,31];var MEDIUM_TEAM=[0,1,4,5,11,13,15,19,21,26,27,28,29,30];var HARD_TEAM=[3,8,9,10,17,18,20];function CKickIcon(iX,iY,oSpriteSheet,oParentContainer){var _oSprite;var _oParentContainer=oParentContainer;this._init=function(iX,iY,oSpriteSheet){var iWidth=oSpriteSheet.getFrameBounds(0).width/3;var iHeight=oSpriteSheet.getFrameBounds(0).height;_oSprite=createSprite(oSpriteSheet,"empty",iWidth/2,iHeight/2,iWidth,iHeight);_oSprite.x=iX;_oSprite.y=iY;_oParentContainer.addChild(_oSprite)};this.changeState=function(szState){_oSprite.gotoAndStop(szState)};this._init(iX,iY,oSpriteSheet)}function CVersusPanel(oParentContainer){var _oListener;var _oFade;var _oFlagPlayer;var _oFlagOpponent;var _oVsText;var _oMatchText;var _oContainer;var _oParentContainer=oParentContainer;var _oThis=this;this._init=function(){_oContainer=new createjs.Container;_oContainer.visible=false;_oParentContainer.addChild(_oContainer);_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oFade.alpha=.5;_oListener=_oFade.on("click",function(){});_oContainer.addChild(_oFade);var oSpriteBg=s_oSpriteLibrary.getSprite("msg_box_small");var oBg=createBitmap(oSpriteBg);oBg.x=CANVAS_WIDTH_HALF;oBg.y=CANVAS_HEIGHT_HALF;oBg.regX=oSpriteBg.width/2;oBg.regY=oSpriteBg.height/2;_oContainer.addChild(oBg);var oSprite=s_oSpriteLibrary.getSprite("flag_"+s_iTeamSelected);_oFlagPlayer=createBitmap(oSprite);_oFlagPlayer.y=CANVAS_HEIGHT_HALF-6;_oContainer.addChild(_oFlagPlayer);oSprite=s_oSpriteLibrary.getSprite("flag_0");_oFlagOpponent=createBitmap(oSprite);_oFlagOpponent.y=CANVAS_HEIGHT_HALF-6;_oContainer.addChild(_oFlagOpponent);_oVsText=new createjs.Text(TEXT_VS,"82px "+PRIMARY_FONT,"#fff");_oVsText.x=CANVAS_WIDTH_HALF;_oVsText.y=CANVAS_HEIGHT_HALF+44;_oVsText.textAlign="center";_oVsText.textBaseline="middle";_oContainer.addChild(_oVsText);var iWidth=400;var iHeight=70;_oMatchText=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,-iHeight/2+230,iWidth,iHeight,82,"center","#fff",PRIMARY_FONT,1,2,2,TEXT_MATCH,true,true,true,false)};this.unload=function(){_oFade.off("click",_oListener)};this.show=function(iOpponent,iLevel){_oMatchText.refreshText(TEXT_MATCH+" "+iLevel);_oFlagOpponent.image=s_oSpriteLibrary.getSprite("flag_"+iOpponent);_oFlagPlayer.x=-200;_oFlagOpponent.x=CANVAS_WIDTH+200;_oVsText.scaleX=_oVsText.scaleY=3;_oVsText.alpha=0;_oContainer.alpha=0;_oContainer.visible=true;createjs.Tween.get(_oContainer).to({alpha:1},500,createjs.Ease.cubicOut).call(function(){_oThis.playAnims()})};this.hide=function(){createjs.Tween.get(_oContainer).to({alpha:0},500,createjs.Ease.quartOut).call(function(){_oContainer.visible=false})};this.playAnims=function(){var iTime=300;createjs.Tween.get(_oFlagPlayer).to({x:CANVAS_WIDTH_HALF-176},iTime,createjs.Ease.cubicOut);createjs.Tween.get(_oFlagOpponent).to({x:CANVAS_WIDTH_HALF+80},iTime,createjs.Ease.cubicOut);createjs.Tween.get(_oVsText).wait(iTime).to({scaleX:1,scaleY:1,alpha:1},200,createjs.Ease.cubicOut).call(function(){setTimeout(function(){_oThis.hide()},2500)})};this._init()}function CMsgBox(szText,oParentContainer){var _oMsgBack;var _oMsg;var _oButOk;var _oThis;var _oContainer;var _oParentContainer;this._init=function(szText){_oContainer=new createjs.Container;_oParentContainer.addChild(_oContainer);var oFade;oFade=new createjs.Shape;oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);oFade.alpha=.5;oFade.on("click",function(){});_oContainer.addChild(oFade);var oSpriteBg=s_oSpriteLibrary.getSprite("msg_box_small");var oBg=createBitmap(oSpriteBg);oBg.x=CANVAS_WIDTH*.5;oBg.y=CANVAS_HEIGHT*.5;oBg.regX=oSpriteBg.width*.5;oBg.regY=oSpriteBg.height*.5;_oContainer.addChild(oBg);var iWidth=500;var iHeight=180;_oMsg=new CTLText(_oContainer,CANVAS_WIDTH/2-iWidth/2,CANVAS_HEIGHT/2-iHeight/2-60,iWidth,iHeight,22,"center","#fff",PRIMARY_FONT,1,2,2,szText,true,true,true,false);_oMsg.setShadow("#000000",2,2,4);_oButOk=new CGfxButton(CANVAS_WIDTH/2,410,s_oSpriteLibrary.getSprite("but_yes"),_oContainer);_oButOk.addEventListener(ON_MOUSE_UP,this._onButOk,this)};this._onButOk=function(){_oThis.unload()};this.unload=function(){_oButOk.unload();_oParentContainer.removeChild(_oContainer)};_oThis=this;_oParentContainer=oParentContainer;this._init(szText)}function CBallStriker(iXPos,iYPos,oSprite,oPhysics,oParentContainer){var _oBall;var _oParentContainer;var _oPhysics;var _oShadow;var _oContainer;var _fStartShadowPos=null;var _fScale=FOV*BALL_RADIUS;var _fScaleShadow=_fScale;var _iBufferTime=0;var _iFrame=0;var _oTween=null;this._init=function(iXPos,iYPos,oSprite){_oContainer=new createjs.Container;_oParentContainer.addChild(_oContainer);var oData={images:[oSprite],frames:{width:oSprite.width/7,height:oSprite.height,regX:oSprite.width/2/7,regY:oSprite.height/2}};var oSpriteSheet=new createjs.SpriteSheet(oData);_oBall=createSprite(oSpriteSheet,0,oSprite.width/2/7,oSprite.height/2,oSprite.width/7,oSprite.height/2);_oBall.stop();this.scale(_fScale);var oSpriteShadow=s_oSpriteLibrary.getSprite("ball_shadow");_oShadow=createBitmap(oSpriteShadow);_oShadow.x=iXPos;_oShadow.y=iYPos;_oShadow.regX=oSpriteShadow.width*.5;_oShadow.regY=oSpriteShadow.height*.5;this.scaleShadow(_fScaleShadow);_oContainer.addChild(_oShadow,_oBall)};this.rolls=function(){var iForceX=_oPhysics.velocity.x*.15;var fAngle=Math.sin(-iForceX);_oBall.rotation=Math.degrees(fAngle);var iForceY=Math.abs(_oPhysics.angularVelocity.x);var oFuncRot=this._goToPrevFrame;if(_oPhysics.angularVelocity.x<0){oFuncRot=this._goToNextFrame}if(iForceY>7){oFuncRot()}else if(iForceY>3){_iBufferTime++;if(_iBufferTime>2/ROLL_BALL_RATE){oFuncRot();_iBufferTime=0}}else if(iForceY>1){_iBufferTime++;if(_iBufferTime>3/ROLL_BALL_RATE){oFuncRot();_iBufferTime=0}}else if(iForceY>MIN_BALL_VEL_ROTATION){_iBufferTime++;if(_iBufferTime>4/ROLL_BALL_RATE){oFuncRot();_iBufferTime=0}}};this._goToPrevFrame=function(){if(_iFrame===0){_iFrame=6;_oBall.gotoAndStop(_iFrame)}else{_iFrame--;_oBall.gotoAndStop(_iFrame)}};this._goToNextFrame=function(){if(_iFrame===7){_iFrame=1;_oBall.gotoAndStop(_iFrame)}else{_iFrame++;_oBall.gotoAndStop(_iFrame)}};this.unload=function(){_oBall.removeAllEventListeners();_oParentContainer.removeChild(_oBall)};this.setVisible=function(bVisible){_oContainer.visible=bVisible};this.getStartScale=function(){return _fScaleShadow};this.startPosShadowY=function(fYPos){_fStartShadowPos=fYPos};this.getStartShadowYPos=function(){return _fStartShadowPos};this.fadeAnimation=function(fVal,iTime,iWait){this.tweenFade(fVal,iTime,iWait)};this.tweenFade=function(fVal,iTime,iWait){_oTween=createjs.Tween.get(_oContainer,{override:true}).wait(iWait).to({alpha:fVal},iTime).call(function(){_oTween=null})};this.setPositionShadow=function(iX,iY){_oShadow.x=iX;_oShadow.y=iY};this.setPosition=function(iXPos,iYPos){_oBall.x=iXPos;_oBall.y=iYPos};this.getPhysics=function(){return _oPhysics};this.setAngle=function(iAngle){_oBall.rotation=iAngle};this.getX=function(){return _oBall.x};this.getY=function(){return _oBall.y};this.getStartScale=function(){return _fScale};this.scale=function(fValue){_oBall.scaleX=fValue;_oBall.scaleY=fValue};this.scaleShadow=function(fScale){if(fScale>.08){_oShadow.scaleX=fScale;_oShadow.scaleY=fScale}else{_oShadow.scaleX=.08;_oShadow.scaleY=.08}};this.setAlphaByHeight=function(fHeight){_oShadow.alpha=fHeight};this.getScale=function(){return _oBall.scaleX};this.getObject=function(){return _oContainer};this.getDepthPos=function(){return _oPhysics.position.y};_oPhysics=oPhysics;_oParentContainer=oParentContainer;this._init(iXPos,iYPos,oSprite);return this}function CGameStriker(oParentContainer,iCurLevel){var _oBg;var _oScene;var _oBall;var _oStartBall;var _oGoalKeeper=null;var _oContainerGame;var _oClickPoint;var _oReleasePoint;var _oHitArea;var _oPlayer;var _oFieldCollision=null;var _oHandSwipeAnim;var _oGoal;var _bGoal=false;var _bLaunched=false;var _bBallOut=false;var _bFieldCollide=false;var _bAnimPlayer=false;var _bAnimGoalKeeper=false;var _bSaved=false;var _bMakeGoal=false;var _bPoleCollide=false;var _iLevel=iCurLevel;var _iArea;var _iTimePressDown=0;var _fTimeReset;var _fTimePoleReset;var _fTimeSwipe;var _fMultiplier;var _aObjects;var _vHitDir;var _iGameState=STATE_INIT;var _oFade;var _oCamera=null;var _oParentContainer=oParentContainer;this._init=function(){this.pause(true);_fMultiplier=1;_aObjects=new Array;_oContainerGame=new createjs.Container;_oParentContainer.addChild(_oContainerGame);_oBg=createBitmap(s_oSpriteLibrary.getSprite("bg_game_striker"));_oBg.cache(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oContainerGame.addChild(_oBg);_oScene=new CScenarioStriker(_iLevel);if(SHOW_3D_RENDER){_oCamera=camera}else{_oCamera=createOrthoGraphicCamera()}var oSprite=s_oSpriteLibrary.getSprite("goal_0");_oGoal=new CGoalStriker(251,28,oSprite,_oContainerGame);_oGoalKeeper=new CGoalKeeper(CANVAS_WIDTH_HALF-100,CANVAS_HEIGHT_HALF-225,TEAM_INFO[s_aMatches[_iLevel-1]].goalkeeper,_oContainerGame);_aObjects.push(_oGoalKeeper);var oSpriteBall=s_oSpriteLibrary.getSprite("ball");_oBall=new CBallStriker(0,0,oSpriteBall,_oScene.ballBody(),_oContainerGame);_aObjects.push(_oBall);this.ballPosition();_oBall.setVisible(false);_fTimeSwipe=MS_TIME_SWIPE_START;_oStartBall=new CStartBall(CANVAS_WIDTH_HALF+55,CANVAS_HEIGHT_HALF+168,_oContainerGame);_oPlayer=new CPlayer(CANVAS_WIDTH_HALF-150,CANVAS_HEIGHT_HALF-320,_oContainerGame);_oPlayer.setVisible(false);var szImage="cursor";if(s_bMobile){szImage="hand_touch"}_oHandSwipeAnim=new CHandSwipeAnim(START_HAND_SWIPE_POS,END_HAND_SWIPE_POS,s_oSpriteLibrary.getSprite(szImage),_oParentContainer);_oHandSwipeAnim.animAllSwipe();_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oFade.alpha=1;_oParentContainer.addChild(_oFade);resizeCanvas3D();_vHitDir=new CANNON.Vec3(0,0,0);this.onExitHelp();createjs.Tween.get(_oFade).to({alpha:0},300,createjs.cubicOut);s_oInterface.showHelpText(TEXT_HELP)};this.createControl=function(){if(!SHOW_3D_RENDER){_oHitArea=new createjs.Shape;_oHitArea.graphics.beginFill("rgba(255,0,0,0.01)").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oContainerGame.addChild(_oHitArea);_oHitArea.on("mousedown",this.onMouseDown);_oHitArea.on("pressmove",this.onPressMove);_oHitArea.on("pressup",this.onPressUp)}else{window.addEventListener("mousedown",this.onMouseDown);window.addEventListener("mousemove",this.onPressMove);window.addEventListener("mouseup",this.onPressUp)}};this.sortDepth=function(oObj1,oObj2){if(oObj1.getDepthPos()>oObj2.getDepthPos()){if(_oContainerGame.getChildIndex(oObj1.getObject())>_oContainerGame.getChildIndex(oObj2.getObject())){_oContainerGame.swapChildren(oObj1.getObject(),oObj2.getObject())}}else if(oObj1.getDepthPos()<oObj2.getDepthPos()){if(_oContainerGame.getChildIndex(oObj2.getObject())>_oContainerGame.getChildIndex(oObj1.getObject())){_oContainerGame.swapChildren(oObj2.getObject(),oObj1.getObject())}}};this.onExitHelp=function(){this.createControl();this.pause(false)};this.poleCollide=function(){_fTimePoleReset=TIME_POLE_COLLISION_RESET;_bPoleCollide=true;playSound("pole",.4,false)};this.fieldCollision=function(){if(_oFieldCollision===null&&_bLaunched){_oFieldCollision=playSound("drop_bounce_grass",.3,false);_oFieldCollision.on("end",function(){_oFieldCollision=null})}};this.ballPosition=function(){var oBallBody=_oScene.ballBody();var oPos2DBall=this.convert3dPosTo2dScreen(oBallBody.position,_oCamera);var fScaleDistance=oPos2DBall.z*(BALL_SCALE_FACTOR-_oBall.getStartScale())+_oBall.getStartScale();_oBall.setPosition(oPos2DBall.x,oPos2DBall.y);_oBall.scale(fScaleDistance);this.refreshShadowCast(_oBall,oBallBody,fScaleDistance)};this.onMouseDown=function(e){if(_bLaunched){return}_fTimeSwipe=MS_TIME_SWIPE_START;_oHandSwipeAnim.removeTweens();_oHandSwipeAnim.setVisible(false);_oClickPoint={x:s_oStage.mouseX,y:s_oStage.mouseY};_oReleasePoint={x:s_oStage.mouseX,y:s_oStage.mouseY}};this.onPressMove=function(){_oReleasePoint={x:s_oStage.mouseX,y:s_oStage.mouseY};_iTimePressDown+=s_iTimeElaps};this.onPressUp=function(){if(_bLaunched){return}else if(_oClickPoint.y<_oReleasePoint.y||_oReleasePoint.x===0&&_oReleasePoint.y===0){return}var fDistance=Math.ceil(distanceV2(_oClickPoint,_oReleasePoint))*FORCE_RATE;if(fDistance>FORCE_MAX){fDistance=FORCE_MAX}if(_iTimePressDown>1e3){_iTimePressDown=1e3}var vHitDir2D=new CVector2(_oClickPoint.x-_oReleasePoint.x,_oClickPoint.y-_oReleasePoint.y);vHitDir2D.scalarProduct(fDistance);var fForceLength=vHitDir2D.length();if(fForceLength>HIT_BALL_MIN_FORCE){if(fForceLength>HIT_BALL_MAX_FORCE){vHitDir2D.normalize();vHitDir2D.scalarProduct(HIT_BALL_MAX_FORCE)}_bAnimPlayer=true;_oPlayer.setVisible(true);var fForceY=_iTimePressDown/10;if(fForceY>MAX_FORCE_Y){fForceY=MAX_FORCE_Y}else if(fForceY<MIN_FORCE_Y){fForceY=MIN_FORCE_Y}_vHitDir.set(-vHitDir2D.getX()*FORCE_MULTIPLIER_AXIS.x,fForceY,vHitDir2D.getY()*FORCE_MULTIPLIER_AXIS.z);_bMakeGoal=s_oGameStriker.goalProbability()}_oReleasePoint.x=0;_oReleasePoint.y=0};this.refreshShadowCast=function(oObject,oBody,fScaleDistance){var oFieldBody=_oScene.getFieldBody();if(oBody.position.z<oFieldBody.position.z){oObject.scaleShadow(0);return}var oPosShadow={x:oBody.position.x,y:oBody.position.y,z:oFieldBody.position.z};var oPos2dShadow=this.convert3dPosTo2dScreen(oPosShadow,_oCamera);var fDistance=(oBody.position.z-BALL_RADIUS)*(oFieldBody.position.z-SHADOWN_FACTOR-oFieldBody.position.z)+oFieldBody.position.z;var fScaleHeight=fDistance*fScaleDistance;oObject.scaleShadow(fScaleHeight);if(fScaleHeight<0){return}oObject.setAlphaByHeight(fDistance);oObject.setPositionShadow(oPos2dShadow.x,oPos2dShadow.y)};this.getLevel=function(){return _iLevel};this.unload=function(){_oParentContainer.removeAllChildren();if(!SHOW_3D_RENDER){_oHitArea.removeAllEventListeners()}_oScene.destroyWorld();_oScene=null};this.resetValues=function(){_fMultiplier=1};this.wallSoundCollision=function(){};this.areaGoal=function(){if(!_bGoal&&!_bSaved){if(_bMakeGoal){_bGoal=true;_fTimeReset=TIME_RESET_AFTER_GOAL;playSound("goal_striker",1,false)}else{this.goalKeeperSave()}}};this.goalKeeperSave=function(){_bSaved=true;_fTimeReset=TIME_RESET_AFTER_SAVE;playSound("ball_saved",1,false);this.rejectBall();_fMultiplier=1};this.rejectBall=function(){_oBall.getPhysics().velocity.negate(_oBall.getPhysics().velocity);switch(_iArea){case 12:_oBall.getPhysics().velocity=_oBall.getPhysics().velocity.vadd(new CANNON.Vec3(_oBall.getPhysics().velocity.x*.4,_oBall.getPhysics().velocity.y*.4,_oBall.getPhysics().velocity.z*.4));break;default:_oBall.getPhysics().velocity.vsub(new CANNON.Vec3(0,50,0))}};this.goalProbability=function(){_iArea=-1;for(var i=0;i<CALCULATE_PROBABILITY.length;i++){if(_vHitDir.z<CALCULATE_PROBABILITY[i].zMax&&_vHitDir.z>CALCULATE_PROBABILITY[i].zMin){if(_vHitDir.x<CALCULATE_PROBABILITY[i].xMax&&_vHitDir.x>CALCULATE_PROBABILITY[i].xMin){_iArea=i}}}if(_iArea===-1){return false}var aProb=new Array;for(var i=0;i<MAX_PERCENT_PROBABILITY;i++){aProb.push(false)}for(var i=0;i<AREAS_INFO[_iArea].probability;i++){aProb[i]=true}var iRandResult=Math.floor(Math.random()*aProb.length);return aProb[iRandResult]};this.addImpulseToBall=function(oDir){if(_bLaunched||_iGameState!==STATE_PLAY){return}var oBall=_oScene.ballBody();_oScene.addImpulse(oBall,oDir);_oScene.setElementAngularVelocity(oBall,{x:0,y:0,z:0});_bLaunched=true;_oBall.setVisible(true);_oStartBall.setVisible(false);setTimeout(function(){s_oGameStriker.chooseDirectionGoalKeeper(oDir)},100);playSound("kick",1,false)};this.chooseDirectionGoalKeeper=function(oDirBall){if(!_bMakeGoal){switch(_iArea){case-1:if(oDirBall.x<GOAL_KEEPER_TOLLERANCE_LEFT){_oGoalKeeper.runAnim(LEFT)}else if(oDirBall.y>GOAL_KEEPER_TOLLERANCE_RIGHT){_oGoalKeeper.runAnim(RIGHT)}break;default:_oGoalKeeper.runAnim(AREA_GOALS_ANIM[_iArea])}}else{var iNoAnim=_oGoalKeeper.getAnimType();switch(_iArea){case 2:case 7:case 12:this.chooseWrongDirGK(ANIM_GOAL_KEEPER_FAIL_ALT);break;default:this.chooseWrongDirGK(ANIM_GOAL_KEEPER_FAIL,iNoAnim);break}}_bAnimGoalKeeper=true};this.chooseWrongDirGK=function(aWrongAnim){var iRandAnim=Math.floor(Math.random()*aWrongAnim.length);while(iRandAnim===AREA_GOALS_ANIM[_iArea]){iRandAnim=Math.floor(Math.random()*aWrongAnim.length)}_oGoalKeeper.runAnim(aWrongAnim[iRandAnim])};this.pause=function(bVal){if(bVal){_iGameState=STATE_PAUSE}else{_iGameState=STATE_PLAY}createjs.Ticker.paused=bVal};this.onExit=function(){this.unload();setVolume("soundtrack",1);s_oMain.gotoMenu()};this.restartLevel=function(){this.resetValues();this.resetScene();_iGameState=STATE_PLAY;this.startOpponentShot()};this.resetBallPosition=function(){var oBallBody=_oScene.ballBody();oBallBody.position.set(POSITION_BALL.x,POSITION_BALL.y,POSITION_BALL.z);_oScene.setElementVelocity(oBallBody,{x:0,y:0,z:0});_oScene.setElementAngularVelocity(oBallBody,{x:0,y:0,z:0});_oBall.fadeAnimation(1,500,0);_oBall.setVisible(false);_oStartBall.setVisible(true);_oStartBall.setAlpha(0);_oStartBall.fadeAnim(1,500,0)};this.ballFadeForReset=function(){if(!_bSaved||!_bGoal||!_bBallOut){return}if(!_bFieldCollide){_oBall.fadeAnimation(0,300,10);_bFieldCollide=true}};this._updateInit=function(){_oScene.update();this._updateBall2DPosition();_iGameState=STATE_PLAY};this.convert2dScreenPosTo3d=function(oPos2d){var iWidth=s_iCanvasResizeWidth;var iHeight=s_iCanvasResizeHeight;var mouse3D=new THREE.Vector3(oPos2d.x/iWidth*2-1,-(oPos2d.y/iHeight)*2+1,-1);mouse3D.unproject(_oCamera);mouse3D.sub(_oCamera.position);mouse3D.normalize();var fFactor=0;mouse3D.multiply(new THREE.Vector3(fFactor,1,fFactor));return mouse3D};this.convert3dPosTo2dScreen=function(pos,oCamera){var v3=new THREE.Vector3(pos.x,pos.y,pos.z);var vector=v3.project(oCamera);var widthHalf=Math.floor(s_iCanvasResizeWidth)*.5;var heightHalf=Math.floor(s_iCanvasResizeHeight)*.5;vector.x=(vector.x*widthHalf+widthHalf)*s_fInverseScaling;vector.y=(-(vector.y*heightHalf)+heightHalf)*s_fInverseScaling;return vector};this.timeReset=function(){if(_fTimeReset>0){_fTimeReset-=s_iTimeElaps}else{this.endTurn()}};this.restartGame=function(){this.resetValues();this.resetScene();_iGameState=STATE_PLAY;_bLaunched=false};this.endTurn=function(){s_oGame.endShotPlayer(_bGoal,_bSaved);this.resetScene()};this.goalAnimation=function(fForce){if(fForce>FORCE_BALL_DISPLAY_SHOCK[0].min&&fForce<FORCE_BALL_DISPLAY_SHOCK[0].max){this.displayShock(INTENSITY_DISPLAY_SHOCK[0].time,INTENSITY_DISPLAY_SHOCK[0].x,INTENSITY_DISPLAY_SHOCK[0].y)}else if(fForce>FORCE_BALL_DISPLAY_SHOCK[1].min&&fForce<FORCE_BALL_DISPLAY_SHOCK[1].max){this.displayShock(INTENSITY_DISPLAY_SHOCK[1].time,INTENSITY_DISPLAY_SHOCK[1].x,INTENSITY_DISPLAY_SHOCK[1].y)}else if(fForce>FORCE_BALL_DISPLAY_SHOCK[2].min&&fForce<FORCE_BALL_DISPLAY_SHOCK[2].max){this.displayShock(INTENSITY_DISPLAY_SHOCK[2].time,INTENSITY_DISPLAY_SHOCK[2].x,INTENSITY_DISPLAY_SHOCK[2].y)}else if(fForce>FORCE_BALL_DISPLAY_SHOCK[3].min){this.displayShock(INTENSITY_DISPLAY_SHOCK[3].time,INTENSITY_DISPLAY_SHOCK[3].x,INTENSITY_DISPLAY_SHOCK[3].y)}};this.displayShock=function(iTime,iXIntensity,iYIntensity){var xShifting=iXIntensity;var yShifting=iYIntensity;createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting),y:Math.round(Math.random()*yShifting)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.8),y:-Math.round(Math.random()*yShifting*.8)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.6),y:Math.round(Math.random()*yShifting*.6)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.4),y:-Math.round(Math.random()*yShifting*.4)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.2),y:Math.round(Math.random()*yShifting*.2)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({y:0,x:0},iTime).call(function(){})})})})})})};this.resetScene=function(){_bGoal=false;_bBallOut=false;_bSaved=false;_bMakeGoal=false;_bPoleCollide=false;_bFieldCollide=false;_oGoalKeeper.fadeAnimation(1);this.resetBallPosition();this.sortDepth(_oBall,_oGoal)};this._onEnd=function(){this.onExit()};this.swapChildrenIndex=function(){for(var i=0;i<_aObjects.length-1;i++){for(var j=i+1;j<_aObjects.length;j++){if(_aObjects[i].getObject().visible&&_aObjects[j].getObject().visible)this.sortDepth(_aObjects[i],_aObjects[j])}}};this.ballOut=function(){if(!_bBallOut&&!_bGoal&&!_bSaved){var oPos=_oBall.getPhysics().position;if(oPos.y>BALL_OUT_Y||oPos.x>BACK_WALL_GOAL_SIZE.width||oPos.x<-BACK_WALL_GOAL_SIZE.width){_bBallOut=true;_fTimeReset=TIME_RESET_AFTER_BALL_OUT;playSound("ball_saved",1,false);_fMultiplier=1}}};this.animPlayer=function(){if(!_bAnimPlayer){_oPlayer.setVisible(false);return}_bAnimPlayer=_oPlayer.animPlayer();if(_oPlayer.getFrame()===SHOOT_FRAME){this.addImpulseToBall({x:_vHitDir.x,y:_vHitDir.y,z:_vHitDir.z});_iTimePressDown=0;this.goalAnimation(_vHitDir.y);s_oInterface.hideHelpText()}};this.animGoalKeeper=function(){if(_bLaunched){if(_bAnimGoalKeeper){_bAnimGoalKeeper=_oGoalKeeper.update();if(!_bAnimGoalKeeper){_oGoalKeeper.viewFrame(_oGoalKeeper.getAnimArray(),_oGoalKeeper.getAnimArray().length-1);_oGoalKeeper.hideFrame(_oGoalKeeper.getAnimArray(),0)}}}else{_oGoalKeeper.update()}};this.resetPoleCollision=function(){if(_fTimePoleReset>0){_fTimePoleReset-=s_iTimeElaps}else{if(!_bGoal||!_bSaved){_fMultiplier=1;playSound("ball_saved",1,false);this.endTurn();_fTimePoleReset=TIME_POLE_COLLISION_RESET}}};this.handSwipeAnim=function(){if(_oHandSwipeAnim.isAnimate()||_bLaunched){return}if(_fTimeSwipe>0){_fTimeSwipe-=s_iTimeElaps}else{_oHandSwipeAnim.animAllSwipe();_oHandSwipeAnim.setVisible(true);_fTimeSwipe=MS_TIME_SWIPE_START}};this.swapGoal=function(){if(_oBall.getPhysics().position.z>GOAL_SPRITE_SWAP_Z){this.sortDepth(_oBall,_oGoal)}};this._updatePlay=function(){for(var i=0;i<PHYSICS_ACCURACY;i++){_oScene.update()}this.ballOut();if(_bGoal||_bBallOut||_bSaved){this.timeReset()}else if(_bPoleCollide){this.resetPoleCollision()}this.animGoalKeeper();this.animPlayer();this._updateBall2DPosition();this.handSwipeAnim();this.swapChildrenIndex();this.swapGoal()};this.update=function(){switch(_iGameState){case STATE_INIT:this._updateInit();break;case STATE_PLAY:this._updatePlay();break;case STATE_FINISH:break;case STATE_PAUSE:break}};this._updateBall2DPosition=function(){this.ballPosition();_oBall.rolls();_oCamera.updateProjectionMatrix();_oCamera.updateMatrixWorld()};s_oGameStriker=this;this._init()}var s_oGameStriker;function CGoalKeeper(iXPos,iYPos,iType,oParentContainer){var _iType=iType;var _pStartPos;var _oContainer;var _aAnimContainer;var _oParentContainer;var _aAllAnim;var _fBuffer=0;var _iAnimKeeper=0;var _iAnimType=IDLE;this._init=function(iXPos,iYPos,oParentContainer){_oParentContainer=oParentContainer;_pStartPos={x:iXPos,y:iYPos};_oContainer=new createjs.Container;_oContainer.x=_pStartPos.x;_oContainer.y=_pStartPos.y;_oParentContainer.addChild(_oContainer);_oContainer.tickChildren=false;_aAllAnim=new Array;_aAnimContainer=new Array;var iWidthMax=0;var iHeightMax=0;for(var i=0;i<NUM_SPRITE_GOALKEEPER.length;i++){_aAnimContainer[i]=new createjs.Container;_aAnimContainer[i].x=OFFSET_CONTAINER_GOALKEEPER[i].x;_aAnimContainer[i].y=OFFSET_CONTAINER_GOALKEEPER[i].y;_aAllAnim.push(this.loadAnim(SPRITE_NAME_GOALKEEPER[i],NUM_SPRITE_GOALKEEPER[i],_aAnimContainer[i]));_oContainer.addChild(_aAnimContainer[i]);var oSprite=s_oSpriteLibrary.getSprite(SPRITE_NAME_GOALKEEPER[i]+_iType+"_0");if(oSprite.width>iWidthMax){iWidthMax=oSprite.width}if(oSprite.height>iHeightMax){iHeightMax=oSprite.height}}_oContainer.cache(-iWidthMax,-iHeightMax,iWidthMax*2,iHeightMax*2);_aAllAnim[IDLE][0].visible=true};this.getAnimType=function(){return _iAnimType};this.getAnimArray=function(){return _aAllAnim[_iAnimType]};this.loadAnim=function(szSprite,iNum,oContainer){var aAnim=new Array;for(var i=0;i<iNum;i++){aAnim.push(createBitmap(s_oSpriteLibrary.getSprite(szSprite+iType+"_"+i)));aAnim[i].visible=false;oContainer.addChild(aAnim[i])}return aAnim};this.getX=function(){return _oContainer.x};this.getY=function(){return _oContainer.y};this.disableAllAnim=function(){for(var i=0;i<_aAnimContainer.length;i++){_aAnimContainer[i].visible=false}};this.setPosition=function(iXPos,iYPos){_oContainer.x=iXPos;_oContainer.y=iYPos};this.setVisible=function(bVal){_oContainer.visible=bVal};this.fadeAnimation=function(fVal){createjs.Tween.get(_oContainer,{override:true}).to({alpha:fVal},500)};this.setAlpha=function(fVal){_oContainer.alpha=fVal};this.getObject=function(){return _oContainer};this.getFrame=function(){return _iAnimKeeper};this.viewFrame=function(aAnim,iFrame){aAnim[iFrame].visible=true};this.hideFrame=function(aAnim,iFrame){aAnim[iFrame].visible=false};this.getDepthPos=function(){return GOAL_KEEPER_DEPTH_Y};this.animGoalKeeper=function(aAnim,iEndFrame){_fBuffer+=s_iTimeElaps;if(_fBuffer>BUFFER_ANIM_PLAYER){this.hideFrame(aAnim,_iAnimKeeper);if(_iAnimKeeper+1<iEndFrame){this.viewFrame(aAnim,_iAnimKeeper+1);_iAnimKeeper++}else{_iAnimKeeper=0;_fBuffer=0;this.viewFrame(aAnim,_iAnimKeeper);return false}_fBuffer=0;_oContainer.updateCache()}return true};this.resetAnimation=function(iType){this.resetAnimFrame(_aAllAnim[iType],NUM_SPRITE_GOALKEEPER[iType])};this.resetAnimFrame=function(aAnim,iNum){for(var i=1;i<iNum;i++){aAnim[i].visible=false}aAnim[0].visible=true};this.setVisibleContainer=function(iType,bVal){_aAnimContainer[iType].visible=bVal};this.runAnim=function(iVal){this.disableAllAnim();this.resetAnimation(iVal);this.setVisibleContainer(iVal,true);_iAnimType=iVal;_iAnimKeeper=0};this.update=function(){return this.animGoalKeeper(_aAllAnim[_iAnimType],NUM_SPRITE_GOALKEEPER[_iAnimType])};this._init(iXPos,iYPos,oParentContainer);return this}function CGoalStriker(iX,iY,oSprite,oParentContainer){var _oGoal;var _oParentContainer;this._init=function(iX,iY,oSprite){_oGoal=createBitmap(oSprite);this.setPosition(iX,iY);_oGoal.cache(0,0,oSprite.width,oSprite.height);_oParentContainer.addChild(_oGoal)};this.unload=function(){_oParentContainer.removeChild(_oGoal)};this.setPosition=function(iX,iY){_oGoal.x=iX;_oGoal.y=iY};this.getDepthPos=function(){return GOAL_SPRITE_SWAP_Y};this.getObject=function(){return _oGoal};_oParentContainer=oParentContainer;this._init(iX,iY,oSprite);return this}function CHandSwipeAnim(oStartPoint,aEndPoint,oSprite,oParentContainer){var _oParentContainer=oParentContainer;var _oHandSwipe;var _oContainer;var _oStartPoint=oStartPoint;var _aEndPoint=aEndPoint;var _bAnimation=false;this._init=function(oSprite){_oContainer=new createjs.Container;_oHandSwipe=createBitmap(oSprite);_oHandSwipe.x=_oStartPoint.x;_oHandSwipe.y=_oStartPoint.y;_oHandSwipe.regX=oSprite.width*.5;_oHandSwipe.regY=oSprite.height*.5;_oHandSwipe.alpha=0;_oParentContainer.addChild(_oContainer);_oContainer.addChild(_oHandSwipe)};this.animAllSwipe=function(){_bAnimation=true;var oParent=this;createjs.Tween.get(_oHandSwipe).to({alpha:1},MS_TIME_SWIPE_END*.1).wait(MS_TIME_SWIPE_END*.3).to({alpha:0},MS_TIME_SWIPE_END*.5,createjs.Ease.quartOut);createjs.Tween.get(_oHandSwipe).to({x:_aEndPoint[0].x,y:_aEndPoint[0].y},MS_TIME_SWIPE_END,createjs.Ease.quartOut).call(function(){_oHandSwipe.x=_oStartPoint.x;_oHandSwipe.y=_oStartPoint.y;createjs.Tween.get(_oHandSwipe).to({alpha:1},MS_TIME_SWIPE_END*.1).wait(MS_TIME_SWIPE_END*.3).to({alpha:0},MS_TIME_SWIPE_END*.5,createjs.Ease.quartOut);createjs.Tween.get(_oHandSwipe).to({x:_aEndPoint[1].x,y:_aEndPoint[1].y},MS_TIME_SWIPE_END,createjs.Ease.quartOut).call(function(){_oHandSwipe.x=_oStartPoint.x;_oHandSwipe.y=_oStartPoint.y;createjs.Tween.get(_oHandSwipe).to({alpha:1},MS_TIME_SWIPE_END*.1).wait(MS_TIME_SWIPE_END*.3).to({alpha:0},MS_TIME_SWIPE_END*.5,createjs.Ease.quartOut);createjs.Tween.get(_oHandSwipe).to({x:_aEndPoint[2].x,y:_aEndPoint[2].y},MS_TIME_SWIPE_END,createjs.Ease.quartOut).call(function(){_oHandSwipe.x=_oStartPoint.x;_oHandSwipe.y=_oStartPoint.y;oParent.animAllSwipe()})})})};this.fadeAnim=function(fVal){createjs.Tween.get(_oContainer,{override:true}).to({alpha:fVal},250)};this.isAnimate=function(){return _bAnimation};this.setVisible=function(bVal){_oHandSwipe.visible=bVal};this.removeTweens=function(){createjs.Tween.removeTweens(_oHandSwipe);_bAnimation=false};this._init(oSprite);return this}function CPlayer(iX,iY,oParentContainer){var _pStartPos;var _aPlayer=new Array;var _oParentContainer=oParentContainer;var _oContainer;var _iAnimPlayer=0;var _fBuffer=0;this._init=function(iX,iY){_pStartPos={x:iX,y:iY};_oContainer=new createjs.Container;_oContainer.x=_pStartPos.x;_oContainer.y=_pStartPos.y;_oParentContainer.addChild(_oContainer);for(var i=0;i<NUM_SPRITE_PLAYER;i++){_aPlayer.push(createBitmap(s_oSpriteLibrary.getSprite("player_"+TEAM_INFO[s_iTeamSelected].player+"_"+i)));_aPlayer[i].visible=false;_oContainer.addChild(_aPlayer[i])}var oSprite=s_oSpriteLibrary.getSprite("player_"+TEAM_INFO[s_iTeamSelected].player+"_0");_oContainer.cache(0,0,oSprite.width,oSprite.height);_aPlayer[0].visible=true};this.setPosition=function(iX,iY){_oContainer.x=iX;_oContainer.y=iY};this.getX=function(){return _oContainer.x};this.getY=function(){return _oContainer.y};this.getStartPos=function(){return _pStartPos};this.setVisible=function(bVal){_oContainer.visible=bVal};this.animFade=function(fAlpha){var oParent=this;createjs.Tween.get(_oContainer).to({alpha:fAlpha},250).call(function(){if(fAlpha===0){_oContainer.visible=false;oParent.hideCharacter(NUM_SPRITE_PLAYER-1);oParent.viewCharacter(_iAnimPlayer)}})};this.viewCharacter=function(iFrame){_aPlayer[iFrame].visible=true};this.hideCharacter=function(iFrame){_aPlayer[iFrame].visible=false};this.getFrame=function(){return _iAnimPlayer};this.animPlayer=function(){_fBuffer+=s_iTimeElaps;if(_fBuffer>BUFFER_ANIM_PLAYER){this.hideCharacter(_iAnimPlayer);if(_iAnimPlayer+1<NUM_SPRITE_PLAYER){this.viewCharacter(_iAnimPlayer+1);_iAnimPlayer++}else{this.viewCharacter(_iAnimPlayer);_iAnimPlayer=0;_fBuffer=0;return false}_oContainer.updateCache();_fBuffer=0}return true};this._init(iX,iY);return this}function CScenarioStriker(){var _oWorld;var _oGroundMaterial;var _oBallMaterial;var _oWallMaterial;var _oBallShape;var _oBallBody;var _oBallMesh;var _oFieldShape;var _oFieldBody;var _oPoleGoalShapeLeftRight;var _oPoleGoalShapeUp;var _oGoalBodyPoleLeftRight;var _oGoalShapeBackWall;var _oGoalShapeLeftRightWall;var _oGoalShapeUpWall;var _oGoalBodyWall;var _aGoalAreaBody;if(SHOW_3D_RENDER)var _oDemo=new CANNON.Demo;this.getDemo=function(){return _oDemo};this._init=function(){if(SHOW_3D_RENDER){_oWorld=_oDemo.getWorld()}else{_oWorld=new CANNON.World}_aGoalAreaBody=new Array;_oWorld.gravity.set(0,0,-9.81);_oWorld.broadphase=new CANNON.NaiveBroadphase;_oWorld.solver.iterations=50;_oWorld.solver.tolerance=1e-5;_oGroundMaterial=new CANNON.Material;_oBallMaterial=new CANNON.Material;_oWallMaterial=new CANNON.Material;var oWallBallCm=new CANNON.ContactMaterial(_oBallMaterial,_oWallMaterial,{friction:.1,restitution:.01});var oGroundBallCm=new CANNON.ContactMaterial(_oBallMaterial,_oGroundMaterial,{friction:.2,restitution:.3});_oWorld.addContactMaterial(oWallBallCm);_oWorld.addContactMaterial(oGroundBallCm);s_oScenario._createBallBody();s_oScenario._createFieldBody();s_oScenario._createGoal();s_oScenario.createBackGoalWall();if(SHOW_AREAS_GOAL){s_oScenario.createAreasGoal()}else{s_oScenario.createAreaGoal(GOAL_LINE_POS,BACK_WALL_GOAL_SIZE,COLOR_AREA_GOAL[0],null)}};this.createAreasGoal=function(){var iID=0;var fX=FIRST_AREA_GOAL_POS.x;var fZ=FIRST_AREA_GOAL_POS.z;for(var i=0;i<NUM_AREA_GOAL.h;i++){for(var j=0;j<NUM_AREA_GOAL.w;j++){s_oScenario.createAreaGoal({x:fX,y:FIRST_AREA_GOAL_POS.y,z:fZ},AREA_GOAL_PROPERTIES,COLOR_AREA_GOAL[iID],AREAS_INFO[iID]);fX+=AREA_GOAL_PROPERTIES.width*2;iID++}fX=FIRST_AREA_GOAL_POS.x;fZ-=AREA_GOAL_PROPERTIES.height*2}};this._createFieldBody=function(){_oFieldShape=new CANNON.Plane;_oFieldBody=new CANNON.Body({mass:0,material:_oGroundMaterial});_oFieldBody.addShape(_oFieldShape);_oFieldBody.position.z=-9;_oFieldBody.addEventListener("collide",function(e){s_oScenario.fieldCollision()});_oWorld.addBody(_oFieldBody);if(SHOW_3D_RENDER){var oFieldMaterial=new THREE.MeshPhongMaterial({color:5803568,specular:1118481,shininess:10});_oDemo.addVisual(_oFieldBody,oFieldMaterial)}};this._createGoal=function(){_oPoleGoalShapeLeftRight=new CANNON.Cylinder(POLE_RIGHT_LEFT_SIZE.radius_top,POLE_RIGHT_LEFT_SIZE.radius_bottom,POLE_RIGHT_LEFT_SIZE.height,POLE_RIGHT_LEFT_SIZE.segments);_oGoalBodyPoleLeftRight=new CANNON.Body({mass:0});_oPoleGoalShapeUp=new CANNON.Cylinder(POLE_UP_SIZE.radius_top,POLE_UP_SIZE.radius_bottom,POLE_UP_SIZE.height,POLE_UP_SIZE.segments);var qRotation=new CANNON.Quaternion;qRotation.setFromAxisAngle(new CANNON.Vec3(0,1,0),Math.PI/2);_oPoleGoalShapeUp.transformAllPoints(new CANNON.Vec3,qRotation);_oGoalBodyPoleLeftRight.addShape(_oPoleGoalShapeLeftRight,new CANNON.Vec3(POLE_UP_SIZE.height*.5,0,0));_oGoalBodyPoleLeftRight.addShape(_oPoleGoalShapeLeftRight,new CANNON.Vec3(-POLE_UP_SIZE.height*.5,0,0));_oGoalBodyPoleLeftRight.addShape(_oPoleGoalShapeUp,new CANNON.Vec3(0,0,POLE_RIGHT_LEFT_SIZE.height*.5));_oGoalBodyPoleLeftRight.position.set(BACK_WALL_GOAL_POSITION.x,BACK_WALL_GOAL_POSITION.y-UP_WALL_GOAL_SIZE.depth,BACK_WALL_GOAL_POSITION.z);_oGoalBodyPoleLeftRight.addEventListener("collide",function(e){s_oScenario.poleCollision()});_oWorld.addBody(_oGoalBodyPoleLeftRight);if(SHOW_3D_RENDER){var oGoalMaterial=new THREE.MeshPhongMaterial({color:16777215,specular:1118481,shininess:50});_oDemo.addVisual(_oGoalBodyPoleLeftRight,oGoalMaterial)}};this.createBackGoalWall=function(){_oGoalShapeBackWall=new CANNON.Box(new CANNON.Vec3(BACK_WALL_GOAL_SIZE.width,BACK_WALL_GOAL_SIZE.depth,BACK_WALL_GOAL_SIZE.height));_oGoalShapeLeftRightWall=new CANNON.Box(new CANNON.Vec3(LEFT_RIGHT_WALL_GOAL_SIZE.width,LEFT_RIGHT_WALL_GOAL_SIZE.depth,LEFT_RIGHT_WALL_GOAL_SIZE.height));_oGoalShapeUpWall=new CANNON.Box(new CANNON.Vec3(UP_WALL_GOAL_SIZE.width,UP_WALL_GOAL_SIZE.depth,UP_WALL_GOAL_SIZE.height));_oGoalBodyWall=new CANNON.Body({mass:0,material:_oWallMaterial});_oGoalBodyWall.addShape(_oGoalShapeBackWall);_oGoalBodyWall.addShape(_oGoalShapeLeftRightWall,new CANNON.Vec3(BACK_WALL_GOAL_SIZE.width,0,0));_oGoalBodyWall.addShape(_oGoalShapeLeftRightWall,new CANNON.Vec3(-BACK_WALL_GOAL_SIZE.width,0,0));_oGoalBodyWall.addShape(_oGoalShapeUpWall,new CANNON.Vec3(0,0,BACK_WALL_GOAL_SIZE.height));_oGoalBodyWall.position.set(BACK_WALL_GOAL_POSITION.x,BACK_WALL_GOAL_POSITION.y,BACK_WALL_GOAL_POSITION.z);_oWorld.addBody(_oGoalBodyWall);if(SHOW_3D_RENDER){_oDemo.addVisual(_oGoalBodyWall)}};this.createAreaGoal=function(oPos,oProperties,oColor,oInfo){var oGoalShapeLine=new CANNON.Box(new CANNON.Vec3(oProperties.width,oProperties.depth,oProperties.height));var oGoalBodyLine=new CANNON.Body({mass:0,userData:oInfo});oGoalBodyLine.addShape(oGoalShapeLine);oGoalBodyLine.position.set(oPos.x,oPos.y,oPos.z);oGoalBodyLine.collisionResponse=0;oGoalBodyLine.addEventListener("collide",function(e){s_oScenario.lineGoalCollision(e)});_oWorld.addBody(oGoalBodyLine);if(SHOW_3D_RENDER){var oMaterial=new THREE.MeshPhongMaterial({color:oColor,specular:1118481,shininess:70});_oDemo.addVisual(oGoalBodyLine,oMaterial)}return oGoalBodyLine};this._createBallBody=function(){_oBallShape=new CANNON.Sphere(BALL_RADIUS);_oBallBody=new CANNON.Body({mass:BALL_MASS,material:_oBallMaterial,linearDamping:BALL_LINEAR_DAMPING,angularDamping:BALL_LINEAR_DAMPING*2});var v3IniPos=new CANNON.Vec3(POSITION_BALL.x,POSITION_BALL.y,POSITION_BALL.z);_oBallBody.position.copy(v3IniPos);_oBallBody.addShape(_oBallShape);_oWorld.add(_oBallBody);if(SHOW_3D_RENDER){var oBallMaterial=new THREE.MeshPhongMaterial({color:16777215,specular:1118481,shininess:70});_oBallMesh=_oDemo.addVisual(_oBallBody,oBallMaterial)}};this.addImpulse=function(oBody,oVec3){var v3WorldPoint=new CANNON.Vec3(0,0,BALL_RADIUS);var v3Impulse=new CANNON.Vec3(oVec3.x,oVec3.y,oVec3.z);oBody.applyImpulse(v3Impulse,v3WorldPoint)};this.addForce=function(oBody,oVec3){var v3WorldPoint=new CANNON.Vec3(0,0,0);var v3Force=new CANNON.Vec3(oVec3.x,oVec3.y,oVec3.z);oBody.applyForce(v3Force,v3WorldPoint)};this.getBodyVelocity=function(oBody){return oBody.velocity};this.ballBody=function(){return _oBallBody};this.ballMesh=function(){return _oBallMesh};this.getCamera=function(){return _oDemo.camera()};this.fieldCollision=function(){s_oGameStriker.fieldCollision();s_oGameStriker.ballFadeForReset()};this.setElementAngularVelocity=function(oElement,oVec3){oElement.angularVelocity.set(oVec3.x,oVec3.y,oVec3.z)};this.setElementVelocity=function(oElement,oVec3){var v3=new CANNON.Vec3(oVec3.x,oVec3.y,oVec3.z);oElement.velocity=v3};this.setElementLinearDamping=function(oElement,fValue){oElement.linearDamping=fValue};this.getFieldBody=function(){return _oFieldBody};this.lineGoalCollision=function(e){s_oGameStriker.areaGoal(e.contact.bj.userData)};this.update=function(){_oWorld.step(PHYSICS_STEP)};this.getGoalBody=function(){return _oGoalBodyPoleLeftRight};this.poleCollision=function(){s_oGameStriker.poleCollide()};this.destroyWorld=function(){var aBodies=_oWorld.bodies;for(var i=0;i<aBodies.length;i++){_oWorld.remove(aBodies[i])}_oWorld=null};s_oScenario=this;if(SHOW_3D_RENDER){_oDemo.addScene("Test",this._init);_oDemo.start()}else{this._init()}}var s_oScenario;function CStartBall(iX,iY,oParetContainer){var _oParentContainer=oParetContainer;var _oStartBall;this._init=function(){var oSpriteStartBall=s_oSpriteLibrary.getSprite("start_ball");_oStartBall=createBitmap(oSpriteStartBall);_oStartBall.regX=oSpriteStartBall.width*.5;_oStartBall.regY=oSpriteStartBall.height*.5;this.setPosition(iX,iY);_oParentContainer.addChild(_oStartBall)};this.setPosition=function(iX,iY){_oStartBall.x=iX;_oStartBall.y=iY};this.fadeAnim=function(fVal,iTime,iWait){createjs.Tween.get(_oStartBall,{override:true}).wait(iWait).to({alpha:fVal},iTime)};this.setAlpha=function(fVal){_oStartBall.alpha=fVal};this.setVisible=function(bVal){_oStartBall.visible=bVal};this._init();return this}function CBallKeeper(iXPos,iYPos,oSprite,oPhysics,oParentContainer){var _oBall;var _oParentContainer;var _oPhysics;var _oShadow;var _oContainer;var _fStartShadowPos=null;var _fScale=.66;var _fScaleShadow=.6;var _iBufferTime=0;var _iFrame=0;var _oTween=null;var _fAlpha;this._init=function(iXPos,iYPos,oSprite){_oContainer=new createjs.Container;_oParentContainer.addChild(_oContainer);var oData={images:[oSprite],frames:{width:oSprite.width/7,height:oSprite.height,regX:oSprite.width/2/7,regY:oSprite.height/2}};var oSpriteSheet=new createjs.SpriteSheet(oData);_oBall=createSprite(oSpriteSheet,0,oSprite.width/2/7,oSprite.height/2,oSprite.width/7,oSprite.height/2);_oBall.stop();this.scale(_fScale);var oSpriteShadow=s_oSpriteLibrary.getSprite("ball_shadow");_oShadow=createBitmap(oSpriteShadow);_oShadow.x=iXPos;_oShadow.y=iYPos;_oShadow.regX=oSpriteShadow.width*.5;_oShadow.regY=oSpriteShadow.height*.5;this.scaleShadow(_fScaleShadow);_oContainer.addChild(_oShadow,_oBall)};this.rolls=function(){var iForceX=_oPhysics.velocity.x*.15;var fAngle=Math.sin(iForceX);_oBall.rotation=Math.degrees(fAngle);var iForceY=Math.abs(_oPhysics.angularVelocity.x);var oFuncRot=this._goToPrevFrame;if(_oPhysics.angularVelocity.x<0){oFuncRot=this._goToNextFrame}if(iForceY>7){oFuncRot()}else if(iForceY>3){_iBufferTime++;if(_iBufferTime>2/ROLL_BALL_RATE){oFuncRot();_iBufferTime=0}}else if(iForceY>1){_iBufferTime++;if(_iBufferTime>3/ROLL_BALL_RATE){oFuncRot();_iBufferTime=0}}else if(iForceY>MIN_BALL_VEL_ROTATION){_iBufferTime++;if(_iBufferTime>4/ROLL_BALL_RATE){oFuncRot();_iBufferTime=0}}};this._goToPrevFrame=function(){if(_iFrame===0){_iFrame=6;_oBall.gotoAndStop(_iFrame)}else{_iFrame--;_oBall.gotoAndStop(_iFrame)}};this._goToNextFrame=function(){if(_iFrame===7){_iFrame=1;_oBall.gotoAndStop(_iFrame)}else{_iFrame++;_oBall.gotoAndStop(_iFrame)}};this.unload=function(){_oBall.removeAllEventListeners();_oParentContainer.removeChild(_oBall)};this.setVisible=function(bVisible){_oBall.visible=bVisible};this.startPosShadowY=function(fYPos){_fStartShadowPos=fYPos};this.getStartShadowYPos=function(){return _fStartShadowPos};this.fadeAnimation=function(fVal,iTime,iWait){if(fVal!==_fAlpha){if(_oTween===null){this.tweenFade(fVal,iTime,iWait)}else{createjs.Tween.removeTweens(_oContainer);this.tweenFade(fVal,iTime,iWait)}_fAlpha=fVal}};this.tweenFade=function(fVal,iTime,iWait){_oTween=createjs.Tween.get(_oContainer).wait(iWait).to({alpha:fVal},iTime).call(function(){_oTween=null})};this.setPositionShadow=function(iX,iY){_oShadow.x=iX;_oShadow.y=iY};this.setPosition=function(iXPos,iYPos){_oBall.x=iXPos;_oBall.y=iYPos};this.getPhysics=function(){return _oPhysics};this.setAngle=function(iAngle){_oBall.rotation=iAngle};this.getX=function(){return _oBall.x};this.getY=function(){return _oBall.y};this.getStartScale=function(){return _fScale};this.scale=function(fValue){_oBall.scaleX=fValue;_oBall.scaleY=fValue};this.scaleShadow=function(fScale){if(fScale>.08){_oShadow.scaleX=fScale;_oShadow.scaleY=fScale}else{_oShadow.scaleX=.08;_oShadow.scaleY=.08}};this.setAlphaByHeight=function(fHeight){_oShadow.alpha=fHeight};this.getScale=function(){return _oBall.scaleX};this.getObject=function(){return _oBall};this.getDepthPos=function(){return _oPhysics.position.y};_oPhysics=oPhysics;_oParentContainer=oParentContainer;this._init(iXPos,iYPos,oSprite);return this}function CGameGoalkeeper(iLevel,iCurBallForceY,oParentContainer){var _oBg;var _oScene;var _oGloves;var _oBall;var _oOpponent=null;var _oGoal;var _oStageMouseMove=null;var _oListenerClickStage;var _oContainerGame;var _bGoal=false;var _bKeeperSave=false;var _bPerfectSaved=false;var _bLaunched=false;var _bFieldCollide=false;var _iLevel;var _iBallSaved=0;var _iGoalOpponent=0;var _iPerfectBallSaved=0;var _iCurBallForceY;var _fTimeReset;var _aObjects;var _iGameState=STATE_INIT;var _oCamera=null;var _oFade;var _oParentContainer=oParentContainer;this._init=function(iLevel,iCurBallForceY){this.pause(true);_iCurBallForceY=iCurBallForceY;_aObjects=new Array;_iLevel=iLevel;_oContainerGame=new createjs.Container;_oParentContainer.addChild(_oContainerGame);_oBg=createBitmap(s_oSpriteLibrary.getSprite("bg_game_gk"));_oContainerGame.addChild(_oBg);_oScene=new CScenarioKeeper;if(SHOW_3D_RENDER){_oCamera=camera}else{_oCamera=createOrthoGraphicCamera()}var oSpriteOpponent=s_oSpriteLibrary.getSprite("opponent_"+TEAM_INFO[s_aMatches[_iLevel-1]].opponent);_oOpponent=new COpponent(600,340,oSpriteOpponent,_oContainerGame);var oSpriteBall=s_oSpriteLibrary.getSprite("ball");_oBall=new CBallKeeper(0,0,oSpriteBall,_oScene.ballBody(),_oContainerGame);_aObjects.push(_oBall);this.ballPosition();resizeCanvas3D();var oSpriteGloves=s_oSpriteLibrary.getSprite("gloves");_oGloves=new CGloves(CANVAS_WIDTH_HALF,CANVAS_HEIGHT_HALF,oSpriteGloves,_oScene.getHandKeeperBody(),_oContainerGame);_aObjects.push(_oGloves);var oSpriteGoal=s_oSpriteLibrary.getSprite("goal_1");_oGoal=new CGoalGoalkeeper(0,0,oSpriteGoal,_oScene.getGoalBody(),_oContainerGame);_aObjects.push(_oGoal);_oFade=new createjs.Shape;_oFade.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);_oFade.alpha=1;_oParentContainer.addChild(_oFade);createjs.Tween.get(_oFade).to({alpha:0},300,createjs.cubicOut);this.startGame();s_oInterface.showHelpText(TEXT_HELP_KEEPER)};this.sortDepth=function(oObj1,oObj2){if(oObj1===null||oObj2===null){return}if(oObj1.getDepthPos()>oObj2.getDepthPos()){if(_oContainerGame.getChildIndex(oObj1.getObject())>_oContainerGame.getChildIndex(oObj2.getObject())){_oContainerGame.swapChildren(oObj1.getObject(),oObj2.getObject())}}else if(oObj1.getDepthPos()<oObj2.getDepthPos()){if(_oContainerGame.getChildIndex(oObj2.getObject())>_oContainerGame.getChildIndex(oObj1.getObject())){_oContainerGame.swapChildren(oObj2.getObject(),oObj1.getObject())}}};this.startGame=function(){this.pause(false)};this.activeEventListeners=function(){if(SHOW_3D_RENDER){window.addEventListener("mousedown",this.addImpulseToBall);window.addEventListener("mousemove",this.onHandKeeper)}else{if(_oStageMouseMove===null){_oStageMouseMove=s_oStage.on("stagemousemove",this.onHandKeeper)}_oListenerClickStage=_oContainerGame.on("click",this.clickStage)}};this.clickStage=function(){_oContainerGame.off("click",_oListenerClickStage);s_oGameKeeper.startOpponentShot()};this.deactiveEventListeners=function(){if(SHOW_3D_RENDER){window.removeEventListener("mousedown",this.addImpulseToBall);window.removeEventListener("mousemove",this.onHandKeeper)}else{s_oStage.off("stagemousemove",_oStageMouseMove);_oStageMouseMove=null}};this.ballPosition=function(){var oBallBody=_oScene.ballBody();var oPos2DBall=this.convert3dPosTo2dScreen(oBallBody.position,_oCamera);var fScaleDistance=oPos2DBall.z*(BALL_SCALE_FACTOR-_oBall.getStartScale())+_oBall.getStartScale();this.shadowBall(oBallBody,fScaleDistance);_oBall.scale(fScaleDistance);_oBall.setPosition(oPos2DBall.x,oPos2DBall.y)};this.shadowBall=function(oBallBody,fScaleDistance){var oFieldBody=_oScene.getFieldBody();var oPosShadow={x:oBallBody.position.x,y:oBallBody.position.y,z:oFieldBody.position.z};var oPos2dShadow=this.convert3dPosTo2dScreen(oPosShadow,_oCamera);var fDistance=oBallBody.position.z-oFieldBody.position.z;var fScaleHeight=fScaleDistance/fDistance;_oBall.scaleShadow(fScaleHeight);var fDistanceShadow=(-oBallBody.position.z-oFieldBody.position.z*.1)*.1;_oBall.setAlphaByHeight(fDistanceShadow);_oBall.setPositionShadow(oPos2dShadow.x,oPos2dShadow.y)};this.unload=function(){_iGameState=-1;_oParentContainer.removeAllChildren();_oScene.destroyWorld();_oScene=null;this.deactiveEventListeners()};this.resetValues=function(){_iGoalOpponent=0;_iBallSaved=0;_iPerfectBallSaved=0};this.wallSoundCollision=function(){};this.goal=function(){if(!_bGoal){_bGoal=true;_fTimeReset=TIME_RESET_AFTER_GOAL;playSound("goal_keeper",1,false)}};this.keeperSave=function(oContactPoint){if(_bGoal){return}if(!_bKeeperSave){if(oContactPoint.x>-BALL_SAVED_POINT.x&&oContactPoint.x<BALL_SAVED_POINT.x&&oContactPoint.z>-BALL_SAVED_POINT.z&&oContactPoint.z<BALL_SAVED_POINT.z){_bPerfectSaved=true;_oBall.getPhysics().mass=0;_fTimeReset=TIME_RESET_AFTER_PERFECT_KEEPER_SAVED;_iPerfectBallSaved++;_oGloves.changeState("perfect");createjs.Tween.get(_oContainerGame).wait(TIME_BALL_IN_HAND).call(function(){_bPerfectSaved=false;_oBall.getPhysics().mass=BALL_MASS;_oGloves.changeState("normal")})}else{_bPerfectSaved=false;_fTimeReset=TIME_RESET_AFTER_KEEPER_SAVED}_bKeeperSave=true;playSound("kick",.65,false);playSound("keep_ball",1,false)}};this.addImpulseToBall=function(){if(_bLaunched||_iGameState!==STATE_PLAY){return}var fX=Math.random()*(BALL_FORCE_X[_iLevel-1]+BALL_FORCE_X[_iLevel-1])-BALL_FORCE_X[_iLevel-1];var fZ=Math.random()*(BALL_FORCE_Z[_iLevel-1].max-BALL_FORCE_Z[_iLevel-1].min)+BALL_FORCE_Z[_iLevel-1].min;var oDir={x:fX,y:-_iCurBallForceY,z:fZ};var oBall=_oScene.ballBody();_oScene.addImpulse(oBall,oDir);_oScene.setElementAngularVelocity(oBall,{x:0,y:0,z:0});_bLaunched=true};this.pause=function(bVal){if(bVal){_iGameState=STATE_PAUSE;if(_oOpponent!==null)_oOpponent.stopAnimation();this.deactiveEventListeners()}else{_iGameState=STATE_PLAY;if(_oOpponent!==null)_oOpponent.playAnimation();this.activeEventListeners()}createjs.Ticker.paused=bVal};this.startOpponentShot=function(){_oOpponent.changeState("shot");_oOpponent.fadeAnimation(1);_oOpponent.onFinishAnimation();s_oInterface.hideHelpText()};this.onExit=function(){this.unload();setVolume("soundtrack",1);s_oMain.changeCanvasSize(1360,640);s_oMain.gotoMenu()};this.restartLevel=function(){this.resetValues();this.resetScene();this.activeEventListeners();_iGameState=STATE_PLAY;this.startOpponentShot()};this.resetBallPosition=function(){var oBallBody=_oScene.ballBody();oBallBody.position.set(POSITION_BALL.x,POSITION_BALL.y,POSITION_BALL.z);_oScene.setElementVelocity(oBallBody,{x:0,y:0,z:0});_oScene.setElementAngularVelocity(oBallBody,{x:0,y:0,z:0});_oBall.fadeAnimation(1,500,0)};this.ballFadeForReset=function(){if(_bGoal||_bKeeperSave){var iWait=1e3;if(_bGoal){iWait=100}if(!_bFieldCollide){_oBall.fadeAnimation(0,300,iWait);_bFieldCollide=true}}};this._updateInit=function(){_oScene.update();this._updateBall2DPosition();_iGameState=STATE_PLAY};this.onHandKeeper=function(e){var oHandKeeperBody=_oScene.getHandKeeperBody();if(!SHOW_3D_RENDER){var oPosMouse={x:e.stageX/s_fInverseScaling,y:e.stageY/s_fInverseScaling}}else{var oPosMouse={x:e.clientX-s_iCanvasOffsetWidth,y:e.clientY-s_iCanvasOffsetHeight}}if(s_bMobile){oPosMouse.y=oPosMouse.y+MOBILE_OFFSET_GLOVES_Y}var oMouse3D=s_oGameKeeper.convert2dScreenPosTo3d(oPosMouse,oHandKeeperBody);if(oMouse3D.x<LIMIT_HAND_RANGE_POS.x&&oMouse3D.x>-LIMIT_HAND_RANGE_POS.x){oHandKeeperBody.position.x=oMouse3D.x}else{if(oMouse3D.x<LIMIT_HAND_RANGE_POS.x){oHandKeeperBody.position.x=-LIMIT_HAND_RANGE_POS.x}else{oHandKeeperBody.position.x=LIMIT_HAND_RANGE_POS.x}}if(oMouse3D.z>LIMIT_HAND_RANGE_POS.zMin&&oMouse3D.z<LIMIT_HAND_RANGE_POS.zMax){oHandKeeperBody.position.z=oMouse3D.z}else{if(oMouse3D.z>LIMIT_HAND_RANGE_POS.zMin){oHandKeeperBody.position.z=LIMIT_HAND_RANGE_POS.zMax}else{oHandKeeperBody.position.z=LIMIT_HAND_RANGE_POS.zMin}}var oPos2D=s_oGameKeeper.convert3dPosTo2dScreen(oHandKeeperBody.position,_oCamera);_oGloves.setPosition(oPos2D.x,oPos2D.y);if(_bPerfectSaved){s_oGameKeeper.ballInHand(oHandKeeperBody.position)}};this.ballInHand=function(oPos){var oBallBody=_oScene.ballBody();oBallBody.position.x=oPos.x;oBallBody.position.y=oPos.y+BALL_RADIUS*.7;oBallBody.position.z=oPos.z;var oPos2DBall=this.convert3dPosTo2dScreen(oBallBody.position,_oCamera);var fScaleDistance=_oBall.getStartScale()-oPos2DBall.z;this.shadowBall(oBallBody,fScaleDistance);_oBall.setPosition(oPos2DBall.x,oPos2DBall.y)};this.convert2dScreenPosTo3d=function(oPos2d){var iWidth=s_iCanvasResizeWidth;var iHeight=s_iCanvasResizeHeight;var mouse3D=new THREE.Vector3(oPos2d.x/iWidth*2-1,-(oPos2d.y/iHeight)*2+1,-1);mouse3D.unproject(_oCamera);mouse3D.sub(_oCamera.position);mouse3D.normalize();var fFactor=34;mouse3D.multiply(new THREE.Vector3(fFactor,1,fFactor));return mouse3D};this.convert3dPosTo2dScreen=function(pos,oCamera){var v3=new THREE.Vector3(pos.x,pos.y,pos.z);var vector=v3.project(oCamera);var widthHalf=Math.floor(s_iCanvasResizeWidth)*.5;var heightHalf=Math.floor(s_iCanvasResizeHeight)*.5;vector.x=(vector.x*widthHalf+widthHalf)*s_fInverseScaling;vector.y=(-(vector.y*heightHalf)+heightHalf)*s_fInverseScaling;return vector};this.timeReset=function(){if(_fTimeReset>0){_fTimeReset-=FPS_TIME}else{if(_bGoal){_iGoalOpponent++}else{_iBallSaved++}s_oGame.endShotCpu(_bGoal,_bKeeperSave);this.resetScene();_bLaunched=false}};this.goalAnimation=function(fForce){if(fForce>500&&fForce<1e3){this.displayShock(INTENSITY_DISPLAY_SHOCK[0].time,INTENSITY_DISPLAY_SHOCK[0].x,INTENSITY_DISPLAY_SHOCK[0].y)}else if(fForce>999&&fForce<2e3){this.displayShock(INTENSITY_DISPLAY_SHOCK[1].time,INTENSITY_DISPLAY_SHOCK[1].x,INTENSITY_DISPLAY_SHOCK[1].y)}else if(fForce>1999&&fForce<3e3){this.displayShock(INTENSITY_DISPLAY_SHOCK[2].time,INTENSITY_DISPLAY_SHOCK[2].x,INTENSITY_DISPLAY_SHOCK[2].y)}else if(fForce>2999){this.displayShock(INTENSITY_DISPLAY_SHOCK[3].time,INTENSITY_DISPLAY_SHOCK[3].x,INTENSITY_DISPLAY_SHOCK[3].y)}};this.displayShock=function(iTime,iXIntensity,iYIntensity){var xShifting=iXIntensity;var yShifting=iYIntensity;createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting),y:Math.round(Math.random()*yShifting)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.8),y:-Math.round(Math.random()*yShifting*.8)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.6),y:Math.round(Math.random()*yShifting*.6)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.4),y:-Math.round(Math.random()*yShifting*.4)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({x:Math.round(Math.random()*xShifting*.2),y:Math.round(Math.random()*yShifting*.2)},iTime).call(function(){createjs.Tween.get(_oContainerGame).to({y:0,x:0},iTime).call(function(){})})})})})})};this.resetScene=function(){_bGoal=false;_bKeeperSave=false;this.resetBallPosition()};this._onEnd=function(){this.onExit()};this.swapChildrenIndex=function(){for(var i=0;i<_aObjects.length-1;i++){for(var j=i+1;j<_aObjects.length;j++){this.sortDepth(_aObjects[i],_aObjects[j])}}};this.rotateGuantes=function(){var fDistanceX=(_oGloves.getX()-CANVAS_WIDTH_HALF)*HAND_KEEPER_ANGLE_RATE;_oGloves.setRotation(fDistanceX)};this._updatePlay=function(){for(var i=0;i<PHYSICS_ACCURACY;i++){_oScene.update()}this._updateBall2DPosition();if(_bKeeperSave||_bGoal){this.timeReset()}this.rotateGuantes();this.swapChildrenIndex()};this.update=function(){switch(_iGameState){case STATE_INIT:{this._updateInit()}break;case STATE_PLAY:{this._updatePlay()}break;case STATE_FINISH:break;case STATE_PAUSE:break}};this._updateBall2DPosition=function(){if(!_bPerfectSaved){this.ballPosition();_oBall.rolls()}_oCamera.updateProjectionMatrix();_oCamera.updateMatrixWorld()};s_oGameKeeper=this;this._init(iLevel,iCurBallForceY)}var s_oGameKeeper;function CGloves(iX,iY,oSprite,oPhysics,oParentContainer){var _oGloves;var _oParentContainer;var _oPhysics;this._init=function(iX,iY,oSprite){var oData={images:[oSprite],frames:{width:oSprite.width/2,height:oSprite.height,regX:oSprite.width/2/2,regY:oSprite.height/2},animations:{normal:[0],perfect:[1]}};var oSpriteSheet=new createjs.SpriteSheet(oData);_oGloves=createSprite(oSpriteSheet,"normal",oSprite.width/2/2,oSprite.height/2,oSprite.width/2,oSprite.height);this.setPosition(iX,iY);_oParentContainer.addChild(_oGloves)};this.unload=function(){_oParentContainer.removeChild(_oGloves)};this.setPosition=function(iX,iY){_oGloves.x=iX;_oGloves.y=iY};this.getObject=function(){return _oGloves};this.getDepthPos=function(){return _oPhysics.position.y};this.getX=function(){return _oGloves.x};this.getY=function(){return _oGloves.y};this.changeState=function(szText){_oGloves.gotoAndStop(szText)};this.getPhysics=function(){return _oPhysics};this.setRotation=function(fValue){_oGloves.rotation=fValue};_oPhysics=oPhysics;_oParentContainer=oParentContainer;this._init(iX,iY,oSprite);return this}function CGoalGoalkeeper(iX,iY,oSprite,oPhysics,oParentContainer){var _oGoal;var _oPhysics;var _oParentContainer;this._init=function(iX,iY,oSprite){_oGoal=createBitmap(oSprite);this.setPosition(iX,iY);_oParentContainer.addChild(_oGoal)};this.unload=function(){_oParentContainer.removeChild(_oGoal)};this.setPosition=function(iX,iY){_oGoal.x=iX;_oGoal.y=iY};this.getObject=function(){return _oGoal};this.getDepthPos=function(){return _oPhysics.position.y};this.getPhysics=function(){return _oPhysics};this.getX=function(){return _oGoal.x};this.getY=function(){return _oGoal.y};_oPhysics=oPhysics;_oParentContainer=oParentContainer;this._init(iX,iY,oSprite);return this}function COpponent(iXPos,iYPos,oSprite,oParentContainer){var _oOpponent;var _oParentContainer;this._init=function(iXPos,iYPos,oSprite,oParentContainer){_oParentContainer=oParentContainer;var oData={images:[oSprite],frames:{width:oSprite.width/13,height:oSprite.height/7,regX:oSprite.width/2/13,regY:oSprite.height/7},animations:{start:0,shot:[0,44,"stay",30/FPS],stay:[45,79,"remain",30/FPS],remain:[79]}};var oSpriteSheet=new createjs.SpriteSheet(oData);_oOpponent=createSprite(oSpriteSheet,"start",oSprite.width/2/13,oSprite.height/7,oSprite.width/13,oSprite.height/7);_oOpponent.scaleX=_oOpponent.scaleY=.9;_oOpponent.x=iXPos;_oOpponent.y=iYPos;_oParentContainer.addChild(_oOpponent)};this.getX=function(){return _oOpponent.x};this.getY=function(){return _oOpponent.y};this.setPosition=function(iXPos,iYPos){if(iXPos===null){}else{_oOpponent.x=iXPos}if(iYPos===null){}else{_oOpponent.y=iYPos}};this.rotate=function(iValue){_oOpponent.scaleX=iValue};this.setVisible=function(bVal){_oOpponent.visible=bVal};this.changeState=function(szState){_oOpponent.gotoAndPlay(szState)};this.stopAnimation=function(){_oOpponent.stop()};this.playAnimation=function(){_oOpponent.play()};this.onFinishAnimation=function(){var oParent=this;_oOpponent.on("animationend",function(){s_oGameKeeper.addImpulseToBall();playSound("kick",.3,false);_oOpponent.removeAllEventListeners()})};this.fadeAnimation=function(fVal){createjs.Tween.get(_oOpponent).to({alpha:fVal},500)};this.removeTweens=function(){createjs.Tween.removeTweens(_oOpponent)};this._init(iXPos,iYPos,oSprite,oParentContainer);return this}function CScenarioKeeper(){var _oWorld;var _oGroundMaterial;var _oBallMaterial;var _oWallMaterial;var _oHandKeeper;var _oBallShape;var _oBallBody;var _oBallMesh;var _oFieldShape;var _oFieldBody;var _oPoleGoalShapeLeftRight;var _oPoleGoalShapeUp;var _oGoalBodyPoleLeftRight;var _oGoalShapeBackWall;var _oGoalShapeLeftRightWall;var _oGoalShapeUpWall;var _oGoalBodyWall;var _oGoalShapeLine;var _oGoalBodyLine;var _oHandShapeKeeper;var _oHandBodyKeeper;var _oHandMeshKeeper;var _oDemo;if(SHOW_3D_RENDER)_oDemo=new CANNON.Demo;this.getDemo=function(){return _oDemo};this._init=function(){if(SHOW_3D_RENDER){_oWorld=_oDemo.getWorld()}else{_oWorld=new CANNON.World}_oWorld.gravity.set(0,0,-9.81);_oWorld.broadphase=new CANNON.NaiveBroadphase;_oWorld.solver.iterations=50;_oWorld.solver.tolerance=1e-5;_oGroundMaterial=new CANNON.Material;_oBallMaterial=new CANNON.Material;_oWallMaterial=new CANNON.Material;_oHandKeeper=new CANNON.Material;var oWallBallCm=new CANNON.ContactMaterial(_oBallMaterial,_oWallMaterial,{friction:.1,restitution:.5});var oGroundBallCm=new CANNON.ContactMaterial(_oBallMaterial,_oGroundMaterial,{friction:.2,restitution:.3});var oHandBallCm=new CANNON.ContactMaterial(_oBallMaterial,_oHandKeeper,{friction:.5,restitution:.1});_oWorld.addContactMaterial(oWallBallCm);_oWorld.addContactMaterial(oGroundBallCm);_oWorld.addContactMaterial(oHandBallCm);s_oScenario._createBallBody();s_oScenario._createFieldBody();s_oScenario._createGoal();s_oScenario.createBackGoalWall();s_oScenario.createLineOfGoal();s_oScenario.createHandGoalKeeper()};this._createFieldBody=function(){_oFieldShape=new CANNON.Plane;_oFieldBody=new CANNON.Body({mass:0,material:_oGroundMaterial});_oFieldBody.addShape(_oFieldShape);_oFieldBody.position.z=-10;_oFieldBody.addEventListener("collide",function(e){s_oScenario.fieldCollision()});_oWorld.addBody(_oFieldBody);if(SHOW_3D_RENDER)_oDemo.addVisual(_oFieldBody)};this._createGoal=function(){_oPoleGoalShapeLeftRight=new CANNON.Cylinder(POLE_RIGHT_LEFT_SIZE.radius_top,POLE_RIGHT_LEFT_SIZE.radius_bottom,POLE_RIGHT_LEFT_SIZE.height,POLE_RIGHT_LEFT_SIZE.segments);_oGoalBodyPoleLeftRight=new CANNON.Body({mass:0});_oPoleGoalShapeUp=new CANNON.Cylinder(POLE_UP_SIZE.radius_top,POLE_UP_SIZE.radius_bottom,POLE_UP_SIZE.height,POLE_UP_SIZE.segments);var qRotation=new CANNON.Quaternion;qRotation.setFromAxisAngle(new CANNON.Vec3(0,1,0),Math.PI/2);_oPoleGoalShapeUp.transformAllPoints(new CANNON.Vec3,qRotation);_oGoalBodyPoleLeftRight.addShape(_oPoleGoalShapeLeftRight,new CANNON.Vec3(POLE_UP_SIZE.height*.5,0,0));_oGoalBodyPoleLeftRight.addShape(_oPoleGoalShapeLeftRight,new CANNON.Vec3(-POLE_UP_SIZE.height*.5,0,0));_oGoalBodyPoleLeftRight.addShape(_oPoleGoalShapeUp,new CANNON.Vec3(0,0,POLE_RIGHT_LEFT_SIZE.height*.5));_oGoalBodyPoleLeftRight.position.set(GOAL_POSITION.x,GOAL_POSITION.y,GOAL_POSITION.z);_oGoalBodyPoleLeftRight.addEventListener("collide",function(e){s_oScenario.poleCollision()});_oWorld.addBody(_oGoalBodyPoleLeftRight);if(SHOW_3D_RENDER){_oDemo.addVisual(_oGoalBodyPoleLeftRight)}};this.createBackGoalWall=function(){_oGoalShapeBackWall=new CANNON.Box(new CANNON.Vec3(BACK_WALL_GOAL_SIZE.width,BACK_WALL_GOAL_SIZE.depth,BACK_WALL_GOAL_SIZE.height));_oGoalShapeLeftRightWall=new CANNON.Box(new CANNON.Vec3(LEFT_RIGHT_WALL_GOAL_SIZE.width,LEFT_RIGHT_WALL_GOAL_SIZE.depth,LEFT_RIGHT_WALL_GOAL_SIZE.height));_oGoalShapeUpWall=new CANNON.Box(new CANNON.Vec3(UP_WALL_GOAL_SIZE.width,UP_WALL_GOAL_SIZE.depth,UP_WALL_GOAL_SIZE.height));_oGoalBodyWall=new CANNON.Body({mass:0,material:_oWallMaterial});_oGoalBodyWall.addShape(_oGoalShapeBackWall);_oGoalBodyWall.addShape(_oGoalShapeLeftRightWall,new CANNON.Vec3(BACK_WALL_GOAL_SIZE.width,0,0));_oGoalBodyWall.addShape(_oGoalShapeLeftRightWall,new CANNON.Vec3(-BACK_WALL_GOAL_SIZE.width,0,0));_oGoalBodyWall.addShape(_oGoalShapeUpWall,new CANNON.Vec3(0,0,BACK_WALL_GOAL_SIZE.height));_oGoalBodyWall.addEventListener("collide",function(e){s_oScenario.goalCollision(e)});_oGoalBodyWall.position.set(BACK_WALL_GOAL_POSITION.x,BACK_WALL_GOAL_POSITION.y,BACK_WALL_GOAL_POSITION.z);_oWorld.addBody(_oGoalBodyWall)};this.createLineOfGoal=function(){_oGoalShapeLine=new CANNON.Box(new CANNON.Vec3(BACK_WALL_GOAL_SIZE.width,BACK_WALL_GOAL_SIZE.depth,BACK_WALL_GOAL_SIZE.height));_oGoalBodyLine=new CANNON.Body({mass:0});_oGoalBodyLine.addShape(_oGoalShapeLine);_oGoalBodyLine.position.set(GOAL_LINE_POS.x,GOAL_LINE_POS.y,GOAL_LINE_POS.z);_oGoalBodyLine.collisionResponse=0;_oGoalBodyLine.addEventListener("collide",function(e){s_oScenario.lineGoalCollision()});_oWorld.addBody(_oGoalBodyLine)};this.createHandGoalKeeper=function(){_oHandShapeKeeper=new CANNON.Box(new CANNON.Vec3(HAND_KEEPER_SIZE.width,HAND_KEEPER_SIZE.depth,HAND_KEEPER_SIZE.height));_oHandBodyKeeper=new CANNON.Body({mass:0,material:_oHandKeeper});_oHandBodyKeeper.addShape(_oHandShapeKeeper);_oHandBodyKeeper.position.set(HAND_KEEPER_POSITION.x,HAND_KEEPER_POSITION.y,HAND_KEEPER_POSITION.z);_oHandBodyKeeper.addEventListener("collide",function(e){s_oScenario.handCollision(e)});_oWorld.addBody(_oHandBodyKeeper);if(SHOW_3D_RENDER)_oHandMeshKeeper=_oDemo.addVisual(_oHandBodyKeeper)};this._createBallBody=function(){_oBallShape=new CANNON.Sphere(BALL_RADIUS);_oBallBody=new CANNON.Body({mass:BALL_MASS,material:_oBallMaterial,linearDamping:BALL_LINEAR_DAMPING,angularDamping:BALL_LINEAR_DAMPING*2});var v3IniPos=new CANNON.Vec3(POSITION_BALL.x,POSITION_BALL.y,POSITION_BALL.z);_oBallBody.position.copy(v3IniPos);_oBallBody.addShape(_oBallShape);_oWorld.add(_oBallBody);if(SHOW_3D_RENDER)_oBallMesh=_oDemo.addVisual(_oBallBody)};this.addImpulse=function(oBody,oVec3){var v3WorldPoint=new CANNON.Vec3(0,0,BALL_RADIUS);var v3Impulse=new CANNON.Vec3(oVec3.x,oVec3.y,oVec3.z);oBody.applyImpulse(v3Impulse,v3WorldPoint)};this.addForce=function(oBody,oVec3){var v3WorldPoint=new CANNON.Vec3(0,0,0);var v3Force=new CANNON.Vec3(oVec3.x,oVec3.y,oVec3.z);oBody.applyForce(v3Force,v3WorldPoint)};this.getBodyVelocity=function(oBody){return oBody.velocity};this.ballBody=function(){return _oBallBody};this.ballMesh=function(){return _oBallMesh};this.getCamera=function(){return _oDemo.camera()};this.fieldCollision=function(){s_oGameKeeper.ballFadeForReset();if(s_oInterface.isHelpTextVisible()===false){playSound("drop_bounce_grass",1,false)}};this.collisionWithBall=function(){s_oGameKeeper.lineGoalCollision()};this.setElementAngularVelocity=function(oElement,oVec3){oElement.angularVelocity.set(oVec3.x,oVec3.y,oVec3.z)};this.setElementVelocity=function(oElement,oVec3){var v3=new CANNON.Vec3(oVec3.x,oVec3.y,oVec3.z);oElement.velocity=v3};this.setElementLinearDamping=function(oElement,fValue){oElement.linearDamping=fValue};this.getFieldBody=function(){return _oFieldBody};this.lineGoalCollision=function(){s_oGameKeeper.goal()};this.handCollision=function(e){s_oGameKeeper.keeperSave(e.contact.rj)};this.update=function(){_oWorld.step(PHYSICS_STEP)};this.getHandKeeperBody=function(){return _oHandBodyKeeper};this.getHandKeeperMesh=function(){return _oHandMeshKeeper};this.getGoalBody=function(){return _oGoalBodyPoleLeftRight};this.goalCollision=function(e){var fForceTot=e.body.velocity.x*e.body.velocity.x+e.body.velocity.y*e.body.velocity.y;s_oGameKeeper.goalAnimation(fForceTot)};this.poleCollision=function(){playSound("kick",1,false)};this.destroyWorld=function(){var aBodies=_oWorld.bodies;var aTmpBodies=new Array;for(var j=0;j<aBodies.length;j++){aTmpBodies[j]=aBodies[j]}var iLen=aBodies.length;for(var i=0;i<iLen;i++){_oWorld.removeBody(aTmpBodies[i])}_oWorld=null};s_oScenario=this;if(SHOW_3D_RENDER){_oDemo.addScene("Test",this._init);_oDemo.start()}else{this._init()}}var s_oScenario;